<% 
  # Bloom Aura - Premium Growth Visualization
  progress = (progress || 0).to_i
  completed_count = (completed_count || 0).to_i
  total_task_count = (total_task_count || 1).to_i
  active_users = orbit_users || []
  real_active_count = active_users.respond_to?(:count) ? active_users.count : (active_users&.size || 0)
  
  # Tasks to display (Unified Routines + Challenges)
  display_tasks = (aura_tasks || []).presence || []
%>

<div id="prototype-garden-section" class="relative group w-full max-w-sm mx-auto">
  <!-- ğŸ¨ Compact Aura Container -->
  <div class="relative aspect-square w-full rounded-[48px] bg-[#08070B] border border-white/[0.03] overflow-hidden flex items-center justify-center">
    
    <!-- ğŸ‘¥ Active Users (Moved to Top Right) -->
    <div class="absolute top-8 right-4 z-30 flex items-center gap-2 px-3 py-1.5 rounded-xl bg-[#08070B]/60 backdrop-blur-md border border-white/10 shadow-xl">
      <div class="flex -space-x-1.5">
        <% active_users.take(2).each do |user| %>
          <img src="<%= user.profile_image %>" class="w-4 h-4 rounded-full border border-[#08070B] grayscale opacity-80">
        <% end %>
      </div>
      <p class="text-[9px] font-black text-white/60 uppercase tracking-widest leading-none">
        <%= real_active_count %>ëª… <span class="text-indigo-400">Running</span>
      </p>
    </div>

    <!-- ğŸŒŒ Ambient Depth -->
    <div class="absolute inset-0">
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-gradient-to-b from-indigo-500/5 to-transparent opacity-50"></div>
    </div>

    <!-- ğŸ¦‹ Fine Particle Dust (Fireflies replacement) -->
    <div class="absolute inset-0 pointer-events-none z-10">
      <% 12.times do |i| %>
        <div class="aura-particle absolute w-0.5 h-0.5 bg-white/20 rounded-full"
             style="--delay: <%= rand(0..5) %>s; --duration: <%= rand(10..20) %>s; top: <%= rand(20..80) %>%; left: <%= rand(20..80) %>%"></div>
      <% end %>
    </div>

    <!-- ğŸ”® The Central Aura Sphere (Energy Seed) -->
    <div class="relative z-20 flex items-center justify-center w-[60%] aspect-square">
      <!-- Outer Glow Layers -->
      <div class="absolute inset-0 rounded-full blur-[40px] transition-all duration-1000 <%= progress >= 100 ? 'bg-emerald-500/20 scale-125' : 'bg-indigo-500/10' %>"></div>
      <div class="absolute inset-0 rounded-full blur-[20px] transition-all duration-1000 <%= progress >= 100 ? 'bg-emerald-400/30' : 'bg-indigo-400/20 shadow-[0_0_40px_rgba(99,102,241,0.2)]' %>"></div>
      
      <!-- Core Sphere (Glassmorphism) -->
      <div class="relative w-full h-full rounded-full border border-white/10 bg-white/[0.05] backdrop-blur-2xl flex flex-col items-center justify-center shadow-inner overflow-hidden">
        <!-- Pulse Animation Inside Core -->
        <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/[0.02] to-transparent animate-shimmer"></div>
        
        <div class="text-center relative z-10">
          <p class="text-[9px] font-black tracking-[0.2em] text-white/40 uppercase mb-1">ì„±ì¥ ë‹¬ì„±ë¥ </p>
          <h2 class="text-5xl font-extralight text-white tracking-tighter tabular-nums">
            <%= progress %><span class="text-sm ml-0.5 opacity-20">%</span>
          </h2>
        </div>

        <!-- Wave effect inside core based on progress -->
        <div class="absolute bottom-0 w-full bg-indigo-500/10 transition-all duration-1000"
             style="height: <%= progress %>%; background-color: <%= progress >= 100 ? 'rgba(16, 185, 129, 0.15)' : 'rgba(79, 70, 229, 0.1)' %>"></div>
      </div>

      <!-- ğŸŒ¸ The Glass Petals (Bloom Aura) -->
      <div class="absolute inset-[-40%] z-0">
        <% display_tasks.each_with_index do |task, i| %>
          <% 
             is_done = task[:completed]
             angle = (360.0 / [display_tasks.size, 1].max) * i
          %>
          <!-- Radial Petal Structure -->
          <div class="absolute inset-0 flex items-center justify-center transition-all duration-1000"
               style="transform: rotate(<%= angle %>deg);">
            
            <!-- The Petal Shape -->
            <div class="relative w-1 h-32 origin-bottom -translate-y-16">
              <!-- Line Connector -->
              <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-[1px] bg-gradient-to-t from-white/10 to-transparent transition-all duration-1000 <%= is_done ? 'h-full from-indigo-500/50' : 'h-1/2' %>"></div>
              
              <!-- The Task Icon (The Tip of the Petal) -->
              <div class="absolute top-0 left-1/2 -translate-x-1/2 transition-all duration-700"
                   style="transform: rotate(-<%= angle %>deg); transition-delay: <%= i * 100 %>ms">
                <div class="relative group/petal">
                   <!-- Aura for completed item -->
                   <% if is_done %>
                     <div class="absolute inset-0 rounded-full bg-white blur-md opacity-20 animate-pulse"></div>
                   <% end %>

                   <div class="w-10 h-10 rounded-2xl flex items-center justify-center transition-all duration-500 <%= is_done ? 'bg-white/10 border border-white/20 shadow-lg scale-110' : 'bg-white/[0.02] border border-white/[0.05] grayscale opacity-20' %>">
                      <span class="text-xl <%= is_done ? 'scale-100' : 'scale-75' %> transition-transform"><%= task[:icon] %></span>
                   </div>
                   
                   <% if is_done %>
                     <div class="absolute -top-1 -right-1 w-3.5 h-3.5 bg-emerald-500 rounded-full flex items-center justify-center shadow-lg border-2 border-[#08070B] animate-pop-in">
                       <svg class="w-1.5 h-1.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="10"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                     </div>
                   <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- ğŸ“Š Subtle Community Footer & Global Avg -->
    <div class="absolute bottom-6 w-full px-8 flex items-center justify-between z-30">
      <!-- âš ï¸ Warning Indicator & Rules Info -->
      <div class="flex items-center gap-1.5 z-40">
        <div class="relative group/warning">
          <% 
            # Current User Penalty Status
            # ìš°ì„  ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ë„˜ê²¨ì¤€ @my_membershipì„ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ê³µì‹ í´ëŸ½ ë©¤ë²„ì‹­ì„ ì°¾ìŒ
            active_membership = local_assigns[:my_membership]
            unless active_membership
              official_club = RoutineClub.official.first
              active_membership = current_user&.routine_club_members&.find_by(routine_club: official_club)
            end
            
            penalty_count = active_membership&.current_month_penalty_count || 0
            is_member = active_membership.present?
          %>
          
          <div class="relative flex items-center gap-1 px-2 py-1.5 rounded-xl backdrop-blur-sm cursor-pointer transition-all duration-300 group-hover/warning:shadow-[0_0_20px_rgba(244,63,94,0.4)]
                      <%= is_member ? 'bg-[#1a0505] border border-rose-500/30 hover:bg-rose-500/10 hover:border-rose-500/60' : 'bg-white/[0.05] border border-white/10 hover:bg-white/10 hover:border-white/20' %>" 
               onclick="document.getElementById('club-rules-modal').classList.remove('hidden')">
            
            <% if is_member && penalty_count > 0 %>
              <!-- Breathing Border Effect (Members Only with warnings) -->
              <div class="absolute inset-0 rounded-xl border border-rose-500/40 animate-pulse z-0"></div>
              
              <!-- Red Pulse Hint for Members with warnings -->
              <div class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-rose-500 rounded-full animate-ping opacity-75 z-20"></div>
              <div class="absolute -top-1 -right-1 w-2.5 h-2.5 bg-rose-500 rounded-full border border-[#08070B] z-20"></div>
            <% end %>

            <% 3.times do |i| %>
              <% is_active = i < penalty_count %>
              <div class="relative z-10 flex items-center justify-center w-5 h-5 rounded transition-all duration-500 <%= is_active ? 'bg-rose-500/20 shadow-[0_0_12px_rgba(244,63,94,0.6)]' : 'bg-white/5 opacity-20' %>">
                <svg class="w-4 h-4 transition-all duration-500 <%= is_active ? 'text-rose-500 scale-110 drop-shadow-[0_0_8px_rgba(244,63,94,0.8)]' : 'text-white' %>" fill="<%= is_active ? 'currentColor' : 'none' %>" stroke="currentColor" viewBox="0 0 24 24" stroke-width="<%= is_active ? '0' : '2.5' %>">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 4H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2zm-7 4v6m0 3h.01" />
                </svg>
              </div>
            <% end %>

            <% unless is_member %>
              <!-- Lock Badge with Red Effect -->
              <div class="absolute -top-2 -right-2 z-10 flex items-center justify-center w-5 h-5 bg-[#1a0505] border border-rose-500/30 rounded-full shadow-[0_0_8px_rgba(244,63,94,0.5)] animate-pulse">
                <svg class="w-2.5 h-2.5 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
              </div>
            <% end %>
          </div>

          <!-- Tooltip -->
          <div class="opacity-0 group-hover/warning:opacity-100 transition-all duration-300 absolute bottom-full left-0 mb-3 px-3 py-2 bg-[#16151D]/95 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl w-max pointer-events-none translate-y-2 group-hover/warning:translate-y-0 text-left z-50">
            <% if is_member %>
              <div class="flex items-center justify-between gap-3 mb-1">
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest">ì´ë²ˆ ë‹¬ ê²½ê³ </p>
                <span class="w-1.5 h-1.5 rounded-full <%= penalty_count >= 1 ? 'bg-amber-500 animate-pulse' : 'bg-slate-700' %>"></span>
              </div>
              <p class="text-xs font-black text-white flex items-center gap-1.5">
                <span class="text-lg text-amber-500"><%= penalty_count %></span>/ 3 <span class="text-[10px] font-bold text-slate-500">ëˆ„ì  ì‹œ ìë™ ì œëª…</span>
              </p>
            <% else %>
              <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">ì‹œìŠ¤í…œ ê´€ë¦¬ ë¯¸ì ìš©</p>
              <p class="text-[10px] font-bold text-slate-400 leading-tight">ë£¨íŒŒ í´ëŸ½ ë©¤ë²„ì—ê²Œë§Œ<br/>ê²½ê³ /ì œëª… ì‹œìŠ¤í…œì´ ì ìš©ë©ë‹ˆë‹¤.</p>
            <% end %>
            <div class="mt-2 pt-2 border-t border-white/5">
              <p class="text-[9px] text-indigo-400 font-bold flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                ëˆŒëŸ¬ì„œ ê·œì • í™•ì¸í•˜ê¸°
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ğŸ“ˆ Global Average Indicator (The Benchmarking) -->
      <div class="flex flex-col items-end gap-1 group/avg">
        <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest leading-none drop-shadow-sm">ì „ì²´ ìœ ì € í‰ê· </p>
        <div class="flex items-baseline gap-1">
          <span class="text-xl font-light text-white tabular-nums tracking-tighter drop-shadow-lg"><%= global_average_progress || 72 %></span>
          <span class="text-[10px] font-black text-indigo-400 group-hover/avg:text-indigo-300 transition-colors">%</span>
        </div>
      </div>
    </div>
  </div>
</div>



<style>
  @keyframes aura-float {
    0%, 100% { transform: translate(0, 0); opacity: 0.1; }
    50% { transform: translate(10px, -10px); opacity: 0.3; }
  }
  .aura-particle { animation: aura-float var(--duration) ease-in-out infinite; animation-delay: var(--delay); }

  @keyframes shimmer {
    0% { transform: translateX(-100%) rotate(45deg); }
    100% { transform: translateX(200%) rotate(45deg); }
  }
  .animate-shimmer { animation: shimmer 4s infinite linear; }

  @keyframes pop-in {
    0% { transform: scale(0); }
    100% { transform: scale(1); }
  }
  .animate-pop-in { animation: pop-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
</style>
