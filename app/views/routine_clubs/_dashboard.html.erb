<div class="space-y-8">
  
  <!-- Stats Overview: Premium Bauhaus Style -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 lg:gap-6">
    <div class="bg-slate-900 rounded-[32px] p-6 lg:p-8 text-white shadow-xl relative overflow-hidden group hover:scale-[1.02] transition-transform">
      <div class="absolute -right-4 -top-4 w-24 h-24 bg-indigo-600/20 rounded-full blur-2xl"></div>
      <p class="text-[10px] font-black text-indigo-300 uppercase tracking-widest mb-3 leading-none">성장 에너지</p>
      <div class="flex items-baseline gap-1">
        <p class="text-3xl lg:text-4xl font-black tracking-tight tabular-nums"><%= @my_membership.growth_points || 0 %></p>
        <p class="text-xs font-bold text-indigo-400">P</p>
      </div>
    </div>

    <div class="bg-white rounded-[32px] p-6 lg:p-8 border border-slate-100 shadow-sm relative overflow-hidden group hover:scale-[1.02] transition-transform">
      <p class="text-[10px] font-black text-purple-400 uppercase tracking-widest mb-3 leading-none">달성률</p>
      <div class="flex items-baseline gap-1">
        <p class="text-3xl lg:text-4xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.achievement_rate.to_i %></p>
        <p class="text-xs font-bold text-slate-400">%</p>
      </div>
      <div class="mt-4 w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 h-full transition-all duration-1000" style="width: <%= @my_membership.achievement_rate.to_i %>%"></div>
      </div>
    </div>
    
    <a href="#attendance-calendar" class="bg-white rounded-[32px] p-6 lg:p-8 border border-slate-100 shadow-sm relative overflow-hidden group hover:scale-[1.02] transition-transform">
      <p class="text-[10px] font-black text-emerald-400 uppercase tracking-widest mb-3 leading-none">출석률</p>
      <div class="flex items-baseline gap-1">
        <p class="text-3xl lg:text-4xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.attendance_rate.to_i %></p>
        <p class="text-xs font-bold text-slate-400">%</p>
      </div>
      <div class="mt-4 w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
        <div class="bg-emerald-500 h-full transition-all duration-1000" style="width: <%= @my_membership.attendance_rate.to_i %>%"></div>
      </div>
    </a>
    
    <div class="bg-white rounded-[32px] p-6 lg:p-8 border border-slate-100 shadow-sm relative overflow-hidden group hover:scale-[1.02] transition-transform cursor-help" 
         title="오늘 분량 면제 & 출석률 70% 보호">
      <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-3 leading-none">휴식권</p>
      <div class="flex items-center justify-between">
        <p class="text-3xl lg:text-4xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.remaining_passes %><span class="text-xs font-bold text-slate-400 ml-1">개</span></p>
        <% if @my_membership.remaining_passes > 0 %>
          <%= button_to use_pass_routine_club_path(@routine_club), method: :post, 
                        class: "px-3 py-1.5 bg-blue-50 text-blue-600 rounded-xl text-[10px] font-black border border-blue-100 hover:bg-blue-600 hover:text-white transition-all", 
                        data: { turbo_confirm: "휴식권을 사용하시겠습니까?" } do %>
             사용
          <% end %>
        <% end %>
      </div>
    </div>
    
    <div class="bg-white rounded-[32px] p-6 lg:p-8 border border-slate-100 shadow-sm relative overflow-hidden group hover:scale-[1.02] transition-transform">
      <p class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-3 leading-none">누적 경고</p>
      <div class="flex items-baseline gap-1">
        <p class="text-3xl lg:text-4xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.penalty_count %></p>
        <p class="text-xs font-bold text-slate-400">회</p>
      </div>
      <div class="absolute -right-2 -bottom-2 text-4xl opacity-5 group-hover:scale-110 transition-transform">⚠️</div>
    </div>
  </div>

  <% days_left = (@my_membership.membership_end_date - Date.current).to_i %>
  <% if days_left.between?(1, 14) %>
    <div class="bg-gradient-to-r from-orange-500 to-pink-500 rounded-[32px] p-8 text-white flex flex-col md:flex-row items-center justify-between gap-6 shadow-xl shadow-orange-200">
       <div class="space-y-1">
          <h3 class="text-2xl font-black">멤버십 만료 안내 ✨</h3>
          <p class="font-bold opacity-90">루파 클럽 멤버십 종료가 <span class="bg-white/20 px-2 py-0.5 rounded text-yellow-300"><%= days_left %>일</span> 남았습니다. 끊김 없는 성장을 위해 연장해 보세요!</p>
       </div>
       <%= link_to "멤버십 기간 연장하기", routine_club_path(@routine_club), class: "px-8 py-4 bg-white text-orange-600 rounded-2xl font-black hover:bg-yellow-100 transition-all text-sm whitespace-nowrap" %>
    </div>
  <% end %>

  <!-- Community Board -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Announcements -->
    <div class="bg-white rounded-[32px] p-8 border border-slate-200 shadow-sm">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-black text-slate-900 flex items-center gap-2">
          <span class="text-2xl">📢</span> 공지사항
        </h2>
        <div class="flex gap-2">
          <% if @is_host || current_user&.admin? %>
            <%= link_to manage_routine_club_path(@routine_club, anchor: "manage-content-community"), class: "text-[10px] font-black bg-indigo-50 text-indigo-600 px-2 py-1 rounded-lg hover:bg-indigo-100 transition-colors" do %>
              공지 등록
            <% end %>
          <% end %>
          <% if @announcements.count > 3 %>
            <button class="text-xs font-bold text-slate-400 hover:text-slate-600 transition-colors">더보기</button>
          <% end %>
        </div>
      </div>
      
      <% if @announcements.any? %>
        <div class="space-y-4">
          <% @announcements.limit(3).each do |notice| %>
            <div class="group cursor-pointer">
              <div class="flex items-center justify-between mb-1">
                <span class="px-2 py-0.5 bg-amber-100 text-amber-700 text-[10px] font-black rounded-lg"><%= notice.created_at.strftime("%m/%d") %></span>
                <span class="text-[10px] font-bold text-slate-300 group-hover:text-amber-500 transition-colors">New</span>
              </div>
              <h3 class="font-bold text-slate-900 group-hover:text-indigo-600 transition-colors line-clamp-1"><%= notice.title %></h3>
              <p class="text-xs text-slate-500 mt-1 line-clamp-2"><%= notice.content %></p>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
          <p class="text-slate-400 font-bold text-sm">등록된 공지사항이 없습니다</p>
        </div>
      <% end %>
    </div>

    <!-- Gatherings -->
    <div class="bg-white rounded-[32px] p-8 border border-slate-200 shadow-sm">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-black text-slate-900 flex items-center gap-2">
          <span class="text-2xl">🎉</span> 다가오는 모임
        </h2>
        <div class="flex gap-2">
          <% if @is_host || current_user&.admin? %>
            <%= link_to manage_routine_club_path(@routine_club, anchor: "manage-content-community"), class: "text-[10px] font-black bg-emerald-50 text-emerald-600 px-2 py-1 rounded-lg hover:bg-emerald-100 transition-colors" do %>
              모임 등록
            <% end %>
          <% end %>
          <% if @gatherings.count > 3 %>
            <button class="text-xs font-bold text-slate-400 hover:text-slate-600 transition-colors">더보기</button>
          <% end %>
        </div>
      </div>
      
      <% if @gatherings.any? %>
        <div class="space-y-3">
          <% @gatherings.limit(3).each do |gathering| %>
            <div class="bg-emerald-50/50 rounded-2xl p-4 border border-emerald-100/50 hover:bg-emerald-50 transition-colors cursor-pointer">
              <div class="flex items-center gap-2 mb-2">
                <span class="px-2 py-0.5 <%= gathering.online? ? 'bg-sky-100 text-sky-600' : 'bg-orange-100 text-orange-600' %> text-[10px] font-black rounded-lg uppercase"><%= gathering.gathering_type == 'online' ? 'ON' : 'OFF' %></span>
                <span class="text-[10px] font-bold text-emerald-600"><%= gathering.gathering_at.strftime("%m/%d %H:%M") %></span>
              </div>
              <h3 class="font-bold text-slate-900 line-clamp-1 mb-1"><%= gathering.title %></h3>
              <div class="flex items-center gap-1 text-[10px] font-bold text-slate-400">
                <span>📍 <%= gathering.location %></span>
                <% if gathering.max_attendees %>
                  <span>·</span>
                  <span>선착순 <%= gathering.max_attendees %>명</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-8 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
          <p class="text-slate-400 font-bold text-sm">예정된 모임이 없습니다</p>
        </div>
      <% end %>
    </div>
  </div>
  <div class="flex flex-col lg:flex-row gap-6 lg:gap-10 items-stretch">
    <!-- Combined Mission Control Panel -->
    <div class="w-full lg:w-[45%] flex flex-col gap-6">
      <div class="bg-slate-900 rounded-[40px] p-8 lg:p-10 shadow-2xl relative overflow-hidden group flex-1 flex flex-col">
        <div class="absolute -right-16 -top-16 w-48 h-48 bg-indigo-600/30 rounded-full blur-[80px]"></div>
        
        <div class="relative z-10 mb-10 flex items-center justify-between">
          <div>
            <h2 class="text-2xl lg:text-3xl font-black text-white tracking-tight italic">오늘의 루틴</h2>
            <p class="text-indigo-300 font-bold text-xs uppercase tracking-widest mt-1">오늘의 정진을 체크하세요</p>
          </div>
          <div class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center text-2xl">⚡</div>
        </div>

        <div class="relative z-10 flex-1 flex flex-col gap-3">
          <% 
            current_wday = Date.current.wday.to_s
            todays_routines = @personal_routines.select { |r| (r.days || []).map(&:to_s).include?(current_wday) }
          %>
          
          <% if todays_routines.any? %>
            <div class="grid grid-cols-1 gap-2.5">
              <% todays_routines.each do |routine| %>
                <% is_done = routine.completed_on?(Date.current) %>
                <%= render 'routine_clubs/dashboard_routine_item', routine: routine, is_done: is_done, selected_date: Date.current %>
              <% end %>
            </div>
          <% else %>
            <div class="flex-1 flex flex-col items-center justify-center py-10 opacity-30">
              <span class="text-5xl mb-4">🏖️</span>
              <p class="text-white font-bold">오늘은 휴식일입니다</p>
            </div>
          <% end %>
        </div>

        <% if todays_routines.any? %>
          <div class="mt-8 pt-6 border-t border-white/5 flex items-center justify-between">
            <div class="flex -space-x-2">
               <% [1,2,3].each do |i| %>
                 <div class="w-6 h-6 rounded-full bg-indigo-500/20 border border-indigo-500/30 flex items-center justify-center text-[10px]">✨</div>
               <% end %>
            </div>
            <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">모두 완료하면 기록이 활성화됩니다</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Right Component: The Daily Record -->
    <div id="rufa-daily-record" class="w-full lg:w-[55%] flex flex-col">
      <%= render 'routine_clubs/daily_record_area' %>
    </div>
  </div>

  <!-- Recent Activity Feed -->
  <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm">
    <h2 class="text-2xl font-black text-slate-900 mb-6">최근 활동</h2>
    
    <% recent_attendances = @routine_club.attendances.includes(routine_club_member: :user).recent.limit(10) %>
    <% if recent_attendances.any? %>
      <div class="space-y-4">
        <% recent_attendances.each do |attendance| %>
          <div class="bg-slate-50 rounded-2xl p-6 flex items-start gap-4">
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white font-black flex-shrink-0">
              <%= attendance.routine_club_member.user.nickname[0].upcase %>
            </div>
            
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <p class="font-black text-slate-900"><%= attendance.routine_club_member.user.nickname %></p>
                <span class="text-xs font-bold text-slate-400">
                  <%= time_ago_in_words(attendance.created_at) %> 전
                </span>
              </div>
              
              <% if attendance.proof_text.present? %>
                <p class="text-sm text-slate-600 font-medium mb-3">
                  <%= attendance.proof_text %>
                </p>
              <% end %>
              
              <div class="flex items-center gap-3">
                <button class="flex items-center gap-1 px-3 py-1.5 bg-white border border-orange-200 rounded-lg hover:border-orange-400 transition-colors">
                  <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
                  </svg>
                  <span class="text-xs font-black text-slate-700"><%= attendance.cheers_count %></span>
                </button>
                
                <span class="text-xs font-bold text-slate-400">
                  <%= attendance.attendance_date.strftime("%m/%d") %>
                </span>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="bg-slate-50 rounded-3xl p-12 text-center">
        <div class="text-4xl mb-3 opacity-30">📊</div>
        <p class="text-slate-400 font-bold">아직 활동 기록이 없습니다</p>
      </div>
    <% end %>
  </div>

  <!-- Attendance Calendar -->
  <div id="attendance-calendar" class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm scroll-mt-24">
    <h2 class="text-2xl font-black text-slate-900 mb-6">출석 캘린더</h2>
    
    <div class="grid grid-cols-7 gap-2">
      <% ['일', '월', '화', '수', '목', '금', '토'].each do |day| %>
        <div class="text-center text-xs font-black text-slate-400 uppercase tracking-widest py-2">
          <%= day %>
        </div>
      <% end %>
      
      <% 
        start_date = @routine_club.start_date
        end_date = [Date.current, @routine_club.end_date].min
        calendar_start = start_date.beginning_of_week(:sunday)
        calendar_end = end_date.end_of_week(:sunday)
        
        my_attendances = @my_membership.attendances.pluck(:attendance_date, :status).to_h
      %>
      
      <% (calendar_start..calendar_end).each do |date| %>
        <% 
          is_in_range = date >= start_date && date <= end_date
          attendance_status = my_attendances[date]
          
          bg_class = if !is_in_range
            "bg-slate-50"
          elsif attendance_status == "present"
            "bg-emerald-500"
          elsif attendance_status == "absent"
            "bg-slate-400"
          elsif attendance_status == "excused"
            "bg-amber-300"
          elsif date < Date.current
            "bg-slate-200"
          else
            "bg-slate-50"
          end
        %>
        
        <div class="aspect-square <%= bg_class %> rounded-lg flex items-center justify-center text-xs font-bold <%= is_in_range ? 'text-white' : 'text-slate-300' %> transition-all hover:ring-2 ring-indigo-300"
             title="<%= date.strftime('%Y-%m-%d') %>">
          <%= date.day %>
        </div>
      <% end %>
    </div>
    
    <div class="flex items-center justify-center gap-6 mt-6 pt-6 border-t border-slate-100">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-emerald-500 rounded"></div>
        <span class="text-xs font-bold text-slate-600">출석</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-slate-400 rounded"></div>
        <span class="text-xs font-bold text-slate-600">결석</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-amber-300 rounded"></div>
        <span class="text-xs font-bold text-slate-600">사유</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 bg-slate-200 rounded"></div>
        <span class="text-xs font-bold text-slate-600">미출석</span>
      </div>
    </div>
  </div>

  <!-- Weekly Reports -->
  <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm">
    <h2 class="text-2xl font-black text-slate-900 mb-6">주간 리포트</h2>
    
    <% reports = RoutineClubReport.where(routine_club: @routine_club, user: current_user).order(start_date: :desc).limit(5) %>
    <% if reports.any? %>
      <div class="space-y-4">
        <% reports.each do |report| %>
          <div class="bg-slate-50 border border-slate-200 rounded-3xl p-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
              <div>
                <span class="inline-block px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full text-xs font-black mb-2">
                  <%= report.report_type == 'weekly' ? '주간' : '월간' %> 리포트
                </span>
                <h3 class="text-lg font-black text-slate-900">
                  <%= report.start_date.strftime("%m월 %d일") %> - <%= report.end_date.strftime("%m월 %d일") %>
                </h3>
              </div>
              <div class="text-right">
                <p class="text-sm font-bold text-slate-500">출석률</p>
                <p class="text-2xl font-black text-indigo-600"><%= report.attendance_rate.to_i %>%</p>
              </div>
            </div>
            
            <p class="text-slate-700 font-medium mb-3">
              <%= report.summary %>
            </p>
            
            <div class="bg-white rounded-xl p-4 border border-slate-100 flex items-center gap-3">
              <div class="text-2xl">💌</div>
              <p class="text-indigo-600 font-bold text-sm">
                <%= report.cheering_message %>
              </p>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="bg-slate-50 rounded-3xl p-12 text-center">
        <div class="text-4xl mb-3 opacity-30">📈</div>
        <p class="text-slate-400 font-bold">아직 생성된 리포트가 없습니다</p>
        <p class="text-xs text-slate-400 mt-2">매주 월요일에 지난주 활동 리포트가 발행됩니다</p>
      </div>
    <% end %>
  </div>

</div>
