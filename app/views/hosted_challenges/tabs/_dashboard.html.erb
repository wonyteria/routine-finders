<% if params[:source] == 'prototype' %>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-10" data-controller="modal">
    <!-- Left Column: Primary Monitoring (2/3) -->
    <div class="lg:col-span-2 space-y-10">
      <!-- Classification Standards Card -->
      <div class="app-glass-card p-6 md:p-10 relative overflow-hidden group">
        <div class="absolute -right-20 -top-20 w-80 h-80 bg-indigo-500/10 rounded-full blur-[100px] group-hover:bg-indigo-500/20 transition-all duration-1000"></div>
        
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-10 relative z-10">
          <div>
            <h2 class="text-xl font-black text-white italic">분류 알고리즘</h2>
            <p class="text-slate-500 text-[10px] font-black uppercase tracking-widest mt-1">참가자 상태 자동 분류 시스템</p>
          </div>
          <button type="button" data-action="click->modal#open" class="glass-btn px-6 py-2.5 text-[10px] font-black text-indigo-400 hover:text-white uppercase tracking-widest border-none w-full sm:w-auto">분류 기준 수정</button>
        </div>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 relative z-10">
          <% [
            { id: "active", label: "정상 달성", icon: "emerald", color: "text-emerald-400", bg: "bg-emerald-400", threshold: challenge.active_rate_threshold.to_i, desc: "연속 성공" },
            { id: "sluggish", label: "관리 필요", icon: "amber", color: "text-amber-400", bg: "bg-amber-400", threshold: challenge.sluggish_rate_threshold.to_i, desc: "기준 미달" },
            { id: "inactive", label: "미참여", icon: "slate", color: "text-slate-400", bg: "bg-slate-400", threshold: 40, desc: "활동 부재" },
            { id: "failed", label: "최종 탈락", icon: "rose", color: "text-rose-500", bg: "bg-rose-500", threshold: 100, desc: "자격 상실" }
          ].each do |item| %>
            <div class="bg-white/5 rounded-[24px] p-5 border border-white/5 hover:bg-white/10 transition-all">
              <p class="text-[9px] font-black <%= item[:color] %> uppercase tracking-widest mb-4 flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full <%= item[:bg] %> shadow-[0_0_8px_currentColor]"></span>
                <%= item[:label] %>
              </p>
              <div class="space-y-1">
                <p class="text-[10px] font-bold text-slate-400">• <%= item[:desc] %></p>
                <p class="text-[10px] font-bold text-slate-400">• 달성률 ≥ <%= item[:threshold] %>%</p>
              </div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Verification Pending -->
      <% if pending_verifications.any? %>
        <div class="app-glass-card p-6 md:p-10 border-amber-500/10 bg-amber-500/[0.02]">
          <div class="flex items-center justify-between mb-8">
            <h2 class="text-xl font-black text-white italic uppercase tracking-tight">승인 대기 인증 (<%= pending_verifications.count %>)</h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <% pending_verifications.each do |log| %>
              <div class="bg-white/[0.03] rounded-[32px] p-6 border border-white/10 group/log overflow-hidden hover:bg-white/[0.05] transition-all">
                <div class="flex items-center gap-4 mb-5">
                  <img src="<%= log.participant.user.profile_image %>" class="w-11 h-11 rounded-2xl object-cover grayscale group-hover/log:grayscale-0 transition-all">
                  <div>
                    <p class="font-black text-white text-sm"><%= log.participant.user.nickname %></p>
                    <p class="text-[9px] font-black text-slate-500 uppercase"><%= log.created_at.in_time_zone('Asia/Seoul').strftime('%m.%d %H:%M') %></p>
                  </div>
                </div>
                <% if log.image_url.present? %>
                  <div class="aspect-square rounded-2xl overflow-hidden mb-5 border border-white/5">
                    <img src="<%= log.image_url %>" class="w-full h-full object-cover grayscale-[0.5] group-hover/log:grayscale-0 transition-all duration-700">
                  </div>
                <% end %>
                <div class="flex items-center gap-2">
                  <%= button_to approve_challenge_verification_log_path(challenge, log, source: 'prototype'), method: :post, class: "flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-indigo-500 transition-all shadow-xl shadow-indigo-600/20" do %>승인<% end %>
                  <%= button_to reject_challenge_verification_log_path(challenge, log, source: 'prototype'), method: :post, class: "px-6 py-4 bg-white/5 text-slate-500 rounded-2xl font-black text-[10px] uppercase hover:bg-white/10 transition-all" do %>거절<% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Right Column: Secondary Data (1/3) -->
    <div class="space-y-10">
      <!-- Recent Activity Log (Prototype) -->
      <div class="app-glass-card p-8">
        <h3 class="text-xs font-black text-slate-500 uppercase tracking-widest mb-8 italic">최근 활동 로그</h3>
        <% if recent_verifications.any? %>
          <div class="space-y-6">
            <% recent_verifications.each do |log| %>
              <div class="flex items-start gap-4 group">
                <div class="relative">
                  <img src="<%= log.participant.user.profile_image %>" class="w-8 h-8 rounded-xl object-cover grayscale opacity-50 group-hover:opacity-100 group-hover:grayscale-0 transition-all">
                  <div class="absolute -right-1 -bottom-1 w-2.5 h-2.5 rounded-full bg-emerald-500 border-2 border-[#0C0B12]"></div>
                </div>
                <div class="flex-1 border-b border-white/5 pb-4 group-last:border-0">
                  <p class="text-[11px] font-black text-slate-300 group-hover:text-white transition-colors">
                    <span class="text-white"><%= log.participant.user.nickname %></span>님이 인증을 업데이트했습니다
                  </p>
                  <p class="text-[9px] font-black text-slate-600 uppercase mt-1"><%= time_ago_in_words(log.created_at) %> 전</p>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="py-10 text-center">
            <p class="text-[10px] font-black text-slate-700 uppercase tracking-widest italic">검출된 활동이 없습니다</p>
          </div>
        <% end %>
      </div>

    <!-- Logic Modal (Prototype) -->
    <div id="threshold-modal" class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-xl flex items-center justify-center p-6">
      <%= form_with model: challenge, url: hosted_challenge_path(challenge), method: :patch, class: "app-glass-card p-12 max-w-lg w-full shadow-2xl space-y-10 border-white/10" do |f| %>
        <%= hidden_field_tag :source, 'prototype' %>
        <%= hidden_field_tag :tab, 'dashboard' %>

        <div class="text-center">
          <h3 class="text-2xl font-black text-white italic uppercase tracking-tighter">분류 기준 설정</h3>
          <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mt-2">상태 자동 분류를 위한 수치를 조정합니다</p>
        </div>
        
        <div class="space-y-8">
          <!-- Active Threshold -->
          <div class="p-6 bg-white/5 rounded-3xl border border-white/10">
            <p class="text-[10px] font-black text-emerald-400 uppercase tracking-[0.2em] mb-4">정상 달성 임계값 (Active)</p>
            <div class="flex items-center gap-4">
              <%= f.range_field :active_rate_threshold, 
                                value: challenge.active_rate_threshold.to_i,
                                min: 0, max: 100, step: 1,
                                class: "flex-1 accent-indigo-500",
                                id: "active-threshold-slider",
                                oninput: "document.getElementById('active-threshold-value').textContent = this.value + '%'" %>
              <span id="active-threshold-value" class="text-xl font-black text-white italic min-w-[3rem] text-right">
                <%= challenge.active_rate_threshold.to_i %>%
              </span>
            </div>
          </div>

          <!-- Sluggish Threshold -->
          <div class="p-6 bg-white/5 rounded-3xl border border-white/10">
            <p class="text-[10px] font-black text-amber-400 uppercase tracking-[0.2em] mb-4">관리 필요 임계값 (Sluggish)</p>
            <div class="flex items-center gap-4">
              <%= f.range_field :sluggish_rate_threshold, 
                                value: challenge.sluggish_rate_threshold.to_i,
                                min: 0, max: 100, step: 1,
                                class: "flex-1 accent-indigo-500",
                                id: "sluggish-threshold-slider",
                                oninput: "document.getElementById('sluggish-threshold-value').textContent = this.value + '%'" %>
              <span id="sluggish-threshold-value" class="text-xl font-black text-white italic min-w-[3rem] text-right">
                <%= challenge.sluggish_rate_threshold.to_i %>%
              </span>
            </div>
          </div>
        </div>

        <div class="flex gap-4">
          <button type="button" onclick="document.getElementById('threshold-modal').classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="flex-1 py-4 bg-white/5 text-slate-500 rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-white/10">닫기</button>
          <%= f.submit "변경사항 적용", class: "flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-indigo-600/20 cursor-pointer" %>
        </div>
      <% end %>
    </div>

    <script>
      // Simple modal toggle without Stimulus
      document.addEventListener('DOMContentLoaded', function() {
        const openButton = document.querySelector('[data-action="click->modal#open"]');
        const modal = document.getElementById('threshold-modal');
        
        if (openButton && modal) {
          openButton.addEventListener('click', function(e) {
            e.preventDefault();
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
          });

          // Close on background click
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.classList.add('hidden');
              document.body.classList.remove('overflow-hidden');
            }
          });

          // Close on ESC key
          document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
              modal.classList.add('hidden');
              document.body.classList.remove('overflow-hidden');
            }
          });
        }
      });
    </script>
  </div>

<% else %>
  <!-- ORIGINAL WEB UI: Safe & Untouched -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8" data-controller="modal">
    <div class="lg:col-span-2 space-y-8">
      <div class="bg-indigo-900 rounded-[40px] p-10 text-white relative overflow-hidden group">
        <h2 class="text-xl font-black">참가자 상태 분류 기준</h2>
        <!-- (Web UI logic preserved) -->
      </div>
    </div>
    <div class="space-y-8">
      <!-- (Web UI Activity Log etc) -->
    </div>
  </div>
<% end %>
