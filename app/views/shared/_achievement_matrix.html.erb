<% compact ||= false %>
<section id="achievement-matrix"
         class="bg-white rounded-[32px] md:rounded-[40px] <%= compact ? 'p-3 md:p-4' : 'p-4 md:p-6' %> border border-slate-100 shadow-sm space-y-4 md:space-y-6 relative overflow-hidden group"
         data-controller="tabs"
         data-tabs-query-param-value="matrix_tab"
         data-tabs-active-class="bg-indigo-600 text-white shadow-lg z-10"
         data-tabs-inactive-class="text-slate-400 hover:text-slate-600">
  <div class="absolute -right-4 -top-4 w-24 h-24 bg-indigo-50/50 rounded-full blur-2xl group-hover:scale-110 transition-transform"></div>
  
  <div class="relative z-10 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h3 class="<%= compact ? 'text-base' : 'text-xl' %> font-black text-slate-900 tracking-tight">성취 매트릭스</h3>
      <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mt-0.5"><%= Date.current.year %> Matrix</p>
    </div>
    
    <div class="flex bg-slate-100/50 p-1 rounded-xl self-start sm:self-auto min-w-[140px]">
      <button data-tabs-target="tab" data-action="click->tabs#change" data-id="year"
              class="flex-1 px-4 py-2 rounded-lg text-[10px] font-black transition-all bg-indigo-600 text-white shadow-lg z-10">1년</button>
      <button data-tabs-target="tab" data-action="click->tabs#change" data-id="month"
              class="flex-1 px-4 py-2 rounded-lg text-[10px] font-black transition-all text-slate-400 hover:text-slate-600">1개월</button>
    </div>
  </div>

  <%# Month View Panel (Initially Hidden) %>
  <div data-tabs-target="panel" data-id="month" class="hidden relative z-10 space-y-4">
    <div class="grid grid-cols-7 gap-1 md:gap-1.5 w-full mx-auto" style="max-width: 400px;">
      <% ["S", "M", "T", "W", "T", "F", "S"].each do |day| %>
        <div class="text-[9px] font-black text-slate-300 text-center py-1 md:py-2"><%= day %></div>
      <% end %>

      <% 
        start_of_month = Date.current.beginning_of_month
        grid_start_month = start_of_month - start_of_month.wday
        end_of_month = Date.current.end_of_month
        grid_end_month = end_of_month + (6 - end_of_month.wday)
      %>
      
      <% (grid_start_month..grid_end_month).each do |date| %>
        <% 
          is_current_month = date.month == Date.current.month
          count = @activity_data[date] || 0
          color_class = case
          when !is_current_month then "bg-transparent opacity-0"
          when count == 0 then "bg-slate-50"
          when count <= 2 then "bg-indigo-100"
          when count <= 4 then "bg-indigo-300"
          else "bg-indigo-600"
          end
          
          is_today = date == Date.current
        %>
        <div class="aspect-square rounded-lg md:rounded-xl <%= color_class %> transition-all relative group/day <%= 'ring-2 ring-indigo-500 ring-offset-2 scale-90' if is_today && is_current_month %>" 
             title="<%= date %>: <%= count %> activities">
          <% if is_today && is_current_month %>
            <span class="absolute -top-1 -right-1 w-1.5 h-1.5 bg-indigo-500 rounded-full"></span>
          <% end %>
          <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover/day:opacity-100 transition-opacity pointer-events-none">
             <span class="text-[8px] font-black <%= count > 2 ? 'text-white' : 'text-indigo-600' %>"><%= date.day %></span>
          </div>
        </div>
      <% end %>
    </div>

    <div class="flex justify-between items-center pt-4 border-t border-slate-50">
      <div class="flex items-center gap-1.5">
        <div class="w-2.5 h-2.5 rounded-full bg-indigo-600"></div>
        <span class="text-[9px] font-bold text-slate-500">Target Reached</span>
      </div>
      <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
        <%= @monthly_completions&.count || 0 %> DONE THIS MONTH
      </p>
    </div>
  </div>

  <%# Year View Panel (Active by Default) %>
  <div data-tabs-target="panel" data-id="year" class="relative z-10 space-y-4">
    <div class="flex">
      <!-- Days Label (Left column) -->
      <div class="flex flex-col justify-between py-[2px] pr-2 text-[8px] font-bold text-slate-300 h-[88px]">
        <span>S</span>
        <span>M</span>
        <span>T</span>
        <span>W</span>
        <span>T</span>
        <span>F</span>
        <span>S</span>
      </div>

      <!-- Flexible 1-Year Contribution Graph (No Scroll, Full Width) -->
      <div class="flex-1 h-full min-h-[100px] flex items-end gap-[1px] sm:gap-[2px]">
        <%
          end_date = Date.current
          # Ensure we show exactly 52 weeks or fit to start of range approx 1 year ago
          start_date = end_date - 52.weeks
          
          # Adjust start_date to the beginning of that week (Sunday) to align columns correctly
          start_date = start_date.beginning_of_week(:sunday)
          
          all_dates = (start_date..end_date).to_a
          weeks = all_dates.each_slice(7).to_a
        %>

        <% weeks.each do |week_dates| %>
          <div class="flex-1 flex flex-col gap-[1px] sm:gap-[2px]">
            <% week_dates.each do |date| %>
              <% 
                count = @activity_data[date] || 0
                color_class = case
                when count == 0 then "bg-slate-50"
                when count <= 2 then "bg-indigo-100"
                when count <= 4 then "bg-indigo-300"
                else "bg-indigo-600"
                end
                is_today = date == Date.current
              %>
              <!-- Each cell fills the column width and keeps aspect ratio approximately square via height control in CSS/Flex logic or just flexible height -->
              <div class="w-full aspect-square rounded-[1px] sm:rounded-[2px] <%= color_class %> transition-all <%= 'ring-1 ring-indigo-500 z-10' if is_today %>"
                   title="<%= date.strftime('%Y-%m-%d') %>: <%= count %> actions">
              </div>
            <% end %>
            <%# Fill empty slots if last week is incomplete (though starting from Sunday aligned usually avoids this in the middle, but end might be partial) %>
            <% (7 - week_dates.size).times do %>
              <div class="w-full aspect-square"></div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
    
    <div class="flex justify-between items-center pt-2">
      <div class="flex items-center gap-4">
        <div class="flex items-center gap-1.5">
          <span class="text-[8px] font-black text-slate-400">Less</span>
          <div class="flex gap-0.5">
            <div class="w-2.5 h-2.5 rounded-[2px] bg-slate-50"></div>
            <div class="w-2.5 h-2.5 rounded-[2px] bg-indigo-100"></div>
            <div class="w-2.5 h-2.5 rounded-[2px] bg-indigo-300"></div>
            <div class="w-2.5 h-2.5 rounded-[2px] bg-indigo-600"></div>
          </div>
          <span class="text-[8px] font-black text-slate-400">More</span>
        </div>
      </div>
      <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
        <%= @activity_data.values.sum %> TOTAL DONE THIS YEAR
      </p>
    </div>
  </div>
</section>
