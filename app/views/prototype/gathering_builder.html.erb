<% content_for :hide_nav, true %>

<div class="h-[100dvh] flex flex-col pt-2 bg-[#07060A] overflow-hidden select-none relative">
  <!-- Dynamic Aurora Background Glow -->
  <div id="aurora-glow" class="fixed -top-32 -left-32 w-[150%] h-[150%] bg-[#10B981]/10 blur-[130px] rounded-full pointer-events-none transition-all duration-1000 z-0"></div>
  <div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[80%] h-[80%] bg-[#34D399]/5 blur-[160px] rounded-full pointer-events-none z-0"></div>

  <style>
    /* Step Animation */
    .step-section {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      display: none;
    }
    .step-section.active {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }
    /* Premium Selection & Theme */
    .premium-selection {
      border-color: #818cf8 !important;
      background: rgba(99, 102, 241, 0.2) !important;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.4), inset 0 0 10px rgba(99, 102, 241, 0.2) !important;
      transform: scale(1.02);
      z-index: 5;
    }
    .selected-cat {
      background: #FFFFFF !important;
      color: #0C0B12 !important;
      border: none !important;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3) !important;
      transform: translateY(-2px);
      z-index: 5;
    }
    .unselected-opt {
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
      opacity: 0.5;
      z-index: 1;
    }
    .glass-input {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 1.25rem;
      color: #ffffff !important;
      font-weight: 700;
      transition: all 0.3s ease;
      -webkit-appearance: none;
      appearance: none;
    }
    .glass-input::placeholder {
      color: rgba(255, 255, 255, 0.4) !important;
      font-weight: 500;
    }
    .glass-input:focus {
      background: rgba(255, 255, 255, 0.12);
      border-color: #818cf8;
      box-shadow: 0 0 15px rgba(129, 140, 248, 0.3);
      outline: none;
    }
    function previewImage(input, previewId) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById(previewId);
          preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
          preview.classList.remove('bg-white/5', 'border-dashed');
          preview.classList.add('border-solid', 'border-emerald-500/20');
        }
        reader.readAsDataURL(input.files[0]);
      }
    }

    /* Stepper Dots */
    .step-dot {
      height: 4px;
      border-radius: 2px;
      transition: all 0.5s ease;
    }
    .active-dot {
      background: #818cf8;
      width: 24px;
      box-shadow: 0 0 10px #818cf8;
    }
    .completed-dot { background: #818cf8; width: 8px; opacity: 0.5; }
    .pending-dot { background: rgba(255, 255, 255, 0.1); width: 8px; }

    .hide-scrollbar::-webkit-scrollbar { display: none; }

    /* Custom Checkbox/Toggle */
    .toggle-pill {
      position: relative;
      width: 52px;
      height: 28px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      display: flex;
      items-center: center;
    }
    .toggle-pill::after {
      content: 'OFF';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 8px;
      font-weight: 900;
      color: rgba(255,255,255,0.4);
      letter-spacing: 0.05em;
    }
    .toggle-pill.active { background: #818cf8; box-shadow: 0 0 15px rgba(129, 140, 248, 0.4); }
    .toggle-pill.active::after {
      content: 'ON';
      left: 10px;
      right: auto;
      color: white;
    }
    .toggle-circle {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle-pill.active .toggle-circle { left: 28px; }
  </style>

  <!-- Header & Stepper -->
  <header class="flex items-center justify-between mb-2 px-8 shrink-0 z-20">
    <button id="prevBtn" class="w-10 h-10 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 active:scale-90 transition-all">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
    </button>
    <div class="flex gap-1.5 h-1 px-4 flex-1 max-w-[150px] justify-center">
      <% 5.times do |i| %>
        <div class="step-dot pending-dot"></div>
      <% end %>
    </div>
    <div class="w-10 flex items-center justify-end">
       <span id="stepCounter" class="text-[10px] font-black text-indigo-400">1/5</span>
    </div>
  </header>

  <%= form_with model: @gathering, url: challenges_path(source: 'prototype'), class: "flex-1 flex flex-col px-8 min-h-0 relative" do |f| %>
    <%= f.hidden_field :cost_type, id: 'h_cost_type' %>
    <%= f.hidden_field :admission_type, id: 'h_admission' %>
    <%= f.hidden_field :end_date, id: 'h_end_date' %>
    <%= f.hidden_field :mode, value: 'offline', id: 'h_mode' %>
    <%= f.hidden_field :meeting_type, id: 'h_meeting_type' %>
    <%= f.hidden_field :category, id: 'h_category' %>
    <%= f.hidden_field :requires_application_message, id: "h_requires_msg" %>

    <div class="flex-1 min-h-0 py-4 flex flex-col relative z-10 overflow-y-auto hide-scrollbar pb-10">
      
      <!-- STEP 1: Core Info -->
      <section id="step-0" class="step-section flex-1 flex flex-col gap-6">
        <div class="space-y-1">
          <h2 class="text-xl font-black text-white tracking-tighter leading-tight">ì–´ë–¤ <span class="bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">ëª¨ì„</span>ì„ ë§Œë“¤ì–´ë³¼ê¹Œìš”?</h2>
        </div>

        <div class="space-y-6">
           <!-- 1. Type Selection & Category -->
           <div class="space-y-4">
             <div class="grid grid-cols-2 gap-3 p-1 overflow-visible">
               <button type="button" data-val="single" class="type-opt p-4 rounded-2xl border flex flex-col items-center gap-2 transition-all premium-selection">
                 <span class="text-2xl">ğŸ—“ï¸</span>
                 <span class="text-sm font-black text-white">ì›ë°ì´ ëª¨ì„</span>
                 <span class="text-[9px] font-bold text-slate-400">1íšŒì„± ë§Œë‚¨</span>
               </button>
               <button type="button" data-val="regular" class="type-opt p-4 rounded-2xl border flex flex-col items-center gap-2 transition-all unselected-opt">
                 <span class="text-2xl">ğŸ”„</span>
                 <span class="text-sm font-black text-white">ì •ê¸° ëª¨ì„</span>
                 <span class="text-[9px] font-bold text-slate-400">ì§€ì†ì  ë§Œë‚¨</span>
               </button>
             </div>
             
             <!-- Category Selection -->
             <div class="space-y-2 p-1 overflow-visible">
               <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Category</label>
               <div class="grid grid-cols-3 gap-2">
                 <% @categories.each do |cat| %>
                   <button type="button" data-val="<%= cat[:key] %>" class="cat-opt p-3 rounded-xl border flex flex-col items-center gap-1 transition-all <%= cat[:key] == 'HOBBY' ? 'selected-cat' : 'unselected-opt' %>">
                     <span class="text-xl"><%= cat[:icon] %></span>
                     <span class="text-[10px] font-black"><%= cat[:label] %></span>
                   </button>
                 <% end %>
               </div>
             </div>
           </div>

            <!-- 2. Basic Details -->
            <div class="space-y-4 pt-4 border-t border-white/5">
              <div class="space-y-2 p-1 overflow-visible">
                <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Meetup Title</label>
                <%= f.text_field :title, class: "glass-input w-full p-4 text-base focus:scale-[1.01]", placeholder: "ì˜ˆ: ê°•ë‚¨ì—­ ì•„ì¹¨ ì¹´í˜ ë…ì„œ ëª¨ì„" %>
              </div>

              <div class="space-y-2 p-1 overflow-visible">
                <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">One-line Summary</label>
                <%= f.text_field :summary, class: "glass-input w-full p-4 text-sm focus:scale-[1.01]", placeholder: "ëª¨ì„ì„ í•œ ë§ˆë””ë¡œ ì†Œê°œí•´ì£¼ì„¸ìš”." %>
              </div>

              <div class="space-y-2 p-1 overflow-visible">
                <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Description</label>
                <%= f.text_area :description, class: "glass-input w-full p-6 text-sm min-h-[140px] leading-relaxed focus:scale-[1.01]", placeholder: "ëª¨ì„ì˜ ëª©ì , ë¶„ìœ„ê¸°, ì§„í–‰ ë°©ì‹ ë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì„¸ìš”." %>
              </div>

              <div class="space-y-2 p-1 overflow-visible">
                <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Preparation & Notice (ì¤€ë¹„ë¬¼/ê³µì§€)</label>
                <%= f.text_area :preparation_items, class: "glass-input w-full p-5 text-sm min-h-[100px] leading-relaxed focus:scale-[1.01]", placeholder: "ì°¸ì—¬ìê°€ ë¯¸ë¦¬ ì¤€ë¹„í•´ì•¼ í•  ë¬¼ê±´ì´ë‚˜ ê¼­ ì•Œì•„ì•¼ í•  ìœ ì˜ì‚¬í•­ì´ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”." %>
              </div>

              <div class="space-y-3 p-1 overflow-visible">
                <div class="flex justify-between items-end pl-1">
                  <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest">Thumbnail Cover</label>
                  <span class="text-[9px] font-bold text-emerald-400/60">ê¶Œì¥ ì‚¬ì´ì¦ˆ: 1280 x 720px</span>
                </div>
                
                <div class="relative group cursor-pointer" onclick="document.getElementById('challenge_thumbnail_image').click()">
                  <div id="thumbnail_preview" class="aspect-[16/9] w-full rounded-2xl bg-white/5 border-2 border-dashed border-white/10 flex flex-col items-center justify-center gap-3 group-hover:bg-white/[0.08] group-hover:border-emerald-500/30 transition-all overflow-hidden relative">
                    <div class="w-12 h-12 rounded-full bg-white/5 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">ğŸ–¼ï¸</div>
                    <div class="text-center px-4">
                      <p class="text-[11px] font-black text-white group-hover:text-emerald-400 transition-colors">í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ</p>
                      <p class="text-[9px] font-bold text-slate-600 mt-1 uppercase">JPG, PNG (Max 5MB)</p>
                    </div>
                  </div>
                  <%= f.file_field :thumbnail_image, class: "hidden", onchange: "previewImage(this, 'thumbnail_preview')" %>
                </div>

                <div class="flex items-start gap-2 px-2 mt-2">
                  <span class="text-xs">ğŸ’¡</span>
                  <p class="text-[10px] font-bold text-slate-500 leading-relaxed">
                    ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì§€ ì•Šìœ¼ë©´ ê³ ë¥¸ <span class="text-emerald-400">ì¹´í…Œê³ ë¦¬ì— ë§ëŠ” ê¸°ë³¸ ì»¤ë²„</span>ê°€ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.
                  </p>
                </div>
              </div>
            </div>
           </div>
        </div>
      </section>

      <!-- STEP 2: Time & Place -->
      <section id="step-1" class="step-section hidden flex-1 flex flex-col gap-6">
        <div class="space-y-1">
          <h2 class="text-2xl font-black text-white tracking-tight leading-tight">ì–¸ì œ, ì–´ë””ì„œ <span class="text-emerald-500">ë§Œë‚ ê¹Œìš”?</span></h2>
        </div>
        <div class="space-y-6">
           <!-- Mode Selection -->
           <div class="grid grid-cols-2 gap-3 p-1 overflow-visible">
             <button type="button" data-val="offline" class="mode-opt p-4 rounded-2xl border flex flex-col items-center gap-2 transition-all premium-selection">
               <span class="text-2xl">ğŸƒ</span>
               <span class="text-sm font-black text-white">ì˜¤í”„ë¼ì¸ ëª¨ì„</span>
             </button>
             <button type="button" data-val="online" class="mode-opt p-4 rounded-2xl border flex flex-col items-center gap-2 transition-all unselected-opt">
               <span class="text-2xl">ğŸ’»</span>
               <span class="text-sm font-black text-white">ì˜¨ë¼ì¸ ëª¨ì„</span>
             </button>
           </div>

           <div class="grid grid-cols-2 gap-3 p-1">
             <div class="space-y-2">
               <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Meeting Date</label>
               <%= f.date_field :start_date, value: Date.current + 7.days, onclick: "this.showPicker()", class: "glass-input w-full p-4 text-xs" %>
             </div>
             <div class="space-y-2">
               <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Start Time</label>
               <%= f.fields_for :meeting_info do |m| %>
                 <%= m.time_field :meeting_time, class: "glass-input w-full p-4 text-xs", onclick: "this.showPicker()", value: "14:00" %>
               <% end %>
             </div>
           </div>

           <!-- Recruitment Period -->
           <div class="space-y-3 p-4 bg-emerald-500/5 border border-emerald-500/10 rounded-2xl">
              <label class="text-[9px] font-black text-emerald-500 uppercase tracking-widest">Recruitment Period (ëª¨ì§‘ ê¸°ê°„)</label>
              <div class="flex gap-2 items-center">
                <%= f.date_field :recruitment_start_date, value: Date.current, onclick: "this.showPicker()", class: "glass-input flex-1 p-3 text-[10px]" %>
                <span class="text-slate-700 text-xs">~</span>
                <%= f.date_field :recruitment_end_date, value: Date.current + 6.days, onclick: "this.showPicker()", class: "glass-input flex-1 p-3 text-[10px]" %>
              </div>
              <p class="text-[8px] font-bold text-slate-600 pl-1 mt-1">ëª¨ì§‘ì´ ì¢…ë£Œë˜ë©´ ë” ì´ìƒ ì‹ ì²­ì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
           </div>
           
           <div class="space-y-4">
             <%= f.fields_for :meeting_info do |m| %>
               <div class="space-y-2 p-1 overflow-visible">
                 <label id="lbl_place_name" class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Place Name</label>
                 <%= m.text_field :place_name, class: "glass-input w-full p-4 text-sm focus:scale-[1.01]", placeholder: "ì˜ˆ: íˆ¬ì¸í”Œë ˆì´ìŠ¤ ê°•ë‚¨ëŒ€ë¡œì " %>
               </div>
               <div id="div_address" class="space-y-2 p-1 overflow-visible">
                 <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Address</label>
                 <%= m.text_field :address, class: "glass-input w-full p-4 text-sm focus:scale-[1.01]", placeholder: "ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”" %>
               </div>
               <div id="div_place_url" class="space-y-2 p-1 overflow-visible">
                 <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Detailed Place URL (Optional)</label>
                 <%= m.text_field :place_url, class: "glass-input w-full p-4 text-xs focus:scale-[1.01]", placeholder: "ë„¤ì´ë²„/ì¹´ì¹´ì˜¤ ì§€ë„ ê³µìœ  ë§í¬" %>
               </div>
             <% end %>
             
             <div class="space-y-2 p-1 overflow-visible">
               <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Chat Link (Optional)</label>
               <%= f.text_field :chat_link, class: "glass-input w-full p-4 text-xs focus:scale-[1.01]", placeholder: "ì¹´ì¹´ì˜¤í†¡ ì˜¤í”ˆì±„íŒ…ë°© ë§í¬ ë“±" %>
             </div>
           </div>
        </div>
      </section>

      <!-- STEP 3: Participation & Cost -->
      <section id="step-2" class="step-section hidden flex-1 flex flex-col gap-6">
        <div class="space-y-1">
          <h2 class="text-xl font-black text-white tracking-tighter leading-tight">ì°¸ì—¬ <span class="text-emerald-500">ì¸ì›ê³¼ ë¹„ìš©</span>ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.</h2>
        </div>
        <div class="space-y-6">
           <div class="space-y-3 p-1">
             <div class="flex justify-between items-center px-1">
               <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest">Max Attendees</label>
               <span id="max_val" class="text-emerald-400 font-black text-base">4ëª…</span>
             </div>
             <%= f.fields_for :meeting_info do |m| %>
               <%= m.range_field :max_attendees, min: 2, max: 50, step: 1, value: 4, id: "max_slider", class: "w-full h-1.5 bg-white/10 rounded-full appearance-none accent-emerald-500" %>
             <% end %>
           </div>

            <div class="grid grid-cols-2 gap-4 p-1 overflow-visible">
              <button type="button" data-val="first_come" class="admission-opt p-4 rounded-xl border font-black text-sm transition-all unselected-opt">ì„ ì°©ìˆœ ì…ì¥</button>
              <button type="button" data-val="approval" class="admission-opt p-4 rounded-xl border font-black text-sm transition-all premium-selection">í˜¸ìŠ¤íŠ¸ ìŠ¹ì¸ì œ</button>
            </div>

            <!-- Priority Access Info (New) -->
            <div class="p-5 rounded-[28px] bg-emerald-500/10 border border-emerald-500/20 space-y-3 relative overflow-hidden group">
              <div class="absolute -right-4 -top-4 w-16 h-16 bg-emerald-500/10 blur-xl"></div>
              <div class="flex items-center gap-2 text-emerald-400">
                <span class="text-sm">ğŸ”±</span>
                <p class="text-[10px] font-black uppercase tracking-widest">Premium Priority Access</p>
              </div>
              <p class="text-[10px] font-bold text-slate-400 leading-relaxed">
                ëª¨ë“  ëª¨ì„ì€ <span class="text-white">ë£¨íŒŒ í´ëŸ½ ë©¤ë²„ë“¤ì—ê²Œ 1ì‹œê°„ ìš°ì„  ì°¸ì—¬ê¶Œ</span>ì´ ë¶€ì—¬ë©ë‹ˆë‹¤. ì¸ê¸° ìˆëŠ” ëª¨ì„ì˜ ê²½ìš°, ê²€ì¦ëœ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ë“¤ì„ ë¨¼ì € í™•ë³´í•˜ëŠ” ë° ìœ ë¦¬í•©ë‹ˆë‹¤.
              </p>
            </div>

           <div class="space-y-4">
              <div class="grid grid-cols-2 gap-2 p-1 overflow-visible">
                <button type="button" data-val="free" class="cost-opt py-4 rounded-2xl border transition-all flex flex-col items-center gap-1 selected-cat">
                  <span class="text-xs font-black">ë¬´ë£Œ ëª¨ì„</span>
                </button>
                <button type="button" data-val="fee" class="cost-opt py-4 rounded-2xl border transition-all flex flex-col items-center gap-1 unselected-opt">
                  <span class="text-xs font-black">ìœ ë£Œ ëª¨ì„</span>
                </button>
              </div>

              <!-- Participation Restriction (New) -->
              <div class="pt-4 border-t border-white/5 space-y-4 p-1 overflow-visible">
                <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Participation Restriction</label>
                <div class="p-5 bg-indigo-500/5 border border-indigo-500/10 rounded-2xl flex items-center justify-between group/premium cursor-pointer active:scale-[0.98] transition-all" id="btn_rufa_only">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center text-xl">âš¡</div>
                    <div>
                      <p class="text-[11px] font-black text-white">ë£¨íŒŒí´ëŸ½ ì „ìš©</p>
                      <p class="text-[9px] font-bold text-indigo-400/60 mt-0.5">ë©¤ë²„ì‹­ íšŒì›ë“¤ë§Œ ì°¸ì—¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                    </div>
                  </div>
                  <div class="toggle-pill" id="toggle_rufa_only">
                    <div class="toggle-circle"></div>
                  </div>
                  <%= f.hidden_field :for_rufa_club_members_only, id: "h_rufa_only", value: "false" %>
                </div>
              </div>

              <div id="cost_box" class="hidden space-y-4 animate-fade-in">
                <div class="relative p-1 overflow-visible">
                  <%= f.hidden_field :amount, value: 10000, id: "h_amount" %>
                  <input type="text" id="amount_display" value="10,000" class="glass-input w-full p-4 text-2xl text-right pr-12 focus:scale-[1.01]" placeholder="0" />
                  <span class="absolute right-5 top-1/2 -translate-y-1/2 text-slate-500 font-bold">ì›</span>
                </div>
                
                <div class="space-y-4 p-1 overflow-visible">
                  <div class="space-y-2">
                    <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Settlement Account (ì •ì‚° ê³„ì¢Œ)</label>
                    <div class="grid grid-cols-4 gap-2">
                      <% default_bank = @gathering.host_bank || current_user.saved_bank_name || 'ì‹ í•œ' %>
                      <% @banks.each do |bank| %>
                        <button type="button" class="bank-opt py-2 rounded-lg border text-[9px] font-black transition-all <%= bank == default_bank ? 'selected-cat' : 'unselected-opt' %>" data-val="<%= bank %>"><%= bank %></button>
                      <% end %>
                      <%= f.hidden_field :host_bank, id: "h_bank", value: default_bank %>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <%= f.text_field :host_account_holder, class: "glass-input w-full p-4 text-xs focus:scale-[1.01]", placeholder: "ì˜ˆê¸ˆì£¼ ì„±í•¨" %>
                    <%= f.text_field :host_account, class: "glass-input w-full p-4 text-xs focus:scale-[1.01]", placeholder: "ê³„ì¢Œë²ˆí˜¸ (- ì—†ì´)" %>
                  </div>
                </div>

                <div class="space-y-2 p-1 pt-2 border-t border-white/5">
                  <label class="text-[10px] font-black text-slate-600 uppercase tracking-widest pl-1">Refund Policy (í™˜ë¶ˆ ì •ì±…)</label>
                  <%= f.text_area :refund_policy, class: "glass-input w-full p-4 text-[11px] min-h-[80px] leading-relaxed", placeholder: "ì˜ˆ: ëª¨ì„ 3ì¼ ì „ 100% í™˜ë¶ˆ, ì´í›„ í™˜ë¶ˆ ë¶ˆê°€ ë“±ì˜ ê¸°ì¤€ì„ ì ì–´ì£¼ì„¸ìš”." %>
                </div>
              </div>
           </div>
        </div>
      </section>

      <!-- STEP 4: Participant Information (NEW) -->
      <section id="step-3" class="step-section hidden flex-1 flex flex-col gap-6">
        <div class="space-y-1">
          <h2 class="text-xl font-black text-white tracking-tighter leading-tight">ì°¸ì—¬ìì—ê²Œ <span class="bg-gradient-to-r from-emerald-400 to-teal-400 bg-clip-text text-transparent">ë”°ë¡œ ë¬¼ì–´ë³¼ ì •ë³´</span>ê°€ ìˆìœ¼ì‹ ê°€ìš”?</h2>
        </div>
        <div class="space-y-6">
           <div class="p-6 bg-white/5 rounded-[32px] border border-white/5 space-y-5">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-[11px] font-black text-white">ì¶”ê°€ ì§ˆë¬¸ í™œì„±í™”</p>
                  <p class="text-[9px] font-bold text-slate-500 mt-0.5">ì°¸ì—¬ìê°€ ì‹ ì²­í•  ë•Œ ë‹µë³€í•´ì•¼ í•  ì§ˆë¬¸</p>
                </div>
                <div class="toggle-pill cursor-pointer" id="toggle_participant_info">
                  <div class="toggle-circle"></div>
                </div>
              </div>
              
              <div id="participant_question_box" class="hidden space-y-3 pt-2 border-t border-white/5">
                <%= f.hidden_field :application_questions, id: 'h_app_questions', value: "[]" %>
                
                <div id="questions_list" class="space-y-3">
                  <!-- Dynamic questions will be added here via JS -->
                </div>
                
                <button type="button" id="add_question_btn" class="w-full py-3.5 rounded-2xl border border-dashed border-white/10 text-slate-500 font-bold text-xs hover:border-emerald-500/40 hover:text-emerald-400 hover:bg-emerald-500/5 transition-all flex items-center justify-center gap-2 group mt-2">
                  <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
                  ì§ˆë¬¸ ì¶”ê°€í•˜ê¸°
                </button>
                <p class="text-[9px] font-bold text-slate-500 pl-1">ì§ˆë¬¸ì„ ì¶”ê°€í•˜ë©´ ì‹ ì²­ìê°€ ê° ì§ˆë¬¸ì— ëŒ€í•´ ë‹µë³€ì„ ì‘ì„±í•˜ê²Œ ë©ë‹ˆë‹¤.</p>
              </div>
           </div>

           <div class="space-y-3">
             <div class="p-5 bg-white/5 border border-white/5 rounded-2xl flex items-start gap-3">
                <span class="text-xl">ğŸ“‹</span>
                <div class="space-y-1">
                  <p class="text-[10px] font-black text-slate-300">í”Œë«í¼ì´ ëŒ€ì‹  ë°›ì•„ë“œë¦¬ëŠ” ì •ë³´</p>
                  <p class="text-[9px] font-bold text-slate-500 leading-relaxed">
                    ë‹¤ìŒ ì •ë³´ëŠ” ì§ˆë¬¸ì„ ë“±ë¡í•˜ì§€ ì•Šì•„ë„ ë£¨í‹´ íŒŒì¸ë”ìŠ¤ê°€ <span class="text-emerald-400">ì‹ ì²­ ê³¼ì •ì—ì„œ ìˆ˜ì§‘</span>í•˜ì—¬ í˜¸ìŠ¤íŠ¸ë‹˜ê»˜ ì „ë‹¬í•©ë‹ˆë‹¤:<br/>
                    â€¢ ë‹‰ë„¤ì„ ë° í”„ë¡œí•„ ì´ë¯¸ì§€<br/>
                    â€¢ <span class="text-emerald-400/80">ì‹¤ì œ ì…ê¸ˆì ì„±í•¨ ë° ì—°ë½ì²˜</span> (ì…ê¸ˆ í™•ì¸ìš©)<br/>
                    â€¢ ê³¼ê±° ì±Œë¦°ì§€ ìˆ˜í–‰ ì„±ê³µë¥ <br/>
                    â€¢ ë£¨íŒŒí´ëŸ½ ë©¤ë²„ì‹­ ì—¬ë¶€ ë° ì„±ì¥ ì•„ì´ë´í‹°í‹°
                  </p>
                </div>
             </div>

             <div class="p-5 bg-emerald-500/5 border border-emerald-500/10 rounded-2xl flex items-start gap-3">
                <span class="text-xl">ğŸ™‹â€â™‚ï¸</span>
                <div class="space-y-1">
                  <p class="text-[10px] font-black text-emerald-400">ì§ì ‘ ë¬¼ì–´ë³´ê³  ì‹¶ì€ ì§ˆë¬¸</p>
                  <p class="text-[9px] font-bold text-slate-500 leading-relaxed tabular-nums">
                    ì§ˆë¬¸ì„ ë“±ë¡í•˜ë©´ ì°¸ì—¬ìê°€ <span class="text-emerald-400">ì‹ ì²­ì„œë¥¼ ì‘ì„±í•  ë•Œ</span> ë‹µë³€ì„ í•¨ê»˜ ì œì¶œí•˜ê²Œ ë©ë‹ˆë‹¤. í˜¸ìŠ¤íŠ¸ë‹˜ì€ ì‹ ì²­ ê²°ê³¼ì—ì„œ ì´ ë‹µë³€ì„ ë³´ê³  ì°¸ê°€ë¥¼ ìˆ˜ë½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                  </p>
                </div>
             </div>
           </div>
        </div>
      </section>

      <!-- STEP 5: Review -->
      <section id="step-4" class="step-section hidden flex-1 flex flex-col gap-6">
        <div class="space-y-1">
          <h2 class="text-xl font-black text-white tracking-tighter leading-tight">ë§ˆì§€ë§‰ìœ¼ë¡œ <span class="text-emerald-500">ëª¨ì„ ì •ë³´</span>ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</h2>
        </div>
        <div class="space-y-6">
           <div class="bg-white/5 rounded-[40px] p-8 space-y-6 border border-white/5 relative overflow-hidden group">
              <div class="absolute -right-12 -top-12 w-48 h-48 bg-emerald-500/10 blur-3xl"></div>
              <div class="space-y-2 relative z-10">
                <h3 id="rev_title" class="text-xl font-black text-white">ê°•ë‚¨ì—­ ì¹´í˜ ë…ì„œ ëª¨ì„</h3>
                <div class="flex items-center gap-2 text-emerald-400 text-xs font-bold">
                  <span>ğŸ“</span>
                  <span id="rev_place">íˆ¬ì¸í”Œë ˆì´ìŠ¤ ê°•ë‚¨ëŒ€ë¡œì </span>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/5 relative z-10">
                <div class="space-y-1">
                  <p class="text-[9px] font-black text-slate-600 uppercase tracking-widest">Meeting Date</p>
                  <p id="rev_date" class="text-xs font-black text-white">2026.01.20 | ì˜¤í›„ 2ì‹œ</p>
                </div>
                <div class="space-y-1">
                  <p class="text-[9px] font-black text-slate-600 uppercase tracking-widest">Recruitment</p>
                  <p id="rev_recruitment" class="text-[10px] font-black text-emerald-400">~ 2026.01.19</p>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4 pt-4 border-t border-white/5 relative z-10">
                <div class="space-y-1">
                  <p class="text-[9px] font-black text-slate-600 uppercase tracking-widest">Attendees</p>
                  <p id="rev_max" class="text-xs font-black text-white">ìµœëŒ€ 4ëª…</p>
                </div>
                <div class="space-y-1">
                   <p class="text-[9px] font-black text-slate-600 uppercase tracking-widest">Cost</p>
                   <p id="rev_cost" class="text-sm font-black text-white">ë¬´ë£Œ</p>
                 </div>
               </div>
               <div id="rev_bank_box" class="pt-4 border-t border-white/5 relative z-10 hidden">
                 <p class="text-[9px] font-black text-slate-600 uppercase tracking-widest mb-1">Settlement Account</p>
                 <p id="rev_bank" class="text-[10px] font-bold text-slate-400"></p>
               </div>
               <div id="rev_refund_box" class="pt-4 border-t border-white/5 relative z-10 hidden">
                 <p class="text-[9px] font-black text-slate-600 uppercase tracking-widest mb-1">Refund Policy</p>
                 <p id="rev_refund" class="text-[10px] font-bold text-slate-400 leading-relaxed line-clamp-2"></p>
               </div>
            </div>
           
           <div class="p-6 bg-emerald-500/5 border border-emerald-500/10 rounded-[32px]">
              <p class="text-[10px] font-bold text-slate-500 text-center leading-relaxed">
                ëª¨ì„ì˜ ì°¸ì—¬ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ <br/>
                <span class="text-emerald-400">ìœ ë£Œ ì°¸ì—¬</span>ë¡œ ì „í™˜í•˜ëŠ” ê²ƒì„ ì¶”ì²œë“œë¦½ë‹ˆë‹¤.
              </p>
           </div>
        </div>
      </section>

    </div>

    <!-- Footer Buttons -->
    <div class="py-4 pb-8 shrink-0 z-20">
      <button id="nextBtn" type="button" class="w-full py-5 rounded-3xl bg-emerald-500 text-white font-black text-base shadow-xl shadow-emerald-500/40 active:scale-95 transition-all">ë‹¤ìŒ ë‹¨ê³„ë¡œ</button>
      <button id="submitBtn" type="button" class="hidden w-full py-5 rounded-3xl bg-emerald-500 text-white font-black text-lg shadow-xl shadow-emerald-500/40 active:scale-90 transition-all">ëª¨ì„ ê°œì„¤ ì™„ë£Œ</button>
    </div>
  <% end %>

  <script>
    (function() {
      let currentStep = 0;
      let isFormDirty = false; // Moved to top scope
      
      const sections = document.querySelectorAll('.step-section');
      const dots = document.querySelectorAll('.step-dot');
      const stepCounter = document.getElementById('stepCounter');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      const prevBtn = document.getElementById('prevBtn');

      function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }
      function unformatNumber(str) {
        return str.replace(/,/g, "");
      }

      function smartScroll(el) {
        if (!el) return;
        setTimeout(() => {
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);
      }

      function previewImage(input, previewId) {
        const preview = document.getElementById(previewId);
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-2xl">`;
            preview.classList.remove('border-dashed', 'bg-white/5');
            preview.classList.add('border-solid', 'border-emerald-500/30');
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // Aurora Update Logic
      const aurora = document.getElementById('aurora-glow');

      function update() {
        sections.forEach((s, i) => {
          s.classList.toggle('active', i === currentStep);
          s.classList.toggle('hidden', i !== currentStep);
        });
        dots.forEach((d, i) => {
          d.classList.toggle('active-dot', i === currentStep);
          d.classList.toggle('pending-dot', i > currentStep);
          d.classList.toggle('completed-dot', i < currentStep);
        });
        stepCounter.textContent = `${currentStep+1}/5`;
        
        // Auto scroll to top on step change
        const activeSection = sections[currentStep];
        if (activeSection) {
          activeSection.parentElement.scrollTo({ top: 0, behavior: 'smooth' });
        }

        if (currentStep === 4) {
          nextBtn.classList.add('hidden');
          submitBtn.classList.remove('hidden');
          
          // Review Sync
          document.getElementById('rev_title').textContent = document.querySelector('input[name="challenge[title]"]').value || "ë¬´ì œ ëª¨ì„";
          document.getElementById('rev_place').textContent = document.querySelector('input[name="challenge[meeting_info_attributes][place_name]"]').value || "ì¥ì†Œ ë¯¸ì •";
          
          const date = document.querySelector('input[name="challenge[start_date]"]').value;
          const time = document.querySelector('input[name="challenge[meeting_info_attributes][meeting_time]"]').value;
          document.getElementById('rev_date').textContent = `${date} | ${time}`;
          document.getElementById('rev_max').textContent = `ìµœëŒ€ ${document.getElementById('max_slider').value}ëª…`;
          
          const rStart = document.querySelector('input[name="challenge[recruitment_start_date]"]').value;
          const rEnd = document.querySelector('input[name="challenge[recruitment_end_date]"]').value;
          document.getElementById('rev_recruitment').textContent = `${rStart.slice(5)} ~ ${rEnd.slice(5)}`;
          
          const costType = document.getElementById('h_cost_type').value;
           const amount = document.getElementById('h_amount').value; // Use hidden field for actual value
           document.getElementById('rev_cost').textContent = costType === 'free' ? "ë¬´ë£Œ" : formatNumber(amount) + "ì›";

           // Settlement Account
           const bank = document.getElementById('h_bank').value;
           const holder = document.querySelector('input[name="challenge[host_account_holder]"]').value;
           const account = document.querySelector('input[name="challenge[host_account]"]').value;
           
           if (costType !== 'free' && bank) {
             document.getElementById('rev_bank').textContent = `${bank}${account ? ' ' + account : ''}${holder ? ' (' + holder + ')' : ''}`;
             document.getElementById('rev_bank_box').classList.remove('hidden');
           } else {
             document.getElementById('rev_bank_box').classList.add('hidden');
           }

           const refund = document.querySelector('textarea[name="challenge[refund_policy]"]').value;
           document.getElementById('rev_refund_box').classList.toggle('hidden', costType === 'free' || !refund);
           document.getElementById('rev_refund').textContent = refund;
        } else {
          nextBtn.classList.remove('hidden');
          submitBtn.classList.add('hidden');
        }
      }

      // Validation Logic
      function validateStep(step) {
        if (step === 0) {
           const title = document.querySelector('input[name="challenge[title]"]').value.trim();
           const summary = document.querySelector('input[name="challenge[summary]"]').value.trim();
           const description = document.querySelector('textarea[name="challenge[description]"]').value.trim();
           
           if(!title) { alert('ëª¨ì„ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
           if(!summary) { alert('í•œ ì¤„ ì†Œê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
           if(!description) { alert('ëª¨ì„ ìƒì„¸ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
        }
        else if (step === 1) {
           const date = document.querySelector('input[name="challenge[start_date]"]').value;
           const time = document.querySelector('input[name="challenge[meeting_info_attributes][meeting_time]"]').value;
           const mode = document.getElementById('h_mode').value;
           const place = document.querySelector('input[name="challenge[meeting_info_attributes][place_name]"]').value.trim();
           
           if(!date) { alert('ëª¨ì„ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return false; }
           if(!time) { alert('ëª¨ì„ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return false; }
           
           if(mode === 'online') {
              if(!place) { alert('ì˜¨ë¼ì¸ í”Œë«í¼ ë˜ëŠ” ë§í¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
           } else {
              if(!place) { alert('ëª¨ì„ ì¥ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
              const address = document.querySelector('input[name="challenge[meeting_info_attributes][address]"]').value.trim();
              if(!address) { alert('ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
           }
        }
        else if (step === 2) {
           const costType = document.getElementById('h_cost_type').value;
           if(costType === 'fee') {
             const amount = document.getElementById('h_amount').value;
             const holder = document.querySelector('input[name="challenge[host_account_holder]"]').value.trim();
             const account = document.querySelector('input[name="challenge[host_account]"]').value.trim();
             if(!amount || parseInt(amount) <= 0) { alert('ì°¸ê°€ë¹„ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
             if(!holder) { alert('ì˜ˆê¸ˆì£¼ ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
             if(!account) { alert('ì •ì‚°ë°›ì„ ê³„ì¢Œë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return false; }
           }
        }
        return true;
      }

      nextBtn.addEventListener('click', () => {
        if (currentStep < 4) { 
           if(validateStep(currentStep)) {
             currentStep++; 
             updateQuestionsJson(); // Ensure questions are synced
             update();
           }
        }
      });
      submitBtn.addEventListener('click', () => {
        isFormDirty = false; // Reset dirty flag before submission
        
        // Premium Completion: Confetti Trigger
        if (typeof confetti !== 'undefined') {
          confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#34D399', '#10B981', '#ffffff']
          });
        }
        
        setTimeout(() => {
          document.querySelector('form').submit();
        }, 800);
      });
      prevBtn.addEventListener('click', () => {
        if (currentStep > 0) { currentStep--; update(); }
        else { window.history.back(); }
      });

      // Selection Logic
      const handleSelect = (btns, hiddenId, activeClass) => {
        btns.forEach(btn => {
          btn.addEventListener('click', () => {
             btns.forEach(b => {
               b.classList.remove(activeClass, 'selected-cat', 'premium-selection');
               b.classList.add('unselected-opt');
             });
             btn.classList.add(activeClass);
             btn.classList.remove('unselected-opt');
              document.getElementById(hiddenId).value = btn.dataset.val;
              
              if (hiddenId === 'h_cost_type') {
                document.getElementById('cost_box').classList.toggle('hidden', btn.dataset.val === 'free');
              }

              smartScroll(btn);
              update(); // Call update to refresh review section
           });
        });
      };

      handleSelect(document.querySelectorAll('.mode-opt'), 'h_mode', 'premium-selection');
      handleSelect(document.querySelectorAll('.type-opt'), 'h_meeting_type', 'premium-selection');
      handleSelect(document.querySelectorAll('.cat-opt'), 'h_category', 'selected-cat');
      handleSelect(document.querySelectorAll('.admission-opt'), 'h_admission', 'premium-selection');
      handleSelect(document.querySelectorAll('.cost-opt'), 'h_cost_type', 'selected-cat');
      handleSelect(document.querySelectorAll('.bank-opt'), 'h_bank', 'selected-cat');

      // Address Visibility Toggle
      document.querySelectorAll('.mode-opt').forEach(btn => {
        btn.addEventListener('click', () => {
           const isOnline = btn.dataset.val === 'online';
           const placeLabel = document.getElementById('lbl_place_name');
           const addrDiv = document.getElementById('div_address');
           const urlDiv = document.getElementById('div_place_url');
           
           if(isOnline) {
             placeLabel.textContent = "Platform / Link";
             if(addrDiv) addrDiv.style.display = 'none';
             if(urlDiv) urlDiv.style.display = 'none';
             document.querySelector('input[name="challenge[meeting_info_attributes][place_name]"]').placeholder = "ì˜ˆ: Zoom, Discord, Google Meet";
           } else {
             placeLabel.textContent = "Place Name";
             if(addrDiv) addrDiv.style.display = 'block';
             if(urlDiv) urlDiv.style.display = 'block';
             document.querySelector('input[name="challenge[meeting_info_attributes][place_name]"]').placeholder = "ì˜ˆ: íˆ¬ì¸í”Œë ˆì´ìŠ¤ ê°•ë‚¨ëŒ€ë¡œì ";
           }
        });
      });

      // Date Sync
      const startDateInput = document.querySelector('input[name="challenge[start_date]"]');
      const endDateInput = document.getElementById('h_end_date');
      startDateInput.addEventListener('change', () => {
        endDateInput.value = startDateInput.value;
      });
      // Initial sync
      if(startDateInput.value) endDateInput.value = startDateInput.value;

      document.getElementById('max_slider').addEventListener('input', (e) => {
        document.getElementById('max_val').textContent = e.target.value + "ëª…";
      });

      // Amount Formatting
      const amountDisplay = document.getElementById('amount_display');
      const amountHidden = document.getElementById('h_amount');

      amountDisplay.addEventListener('input', (e) => {
        let value = unformatNumber(e.target.value);
        if(!isNaN(value) && value !== "") {
           amountHidden.value = value;
           e.target.value = formatNumber(value);
        } else {
           amountHidden.value = 0;
           e.target.value = "";
        }
      });

      // Participant Info Toggle
      const toggleParticipantInfo = document.getElementById('toggle_participant_info');
      const participantQuestionBox = document.getElementById('participant_question_box');
      toggleParticipantInfo.addEventListener('click', () => {
        const active = toggleParticipantInfo.classList.toggle('active');
        participantQuestionBox.classList.toggle('hidden', !active);
        document.getElementById('h_requires_msg').value = active;
        smartScroll(toggleParticipantInfo);
      });

      // Rufa Only Toggle
      const toggleRufaOnly = document.getElementById('toggle_rufa_only');
      const btnRufaOnly = document.getElementById('btn_rufa_only');
      btnRufaOnly.addEventListener('click', () => {
        const active = toggleRufaOnly.classList.toggle('active');
        document.getElementById('h_rufa_only').value = active;
        
        if (active) {
          btnRufaOnly.classList.add('premium-selection');
          btnRufaOnly.classList.remove('bg-indigo-500/5', 'border-indigo-500/10');
        } else {
          btnRufaOnly.classList.remove('premium-selection');
          btnRufaOnly.classList.add('bg-indigo-500/5', 'border-indigo-500/10');
        }
        smartScroll(btnRufaOnly);
      });

      // Bind focus to all inputs
      document.querySelectorAll('input, textarea').forEach(el => {
        el.addEventListener('focus', () => smartScroll(el));
      });

      // >>> [NEW] Multiple Questions Logic
      const questionsList = document.getElementById('questions_list');
      const addQuestionBtn = document.getElementById('add_question_btn');
      const questionsHidden = document.getElementById('h_app_questions');

      function updateQuestionsJson() {
        if (!questionsHidden) return;
        const inputs = document.querySelectorAll('.question-input');
        const questions = Array.from(inputs)
          .map(input => input.value.trim())
          .filter(val => val !== "");
        questionsHidden.value = JSON.stringify(questions);
      }

      function createQuestionInput(value = "") {
        const div = document.createElement('div');
        div.className = "flex gap-2 items-start group";
        div.innerHTML = `
          <div class="flex-1">
            <input type="text" class="glass-input w-full p-4 text-sm focus:scale-[1.01] question-input bg-white/5 border border-white/10 rounded-xl" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš” (ì˜ˆ: ì‹ ì²­ ë™ê¸°ê°€ ë¬´ì—‡ì¸ê°€ìš”?)" value="${value.replace(/"/g, '&quot;')}">
          </div>
          <button type="button" class="w-[50px] h-[50px] rounded-xl bg-white/5 border border-white/5 flex items-center justify-center text-slate-500 hover:text-rose-400 hover:bg-rose-500/10 transition-all remove-question-btn shrink-0 mt-0.5">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          </button>
        `;
        
        div.querySelector('.remove-question-btn').addEventListener('click', () => {
          div.remove();
          updateQuestionsJson();
        });
        
        const input = div.querySelector('input');
        input.addEventListener('input', updateQuestionsJson);
        input.addEventListener('focus', () => smartScroll(input));
        
        return div;
      }

      if (addQuestionBtn) {
        addQuestionBtn.addEventListener('click', () => {
          const newQ = createQuestionInput();
          questionsList.appendChild(newQ);
          setTimeout(() => newQ.querySelector('input').focus(), 50);
          updateQuestionsJson();
        });
      }

      // Initial Question
      if (questionsList && questionsList.children.length === 0) {
         // Default empty question
         const initial = createQuestionInput("");
         questionsList.appendChild(initial);
         updateQuestionsJson();
      }
      // <<< End Multiple Questions Logic

      update();

      // Prevent accidental exit
      setTimeout(() => {
        const form = document.querySelector('form');
        if (form) {
          form.addEventListener('change', () => { isFormDirty = true; });
          form.addEventListener('input', () => { isFormDirty = true; });
          form.addEventListener('submit', () => { isFormDirty = false; });
          
          window.addEventListener('beforeunload', (e) => {
            if (isFormDirty) {
              e.preventDefault();
              e.returnValue = '';
            }
          });
          
          document.addEventListener('turbo:before-visit', (e) => {
            if (isFormDirty && document.body.contains(form)) {
               if (!confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                 e.preventDefault();
               } else {
                 isFormDirty = false;
               }
            }
          });
        }
      }, 500);
    })();
  </script>
</div>
