<!DOCTYPE html>
<html class="scroll-smooth">
  <head>
    <title>Routine Finders App Prototype</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="flash-notice" content="<%= notice %>">
    <meta name="flash-alert" content="<%= alert %>">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="<%= asset_path('rf_symbol_v9.png') %>">
    <link rel="icon" type="image/png" sizes="16x16" href="<%= asset_path('rf_symbol_v9.png') %>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="루파">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#7C4DFF">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap" rel="stylesheet">
    
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <!-- Kakao SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js" crossorigin="anonymous"></script>
    <script>
      if (!Kakao.isInitialized()) {
        Kakao.init('f959f8ada6c21d791ef5be7f4257e19e');
      }
    </script>

    <style>
      :root {
        --app-bg: #0C0B12;
        --app-surface: #1B1A24;
        --app-surface-accent: #252433;
        --app-primary: #7C4DFF;
        --app-primary-glow: rgba(124, 77, 255, 0.4);
        --app-text-main: #FFFFFF;
        --app-text-dim: #8E8D9E;
        --app-border: rgba(255, 255, 255, 0.06);
      }

      body {
        background-color: var(--app-bg);
        color: var(--app-text-main);
        font-family: 'Pretendard', sans-serif;
        -webkit-tap-highlight-color: transparent;
      }

      .app-glass-card {
        background: var(--app-surface);
        border: 1px solid var(--app-border);
        border-radius: 32px;
      }

      .app-fab-gradient {
        background: linear-gradient(135deg, #7C4DFF 0%, #651FFF 100%);
        box-shadow: 0 10px 25px rgba(124, 77, 255, 0.4);
      }

      /* Transitions for Taps */
      .app-tap-active:active {
        transform: scale(0.96);
        transition: transform 0.1s ease;
      }
    </style>
  </head>

  <body class="min-h-screen" data-controller="proto-ui toast loading" data-logged-in="<%= logged_in? %>">
    <main data-controller="modal" class="w-full max-w-md mx-auto min-h-screen relative pb-40 px-4 shadow-2xl bg-[#0C0B12]">
      <%= yield %>
    </main>

    <!-- App Bottom Navigation Bar (Hidden if hide_nav is set) -->
    <% unless content_for?(:hide_nav) %>
      <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-sm h-20 bg-[#16151D]/80 backdrop-blur-3xl rounded-[32px] border border-white/10 flex items-center justify-around px-8 z-[100] shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
      <%= link_to prototype_home_path, class: "flex items-center justify-center w-12 h-12 app-tap-active #{current_page?(prototype_home_path) ? 'text-indigo-400' : 'text-slate-600'}" do %>
        <span class="text-2xl">🏠</span>
      <% end %>

      <%= link_to prototype_explore_path, class: "flex items-center justify-center w-12 h-12 app-tap-active #{current_page?(prototype_explore_path) ? 'text-indigo-400' : 'text-slate-600'}" do %>
        <span class="text-2xl">🧭</span>
      <% end %>

      <button type="button" onclick="document.getElementById('fab-menu-sheet').classList.remove('hidden')" class="w-16 h-16 app-fab-gradient rounded-full flex items-center justify-center -translate-y-6 shadow-2xl border-4 border-[#0C0B12] active:scale-90 transition-transform cursor-pointer">
        <span class="text-2xl text-white font-black">+</span>
      </button>

      <%= link_to prototype_synergy_path, class: "flex items-center justify-center w-12 h-12 app-tap-active #{current_page?(prototype_synergy_path) ? 'text-indigo-400' : 'text-slate-600'}" do %>
        <span class="text-2xl">✨</span>
      <% end %>

      <%= link_to prototype_my_path, 
                  data: { action: "click->proto-ui#checkLogin" },
                  class: "flex items-center justify-center w-12 h-12 app-tap-active #{current_page?(prototype_my_path) ? 'text-indigo-400' : 'text-slate-600'}" do %>
        <span class="text-2xl">👤</span>
      <% end %>
    </nav>
    <% end %>

    <!-- 1. Routine Record Bottom Sheet -->
    <div id="record-sheet" class="hidden fixed inset-0 z-[210]">
      <div onclick="document.getElementById('record-sheet').classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="absolute inset-0 bg-black/80 backdrop-blur-md cursor-pointer"></div>
      <div class="absolute bottom-0 left-0 right-0 max-w-md mx-auto bg-[#1B1A24] rounded-t-[40px] p-8 pb-12 animate-slide-up border-t border-white/10 shadow-[0_-20px_60px_rgba(124,77,255,0.2)] z-10">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <h3 class="text-xl font-black text-white mb-2 text-center">오늘의 루틴 기록</h3>
        <p class="text-xs font-bold text-indigo-400 mb-8 text-center uppercase tracking-widest leading-none">Record your success</p>
        
        <%= form_with url: prototype_record_path, method: :post, class: "space-y-6" do |f| %>
          <%= f.hidden_field :activity_type, value: "routine_record" %>
          <div class="space-y-4">
            <%= f.text_area :body, 
                            placeholder: "오늘 어떤 루틴을 지켰나요? 자신에게 한 마디 남겨보세요.", 
                            autofocus: true,
                            class: "w-full min-h-[160px] bg-white/5 border-2 border-white/10 rounded-3xl p-6 text-white text-base font-bold placeholder:text-white/20 focus:border-indigo-500 focus:ring-0 transition-all resize-none shadow-inner" %>
            
            <div class="flex items-center gap-3 p-4 bg-indigo-500/10 rounded-2xl border border-indigo-500/20">
              <span class="text-xl">✨</span>
              <p class="text-[11px] font-bold text-indigo-300">작성한 기록은 '시너지' 피드에 공유되어 다른 멤버들의 성장을 응원하게 됩니다.</p>
            </div>
          </div>

          <div class="flex gap-3">
             <button type="button" onclick="document.getElementById('record-sheet').classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="px-6 py-4 rounded-2xl bg-white/5 text-slate-500 font-black text-sm">취소</button>
             <%= f.submit "기록 저장하기", class: "flex-1 py-4 rounded-2xl app-fab-gradient text-white font-black text-sm shadow-xl active:scale-95 transition-all cursor-pointer" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- 1-2. Today's Commitment Bottom Sheet -->
    <div id="commitment-sheet" class="hidden fixed inset-0 z-[210]">
      <div onclick="document.getElementById('commitment-sheet').classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="absolute inset-0 bg-black/80 backdrop-blur-md cursor-pointer"></div>
      <div class="absolute bottom-0 left-0 right-0 max-w-md mx-auto bg-[#1B1A24] rounded-t-[40px] p-8 pb-12 animate-slide-up border-t border-white/10 shadow-[0_-20px_60px_rgba(124,77,255,0.2)] z-10">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <h3 class="text-xl font-black text-white mb-2 text-center">오늘의 다짐</h3>
        <p class="text-xs font-bold text-rose-400 mb-8 text-center uppercase tracking-widest leading-none">Declare your commitment</p>
        
        <%= form_with url: prototype_record_path, method: :post, class: "space-y-6" do |f| %>
          <%= f.hidden_field :activity_type, value: "reflection" %>
          <div class="space-y-4">
            <%= f.text_area :body, 
                            placeholder: "오늘 하루를 어떻게 보내고 싶나요? 당당하게 선언해보세요!", 
                            autofocus: true,
                            class: "w-full min-h-[160px] bg-white/5 border-2 border-white/10 rounded-3xl p-6 text-white text-base font-bold placeholder:text-white/20 focus:border-rose-500/50 focus:ring-0 transition-all resize-none shadow-inner" %>
            
            <div class="flex items-center gap-3 p-4 bg-rose-500/10 rounded-2xl border border-rose-500/20">
              <span class="text-xl">🔥</span>
              <p class="text-[11px] font-bold text-rose-300">오늘의 다짐은 나뿐만 아니라 동료들에게도 큰 자극이 됩니다.</p>
            </div>
          </div>

          <div class="flex gap-3">
             <button type="button" onclick="document.getElementById('commitment-sheet').classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="px-6 py-4 rounded-2xl bg-white/5 text-slate-500 font-black text-sm">취소</button>
             <%= f.submit "다짐 선언하기", class: "flex-1 py-4 rounded-2xl bg-gradient-to-r from-rose-500 to-orange-500 text-white font-black text-sm shadow-xl shadow-rose-500/20 active:scale-95 transition-all cursor-pointer" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- 2. FAB Menu Sheet (Simple List Style) -->
    <div id="fab-menu-sheet" class="hidden fixed inset-0 z-[215]">
      <div onclick="document.getElementById('fab-menu-sheet').classList.add('hidden')" class="absolute inset-0 bg-black/80 backdrop-blur-md cursor-pointer transition-opacity"></div>
      <div class="absolute bottom-0 left-0 right-0 max-w-md mx-auto bg-[#1B1A24] rounded-t-[40px] p-8 pb-12 animate-slide-up border-t border-white/10 shadow-[0_-20px_60px_rgba(124,77,255,0.2)]">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <h3 class="text-xl font-black text-white mb-2 text-center">새로운 시작하기</h3>
        <p class="text-xs font-bold text-indigo-400 mb-8 text-center uppercase tracking-widest leading-none">Create & Join</p>
        
        <div class="space-y-4">
          <% 
            membership = current_user&.routine_club_members&.active&.first
            is_club_member = (current_user&.admin? || membership.present?)
            user_level = (current_user&.total_routine_completions || 0) / 10 # Simple level logic for proto
          %>

          <!-- 1. Create Routine -->
          <a href="/prototype/routine_builder" 
             data-action="click->proto-ui#checkLogin"
             class="block w-full p-5 rounded-3xl bg-white/5 border border-white/5 hover:bg-white/10 text-left group active:scale-[0.98] transition-all">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-2xl bg-[#0C0B12] flex items-center justify-center border border-white/10">
                <span class="text-2xl">📝</span>
              </div>
              <div class="flex-1">
                <p class="text-white font-bold text-base">내 루틴 만들기</p>
                <p class="text-slate-500 text-xs font-bold mt-0.5">나만의 데일리 루틴 설정</p>
              </div>
            </div>
          </a>

          <!-- 2. Create Challenge -->
          <a href="<%= (is_club_member || user_level >= 10) ? "/prototype/challenge_builder" : "#" %>" 
             data-action="click->proto-ui#checkLogin"
             onclick="<%= (is_club_member || user_level >= 10) ? "" : "alert('레벨 10 달성 또는 루파 클럽 가입 시 개설 가능합니다!'); return false;" %>"
             class="block w-full p-5 rounded-3xl bg-white/5 border border-white/5 hover:bg-white/10 text-left group active:scale-[0.98] transition-all relative overflow-hidden">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-[#0C0B12] flex items-center justify-center border border-white/10">
                  <span class="text-2xl">🚩</span>
                </div>
                <div class="flex-1">
                  <p class="text-white font-bold text-base">챌린지 만들기</p>
                  <p class="text-slate-500 text-xs font-bold mt-0.5">함께 성장하는 목표 달성</p>
                </div>
              </div>
              <% if is_club_member %>
                <span class="px-2 py-1 bg-indigo-500 text-white text-[8px] font-black rounded-lg shadow-glow shadow-indigo-500/20">PREMIUM BYPASS</span>
              <% elsif user_level < 10 %>
                <div class="flex items-center gap-1 px-2 py-1 bg-white/10 rounded-lg">
                  <span class="text-[9px] font-black text-slate-400 italic">Lv.10</span>
                  <span class="text-[10px]">🔒</span>
                </div>
              <% end %>
            </div>
          </a>

          <!-- 3. Create Gathering -->
          <a href="<%= (is_club_member || user_level >= 10) ? "/prototype/gathering_builder" : "#" %>" 
             data-action="click->proto-ui#checkLogin"
             onclick="<%= (is_club_member || user_level >= 10) ? "" : "alert('레벨 10 달성 또는 루파 클럽 가입 시 개설 가능합니다!'); return false;" %>"
             class="block w-full p-5 rounded-3xl bg-white/5 border border-white/5 hover:bg-white/10 text-left group active:scale-[0.98] transition-all relative overflow-hidden">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-[#0C0B12] flex items-center justify-center border border-white/10">
                  <span class="text-2xl">💬</span>
                </div>
                <div class="flex-1">
                  <p class="text-white font-bold text-base">모임 만들기</p>
                  <p class="text-slate-500 text-xs font-bold mt-0.5">취향과 관심사 공유</p>
                </div>
              </div>
              <% if is_club_member %>
                <span class="px-2 py-1 bg-indigo-500 text-white text-[8px] font-black rounded-lg shadow-glow shadow-indigo-500/20">PREMIUM BYPASS</span>
              <% elsif user_level < 10 %>
                <div class="flex items-center gap-1 px-2 py-1 bg-white/10 rounded-lg">
                  <span class="text-[9px] font-black text-slate-400 italic">Lv.10</span>
                  <span class="text-[10px]">🔒</span>
                </div>
              <% end %>
            </div>
          </a>

          <!-- 4. 루파클럽 상태 및 혜택 (Bottom Highlight) -->
          <a href="<%= is_club_member ? prototype_my_path : prototype_club_join_path %>" 
             data-action="click->proto-ui#checkLogin"
             class="block w-full p-5 rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 text-left group active:scale-[0.98] transition-all shadow-lg shadow-indigo-600/20">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-2xl bg-white/20 flex items-center justify-center backdrop-blur-sm">
                <span class="text-2xl">🔱</span>
              </div>
              <div class="flex-1">
                <p class="text-white font-black text-lg">
                  <%= is_club_member ? "나의 멤버십 혜택" : "루파클럽 멤버십 가입" %>
                </p>
                <p class="text-indigo-100 text-xs font-bold mt-0.5">
                  <% if is_club_member %>
                    🎟️ <%= membership.remaining_relax_passes %> · 
                    🛡️ <%= membership.remaining_save_passes %> · 
                    ⚡ <%= number_with_delimiter(membership.growth_points || 0) %>P
                  <% else %>
                    레벨 제한 없이 즉시 리더가 되세요
                  <% end %>
                </p>
              </div>
              <svg class="w-6 h-6 text-white opacity-50 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/></svg>
            </div>
          </a>
        </div>

        <div class="mt-8 text-center">
            <button type="button" onclick="document.getElementById('fab-menu-sheet').classList.add('hidden')" class="px-8 py-3 rounded-full bg-white/5 text-slate-500 font-bold text-sm hover:bg-white/10 transition-colors">닫기</button>
        </div>
      </div>
    </div>
    
    <!-- 1. 이용약관 모달 -->
    <div id="terms-modal" class="hidden fixed inset-0 z-[600]">
      <div onclick="document.getElementById('terms-modal').classList.add('hidden')" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
      <div class="absolute bottom-0 left-0 right-0 max-w-md mx-auto bg-[#1B1A24] rounded-t-[40px] p-8 pb-12 animate-slide-up border-t border-white/10 max-h-[80vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <h3 class="text-xl font-black text-white mb-6 text-center">서비스 이용안내 및 약관</h3>
        <div class="space-y-6 text-sm text-slate-400 font-bold leading-relaxed px-2">
          <div class="space-y-2">
            <p class="text-white">제 1조 (플랫폼의 성격)</p>
            <p>'루틴 파인더스'(이하 "플랫폼")는 개인 개발자가 성장의 즐거움을 나누기 위해 제작한 개인 운영 플랫폼입니다. 누구나 자유롭게 자신만의 루틴을 세우고, 챌린지와 모임을 개설하여 함께 성장하는 것을 목표로 합니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">제 2조 (서비스의 제공)</p>
            <p>본 플랫폼은 개인의 기록을 돕는 루틴 기록 도구와 타인과 소통할 수 있는 챌린지 및 모임 운영 도구를 제공합니다. 플랫폼은 도구를 제공할 뿐, 각 챌린지와 모임의 운영 주체는 해당 기능을 개설한 사용자(호스트)에게 있습니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">제 3조 (이용자의 권리와 책임)</p>
            <p>1. 사용자는 플랫폼 내에서 타인에게 긍정적인 자극과 응원을 전하는 것을 원칙으로 합니다.</p>
            <p>2. 개인이 운영하는 공간인 만큼 타인의 명예를 훼손하거나 커뮤니티의 질서를 어지럽히는 행위에 대해서는 운영자가 이용을 제한할 수 있습니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">제 4조 (서비스 운영에 관한 사항)</p>
            <p>개인 개발자가 관리하는 플랫폼 특성상 예기치 못한 점검이나 기능 업데이트가 잦을 수 있습니다. 운영자는 최선을 다해 안정적인 서비스를 제공하려 노력하되, 시스템 장애로 인한 데이터 손실 등에 대해서는 완전한 책임을 지기 어려움을 양해 부탁드립니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">제 5조 (저작권 및 상호 존중)</p>
            <p>본 서비스 내의 디자인과 로직은 운영자의 소중한 자산입니다. 또한 사용자가 올린 게시글의 저작권은 사용자에게 있으며, 서로의 개인적 창작물과 노력을 존중해야 합니다.</p>
          </div>
          <div class="pt-8 text-center">
            <button onclick="document.getElementById('terms-modal').classList.add('hidden')" class="w-full py-4 bg-indigo-600 rounded-2xl text-white font-black text-sm hover:bg-indigo-500 transition-colors shadow-lg shadow-indigo-600/20">플랫폼과 함께 성장하겠습니다</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. 개인정보처리방침 모달 -->
    <div id="privacy-modal" class="hidden fixed inset-0 z-[600]">
      <div onclick="document.getElementById('privacy-modal').classList.add('hidden')" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
      <div class="absolute bottom-0 left-0 right-0 max-w-md mx-auto bg-[#1B1A24] rounded-t-[40px] p-8 pb-12 animate-slide-up border-t border-white/10 max-h-[80vh] overflow-y-auto">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <h3 class="text-xl font-black text-white mb-6 text-center">개인정보 처리 및 보호 안내</h3>
        <div class="space-y-6 text-sm text-slate-400 font-bold leading-relaxed px-2">
          <div class="space-y-2">
            <p class="text-white">1. 최소한의 정보만 수집합니다</p>
            <p>운영자는 카카오 로그인을 통해 제공받는 최소한의 정보(닉네임, 프로필 이미지 등)와 사용자가 직접 작성하는 루틴 기록만을 수집하며, 이를 상업적으로 판매하거나 불법적으로 사용하지 않습니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">2. 정보의 소중한 활용</p>
            <p>수집된 정보는 플랫폼 내에서 친구들과 루틴 현황을 공유하고, 본인이 개설한 챌린지나 모임을 관리하기 위한 용도로만 사용됩니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">3. 보관 및 파기 원칙</p>
            <p>사용자의 데이터는 플랫폼 이용 기간 동안 안전하게 보관되며, 탈퇴 시 지체 없이 파기됩니다. 다만, 커뮤니티 성격상 본인이 작성하여 타인과 공유한 게시물은 서비스 품질 유지를 위해 남을 수 있습니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">4. 개인 개발자의 약속</p>
            <p>운영자는 사용자의 개인정보를 제3자에게 임의로 제공하지 않으며, 보안 수칙을 가이드에 따라 철저히 준수하여 정보를 보호하겠습니다.</p>
          </div>
          <div class="pt-8 text-center">
            <button onclick="document.getElementById('privacy-modal').classList.add('hidden')" class="w-full py-4 bg-emerald-600 rounded-2xl text-white font-black text-sm hover:bg-emerald-500 transition-colors shadow-lg shadow-emerald-600/20">운영자를 신뢰하고 시작합니다</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. Badge Celebration Modal -->
    <% if @new_badges&.any? %>
      <% @new_badges.each_with_index do |ub, idx| %>
        <div id="badge-celebration-<%= idx %>" class="fixed inset-0 z-[1000] flex items-center justify-center p-6 <%= 'hidden' if idx > 0 %>">
          <div class="absolute inset-0 bg-black/90 backdrop-blur-2xl animate-fade-in"></div>
          
          <div class="relative w-full max-w-sm app-glass-card border-white/20 p-10 text-center space-y-8 animate-badge-pop">
            <!-- Particle Effect Decoration -->
            <div class="absolute inset-0 overflow-hidden rounded-[32px] pointer-events-none">
              <div class="absolute top-0 left-1/4 w-20 h-20 bg-indigo-500/20 blur-3xl animate-pulse"></div>
              <div class="absolute bottom-0 right-1/4 w-20 h-20 bg-purple-500/20 blur-3xl animate-pulse delay-700"></div>
            </div>

            <div class="space-y-6 relative z-10">
              <div class="w-32 h-32 rounded-[40px] bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-6xl mx-auto shadow-[0_20px_50px_rgba(124,77,255,0.5)] animate-float">
                <%= ub.badge.icon_path.presence || "🏆" %>
              </div>
              
              <div class="space-y-2">
                <p class="text-xs font-black text-indigo-400 uppercase tracking-[0.3em] animate-fade-in">New Identity Earned</p>
                <h3 class="text-3xl font-black text-white leading-tight"><%= ub.badge.name %></h3>
              </div>
              
              <p class="text-sm font-bold text-slate-400 leading-relaxed px-4">
                "<%= ub.badge.description %>"<br/>
                루파님의 성장이 새로운 증거를 남겼습니다!
              </p>
            </div>

            <div class="pt-4 relative z-10 space-y-3" 
                 data-controller="share"
                 data-share-title-value="루바 성취 배지 획득! 🏆"
                 data-share-text-value="'<%= ub.badge.name %>' 배지를 획득했습니다! 루틴 파인더스에서 함께 성장해요."
                 data-share-url-value="<%= prototype_home_url %>">
              <button data-action="click->share#share"
                      class="w-full py-4 bg-indigo-500 text-white font-black text-sm rounded-2xl shadow-xl active:scale-95 transition-all">
                지금 바로 공유하기
              </button>
              
              <button onclick="this.closest('.fixed').classList.add('hidden'); 
                               const next = document.getElementById('badge-celebration-<%= idx + 1 %>');
                               if(next) { next.classList.remove('hidden'); } 
                               else { document.body.classList.remove('overflow-hidden'); }"
                      class="w-full py-4 bg-white/10 text-white/60 font-black text-sm rounded-2xl active:scale-95 transition-all">
                다음에 할게요
              </button>
            </div>
          </div>
          
          <!-- Confetti Overlay (CSS Only) -->
          <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <% 20.times do %>
              <div class="confetti" style="left: <%= rand(100) %>%; animation-delay: <%= rand(3000) %>ms; background-color: <%= ['#7C4DFF', '#FFD700', '#00E676', '#FF1744'].sample %>;"></div>
            <% end %>
          </div>
        </div>
      <% end %>
      
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          document.body.classList.add('overflow-hidden');
          // Mark as viewed via a silent request or just assume viewed after this render for prototype
          fetch('/prototype/mark_badges_viewed', { method: 'POST', headers: { 'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content } });
        });
      </script>

      <style>
        @keyframes badge-pop {
          0% { transform: scale(0.5); opacity: 0; }
          70% { transform: scale(1.05); }
          100% { transform: scale(1); opacity: 1; }
        }
        @keyframes rotate-slow {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        @keyframes fade-in {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes float {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-10px); }
        }
        .animate-badge-pop { animation: badge-pop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .confetti {
          position: absolute;
          top: -20px;
          width: 10px;
          height: 10px;
          border-radius: 2px;
          animation: fall linear 3s infinite;
        }
        @keyframes fall {
          to { transform: translateY(100vh) rotate(720deg); }
        }
      </style>
    <% end %>
  </body>
</html>
