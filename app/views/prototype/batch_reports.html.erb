<div class="space-y-8 py-10 pb-32" data-controller="batch-copy">
  <!-- 1. Header -->
  <header class="px-6 space-y-4">
    <div class="flex items-center justify-between">
      <%= link_to prototype_admin_clubs_path, class: "w-10 h-10 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 active:scale-95 transition-all" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
      <% end %>
      <div class="px-3 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20">
        <span class="text-[9px] font-black text-emerald-400 uppercase tracking-widest leading-none">Batch Sharing Mode</span>
      </div>
      <div class="w-10"></div>
    </div>

    <div class="space-y-2">
      <h1 class="text-3xl font-black text-white tracking-tight">ì „ì²´ ë¦¬í¬íŠ¸ í†µí•© ìš”ì•½</h1>
      <p class="text-xs font-bold text-slate-500 leading-relaxed">
        ìµœê·¼ ìƒì„±ëœ ëª¨ë“  ë©¤ë²„ì˜ ë¦¬í¬íŠ¸ë¥¼ í•œ í™”ë©´ì—ì„œ í™•ì¸í•˜ê³ <br/>
        ë‹¨í†¡ë°© ê³µìœ ë¥¼ ìœ„í•´ í…ìŠ¤íŠ¸ë¡œ ë¹ ë¥´ê²Œ ë³µì‚¬í•©ë‹ˆë‹¤.
      </p>
    </div>
  </header>

  <!-- 2. Filters & Actions -->
  <section class="px-6 flex flex-col gap-3">
    <div class="flex bg-white/5 p-1 rounded-2xl border border-white/10">
      <%= link_to "ì£¼ê°„ ë³´ë“œ", prototype_batch_reports_path(type: "weekly"), class: "flex-1 py-3 text-center text-xs font-black rounded-xl transition-all #{@report_type == 'weekly' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500'}" %>
      <%= link_to "ì›”ê°„ ë³´ë“œ", prototype_batch_reports_path(type: "monthly"), class: "flex-1 py-3 text-center text-xs font-black rounded-xl transition-all #{@report_type == 'monthly' ? 'bg-purple-600 text-white shadow-lg' : 'text-slate-500'}" %>
    </div>
    
    <div class="grid grid-cols-1 gap-2">
      <button data-action="batch-copy#copySummary" class="w-full py-4 bg-indigo-600 text-white rounded-[24px] font-black text-sm shadow-xl shadow-indigo-600/20 active:scale-95 transition-all flex items-center justify-center gap-3">
        <span class="text-xl">ğŸ“Š</span>
        <span>ë‹¨í†¡ë°©ìš© ìš”ì•½ ë¬¸êµ¬ ë³µì‚¬</span>
      </button>
      <button data-action="batch-copy#copyAll" class="w-full py-3.5 bg-white/5 border border-white/10 text-slate-400 rounded-[20px] font-black text-[11px] uppercase tracking-widest active:scale-95 transition-all">
        ìƒì„¸í˜• ë¦¬í¬íŠ¸ ì „ì²´ ë³µì‚¬
      </button>
    </div>
  </section>

  <!-- 3. Report Feed -->
  <section class="px-6 space-y-4">
    <div class="flex items-center justify-between px-1">
      <h2 class="text-xs font-black text-slate-500 uppercase tracking-[0.2em]">
        <%= @report_type == 'weekly' ? 'WEEKLY' : 'MONTHLY' %> RANKING
      </h2>
      <% if @reports.any? %>
        <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest"><%= @reports.first.start_date.strftime("%Y.%m.%d") %> ê¸°ì¤€</span>
      <% end %>
    </div>

    <div class="space-y-3" id="reports-container">
      <% if @reports.any? %>
        <% @reports.each_with_index do |report, index| %>
          <div class="app-glass-card p-5 border-white/5 bg-white/[0.02] flex items-center justify-between">
            <div class="flex items-center gap-4">
               <span class="text-xs font-black <%= index < 3 ? 'text-amber-500' : 'text-slate-600' %> w-4">#<%= index + 1 %></span>
               <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center text-white font-black text-xs border border-white/5">
                 <%= report.user.nickname[0].upcase %>
               </div>
               <div>
                 <h4 class="text-sm font-black text-white"><%= report.user.nickname %></h4>
                 <p class="text-[9px] font-bold text-slate-500 mt-0.5"><%= report.identity_title %></p>
               </div>
            </div>
            
            <div class="text-right">
              <p class="text-lg font-black <%= report.achievement_rate >= 80 ? 'text-emerald-400' : (report.achievement_rate < 70 ? 'text-rose-500' : 'text-white') %> tabular-nums">
                <%= report.achievement_rate.to_i %>%
              </p>
              <div class="w-12 h-1 bg-white/5 rounded-full mt-1 ml-auto overflow-hidden">
                <div class="h-full <%= report.achievement_rate >= 80 ? 'bg-emerald-500' : (report.achievement_rate < 70 ? 'bg-rose-500' : 'bg-indigo-500') %>" style="width: <%= report.achievement_rate %>%"></div>
              </div>
            </div>

            <!-- Hidden raw text for copy (Routines kept here for copy functionality) -->
            <div class="hidden share-text" data-nickname="<%= report.user.nickname %>" 
                 data-identity="<%= report.identity_title %>"
                 data-log="<%= report.log_rate.to_i %>"
                 data-achieve="<%= report.achievement_rate.to_i %>"
                 data-summary="<%= report.summary %>"
                 data-routines='<%= report.respond_to?(:routines) ? report.routines.to_json : "[]" %>'>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="py-20 text-center app-glass-card border-white/10 border-dashed">
          <p class="text-xs font-bold text-slate-600">í•´ë‹¹ íƒ€ì…ì˜ ë¦¬í¬íŠ¸ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      <% end %>
    </div>
  </section>
  
  <!-- Hidden data for header text -->
  <div id="share-header" class="hidden" 
       data-title="[ë£¨íŒŒ í´ëŸ½ <%= @report_type == 'weekly' ? 'ì£¼ê°„' : "#{@target_start.month}ì›”" %> ì„±ì·¨ ë¦¬í¬íŠ¸]"
       data-period="<%= @target_start.strftime('%Y.%m.%d') %> ~ <%= @target_end.strftime('%Y.%m.%d') %>">
  </div>
</div>

<script>
  document.addEventListener('turbo:load', function() {
    const container = document.querySelector('[data-controller="batch-copy"]');
    if (!container) return;

    const copyBtn = document.querySelector('[data-action="batch-copy#copyAll"]');
    const summaryBtn = document.querySelector('[data-action="batch-copy#copySummary"]');
    const header = document.getElementById('share-header');
    
    const showSuccess = (btn, originalContent) => {
      btn.innerHTML = '<span>âœ…</span><span>ë³µì‚¬ ì™„ë£Œ!</span>';
      setTimeout(() => { btn.innerHTML = originalContent; }, 2000);
    };

    // ìš”ì•½í˜• ë³µì‚¬ (User Requested Format)
    summaryBtn.addEventListener('click', function() {
      const reports = document.querySelectorAll('.share-text');
      const originalContent = summaryBtn.innerHTML;
      
      let text = "ğŸ”± " + header.dataset.title + "\n";
      text += "ğŸ“… " + header.dataset.period + "\n\n";
      
      reports.forEach((report, index) => {
        const rate = parseInt(report.dataset.achieve);
        const emoji = rate >= 90 ? "ğŸ”¥" : (rate < 70 ? "âš ï¸" : "âœ¨");
        text += (index + 1) + ". " + report.dataset.nickname + ": " + rate + "% " + emoji + "\n";
      });
      
      text += "\n------------------\n";
      text += "ğŸ’¡ 70% ë¯¸ë§Œ ë©¤ë²„ëŠ” ë¶„ë°œí•´ì£¼ì„¸ìš”!\n";
      text += "ì •ì§„í•˜ëŠ” ë£¨íŒŒ í´ëŸ½ì´ ë©ì‹œë‹¤. ğŸ’ª";

      navigator.clipboard.writeText(text).then(() => showSuccess(summaryBtn, originalContent));
    });

    // ìƒì„¸í˜• ë³µì‚¬ (Updated to include individual routines)
    copyBtn.addEventListener('click', function() {
      const reports = document.querySelectorAll('.share-text');
      const originalContent = copyBtn.innerHTML;
      
      let text = header.dataset.title + "\n";
      text += "(" + header.dataset.period + ")\n\n";
      
      reports.forEach((report, index) => {
        text += (index + 1) + ". " + report.dataset.nickname + "ë‹˜ [" + report.dataset.identity + "]\n";
        text += "- ì „ì²´ ë‹¬ì„±ë¥ : " + report.dataset.achieve + "%\n";
        
        const routines = JSON.parse(report.dataset.routines || "[]");
        if (routines.length > 0) {
          text += "- ìƒì„¸ í•­ëª©: ";
          text += routines.map(r => r.name + "(" + r.rate + "%)").join(", ") + "\n";
        }
        
        text += "  ( " + report.dataset.summary + " )\n\n";
      });
      
      text += "ë£¨í‹´ íŒŒì¸ë”ìŠ¤ëŠ” ì—¬ëŸ¬ë¶„ì˜ ì„±ì¥ì„ ì‘ì›í•©ë‹ˆë‹¤. ğŸ’ª";

      navigator.clipboard.writeText(text).then(() => showSuccess(copyBtn, originalContent));
    });
  });
</script>
