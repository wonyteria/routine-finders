<%= turbo_stream.remove "routine_#{@routine.id}_card" %>
<%= turbo_stream.remove "total_routine_#{@routine.id}_item" %>

<% if current_user.personal_routines.where(deleted_at: nil).none? %>
  <%= turbo_stream.append "total-routine-list" do %>
    <div id="no-total-routines-msg" class="py-16 text-center border-2 border-dashed border-slate-100 rounded-3xl">
      <p class="text-xs font-bold text-slate-300 italic">아직 등록된 루틴이 없습니다.</p>
    </div>
  <% end %>
<% end %>

<%# Update stats in sidebar if needed %>
<%= turbo_stream.update "total-active-count" do %>
  <%= current_user.personal_routines.count %> Active
<% end %>

<%= turbo_stream.update "monthly-done-count" do %>
  <%= @monthly_completions&.count || 0 %>
<% end %>

<%= turbo_stream.update "achievement-matrix" do %>
  <%= render "shared/achievement_matrix" %>
<% end %>
<%# Update Prototype Progress if in prototype view %>
<% 
  current_wday = Date.current.wday.to_s
  todays_routines = current_user.personal_routines.where(deleted_at: nil).select { |r| (r.days || []).map(&:to_s).include?(current_wday) }
  joined_participations = current_user ? current_user.participations.active.joins(:challenge) : []
  
  routine_total = todays_routines.count
  routine_done = todays_routines.select(&:completed_today?).count
  
  # Progress Calculation (Strictly Routine Only)
  total_task_count = routine_total
  completed_count = routine_done
  progress = total_task_count.positive? ? (completed_count.to_f / total_task_count * 100).to_i : 0
%>
<% 
  orbit_total_particles = [User.joins(:rufa_activities).where("rufa_activities.created_at >= ?", 30.minutes.ago).distinct.count, 1].max
%>
<%= turbo_stream.replace "prototype-orbit-section" do %>
  <%= render partial: "prototype/orbit", locals: { 
        progress: progress, 
        completed_count: completed_count, 
        total_task_count: total_task_count,
        orbit_total_particles: orbit_total_particles,
        orbit_users: [],
        todays_routines: todays_routines
      } %>
<% end %>
