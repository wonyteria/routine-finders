<!DOCTYPE html>
<html class="scroll-smooth overflow-x-hidden" style="scrollbar-gutter: stable;">
  <head>
    <title>루틴 파인더스 | 성장 루틴 플랫폼</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="flash-notice" content="<%= notice %>">
    <meta name="flash-alert" content="<%= alert %>">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="<%= asset_path('rf_official_logo.png') %>">
    <link rel="icon" type="image/png" sizes="16x16" href="<%= asset_path('rf_official_logo.png') %>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="루파">
    <link rel="apple-touch-icon" href="<%= asset_path('rf_official_logo.png') %>">
    <meta name="theme-color" content="#7C4DFF">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap" rel="stylesheet">
    
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <!-- Kakao SDK -->
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.0/kakao.min.js" crossorigin="anonymous"></script>
    <script>
      if (!Kakao.isInitialized()) {
        Kakao.init('f959f8ada6c21d791ef5be7f4257e19e');
      }
    </script>

    <style>
      :root {
        --app-bg: #0C0B12;
        --app-surface: #1B1A24;
        --app-surface-accent: #252433;
        --app-primary: #7C4DFF;
        --app-primary-glow: rgba(124, 77, 255, 0.4);
        --app-text-main: #FFFFFF;
        --app-text-dim: #8E8D9E;
        --app-border: rgba(255, 255, 255, 0.06);
      }

      body {
        background-color: var(--app-bg);
        color: var(--app-text-main);
        font-family: 'Pretendard', sans-serif;
        -webkit-tap-highlight-color: transparent;
      }

      .app-glass-card {
        background: var(--app-surface);
        border: 1px solid var(--app-border);
        border-radius: 32px;
      }

      .app-fab-gradient {
        background: linear-gradient(135deg, #7C4DFF 0%, #651FFF 100%);
        box-shadow: 0 10px 25px rgba(124, 77, 255, 0.4);
      }

      /* Transitions for Taps */
      .app-tap-active:active {
        transform: scale(0.96);
        transition: transform 0.1s ease;
      }

      /* Animations */
      @keyframes fade-in {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      .animate-fade-in {
        animation: fade-in 0.3s ease-out forwards;
      }

      @keyframes slide-up {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      .animate-slide-up {
        animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      @keyframes scale-up {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
      .animate-scale-up {
        animation: scale-up 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      /* Turbo Frame Handling */
      turbo-frame {
        display: block;
        min-height: 1px;
      }
      /* Hide direct text nodes (like 'Content missing') */
      turbo-frame:not([src]) {
        font-size: 0 !important;
      }
      turbo-frame > * {
        font-size: initial !important;
      }
      /* Loading State */
      turbo-frame[busy] {
        opacity: 0.6;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }

      @keyframes badge-pop {
        0% { transform: translate(-50%, -45%) scale(0.95); opacity: 0; }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      }
      .animate-badge-pop {
        animation: badge-pop 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
    </style>
  </head>

  <body class="min-h-screen overflow-x-hidden" data-controller="proto-ui toast loading" data-logged-in="<%= logged_in? %>">


    <main data-controller="modal" class="w-full max-w-md mx-auto min-h-screen relative pt-14 pb-40 px-4 bg-[#0C0B12] z-0 isolate">
      <%= yield %>
    </main>

    <!-- 1. Routine Record Bottom Sheet -->
    <div id="record-sheet" class="hidden fixed inset-0 z-[11000] flex items-center justify-center p-4">
      <div onclick="document.getElementById('record-sheet').classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="absolute inset-0 bg-black/80 backdrop-blur-md cursor-pointer"></div>
      <div class="relative w-full max-w-md bg-[#1B1A24] rounded-[40px] p-8 pb-10 animate-slide-up border border-white/10 shadow-[0_20px_60px_rgba(0,0,0,0.5)] z-10 max-h-[90vh] overflow-y-auto hide-scrollbar modal-content-safe">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <h3 class="text-xl font-black text-white mb-2 text-center">오늘의 루틴 기록</h3>
        <p class="text-xs font-bold text-indigo-400 mb-8 text-center uppercase tracking-widest leading-none">Record your success</p>
        
        <%= form_with url: prototype_record_path, method: :post, class: "space-y-6" do |f| %>
          <%= f.hidden_field :activity_type, value: "routine_record" %>
          <div class="space-y-4">
            <%= f.text_area :body, 
                            placeholder: "오늘 어떤 루틴을 지켰나요? 자신에게 한 마디 남겨보세요.", 
                            autofocus: true,
                            class: "w-full min-h-[160px] bg-white/5 border-2 border-white/10 rounded-3xl p-6 text-white text-base font-bold placeholder:text-white/20 focus:border-indigo-500 focus:ring-0 transition-all resize-none shadow-inner" %>
            
            <div class="flex items-center gap-3 p-4 bg-indigo-500/10 rounded-2xl border border-indigo-500/20">
              <span class="text-xl">✨</span>
              <p class="text-[11px] font-bold text-indigo-300">작성한 기록은 '시너지' 피드에 공유되어 다른 멤버들의 성장을 응원하게 됩니다.</p>
            </div>
          </div>

          <div class="flex gap-3">
             <button type="button" onclick="document.getElementById('record-sheet').classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="px-6 py-4 rounded-2xl bg-white/5 text-slate-500 font-black text-sm">취소</button>
             <%= f.submit "기록 저장하기", class: "flex-1 py-4 rounded-2xl app-fab-gradient text-white font-black text-sm shadow-xl active:scale-95 transition-all cursor-pointer" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- 1-2. Today's Commitment Bottom Sheet -->
    <div id="commitment-sheet" class="hidden fixed inset-0 z-[11000] flex items-center justify-center p-4">
      <div onclick="document.getElementById('commitment-sheet').classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="absolute inset-0 bg-black/80 backdrop-blur-md cursor-pointer"></div>
      <div class="relative w-full max-w-md bg-[#1B1A24] rounded-[40px] p-8 pb-10 animate-slide-up border border-white/10 shadow-[0_20px_60px_rgba(0,0,0,0.5)] z-10 max-h-[90vh] overflow-y-auto hide-scrollbar modal-content-safe">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <h3 class="text-xl font-black text-white mb-2 text-center">오늘의 다짐</h3>
        <p class="text-xs font-bold text-rose-400 mb-8 text-center uppercase tracking-widest leading-none">Declare your commitment</p>
        
        <%= form_with url: prototype_record_path, method: :post, class: "space-y-6" do |f| %>
          <%= f.hidden_field :activity_type, value: "reflection" %>
          <div class="space-y-4">
            <%= f.text_area :body, 
                            placeholder: "오늘 하루를 어떻게 보내고 싶나요? 당당하게 선언해보세요!", 
                            autofocus: true,
                            class: "w-full min-h-[160px] bg-white/5 border-2 border-white/10 rounded-3xl p-6 text-white text-base font-bold placeholder:text-white/20 focus:border-rose-500/50 focus:ring-0 transition-all resize-none shadow-inner" %>
            
            <div class="flex items-center gap-3 p-4 bg-rose-500/10 rounded-2xl border border-rose-500/20">
              <span class="text-xl">🔥</span>
              <p class="text-[11px] font-bold text-rose-300">오늘의 다짐은 나뿐만 아니라 동료들에게도 큰 자극이 됩니다.</p>
            </div>
          </div>

          <div class="flex gap-3">
             <button type="button" onclick="document.getElementById('commitment-sheet').classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="px-6 py-4 rounded-2xl bg-white/5 text-slate-500 font-black text-sm">취소</button>
             <%= f.submit "다짐 선언하기", class: "flex-1 py-4 rounded-2xl bg-gradient-to-r from-rose-500 to-orange-500 text-white font-black text-sm shadow-xl shadow-rose-500/20 active:scale-95 transition-all cursor-pointer" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- 2. FAB Menu Sheet (Simple List Style) -->
    <div id="fab-menu-sheet" class="hidden fixed inset-0 z-[50000] flex items-center justify-center p-4">
      <div id="fab-menu-overlay"
           onclick="window.toggleFabMenu && window.toggleFabMenu()" 
           class="absolute inset-0 bg-black/80 backdrop-blur-md cursor-pointer transition-opacity z-0"></div>
      <div id="fab-menu-content"
           class="relative w-full max-w-md bg-[#1B1A24] rounded-[40px] p-8 pb-10 border border-white/10 shadow-[0_20px_60px_rgba(0,0,0,0.5)] max-h-[90vh] overflow-y-auto hide-scrollbar modal-content-safe z-10">

        
        <div class="space-y-4">
          <% 
            membership = current_user&.routine_club_members&.active&.first
            is_club_member = (current_user&.admin? || membership.present?)
            user_level = (current_user&.total_routine_completions || 0) / 10 # Simple level logic for proto
          %>

          <!-- 1. Create Routine -->
          <a href="<%= prototype_routine_builder_path %>" 
             data-action="click->proto-ui#checkLogin"
             class="block w-full p-5 rounded-3xl bg-white/5 border border-white/5 hover:bg-white/10 text-left group active:scale-[0.98] transition-all">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-2xl bg-[#0C0B12] flex items-center justify-center border border-white/10">
                <span class="text-2xl">📝</span>
              </div>
              <div class="flex-1">
                <p class="text-white font-bold text-base">내 루틴 만들기</p>
                <p class="text-slate-500 text-xs font-bold mt-0.5">나만의 데일리 루틴 설정</p>
              </div>
            </div>
          </a>



          <!-- 2. Create Challenge -->
          <a href="<%= (is_club_member || user_level >= 10) ? prototype_challenge_builder_path : "#" %>" 
             data-action="click->proto-ui#checkLogin"
             onclick="<%= (is_club_member || user_level >= 10) ? "" : "alert('레벨 10 달성 또는 루파 클럽 가입 시 개설 가능합니다!'); return false;" %>"
             class="block w-full p-5 rounded-3xl bg-white/5 border border-white/5 hover:bg-white/10 text-left group active:scale-[0.98] transition-all relative overflow-hidden">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-[#0C0B12] flex items-center justify-center border border-white/10">
                  <span class="text-2xl">🚩</span>
                </div>
                <div class="flex-1">
                  <p class="text-white font-bold text-base">챌린지 만들기</p>
                  <p class="text-slate-500 text-xs font-bold mt-0.5">함께 성장하는 목표 달성</p>
                </div>
              </div>
              <% if is_club_member %>
                <span class="px-2 py-1 bg-indigo-500 text-white text-[8px] font-black rounded-lg shadow-glow shadow-indigo-500/20">PREMIUM</span>
              <% elsif user_level < 10 %>
                <div class="flex items-center gap-1 px-2 py-1 bg-white/10 rounded-lg">
                  <span class="text-[9px] font-black text-slate-400 italic">Lv.10</span>
                  <span class="text-[10px]">🔒</span>
                </div>
              <% end %>
            </div>
          </a>

          <!-- 3. Create Gathering -->
          <a href="<%= (is_club_member || user_level >= 10) ? prototype_gathering_builder_path : "#" %>" 
             data-action="click->proto-ui#checkLogin"
             onclick="<%= (is_club_member || user_level >= 10) ? "" : "alert('레벨 10 달성 또는 루파 클럽 가입 시 개설 가능합니다!'); return false;" %>"
             class="block w-full p-5 rounded-3xl bg-white/5 border border-white/5 hover:bg-white/10 text-left group active:scale-[0.98] transition-all relative overflow-hidden">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-[#0C0B12] flex items-center justify-center border border-white/10">
                  <span class="text-2xl">💬</span>
                </div>
                <div class="flex-1">
                  <p class="text-white font-bold text-base">모임 만들기</p>
                  <p class="text-slate-500 text-xs font-bold mt-0.5">취향과 관심사 공유</p>
                </div>
              </div>
              <% if is_club_member %>
                <span class="px-2 py-1 bg-indigo-500 text-white text-[8px] font-black rounded-lg shadow-glow shadow-indigo-500/20">PREMIUM</span>
              <% elsif user_level < 10 %>
                <div class="flex items-center gap-1 px-2 py-1 bg-white/10 rounded-lg">
                  <span class="text-[9px] font-black text-slate-400 italic">Lv.10</span>
                  <span class="text-[10px]">🔒</span>
                </div>
              <% end %>
            </div>
          </a>

          <!-- 4. 루파클럽 상태 및 혜택 (Bottom Highlight) -->
          <% if is_club_member %>
            <button type="button" 
                    data-action="click->proto-ui#openModal"
                    data-modal-id="membership-master-modal"
                    onclick="document.getElementById('membership-master-modal').classList.remove('hidden'); document.getElementById('fab-menu-sheet').classList.add('hidden'); document.body.classList.add('overflow-hidden')"
                    class="block w-full p-5 rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 text-left group active:scale-[0.98] transition-all shadow-lg shadow-indigo-600/20 cursor-pointer">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-white p-2 flex items-center justify-center backdrop-blur-sm shadow-inner">
                  <%= image_tag "rf_official_logo.png", class: "w-full h-full object-contain" %>
                </div>
                <div class="flex-1">
                  <p class="text-white font-black text-lg">나의 멤버십 혜택</p>
                  <p class="text-indigo-100 text-xs font-bold mt-0.5">
                    🎟️ <%= membership&.remaining_relax_passes || 0 %> · 
                    🛡️ <%= membership&.remaining_save_passes || 0 %> · 
                    ⚡ <%= number_with_delimiter(membership&.growth_points || 0) %>P
                  </p>
                </div>
                <svg class="w-6 h-6 text-white opacity-50 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/></svg>
              </div>
            </button>
              <% else %>
            <a href="/club_join" 
               data-action="click->proto-ui#checkLogin"
               class="block w-full p-5 rounded-3xl bg-gradient-to-r from-indigo-600 to-purple-600 text-left group active:scale-[0.98] transition-all shadow-lg shadow-indigo-600/20">
              <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-white p-2 flex items-center justify-center backdrop-blur-sm shadow-inner overflow-hidden">
                  <%= image_tag "rf_official_logo.png", class: "w-full h-full object-contain" %>
                </div>
                <div class="flex-1">
                  <p class="text-white font-black text-lg">루파 클럽 가입</p>
                  <p class="text-indigo-100 text-xs font-bold mt-0.5">레벨 제한 없이 즉시 리더가 되세요</p>
                </div>
                <svg class="w-6 h-6 text-white opacity-50 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 5l7 7-7 7"/></svg>
              </div>
            </a>
          <% end %>
        </div>


      </div>
    </div>
    
    <!-- 1. 이용약관 모달 -->
    <div id="terms-modal" class="hidden fixed inset-0 z-[600]">
      <div onclick="document.getElementById('terms-modal').classList.add('hidden')" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
      <div class="absolute bottom-0 left-0 right-0 max-w-md mx-auto bg-[#1B1A24] rounded-t-[40px] p-8 pb-12 animate-slide-up border-t border-white/10 max-h-[80vh] overflow-y-auto modal-content-safe">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <h3 class="text-xl font-black text-white mb-6 text-center">서비스 이용안내 및 약관</h3>
        <div class="space-y-6 text-sm text-slate-400 font-bold leading-relaxed px-2">
          <div class="space-y-2">
            <p class="text-white">제 1조 (플랫폼의 성격)</p>
            <p>'루틴 파인더스'(이하 "플랫폼")는 개인 개발자가 성장의 즐거움을 나누기 위해 제작한 개인 운영 플랫폼입니다. 누구나 자유롭게 자신만의 루틴을 세우고, 챌린지와 모임을 개설하여 함께 성장하는 것을 목표로 합니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">제 2조 (서비스의 제공)</p>
            <p>본 플랫폼은 개인의 기록을 돕는 루틴 기록 도구와 타인과 소통할 수 있는 챌린지 및 모임 운영 도구를 제공합니다. 플랫폼은 도구를 제공할 뿐, 각 챌린지와 모임의 운영 주체는 해당 기능을 개설한 사용자(호스트)에게 있습니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">제 3조 (이용자의 권리와 책임)</p>
            <p>1. 사용자는 플랫폼 내에서 타인에게 긍정적인 자극과 응원을 전하는 것을 원칙으로 합니다.</p>
            <p>2. 개인이 운영하는 공간인 만큼 타인의 명예를 훼손하거나 커뮤니티의 질서를 어지럽히는 행위에 대해서는 운영자가 이용을 제한할 수 있습니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">제 4조 (서비스 운영에 관한 사항)</p>
            <p>개인 개발자가 관리하는 플랫폼 특성상 예기치 못한 점검이나 기능 업데이트가 잦을 수 있습니다. 운영자는 최선을 다해 안정적인 서비스를 제공하려 노력하되, 시스템 장애로 인한 데이터 손실 등에 대해서는 완전한 책임을 지기 어려움을 양해 부탁드립니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">제 5조 (저작권 및 상호 존중)</p>
            <p>본 서비스 내의 디자인과 로직은 운영자의 소중한 자산입니다. 또한 사용자가 올린 게시글의 저작권은 사용자에게 있으며, 서로의 개인적 창작물과 노력을 존중해야 합니다.</p>
          </div>
          <div class="pt-8 text-center">
            <button onclick="document.getElementById('terms-modal').classList.add('hidden')" class="w-full py-4 bg-indigo-600 rounded-2xl text-white font-black text-sm hover:bg-indigo-500 transition-colors shadow-lg shadow-indigo-600/20">플랫폼과 함께 성장하겠습니다</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. 개인정보처리방침 모달 -->
    <div id="privacy-modal" class="hidden fixed inset-0 z-[600]">
      <div onclick="document.getElementById('privacy-modal').classList.add('hidden')" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
      <div class="absolute bottom-0 left-0 right-0 max-w-md mx-auto bg-[#1B1A24] rounded-t-[40px] p-8 pb-12 animate-slide-up border-t border-white/10 max-h-[80vh] overflow-y-auto modal-content-safe">
        <div class="w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-8"></div>
        <h3 class="text-xl font-black text-white mb-6 text-center">개인정보 처리 및 보호 안내</h3>
        <div class="space-y-6 text-sm text-slate-400 font-bold leading-relaxed px-2">
          <div class="space-y-2">
            <p class="text-white">1. 최소한의 정보만 수집합니다</p>
            <p>운영자는 카카오 로그인을 통해 제공받는 최소한의 정보(닉네임, 프로필 이미지 등)와 사용자가 직접 작성하는 루틴 기록만을 수집하며, 이를 상업적으로 판매하거나 불법적으로 사용하지 않습니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">2. 정보의 소중한 활용</p>
            <p>수집된 정보는 플랫폼 내에서 친구들과 루틴 현황을 공유하고, 본인이 개설한 챌린지나 모임을 관리하기 위한 용도로만 사용됩니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">3. 보관 및 파기 원칙</p>
            <p>사용자의 데이터는 플랫폼 이용 기간 동안 안전하게 보관되며, 탈퇴 시 지체 없이 파기됩니다. 다만, 커뮤니티 성격상 본인이 작성하여 타인과 공유한 게시물은 서비스 품질 유지를 위해 남을 수 있습니다.</p>
          </div>
          <div class="space-y-2">
            <p class="text-white">4. 개인 개발자의 약속</p>
            <p>운영자는 사용자의 개인정보를 제3자에게 임의로 제공하지 않으며, 보안 수칙을 가이드에 따라 철저히 준수하여 정보를 보호하겠습니다.</p>
          </div>
          <div class="pt-8 text-center">
            <button onclick="document.getElementById('privacy-modal').classList.add('hidden')" class="w-full py-4 bg-emerald-600 rounded-2xl text-white font-black text-sm hover:bg-emerald-500 transition-colors shadow-lg shadow-emerald-600/20">운영자를 신뢰하고 시작합니다</button>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. Badge Celebration Modal -->
    <% if @new_badges&.any? %>
      <% @new_badges.each_with_index do |ub, idx| %>
        <div id="badge-celebration-<%= idx %>" class="fixed inset-0 z-[99990] flex items-center justify-center p-6 bg-[#0C0B12] <%= 'hidden' if idx > 0 %>">
          <div class="absolute inset-0 bg-[#0C0B12] animate-fade-in"></div>
          
          <div class="relative w-full max-w-sm app-glass-card border-white/20 p-10 text-center space-y-8 animate-badge-pop">
            <!-- Particle Effect Decoration -->
            <div class="absolute inset-0 overflow-hidden rounded-[32px] pointer-events-none">
              <div class="absolute top-0 left-1/4 w-20 h-20 bg-indigo-500/20 blur-3xl animate-pulse"></div>
              <div class="absolute bottom-0 right-1/4 w-20 h-20 bg-purple-500/20 blur-3xl animate-pulse delay-700"></div>
            </div>

            <div class="space-y-6 relative z-10">
              <div class="w-32 h-32 rounded-[40px] bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-6xl mx-auto shadow-[0_20px_50px_rgba(124,77,255,0.5)] animate-float">
                <%= ub.badge.icon_path.presence || "🏆" %>
              </div>
              
              <div class="space-y-2">
                <p class="text-xs font-black text-indigo-400 uppercase tracking-[0.3em] animate-fade-in">New Identity Earned</p>
                <h3 class="text-3xl font-black text-white leading-tight"><%= ub.badge.name %></h3>
              </div>
              
              <p class="text-sm font-bold text-slate-400 leading-relaxed px-4">
                "<%= ub.badge.description %>"<br/>
                루파님의 성장이 새로운 증거를 남겼습니다!
              </p>
            </div>

            <div class="pt-4 relative z-10">
              <button onclick="this.closest('.fixed').classList.add('hidden'); 
                               const next = document.getElementById('badge-celebration-<%= idx + 1 %>');
                               if(next) { next.classList.remove('hidden'); } 
                               else { document.body.classList.remove('overflow-hidden'); }"
                      class="w-full py-4 bg-indigo-500 text-white font-black text-sm rounded-2xl shadow-xl active:scale-95 transition-all">
                확인했어요
              </button>
            </div>
          </div>
          
          <!-- Confetti Overlay (CSS Only) -->
          <div class="absolute inset-0 pointer-events-none overflow-hidden">
            <% 20.times do %>
              <div class="confetti" style="left: <%= rand(100) %>%; animation-delay: <%= rand(3000) %>ms; background-color: <%= ['#7C4DFF', '#FFD700', '#00E676', '#FF1744'].sample %>;"></div>
            <% end %>
          </div>
        </div>
      <% end %>
      
      <script>
        (function() {
          const markAsViewed = () => {
            const badgeCelebration = document.querySelector('[id^="badge-celebration-"]');
            if (!badgeCelebration || window.badgesMarkedAsViewed) return;
            
            fetch('/mark_badges_viewed', { 
              method: 'POST', 
              headers: { 
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content 
              },
              body: JSON.stringify({ badge_ids: <%= @new_badges.map(&:id).to_json %> })
            }).then(() => {
              window.badgesMarkedAsViewed = true;
            });
          };

          document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.add('overflow-hidden');
            markAsViewed();
          });
          document.addEventListener('turbo:load', () => {
            const celebration = document.querySelector('[id^="badge-celebration-"]');
            if (celebration) {
              document.body.classList.add('overflow-hidden');
              markAsViewed();
            }
          });
        })();
      </script>

      <style>
        @keyframes badge-pop {
          0% { transform: scale(0.5); opacity: 0; }
          70% { transform: scale(1.05); }
          100% { transform: scale(1); opacity: 1; }
        }
        @keyframes rotate-slow {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        @keyframes fade-in {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes float {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-10px); }
        }
        .animate-badge-pop { animation: badge-pop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .animate-fade-in { animation: fade-in 0.5s ease-out forwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .confetti {
          position: absolute;
          top: -20px;
          width: 10px;
          height: 10px;
          border-radius: 2px;
          animation: fall linear 3s infinite;
        }
        @keyframes fall {
          to { transform: translateY(100vh) rotate(720deg); }
        }
      </style>
    <% end %>
    <% if flash[:is_rufa_pending] %>
      <div id="rufa-pending-modal" class="fixed inset-0 z-[3000] flex items-center justify-center p-6">
        <div onclick="this.parentElement.remove(); document.body.classList.remove('overflow-hidden')" class="absolute inset-0 bg-black/90 backdrop-blur-xl"></div>
        <div class="relative w-full max-w-sm app-glass-card border-white/20 p-10 flex flex-col items-center text-center space-y-6 animate-badge-pop bg-[#16151D] m-0">
          <div class="w-24 h-24 bg-amber-500 rounded-[32px] flex items-center justify-center text-5xl shadow-2xl shadow-amber-500/50">⌛</div>
          <div class="space-y-2">
            <h3 class="text-2xl font-black text-white">클럽 가입 확인 중</h3>
            <p class="text-sm font-bold text-slate-400">호스트가 입금을 확인하고 있습니다.<br/>승인이 완료되면 루파 전용 혜택을<br/>즉시 이용하실 수 있습니다.</p>
          </div>
          <div class="w-full pt-4 space-y-3">
             <button onclick="this.closest('#rufa-pending-modal').remove(); document.body.classList.remove('overflow-hidden')" 
                     class="w-full py-4 bg-amber-500 text-white font-black rounded-2xl active:scale-95 transition-all focus:outline-none">확인했습니다</button>
             <%= link_to guide_routine_clubs_path(source: 'prototype'), class: "block text-xs font-bold text-slate-500 hover:text-white transition-colors" do %>
               자세한 안내 보기
             <% end %>
          </div>
        </div>
      </div>
      <script>document.body.classList.add('overflow-hidden');</script>
    <% end %>

    <!-- 3. Membership Master Center Modal (Comprehensive) -->
    <% if current_user && is_club_member %>
      <% 
        official_club = RoutineClub.official.first
        membership = current_user.routine_club_members.active.first
      %>
      <div id="membership-master-modal" class="hidden fixed inset-0 z-[32000] flex items-center justify-center p-6">
        <div onclick="this.parentElement.classList.add('hidden'); document.body.classList.remove('overflow-hidden')" class="absolute inset-0 bg-black/95 backdrop-blur-2xl"></div>
        
        <div class="relative w-full max-w-md bg-gradient-to-b from-[#1E1C28] to-[#0C0B12] rounded-[48px] border border-white/10 shadow-[0_0_100px_rgba(79,70,229,0.3)] overflow-y-auto max-h-[90vh] hide-scrollbar animate-badge-pop">
          <!-- Glow Decor -->
          <div class="absolute -top-24 -left-24 w-64 h-64 bg-indigo-600/20 blur-[100px] rounded-full"></div>
          
          <div class="relative z-10 p-8 space-y-10">
            <!-- Header: Member Identity -->
            <div class="text-center space-y-4">
              <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20">
                <span class="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-pulse"></span>
                <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest leading-none">Premium Membership</span>
              </div>
              <div class="space-y-1">
                <h3 class="text-2xl font-black text-white">루파 <%= official_club&.generation_number %>기 정식 멤버</h3>
                <p class="text-xs font-bold text-slate-400">당신의 성장은 이제 특별한 시스템으로 관리됩니다.</p>
              </div>
            </div>

            <!-- Benefits Grid -->
            <div class="grid grid-cols-2 gap-3">
              <div class="p-4 rounded-3xl bg-white/[0.03] border border-white/5 space-y-2">
                <span class="text-2xl">🎟️</span>
                <p class="text-xs font-black text-white">20% 자동 할인</p>
                <p class="text-[9px] font-bold text-slate-500">모든 유료 활동 즉시 할인</p>
              </div>
              <div class="p-4 rounded-3xl bg-white/[0.03] border border-white/5 space-y-2">
                <span class="text-2xl">⚖️</span>
                <p class="text-xs font-black text-white">아이템 마스터</p>
                <p class="text-[9px] font-bold text-slate-500">매월 휴식/세이브권 충전</p>
              </div>
              <div class="p-4 rounded-3xl bg-white/[0.03] border border-white/5 space-y-2">
                <span class="text-2xl">🏛️</span>
                <p class="text-xs font-black text-white">라운지 입장권</p>
                <p class="text-[9px] font-bold text-slate-500">전용 강의 및 세션 참여</p>
              </div>
              <div class="p-4 rounded-3xl bg-white/[0.03] border border-white/5 space-y-2">
                <span class="text-2xl">✨</span>
                <p class="text-xs font-black text-white">골든 아우라</p>
                <p class="text-[9px] font-bold text-slate-500">프로필 전용 효과 적용</p>
              </div>
            </div>

            <!-- Item Management Section -->
            <div class="space-y-5 pt-4 border-t border-white/5">
              <div class="flex items-center justify-between px-1">
                <h4 class="text-[11px] font-black text-indigo-400 uppercase tracking-[0.2em]">아이템 인벤토리</h4>
                <div class="flex items-center gap-1.5">
                  <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                  <span class="text-[9px] font-black text-slate-500 uppercase">System Ready</span>
                </div>
              </div>

              <!-- Date Selection -->
              <div class="relative group">
                <input type="date" 
                       id="master-center-date-picker"
                       value="<%= Date.current.to_s %>"
                       max="<%= Date.current.to_s %>"
                       class="w-full bg-black/40 border border-white/10 rounded-2xl p-4 text-white text-sm font-bold focus:border-indigo-500 outline-none transition-all appearance-none"
                       onchange="document.querySelectorAll('.master-center-date').forEach(input => input.value = this.value)">
                <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                </div>
              </div>

              <!-- Pass Buttons -->
              <div class="grid grid-cols-1 gap-3">
                <%= form_with url: use_pass_routine_club_path(official_club, pass_type: 'relax', source: 'prototype'), method: :post, id: "master-relax-form", class: "contents" do |f| %>
                  <%= f.hidden_field :date, value: Date.current, class: "master-center-date" %>
                  <button type="button" 
                          <% if membership&.remaining_relax_passes.to_i <= 0 %>disabled<% end %>
                          onclick="requestItemUse('master-relax-form', '휴식권을 사용하시겠습니까?', '해당 날짜가 공식 휴가로 처리됩니다.', '🎟️')"
                          class="w-full p-5 rounded-3xl bg-white/[0.03] border border-white/5 hover:border-indigo-500/40 hover:bg-indigo-500/5 transition-all text-left flex gap-4 items-center group disabled:opacity-30">
                    <div class="w-14 h-14 rounded-2xl bg-indigo-500/10 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">🎟️</div>
                    <div>
                      <div class="flex items-center gap-2 mb-0.5">
                        <span class="text-sm font-black text-white">휴식권</span>
                        <span class="px-1.5 py-0.5 bg-indigo-500/20 rounded text-[8px] font-black text-indigo-400"><%= membership&.remaining_relax_passes || 0 %>개 남음</span>
                      </div>
                      <p class="text-[10px] font-bold text-slate-500 leading-tight whitespace-nowrap truncate">공식 휴가로 처리되어 출석이 유지됩니다.</p>
                    </div>
                  </button>
                <% end %>

                <%= form_with url: use_pass_routine_club_path(official_club, pass_type: 'save', source: 'prototype'), method: :post, id: "master-save-form", class: "contents" do |f| %>
                  <%= f.hidden_field :date, value: Date.current, class: "master-center-date" %>
                  <button type="button" 
                          <% if membership&.remaining_save_passes.to_i <= 0 %>disabled<% end %>
                          onclick="requestItemUse('master-save-form', '세이브권을 사용하시겠습니까?', '지나간 결석을 출석으로 복구합니다.', '🛡️')"
                          class="w-full p-5 rounded-3xl bg-white/[0.03] border border-white/5 hover:border-emerald-500/40 hover:bg-emerald-500/5 transition-all text-left flex gap-4 items-center group disabled:opacity-30">
                    <div class="w-14 h-14 rounded-2xl bg-emerald-500/10 flex items-center justify-center text-2xl group-hover:scale-110 transition-transform">🛡️</div>
                    <div>
                      <div class="flex items-center gap-2 mb-0.5">
                        <span class="text-sm font-black text-white">세이브권</span>
                        <span class="px-1.5 py-0.5 bg-emerald-500/20 rounded text-[8px] font-black text-emerald-400"><%= membership&.remaining_save_passes || 0 %>개 남음</span>
                      </div>
                      <p class="text-[10px] font-bold text-slate-500 leading-tight whitespace-nowrap truncate">지나간 결석을 출석으로 긴급 복구합니다.</p>
                    </div>
                  </button>
                <% end %>
              </div>
            </div>

            <!-- Footer: Navigation -->
            <div class="pt-2 pb-6 flex flex-col items-center gap-4">
               <%= link_to '/achievement_report', class: "text-xs font-black text-indigo-400 hover:text-white transition-colors" do %>
                 상세 성장 분석 보러가기 →
               <% end %>
               <button onclick="this.closest('#membership-master-modal').classList.add('hidden'); document.body.classList.remove('overflow-hidden')"
                       class="w-full py-4.5 bg-white/5 text-slate-500 font-bold text-sm rounded-2xl hover:text-white transition-colors">
                 닫기
               </button>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    
    <!-- Global Item Confirmation Modal -->
    <div id="item-confirm-modal" class="hidden fixed inset-0 z-[100000] flex items-center justify-center p-6">
      <div onclick="document.getElementById('item-confirm-modal').classList.add('hidden')" class="absolute inset-0 bg-black/95 backdrop-blur-xl"></div>
      <div class="relative w-full max-w-sm app-glass-card border-white/20 p-8 text-center space-y-6 animate-badge-pop bg-[#16151D]">
        <div class="w-20 h-20 bg-indigo-500/20 rounded-[28px] flex items-center justify-center text-4xl mx-auto confirm-icon">🔮</div>
        <div class="space-y-2">
          <h3 class="text-2xl font-black text-white confirm-title">아이템을 사용하시겠습니까?</h3>
          <p class="text-sm font-bold text-slate-400 leading-relaxed px-4 confirm-subtitle">사용 후에는 취소할 수 없습니다.</p>
        </div>
        <div class="grid grid-cols-2 gap-3 pt-4">
          <button onclick="document.getElementById('item-confirm-modal').classList.add('hidden')" class="py-4 bg-white/5 text-slate-500 font-black rounded-2xl active:scale-95 transition-all">취소</button>
          <button id="item-confirm-submit" class="py-4 bg-indigo-500 text-white font-black rounded-2xl active:scale-95 transition-all shadow-lg shadow-indigo-500/20">사용하기</button>
        </div>
      </div>
    </div>

    <!-- Global User Profile Modal Frame -->
    <turbo-frame id="user-profile-modal-frame"></turbo-frame>

    <!-- Daily Greeting Modal (Priority Layer) -->
    <% if flash[:show_daily_greeting] && current_user && !@show_club_welcome_modal %>
      <%= render 'shared/daily_greeting' %>
    <% end %>

    <!-- 0. Club Member Welcome Modal (Master Celebration - Global Layer) -->
    <% if @show_club_welcome_modal %>
      <div id="club-welcome-celebration" class="fixed inset-0 z-[99999] flex items-center justify-center p-6 bg-[#0C0B12]">
        <div class="relative w-full max-w-md bg-gradient-to-b from-[#1E1C28] to-[#0C0B12] rounded-[40px] border border-white/10 shadow-[0_0_100px_rgba(79,70,229,0.3)] overflow-y-auto max-h-[90vh] animate-badge-pop">
          <!-- Glow Decor -->
          <div class="absolute -top-24 -left-24 w-64 h-64 bg-indigo-600/30 blur-[100px] rounded-full animate-pulse"></div>
          <div class="absolute -bottom-24 -right-24 w-64 h-64 bg-purple-600/20 blur-[100px] rounded-full"></div>
          
          <!-- Content -->
          <div class="relative z-10 p-6 flex flex-col items-center text-center space-y-6">
            <!-- Visual Badge -->
            <div class="relative group">
              <div class="absolute inset-0 bg-indigo-500 blur-2xl opacity-20 group-hover:opacity-40 transition-opacity"></div>
              <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 rounded-[32px] flex items-center justify-center text-5xl shadow-2xl relative z-10 border border-white/20">
                👑
              </div>
              <!-- Orbiting dots decor -->
              <div class="absolute -inset-4 border-2 border-dashed border-indigo-500/20 rounded-full animate-spin-slower"></div>
            </div>

            <div class="space-y-3">
              <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20 mb-2">
                <span class="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-pulse"></span>
                <span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest leading-none">Membership Approved</span>
              </div>
              <h2 class="text-2xl font-black text-white leading-tight">
                환영합니다, 루파님!<br/>
                이제 <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400"><%= @routine_club.generation_number %>기 정식 멤버</span>입니다.
              </h2>
              <p class="text-sm font-bold text-slate-400">당신의 성장을 가속화할 전용 시스템이 활성화되었습니다.</p>
            </div>

            <!-- Benefits Summary Card -->
            <div class="w-full bg-white/[0.03] border border-white/5 rounded-[24px] p-5 space-y-3">
              <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest text-left pl-1">Unlocked Member Benefits</p>
              <div class="grid grid-cols-1 gap-3 text-left">
                <div class="flex items-center gap-4 group">
                  <div class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center text-xl shrink-0">🔮</div>
                  <div class="space-y-0.5">
                    <p class="text-xs font-black text-white">아이템 마스터 권한</p>
                    <p class="text-[10px] font-bold text-slate-500 leading-tight">매월 3장의 휴식권/세이브권 자동 리필</p>
                  </div>
                </div>
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-xl bg-rose-500/10 flex items-center justify-center text-xl shrink-0">🎟️</div>
                  <div class="space-y-0.5">
                    <p class="text-xs font-black text-white">상시 20% 자동 할인</p>
                    <p class="text-[10px] font-bold text-slate-500 leading-tight">모든 챌린지 및 모임 참가비 즉시 할인</p>
                  </div>
                </div>
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center text-xl shrink-0">🏛️</div>
                  <div class="space-y-0.5">
                    <p class="text-xs font-black text-white">프라이빗 라운지 입장</p>
                    <p class="text-[10px] font-bold text-slate-500 leading-tight">멤버 전용 딥워크 세션 및 인사이트 강의</p>
                  </div>
                </div>
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center text-xl shrink-0">✨</div>
                  <div class="space-y-0.5">
                    <p class="text-xs font-black text-white">골든 아우라 ID</p>
                    <p class="text-[10px] font-bold text-slate-500 leading-tight">프리미엄 멤버십 전용 프로필 효과 적용</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="w-full pt-4">
              <%= form_with url: mark_welcomed_routine_club_path(@routine_club), method: :post, class: "w-full" do %>
                <button type="submit" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-black rounded-2xl shadow-2xl shadow-indigo-600/40 hover:scale-[1.02] active:scale-95 transition-all outline-none">
                  시스템 시작하기
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
    <!-- CORE SCRIPT: Manual Fab Menu Handler (Circuit Breaker) -->
    <script>
      // Stimulus 로딩 실패를 대비한 안전장치 함수 직접 정의
      window.toggleFabMenu = function() {
        // console.log("🔘 FAB Menu Toggle: Vanilla JS Fallback Executed");
        
        const menu = document.getElementById('fab-menu-sheet');
        if (!menu) return;

        const bg = document.getElementById('fab-menu-overlay');
        const content = document.getElementById('fab-menu-content');

        if (!bg || !content) {
            menu.classList.toggle('hidden');
            document.body.classList.toggle('overflow-hidden');
            return;
        }

        if (menu.classList.contains('hidden')) {
            // [OPEN]
            menu.classList.remove('hidden');
            
            // 1. 초기 스타일 설정 (트랜지션 끄고 시작값 설정)
            bg.style.transition = 'none';
            content.style.transition = 'none';
            
            bg.style.opacity = '0';
            bg.style.backgroundColor = 'rgba(0, 0, 0, 0.8)'; // 강제 배경색 지정
            content.style.transform = 'translateY(100%)';
            
            // 2. 강제 리플로우 (브라우저가 초기값을 인식하도록 함)
            bg.offsetHeight; 
            content.offsetHeight;

            // 3. Double rAF 패턴: 다음 페인트 프레임까지 확실히 기다림
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    // 트랜지션 켜고 목표값 설정
                    bg.style.transition = 'opacity 0.3s ease';
                    content.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                    
                    bg.style.opacity = '1';
                    content.style.transform = 'translateY(0)';
                });
            });
            
            document.body.classList.add('overflow-hidden');
        } else {
            // [CLOSE]
            bg.style.opacity = '0';
            content.style.transform = 'translateY(100%)';

            setTimeout(() => {
                menu.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                
                // 스타일 정리
                content.style.transform = '';
                content.style.transition = '';
                bg.style.opacity = '';
                bg.style.transition = '';
            }, 300);
        }
      };

      // 아이템 사용 확인 팝업 함수
      window.requestItemUse = function(formId, title, subtitle, icon) {
        const modal = document.getElementById('item-confirm-modal');
        if (!modal) return;

        modal.querySelector('.confirm-title').innerText = title;
        modal.querySelector('.confirm-subtitle').innerText = subtitle;
        modal.querySelector('.confirm-icon').innerText = icon;
        
        const submitBtn = document.getElementById('item-confirm-submit');
        submitBtn.onclick = () => {
          const form = document.getElementById(formId);
          if (form) {
            form.requestSubmit(); // Turbo 지원 방식으로 제출
          }
          modal.classList.add('hidden');
        };
        
        modal.classList.remove('hidden');
      };

      // 로그인 체크 함수 Fallback
      window.checkLoginFallback = function(e) {
        const isLoggedIn = document.body.getAttribute('data-logged-in');
        if (isLoggedIn === "false") {
          e.preventDefault();
          window.location.href = '/login';
          return false;
        }
        return true;
      };
    </script>
    <!-- App Bottom Navigation Bar (Standalone Fixed Layer - Moved to Bottom for Z-Index Safety) -->
    <% unless content_for?(:hide_nav) %>
      <div class="fixed bottom-10 inset-x-0 z-[60000] flex justify-center pointer-events-none">
        <div class="w-full max-w-md mx-auto px-4 flex justify-center">
          <nav class="pointer-events-auto w-[92%] max-w-[360px] h-20 bg-[#16151D]/98 backdrop-blur-3xl rounded-[32px] border border-white/10 flex items-center justify-between px-2 shadow-[0_20px_60px_rgba(0,0,0,0.8)]">
            <!-- Left Side Icons -->
            <div class="flex flex-1 justify-around items-center">
              <%= link_to prototype_home_path, class: "flex items-center justify-center w-12 h-12 app-tap-active #{current_page?(prototype_home_path) ? 'text-indigo-400' : 'text-slate-600'}" do %>
                <span class="text-2xl">🏠</span>
              <% end %>

              <%= link_to prototype_explore_path, class: "flex items-center justify-center w-12 h-12 app-tap-active #{current_page?(prototype_explore_path) ? 'text-indigo-400' : 'text-slate-600'}" do %>
                <span class="text-2xl">🧭</span>
              <% end %>
            </div>

            <!-- Master FAB Button -->
            <div class="flex-none px-1 relative">
              <button type="button" 
                      data-action="click->proto-ui#toggleFabMenu" 
                      class="w-16 h-16 app-fab-gradient rounded-full flex items-center justify-center -translate-y-7 shadow-[0_15px_35px_rgba(124,77,255,0.6)] border-4 border-[#0C0B12] active:scale-90 transition-transform cursor-pointer relative z-[61000]">
                <span class="text-2xl text-white font-black leading-none">+</span>
              </button>
            </div>

            <!-- Right Side Icons -->
            <div class="flex flex-1 justify-around items-center">
              <%= link_to prototype_synergy_path, class: "flex items-center justify-center w-12 h-12 app-tap-active #{current_page?(prototype_synergy_path) ? 'text-indigo-400' : 'text-slate-600'}" do %>
                <span class="text-2xl">✨</span>
              <% end %>

              <%= link_to prototype_my_path, 
                          data: { action: "click->proto-ui#checkLogin" },
                          class: "flex items-center justify-center w-12 h-12 app-tap-active #{current_page?(prototype_my_path) ? 'text-indigo-400' : 'text-slate-600'}" do %>
                <span class="text-2xl">👤</span>
              <% end %>
            </div>
          </nav>
        </div>
      </div>
    <% end %>
    <script>
      window.closeUserProfileModal = function() {
        const container = document.getElementById('user-profile-modal-container');
        const frame = document.getElementById('user-profile-modal-frame');
        const overlay = document.getElementById('user-profile-modal-overlay');
        
        if (container) {
          // 1. 애니메이션 시작 (배경 투명화 + 카드 슬라이드)
          container.style.transition = 'all 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
          container.style.backgroundColor = 'transparent';
          container.style.backdropFilter = 'blur(0px)';
          if (overlay) overlay.style.opacity = '0';
          container.classList.add('animate-modal-out');

          // 2. 카드가 사라지는 도중에 다음 페이지 로드를 미리 시작 (핵심!)
          if (window.location.pathname.includes('/user_card/')) {
            setTimeout(() => {
              if (window.Turbo) {
                Turbo.visit('/synergy', { action: 'replace' });
              } else {
                window.location.href = '/synergy';
              }
            }, 100); // 0.1초 후에 바로 이동 시작
          } else {
            // 프레임으로 열린 경우의 마무리
            setTimeout(() => {
              if (frame) {
                frame.innerHTML = '';
                frame.style.display = 'none';
              }
              document.body.classList.remove('overflow-hidden');
            }, 300);
          }
        } else {
          window.location.href = '/synergy';
        }
      };
    </script>
    <turbo-frame id="user-profile-modal-frame" class="hidden"></turbo-frame>
  </body>
</html>
