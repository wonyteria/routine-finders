<div class="space-y-10">
  <% if can_write_review %>
    <!-- Write Review Form (Only for 7+ days participants) -->
    <div class="bg-white/[0.03] p-6 rounded-2xl border border-white/5 space-y-4">
      <div class="space-y-1">
        <h2 class="text-sm font-bold text-white uppercase tracking-widest">챌린지 경험 공유하기</h2>
        <p class="text-slate-400 text-[11px] font-medium">7일 이상의 여정을 다른 참가자들에게도 알려주세요!</p>
      </div>
      
      <%= form_with(model: [challenge, Review.new], class: "space-y-6") do |f| %>
        <div class="space-y-3">
          <p class="text-sm font-black text-slate-300 uppercase tracking-widest">평점 선택</p>
          <div class="flex items-center gap-2" data-controller="rating">
            <% (1..5).each do |star| %>
              <button type="button" 
                      data-action="click->rating#set" 
                      data-rating-value="<%= star %>"
                      class="text-slate-200 hover:text-amber-400 transition-colors">
                <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
              </button>
            <% end %>
            <%= f.hidden_field :rating, data: { rating_target: "input" } %>
          </div>
        </div>

        <div class="space-y-3">
          <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest pl-1">상세 리뷰</p>
          <%= f.text_area :content, 
                          placeholder: "챌린지의 솔직한 후기를 적어주세요. (최소 10자)", 
                          class: "w-full p-5 bg-white/[0.03] border border-white/5 rounded-2xl focus:border-indigo-500 outline-none transition-all min-h-[140px] text-xs font-medium text-white" %>
        </div>

        <div class="flex justify-end">
          <%= f.submit "리뷰 등록하기", class: "px-10 py-4 bg-indigo-600 text-white rounded-3xl font-black text-sm shadow-xl shadow-indigo-600/20 hover:bg-indigo-700 transition-all active:scale-95 cursor-pointer" %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Stats Header -->
  <div class="flex flex-col md:flex-row items-center gap-6 bg-white/[0.03] p-6 rounded-2xl border border-white/5">
    <div class="text-center md:text-left space-y-1">
      <p class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.2em] mb-1">Total Score</p>
      <div class="flex items-end gap-2 text-white font-bold">
        <% dynamic_avg = @reviews.any? ? (@reviews.sum(:rating).to_f / @reviews.count).round(1) : 0 %>
        <span class="text-4xl font-bold"><%= dynamic_avg %></span>
        <span class="text-lg text-slate-500 mb-1">/ 5.0</span>
      </div>
    </div>
    
    <div class="grow flex flex-col gap-2">
      <% [5, 4, 3, 2, 1].each do |star| %>
        <% 
          count = @reviews.select { |r| r.rating == star }.size
          percent = @reviews.any? ? (count.to_f / @reviews.count * 100).to_i : 0
        %>
        <div class="flex items-center gap-4">
          <span class="text-xs font-bold text-slate-400 w-8"><%= star %>점</span>
          <div class="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
            <div class="h-full bg-amber-400" style="width: <%= percent %>%"></div>
          </div>
          <span class="text-xs font-bold text-slate-300 w-8"><%= count %></span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Review List -->
  <div class="space-y-6">
    <% if reviews.any? %>
      <div class="grid grid-cols-1 gap-6">
        <% reviews.each do |review| %>
          <div class="p-6 bg-white/[0.03] border border-white/5 rounded-2xl hover:border-indigo-500/30 transition-all group">
            <div class="flex items-start justify-between gap-4">
              <div class="flex items-center gap-3">
                <img src="<%= review.user.profile_image %>" class="w-10 h-10 rounded-xl object-cover shadow-sm bg-white/5" alt="">
                <div>
                  <p class="text-sm font-bold text-white"><%= review.user.nickname %></p>
                  <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-0.5"><%= review.created_at.strftime("%Y.%m.%d") %></p>
                </div>
              </div>
              <div class="flex items-center gap-0.5">
                <% (1..5).each do |s| %>
                  <svg class="w-4 h-4 <%= review.rating >= s ? 'text-amber-400' : 'text-slate-100' %>" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                  </svg>
                <% end %>
              </div>
            </div>
            
            <div class="mt-6">
              <p class="text-slate-300 font-medium leading-relaxed italic">"<%= review.content %>"</p>
            </div>

            <% if review.user.participations.find_by(challenge: challenge)&.completion_rate.to_i >= 90 %>
              <div class="mt-6 flex items-center gap-2">
                <span class="px-3 py-1 bg-emerald-50 text-emerald-600 rounded-lg text-[10px] font-black tracking-widest uppercase">Excellent Participator</span>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="py-20 text-center space-y-4">
        <div class="w-20 h-20 bg-slate-100 rounded-[32px] flex items-center justify-center mx-auto text-slate-300">
          <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        </div>
        <p class="text-slate-400 font-bold">아직 작성된 리뷰가 없습니다.<br>첫 번째 리뷰어가 되어보세요!</p>
      </div>
    <% end %>
  </div>
</div>
