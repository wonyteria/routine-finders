<div class="space-y-12 py-10 pb-32">
  <!-- 1. Header & Quick Actions -->
  <header class="px-6 space-y-4">
    <div class="flex items-center justify-between">
      <%= link_to prototype_home_path, class: "w-10 h-10 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 active:scale-95 transition-all" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
      <% end %>
      <div class="px-3 py-1 rounded-full bg-indigo-500/10 border border-indigo-500/20">
        <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest leading-none">Club Cockpit</span>
      </div>
      <div class="w-10"></div> <!-- Spacer -->
    </div>

    <div class="space-y-1">
      <h1 class="text-3xl font-black text-white tracking-tight">í´ëŸ½ í˜¸ìŠ¤íŠ¸ ì„¼í„°</h1>
      <p class="text-xs font-bold text-slate-500 leadings-relaxed">ë£¨íŒŒí´ëŸ½ <%= @routine_club.generation_number %>ê¸° ìš´ì˜ í˜„í™©ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.</p>
    </div>
  </header>

  <!-- 2. Pulse: Energy Stats -->
  <section class="px-6">
    <div class="grid grid-cols-2 gap-4">
      <div class="app-glass-card p-6 bg-indigo-500/5 border-indigo-500/10">
        <p class="text-[9px] font-black text-indigo-400 uppercase tracking-[0.2em] mb-2">Club Members</p>
        <div class="flex items-baseline gap-1">
          <span class="text-3xl font-black text-white"><%= @members.count %></span>
          <span class="text-[10px] font-bold text-slate-500">/ <%= @routine_club.max_members %></span>
        </div>
      </div>
      <div class="app-glass-card p-6 bg-emerald-500/5 border-emerald-500/10">
        <p class="text-[9px] font-black text-emerald-400 uppercase tracking-[0.2em] mb-2">Weekly Pulse</p>
        <div class="flex items-baseline gap-1">
          <span class="text-3xl font-black text-white"><%= @weekly_attendance_rate.to_i %></span>
          <span class="text-[10px] font-bold text-slate-500">%</span>
        </div>
      </div>
    </div>
  </section>

  <!-- 3. Pending Payments: Urgent Action -->
  <% if @pending_payments.any? %>
    <section class="px-6 space-y-4">
      <div class="flex items-center justify-between px-1">
        <h2 class="text-xs font-black text-amber-500 uppercase tracking-[0.2em]">ì‹ ì²­ ëŒ€ê¸° ì¤‘ (<%= @pending_payments.count %>)</h2>
        <span class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span>
      </div>
      
      <div class="space-y-3">
        <% @pending_payments.each do |membership| %>
          <div class="app-glass-card p-5 border-amber-500/20 bg-amber-500/5 space-y-4">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-2xl bg-amber-500 flex items-center justify-center text-white text-lg font-black shadow-lg shadow-amber-500/20">
                <%= membership.user.nickname[0].upcase %>
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="text-sm font-black text-white truncate"><%= membership.user.nickname %></h4>
                <p class="text-[10px] font-bold text-slate-500 mt-0.5">ì…ê¸ˆì: <%= membership.depositor_name %> / â‚©<%= number_with_delimiter(membership.paid_amount) %></p>
              </div>
            </div>
            
            <div class="flex gap-2 pt-2">
              <%= button_to "ìŠ¹ì¸í•˜ê¸°", confirm_payment_routine_club_path(@routine_club, member_id: membership.id, source: 'prototype'), method: :post, class: "flex-1 py-3 bg-emerald-600 rounded-xl text-[11px] font-black text-white active:scale-95 transition-all shadow-lg shadow-emerald-900/20" %>
              <%= button_to "ê±°ë¶€", reject_payment_routine_club_path(@routine_club, member_id: membership.id, source: 'prototype'), method: :post, class: "px-6 py-3 bg-white/5 rounded-xl text-[11px] font-black text-slate-500 active:scale-95 transition-all" %>
            </div>
          </div>
        <% end %>
      </div>
    </section>
  <% end %>

  <!-- 4. Member Status Tracker -->
  <section class="px-6 space-y-6">
    <div class="flex items-center justify-between px-1">
      <h2 class="text-xs font-black text-slate-500 uppercase tracking-[0.2em]">í™œë™ ë©¤ë²„ ë¦¬í¬íŠ¸</h2>
      <button class="text-[10px] font-black text-indigo-400">ì „ì²´ë³´ê¸° â†’</button>
    </div>

    <div class="space-y-4">
      <% @member_stats.take(15).each do |stats| %>
        <% m = stats[:membership] %>
        <% 
            monthly_rate = stats[:monthly_rate]
            status_icon = case monthly_rate
            when 95..100 then "ğŸ‘‘"
            when 90..94 then "ğŸ”¥"
            when 70..89 then "âœ…"
            when 50..69 then "ğŸŒ¿"
            when 30..49 then "âš ï¸"
            else "ğŸš¨"
            end
            
            is_warning = monthly_rate < 60 || m.penalty_count > 0
        %>
        <div class="app-glass-card p-4 flex items-center justify-between group <%= is_warning ? 'border-orange-500/20 bg-orange-500/5' : 'border-white/5' %> active:scale-[0.99] transition-all">
          <div class="flex items-center gap-4 min-w-0 flex-1">
            <div class="flex flex-col items-center gap-1 shrink-0 px-1">
              <span class="text-2xl"><%= status_icon %></span>
            </div>
            <div class="relative">
              <% if m.user.profile_image.present? %>
                <img src="<%= m.user.profile_image %>" class="w-12 h-12 rounded-2xl border border-white/10 grayscale group-hover:grayscale-0 transition-all">
              <% else %>
                <div class="w-12 h-12 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-white font-black text-sm">
                  <%= m.user.nickname[0].upcase %>
                </div>
              <% end %>
            </div>
            <div class="min-w-0">
              <h4 class="text-sm font-black text-white truncate leading-tight"><%= m.user.nickname %></h4>
              <div class="flex items-center gap-2 mt-1">
                <span class="text-[9px] font-bold text-slate-500"><%= monthly_rate.to_i %>% Success</span>
                <span class="w-px h-2 bg-white/10"></span>
                <span class="text-[9px] font-black text-indigo-400"><%= number_with_delimiter(stats[:cumulative_points]) %>P</span>
              </div>
            </div>
          </div>
          
          <div class="flex gap-2">
          <div class="flex gap-2">
            <button onclick="openMessageModal(<%= m.user.id %>, '<%= m.user.nickname %>')" class="w-9 h-9 rounded-xl bg-white/5 flex items-center justify-center text-sm active:scale-90 transition-all hover:bg-white/10">ğŸ’¬</button>
            <button onclick="openPenaltyModal(<%= m.id %>, '<%= m.user.nickname %>', 'warn')" class="w-9 h-9 rounded-xl bg-white/5 flex items-center justify-center text-amber-500/60 active:scale-90 transition-all hover:bg-amber-500/20">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
            </button>
            <button onclick="openPenaltyModal(<%= m.id %>, '<%= m.user.nickname %>', 'kick')" class="w-9 h-9 rounded-xl bg-white/5 flex items-center justify-center text-rose-500/60 active:scale-90 transition-all hover:bg-rose-500/20">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"/></svg>
            </button>
          </div>
          </div>
        </div>
      <% end %>
    </div>
  </section>

  <!-- 5. Community Ops -->
  <section class="px-6 space-y-6">
    <div class="flex items-center justify-between px-1">
      <h2 class="text-xs font-black text-slate-500 uppercase tracking-[0.2em]">ì»¤ë®¤ë‹ˆí‹° ìš´ì˜</h2>
    </div>

    <div class="grid grid-cols-2 gap-3">
      <button class="app-glass-card p-6 flex flex-col items-center gap-3 active:scale-95 transition-all text-center">
        <div class="w-12 h-12 rounded-2xl bg-amber-500/10 flex items-center justify-center text-2xl">ğŸ“¢</div>
        <p class="text-[11px] font-black text-white">ê³µì§€ ì „ì†¡</p>
      </button>
      <button class="app-glass-card p-6 flex flex-col items-center gap-3 active:scale-95 transition-all text-center">
        <div class="w-12 h-12 rounded-2xl bg-purple-500/10 flex items-center justify-center text-2xl">ğŸ—“ï¸</div>
        <p class="text-[11px] font-black text-white">ëª¨ì„ ê°œì„¤</p>
      </button>
    </div>
  </section>

  <!-- 6. Bottom Banner: Restorying -->
  <section class="px-6">
    <div class="p-6 rounded-[32px] bg-gradient-to-br from-indigo-600 to-purple-700 relative overflow-hidden shadow-2xl">
      <div class="absolute -right-8 -bottom-8 w-32 h-32 bg-white/10 blur-3xl rounded-full"></div>
      <div class="relative z-10 space-y-3">
        <h3 class="text-lg font-black text-white">ìš´ì˜ ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°</h3>
        <p class="text-[10px] font-medium text-white/70 leading-relaxed">ì´ë²ˆ ì£¼ ë©¤ë²„ë“¤ì˜ ì„±ì¥ ë°ì´í„°ë¥¼<br/>CSV íŒŒì¼ë¡œ ì´ë©”ì¼ ì „ì†¡í•©ë‹ˆë‹¤.</p>
        <button class="px-5 py-2.5 bg-white text-indigo-600 rounded-xl text-[10px] font-black shadow-xl active:scale-95 transition-all">ì§€ê¸ˆ ì „ì†¡í•˜ê¸°</button>
      </div>
    </div>
  </section>
</div>

<!-- Message Modal -->
<div id="message-modal" class="hidden fixed inset-0 bg-black/50 z-[6000] flex items-center justify-center p-4">
  <div class="bg-[#1B1A24] rounded-[32px] max-w-md w-full p-8 border border-white/10 shadow-2xl animate-badge-pop" onclick="event.stopPropagation()">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-black text-white leading-none">ê°œì¸ ë©”ì‹œì§€ ì „ì†¡</h3>
      <button onclick="closeMessageModal()" class="p-2 hover:bg-white/5 rounded-lg transition-colors">
        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <%= form_with url: send_message_routine_club_path(@routine_club), method: :post, class: "space-y-6" do |f| %>
      <%= hidden_field_tag :recipient_id, "", id: "recipient-id" %>
      
      <div class="bg-indigo-500/10 border border-indigo-500/20 rounded-2xl p-4">
        <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-1">Recipient</p>
        <p class="text-sm font-bold text-white" id="recipient-name"></p>
      </div>

      <div class="space-y-2">
        <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1">Message Content</label>
        <%= text_area_tag :message, "", 
            id: "message-content",
            rows: 6, 
            class: "w-full px-5 py-4 bg-white/5 border border-white/10 rounded-2xl focus:border-indigo-500 font-medium text-sm text-white resize-none outline-none transition-all",
            placeholder: "ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." %>
      </div>

      <div class="flex gap-3">
        <%= f.submit "ì „ì†¡", class: "flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-600/20 cursor-pointer" %>
        <button type="button" onclick="closeMessageModal()" class="flex-1 py-4 bg-white/5 text-slate-400 rounded-2xl font-black text-xs hover:bg-white/10 transition-all">
          ì·¨ì†Œ
        </button>
      </div>
    <% end %>
  </div>
</div>

<script>
  function openMessageModal(userId, userName) {
    document.getElementById('message-modal').classList.remove('hidden');
    document.getElementById('recipient-id').value = userId;
    document.getElementById('recipient-name').textContent = userName;
    document.getElementById('message-content').value = '';
    document.getElementById('message-content').focus();
  }

  function closeMessageModal() {
    document.getElementById('message-modal').classList.add('hidden');
  }

  // Close modal when clicking outside
  document.addEventListener('click', function(event) {
    const messageModal = document.getElementById('message-modal');
    const penaltyModal = document.getElementById('penalty-modal');
    if (event.target === messageModal) {
      closeMessageModal();
    }
    if (event.target === penaltyModal) {
      closePenaltyModal();
    }
  });

  function openPenaltyModal(memberId, userName, actionType) {
    const modal = document.getElementById('penalty-modal');
    const title = document.getElementById('penalty-title');
    const form = document.getElementById('penalty-form');
    const targetName = document.getElementById('penalty-target-name');
    const submitBtn = document.getElementById('penalty-submit-btn');
    
    document.getElementById('penalty-member-id').value = memberId;
    targetName.textContent = userName;
    
    if (actionType === 'warn') {
      title.textContent = 'ìš´ì˜ ì •ì±… ê²½ê³  ë¶€ì—¬';
      form.action = `<%= warn_member_routine_club_path(@routine_club) %>`;
      submitBtn.textContent = 'ê²½ê³  ë¶€ì—¬';
      submitBtn.className = 'flex-1 py-4 bg-amber-600 text-white rounded-2xl font-black text-xs hover:bg-amber-700 transition-all shadow-xl shadow-amber-600/20 cursor-pointer';
    } else {
      title.textContent = 'ì‹œìŠ¤í…œ ì˜êµ¬ ì œëª…';
      form.action = `<%= kick_member_routine_club_path(@routine_club) %>`;
      submitBtn.textContent = 'ì œëª… ì²˜ë¦¬';
      submitBtn.className = 'flex-1 py-4 bg-rose-600 text-white rounded-2xl font-black text-xs hover:bg-rose-700 transition-all shadow-xl shadow-rose-600/20 cursor-pointer';
    }
    
    modal.classList.remove('hidden');
    document.getElementById('penalty-reason').value = '';
    document.getElementById('penalty-reason').focus();
  }

  function closePenaltyModal() {
    document.getElementById('penalty-modal').classList.add('hidden');
  }
</script>

<!-- Penalty Modal -->
<div id="penalty-modal" class="hidden fixed inset-0 bg-black/50 z-[6000] flex items-center justify-center p-4">
  <div class="bg-[#1B1A24] rounded-[32px] max-w-md w-full p-8 border border-white/10 shadow-2xl animate-badge-pop" onclick="event.stopPropagation()">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-black text-white leading-none" id="penalty-title">ê²½ê³ /ì œëª… ì²˜ë¦¬</h3>
      <button onclick="closePenaltyModal()" class="p-2 hover:bg-white/5 rounded-lg transition-colors">
        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <%= form_with url: "#", method: :post, id: "penalty-form", class: "space-y-6" do |f| %>
      <%= hidden_field_tag :member_id, "", id: "penalty-member-id" %>
      
      <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
        <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Target Member</p>
        <p class="text-sm font-bold text-white" id="penalty-target-name"></p>
      </div>

      <div class="space-y-2">
        <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1">Penalty Reason <span class="text-rose-500">*</span></label>
        <%= text_area_tag :reason, "", 
            id: "penalty-reason",
            rows: 4, 
            required: true,
            class: "w-full px-5 py-4 bg-white/5 border border-white/10 rounded-2xl focus:border-indigo-500 font-medium text-sm text-white resize-none outline-none transition-all",
            placeholder: "ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." %>
      </div>

      <div class="flex gap-3">
        <%= f.submit "í™•ì •", id: "penalty-submit-btn", class: "flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-600/20 cursor-pointer" %>
        <button type="button" onclick="closePenaltyModal()" class="flex-1 py-4 bg-white/5 text-slate-400 rounded-2xl font-black text-xs hover:bg-white/10 transition-all">
          ì·¨ì†Œ
        </button>
      </div>
    <% end %>
  </div>
</div>
