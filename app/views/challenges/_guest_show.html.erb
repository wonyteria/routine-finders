<style>
  /* Premium Dark Mode Overrides */
  .detail-content-env h2, .detail-content-env h3 { color: #ffffff !important; font-weight: 900 !important; }
  .detail-content-env p, .detail-content-env li, .detail-content-env span { color: #a1a1aa !important; }
  .detail-content-env .bg-white, .detail-content-env .bg-slate-50, .detail-content-env .bg-indigo-50, .detail-content-env .bg-orange-50, .detail-content-env .bg-emerald-50, .detail-content-env .bg-amber-50 { 
    background-color: rgba(255, 255, 255, 0.03) !important; 
    border: 1px solid rgba(255, 255, 255, 0.08) !important;
    border-radius: 24px !important;
  }
  .detail-content-env .text-slate-900, .detail-content-env .text-orange-900, .detail-content-env .text-emerald-900, .detail-content-env .text-amber-900 { color: #ffffff !important; }
  .detail-content-env .text-slate-600, .detail-content-env .text-slate-700, .detail-content-env .text-emerald-600, .detail-content-env .text-amber-600 { color: #a1a1aa !important; }

  /* Hide Scrollbar */
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<div class="relative -mx-4 min-h-screen bg-[#0C0B12] selection:bg-indigo-500/30">
  <!-- 1. Immersive Hero (Fixed Aspect with Premium Blending) -->
  <section class="relative h-[320px] w-full overflow-hidden">
    <% if @challenge.thumbnail_image.attached? %>
      <%= image_tag @challenge.thumbnail_image, class: "w-full h-full object-cover scale-105" %>
    <% else %>
      <img src="<%= @challenge.thumbnail %>" class="w-full h-full object-cover scale-105" alt="">
    <% end %>
    
    <!-- Premium Overlays -->
    <div class="absolute inset-0 bg-gradient-to-t from-[#0C0B12] via-[#0C0B12]/40 to-black/20 z-10"></div>
    <div class="absolute inset-0 aura-glow-discovery opacity-40 z-10"></div>
    
    <!-- Top Nav (Floating Glass) -->
    <div class="fixed top-0 inset-x-0 z-[100] px-6 py-10 flex justify-between items-center pointer-events-none">
      <div class="pointer-events-auto">
        <%= link_to (params[:source] == 'prototype' ? prototype_explore_path : :back), class: "w-12 h-12 rounded-2xl bg-black/20 backdrop-blur-2xl border border-white/10 flex items-center justify-center text-white shadow-2xl active:scale-90 transition-all" do %>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
        <% end %>
      </div>
      <div class="pointer-events-auto flex items-center gap-3">
        <% if current_user&.admin? %>
          <%= link_to challenge_path(@challenge), 
                      method: :delete,
                      data: { 
                        turbo_method: :delete,
                        turbo_confirm: "'#{@challenge.title}' ì±Œë¦°ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?" 
                      },
                      class: "w-12 h-12 rounded-2xl bg-rose-500/10 backdrop-blur-2xl border border-rose-500/20 flex items-center justify-center text-rose-500 shadow-2xl active:scale-90 transition-all" do %>
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          <% end %>
        <% end %>
        <button 
          data-controller="share"
          data-share-title-value="<%= @challenge.title %>"
          data-share-text-value="ë£¨í‹´ íŒŒì¸ë”ì—ì„œ '<%= @challenge.title %>' ë„ì „ì— í•¨ê»˜í•´ìš”! ğŸŒ¿"
          data-share-url-value="<%= challenge_url(@challenge) %>"
          data-action="click->share#share"
          class="w-12 h-12 rounded-2xl bg-black/20 backdrop-blur-2xl border border-white/10 flex items-center justify-center text-white shadow-2xl active:scale-90 transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
        </button>
      </div>
    </div>

    <!-- Title Info (Layered) -->
    <div class="absolute bottom-10 left-8 right-8 z-20 space-y-4">
      <div class="flex items-center gap-2">
        <span class="px-3 py-1.5 rounded-xl bg-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.5)] text-[10px] font-black text-white uppercase tracking-widest leading-none">
          <%= @challenge.category_display || (@challenge.offline? ? 'Gathering' : 'Challenge') %>
        </span>
        <% if @challenge.priority_access_for_members? %>
          <span class="px-3 py-1.5 rounded-xl bg-amber-500/90 shadow-[0_0_15px_rgba(245,158,11,0.5)] text-[10px] font-black text-white uppercase tracking-widest leading-none">ELITE</span>
        <% end %>
      </div>
      <h1 class="text-3xl font-black text-white leading-tight glow-text-primary"><%= @challenge.title %></h1>
    </div>
  </section>

  <!-- 2. Smart Category Switcher (Sticky Glass Control) -->
  <div class="sticky top-0 z-40 bg-[#0C0B12]/80 backdrop-blur-3xl border-b border-white/5 py-4 px-6 overflow-hidden">
    <div class="flex items-center gap-3 overflow-x-auto no-scrollbar scroll-smooth">
      <% 
        if @challenge.gathering?
          rules_label = @challenge.virtual_gathering? ? "ì ‘ì†ì•ˆë‚´" : "ì¥ì†Œì•ˆë‚´"
          main_tabs = [
            { id: "intro", label: "ìƒì„¸ì„¤ëª…", icon: "âœ¨" },
            { id: "rules", label: rules_label, icon: "ğŸ“" },
            { id: "guide", label: "ì°¸ì—¬ì•ˆë‚´", icon: "ğŸ’" },
            { id: "community", label: "ì»¤ë®¤ë‹ˆí‹°", icon: "ğŸ’¬" }
          ]
        else
          main_tabs = [
            { id: "intro", label: "ìƒì„¸ì„¤ëª…", icon: "âœ¨" },
            { id: "rules", label: "ì§„í–‰ë°©ë²•", icon: "âš¡" },
            { id: "rewards", label: "ë¦¬ì›Œë“œ", icon: "ğŸ" },
            { id: "community", label: "ì»¤ë®¤ë‹ˆí‹°", icon: "ğŸ’¬" }
          ]
        end
      %>
      <% main_tabs.each do |t| %>
        <%= link_to challenge_path(@challenge, tab: t[:id], source: 'prototype'), 
                    class: "shrink-0 px-6 py-3.5 rounded-2xl font-black text-[13px] transition-all flex items-center gap-2 border #{ @tab == t[:id] ? 'bg-white text-black shadow-[0_10px_20px_rgba(255,255,255,0.2)]' : 'text-white/40 border-white/5 bg-white/[0.02] hover:bg-white/5' }" do %>
          <span class="text-base"><%= t[:icon] %></span>
          <%= t[:label] %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- 3. Dynamic Content Area -->
  <section class="px-6 py-10 pb-48 space-y-12 detail-content-env">
    <% case @tab %>
    <% when "intro" %>
      <div class="space-y-10 animate-fade-in">
        <!-- Host Preview Card (Premium Glass) -->
        <div class="space-y-4">
          <h3 class="text-[11px] font-black text-white/40 uppercase tracking-[0.2em] px-2 leading-none">The Visionary</h3>
          <%= link_to prototype_user_card_path(@challenge.host || 0), data: { turbo_frame: "user-profile-modal-frame" }, class: "app-glass-card-premium p-6 border-white/5 bg-white/[0.02] flex items-center gap-6 hover:bg-white/5 transition-all active:scale-[0.98] group relative overflow-hidden" do %>
            <div class="absolute -right-4 -top-4 w-20 h-20 bg-indigo-500/10 blur-2xl pointer-events-none"></div>
            <div class="relative shrink-0">
              <img src="<%= @challenge.host&.profile_image || asset_path('rf_official_logo.png') %>" class="w-16 h-16 rounded-[24px] border border-white/10 object-cover bg-white/5 shadow-2xl transition-transform group-hover:scale-105">
              <% if @challenge.host&.is_rufa_club_member? %>
                <div class="absolute -right-1 -bottom-1 w-6 h-6 bg-indigo-500 rounded-lg border-2 border-[#16151D] flex items-center justify-center text-[10px] font-black text-white shadow-lg">R</div>
              <% end %>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Challenge Host</p>
              <h3 class="text-xl font-black text-white truncate group-hover:text-indigo-400 transition-colors leading-none"><%= @challenge.host_name || "í”Œë«í¼ ìš´ì˜ì" %></h3>
              <p class="text-[11px] font-bold text-white/30 mt-2">í•¨ê»˜ ì„±ì¥ì„ ë””ìì¸í•©ë‹ˆë‹¤</p>
            </div>
          <% end %>
        </div>
        <%= render "challenges/tabs/intro", challenge: @challenge %>
      </div>

    <% when "rules", "records" %>
      <div class="space-y-10 animate-fade-in">
        <div class="p-8 app-glass-card-premium border-indigo-500/20 bg-indigo-500/5 relative overflow-hidden">
           <div class="absolute -left-6 -top-6 w-20 h-20 bg-indigo-500/10 blur-2xl"></div>
           <p class="text-indigo-300 text-[13px] font-bold leading-relaxed relative z-10 flex gap-3">
             <span class="text-lg">ğŸ’¡</span>
             <%= @challenge.offline? ? "ëª¨ì„ ì‹œê°„ê³¼ ì¥ì†Œë¥¼ ì‚¬ì „ì— ìˆ™ì§€í•˜ì—¬ ë…¸ì‡¼ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•´ì£¼ì„¸ìš”." : "ë§¤ì¼ ì •í•´ì§„ ê°€ì´ë“œì— ë§ì¶° ì¸ì¦ìƒ·ì„ ë‚¨ê²¨ì£¼ì‹œë©´ ì„±ì‹¤í•¨ ì§€ìˆ˜ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤." %>
           </p>
        </div>
        <%= render "challenges/tabs/rules", challenge: @challenge %>
      </div>

    <% when "rewards", "guide" %>
      <div class="animate-fade-in space-y-8">
        <% if @challenge.offline? %>
          <!-- Preparation Items -->
          <div class="space-y-4">
             <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest px-2">ì¤€ë¹„ë¬¼ ë° ìœ ì˜ì‚¬í•­</h3>
             <div class="p-6 bg-amber-500/5 border border-amber-500/10 rounded-3xl">
                <% if @challenge.preparation_items.present? %>
                  <p class="text-sm font-medium text-slate-200 leading-relaxed whitespace-pre-wrap"><%= @challenge.preparation_items %></p>
                <% else %>
                  <p class="text-xs font-bold text-slate-500 italic text-center py-4 text-white">íŠ¹ë³„í•œ ì¤€ë¹„ë¬¼ ì—†ì´ í¸í•˜ê²Œ ì°¸ì„í•´ ì£¼ì„¸ìš”!</p>
                <% end %>
             </div>
          </div>

          <!-- Application Question -->
          <!-- Application Question -->
          <% if @challenge.requires_application_message? %>
            <div class="space-y-4">
               <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest px-2">ì‹ ì²­ ì‹œ ì§ˆë¬¸</h3>
               <div class="p-6 bg-white/[0.02] border border-white/5 rounded-3xl space-y-4">
                  <p class="text-xs font-black text-indigo-400 mb-2 leading-relaxed">ì‹ ì²­ ì‹œ ì•„ë˜ ì§ˆë¬¸ì— ëŒ€í•œ ë‹µë³€ì„ í•¨ê»˜ ì ì–´ì£¼ì…”ì•¼ í•©ë‹ˆë‹¤.</p>
                  
                  <% if @challenge.application_questions.present? && @challenge.application_questions.any? %>
                    <% @challenge.application_questions.each_with_index do |question, i| %>
                       <div class="space-y-1 pb-3 border-b border-white/5 last:border-0 last:pb-0">
                          <span class="text-[10px] font-black text-slate-500 uppercase">Question <%= i + 1 %></span>
                          <p class="text-sm font-bold text-white italic leading-relaxed" style="white-space: pre-line;">"<%= question %>"</p>
                       </div>
                    <% end %>
                  <% else %>
                     <p class="text-sm font-bold text-white italic" style="white-space: pre-line;">"<%= @challenge.application_question.presence || "ëª¨ì„ì— ì°¸ì—¬í•˜ê³  ì‹¶ì€ ì´ìœ ë¥¼ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”." %>"</p>
                  <% end %>
               </div>
            </div>
          <% end %>

          <!-- Refund Policy -->
          <div class="space-y-4">
             <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest px-2">í™˜ë¶ˆ ë° ì·¨ì†Œ ê·œì •</h3>
             <div class="p-6 bg-white/[0.02] border border-white/5 rounded-3xl">
                <p class="text-xs font-medium text-slate-400 leading-relaxed whitespace-pre-wrap"><%= @challenge.refund_policy.presence || "ëª¨ì„ ì‹œì‘ 24ì‹œê°„ ì „ê¹Œì§€ 100% í™˜ë¶ˆ ê°€ëŠ¥í•˜ë©°, ì´í›„ì—ëŠ” ì¥ì†Œ ì˜ˆì•½ ë“±ì˜ ì‚¬ìœ ë¡œ í™˜ë¶ˆì´ ì–´ë ¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤." %></p>
             </div>
          </div>
        <% else %>
          <%= render "challenges/tabs/rewards", challenge: @challenge %>
        <% end %>
      </div>

     <% when "community" %>
      <div class="space-y-10 animate-fade-in">
         <div class="space-y-4">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest px-2">ì°¸ì—¬ ë©¤ë²„</h3>
            <%= render "challenges/tabs/participants", challenge: @challenge, participants: @participants %>
         </div>
         <div class="space-y-4">
            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest px-2">ì°¸ì—¬ í›„ê¸° <span class="text-xs text-indigo-400 ml-1"><%= @reviews.count %></span></h3>
            <%= render "challenges/tabs/reviews", challenge: @challenge, reviews: @reviews, can_write_review: @can_write_review %>
         </div>
      </div>
    <% end %>
  </section>

  <!-- 4. Fixed Final Action Bar (Premium Floating Layer) -->
  <div class="fixed bottom-12 left-1/2 -translate-x-1/2 w-[92%] max-w-[400px] z-[500] animate-slide-up">
    <div class="app-glass-card-premium p-3 !rounded-[32px] border-white/10 bg-[#16151D]/90 backdrop-blur-3xl shadow-[0_30px_60px_rgba(0,0,0,0.8)] flex items-center justify-between gap-4">
      <div class="flex-1 pl-6">
        <p class="text-[9px] font-black text-white/30 uppercase tracking-[0.3em] mb-1.5 leading-none">Participation Fee</p>
        <div class="flex items-baseline gap-1.5">
          <span class="text-2xl font-black text-white italic tracking-tighter"><%= @challenge.cost_type_free? ? 'ë¬´ë£Œ ì°¸ì—¬' : number_with_delimiter(@challenge.total_payment_amount) %></span>
          <% unless @challenge.cost_type_free? %>
            <span class="text-[11px] font-black text-white/40 uppercase">KRW</span>
          <% end %>
        </div>
      </div>
      
      <% if @is_host %>
         <%= link_to hosted_challenge_path(@challenge, source: params[:source]), class: "px-9 py-4.5 app-fab-gradient rounded-[24px] text-xs font-black text-white active:scale-95 transition-all shadow-[0_10px_20px_rgba(99,102,241,0.3)]" do %>
           ê´€ë¦¬í•˜ê¸°
         <% end %>
      <% elsif @is_joined %>
         <%= link_to challenge_path(@challenge, tab: 'records', source: 'prototype'), class: "px-9 py-4.5 bg-emerald-500 rounded-[24px] text-xs font-black text-white active:scale-95 transition-all shadow-[0_10px_20px_rgba(16,185,129,0.3)]" do %>
           ëŒ€ì‹œë³´ë“œ
         <% end %>
      <% else %>
        <% if logged_in? %>
          <button data-action="click->modal#open" class="px-10 py-4.5 app-fab-gradient rounded-[24px] text-xs font-black text-white active:scale-95 transition-all cursor-pointer shadow-[0_10px_25px_rgba(99,102,241,0.4)]">
            ì‹ ì²­í•˜ê¸°
          </button>
        <% else %>
          <%= link_to prototype_login_path, 
                      class: "px-10 py-4.5 app-fab-gradient rounded-[24px] text-xs font-black text-white active:scale-95 transition-all text-center cursor-pointer flex items-center justify-center shadow-[0_10px_25px_rgba(99,102,241,0.4)]" do %>
            ì§€ê¸ˆ ì‹œì‘
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Redesigned Modal (Youngja's Premium Sheet) -->
  <div data-modal-target="container" 
       data-action="click->modal#closeOnBackground" 
       class="fixed inset-0 z-[60000] hidden bg-black/80 backdrop-blur-2xl flex items-end sm:items-center justify-center p-0 sm:p-6">
    <div class="modal-content w-full max-w-md bg-[#0C0B12] rounded-t-[48px] sm:rounded-[48px] border-t border-white/10 sm:border border-white/10 overflow-hidden shadow-2xl relative">
      <!-- Glow Decor -->
      <div class="absolute -top-40 -left-20 w-60 h-60 bg-indigo-600/20 blur-[100px] pointer-events-none"></div>
      
      <div class="p-10 text-center space-y-8 relative z-10">
        <div class="w-24 h-24 rounded-[40px] bg-white/[0.03] border border-white/10 flex items-center justify-center text-5xl mx-auto shadow-inner">
          <%= @challenge.category == 'HEALTH' ? 'ğŸ’ª' : 'ğŸš€' %>
        </div>
        
        <div class="space-y-3">
          <h2 class="text-3xl font-black text-white tracking-tight leading-tight"><%= @challenge.title %></h2>
          <p class="text-[13px] font-bold text-white/40">ë‹¹ì‹ ì˜ ì„±ì¥ì„ ìœ„í•œ ìœ„ëŒ€í•œ ì²« ê±¸ìŒì…ë‹ˆë‹¤.</p>
        </div>

        <div class="space-y-4 pt-4">
          <% if @challenge.cost_type_free? %>
            <% if logged_in? %>
              <%= button_to join_challenge_path(@challenge, source: 'prototype'), 
                            method: :post, 
                            class: "w-full py-5 app-fab-gradient text-white rounded-3xl font-black text-base active:scale-95 transition-all cursor-pointer shadow-xl shadow-indigo-500/20" do %>
                ë¬´ë£Œë¡œ ì‹œì‘í•˜ê¸°
              <% end %>
            <% else %>
              <%= link_to prototype_login_path, 
                          class: "block w-full py-5 app-fab-gradient text-white rounded-3xl font-black text-base active:scale-95 transition-all text-center cursor-pointer shadow-xl shadow-indigo-500/20" do %>
                ë¡œê·¸ì¸ í›„ ì‹œì‘
              <% end %>
            <% end %>
          <% else %>
            <% if logged_in? %>
              <%= link_to new_challenge_application_path(@challenge, source: 'prototype'), 
                          class: "block w-full py-5 app-fab-gradient text-white rounded-3xl font-black text-base active:scale-95 transition-all text-center cursor-pointer shadow-xl shadow-indigo-500/20" do %>
                ì‹ ì²­ì„œ ì‘ì„±í•˜ê¸°
              <% end %>
            <% else %>
              <%= link_to prototype_login_path, 
                          class: "block w-full py-5 app-fab-gradient text-white rounded-3xl font-black text-base active:scale-95 transition-all text-center cursor-pointer shadow-xl shadow-indigo-500/20" do %>
                ì‹ ì²­ ì •ë³´ í™•ì¸
              <% end %>
            <% end %>
          <% end %>
          <button data-action="click->modal#close" class="w-full py-3 text-white/20 font-black text-[11px] tracking-[0.3em] uppercase cursor-pointer hover:text-white/40 transition-colors">Dismiss</button>
        </div>
      </div>
    </div>
  </section>
</div>
</div>
