<% if notice %>
  <div id="success-popup" class="fixed inset-0 z-[5000] flex items-center justify-center p-6">
    <div onclick="this.parentElement.remove()" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
    <div class="relative app-glass-card p-8 bg-[#1B1A24] border-white/10 text-center space-y-4 max-w-xs animate-badge-pop">
      <div class="w-16 h-16 bg-emerald-500/20 text-emerald-400 rounded-2xl flex items-center justify-center text-3xl mx-auto">âœ¨</div>
      <div class="space-y-1">
        <h3 class="text-lg font-black text-white">ì—…ë°ì´íŠ¸ ì™„ë£Œ</h3>
        <p class="text-xs font-bold text-slate-400"><%= notice %></p>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" class="w-full py-3 bg-white/5 hover:bg-white/10 text-white font-bold text-sm rounded-xl transition-all">í™•ì¸</button>
    </div>
  </div>
<% end %>

<div class="space-y-8 py-10 pb-32">
  <!-- 1. Header -->
  <header class="px-6 space-y-4">
    <div class="flex items-center justify-between">
      <%= link_to prototype_admin_dashboard_path, class: "w-10 h-10 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 active:scale-95 transition-all" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
      <% end %>

      <div class="w-10"></div>
    </div>

    <div class="space-y-1">
      <div class="flex items-center justify-between">
        <h1 class="text-3xl font-black text-white tracking-tight">ë£¨íŒŒ í´ëŸ½ í†µí•© ê´€ë¦¬</h1>
      </div>
      <p class="text-xs font-bold text-slate-500">í”Œë«í¼ ìœ ì¼ì˜ ê³µì‹ ë©¤ë²„ì‹­ 'ë£¨íŒŒ í´ëŸ½'ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
    </div>
  </header>

  <% if @official_club %>
    <!-- 2. Club Overview Statistics -->
    <section class="px-6">
      <div class="app-glass-card p-6 border-white/5 bg-gradient-to-br from-indigo-600/10 to-purple-600/10 relative overflow-hidden">
        <div class="flex items-center justify-between relative z-10">
          <div class="space-y-1">
            <h2 class="text-xl font-black text-white"><%= @official_club.title %></h2>
            <div class="flex items-center gap-2">
               <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
               <p class="text-[10px] font-black text-emerald-500 uppercase tracking-widest">í™œì„± ì‹œì¦Œ (Active)</p>
            </div>
          </div>
          <div class="text-right">
            <%= link_to prototype_batch_reports_path, class: "px-4 py-2.5 bg-emerald-500 rounded-xl text-[10px] font-black text-white shadow-lg shadow-emerald-500/20 active:scale-95 transition-all flex items-center gap-2 inline-flex" do %>
              <span>ğŸ“ˆ</span> ë¦¬í¬íŠ¸
            <% end %>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-8 pt-6 border-t border-white/5">
           <div class="text-center border-r border-white/5">
             <p class="text-[9px] font-black text-slate-500 mb-1 text-center">í˜„ì¬ ì¸ì›</p>
             <p class="text-lg font-black text-white"><%= @club_members.count %>ëª…</p>
           </div>
           <div class="text-center">
             <p class="text-[9px] font-black text-slate-500 mb-1 text-center">í‰ê·  ë‹¬ì„±ë¥ </p>
             <p class="text-lg font-black text-indigo-400"><%= @official_club.average_attendance_rate %>%</p>
           </div>
        </div>
      </div>
    </section>

    <!-- 3. Main Navigation Tabs -->
    <nav class="px-6 sticky top-0 z-30 bg-[#1B1A24]/80 backdrop-blur-md py-4">
      <div class="flex items-center justify-between gap-2 border-b border-white/5">
        <button type="button" 
                id="tab-btn-members"
                onclick="switchClubTab('members')"
                class="flex-1 pb-4 text-xs font-black uppercase tracking-widest border-b-2 transition-all text-indigo-400 border-indigo-400">íšŒì› ê´€ë¦¬</button>
        <button type="button" 
                id="tab-btn-lounge"
                onclick="switchClubTab('lounge')"
                class="flex-1 pb-4 text-xs font-black uppercase tracking-widest border-b-2 transition-all text-slate-500 border-transparent">ë¼ìš´ì§€ ê´€ë¦¬</button>
        <button type="button" 
                id="tab-btn-announcements"
                onclick="switchClubTab('announcements')"
                class="flex-1 pb-4 text-xs font-black uppercase tracking-widest border-b-2 transition-all text-slate-500 border-transparent">ê³µì§€</button>
        <button type="button" 
                id="tab-btn-settings"
                onclick="switchClubTab('settings')"
                class="flex-1 pb-4 text-xs font-black uppercase tracking-widest border-b-2 transition-all text-slate-500 border-transparent">í´ëŸ½ ì„¤ì •</button>
      </div>
    </nav>

    <!-- 4. Tab Panels -->
    <div class="space-y-12">
      <!-- Member Management Panel -->
      <div id="panel-members" class="space-y-12">
        <!-- Pending Approvals -->
        <% if @pending_memberships.any? %>
          <section class="px-6 space-y-4">
            <div class="flex items-center justify-between pl-1">
              <div class="flex items-center gap-2 text-amber-500">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                <span class="text-[10px] font-black uppercase tracking-widest">ê²°ì œ ëŒ€ê¸° ë©¤ë²„ (<%= @pending_memberships.size %>)</span>
              </div>
            </div>
            <div class="space-y-3">
              <% @pending_memberships.each do |member| %>
                <div class="app-glass-card border-amber-500/20 bg-amber-500/5">
                  <!-- ê¸°ë³¸ ì •ë³´ (í´ë¦­ ê°€ëŠ¥) -->
                  <div onclick="toggleMemberDetail(<%= member.id %>)" class="p-4 flex items-center justify-between cursor-pointer hover:bg-amber-500/10 transition-all rounded-3xl">
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-black text-white leading-tight truncate"><%= member.user.nickname %></p>
                        <p class="text-[9px] font-bold text-slate-500 mt-0.5">ì…ê¸ˆëª…: <%= member.depositor_name %> Â· â‚©<%= number_with_delimiter(member.paid_amount) %></p>
                      </div>
                      <svg id="member-icon-<%= member.id %>" class="w-5 h-5 text-slate-500 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                      </svg>
                    </div>

                  <!-- ìƒì„¸ ì •ë³´ (í† ê¸€) -->
                  <div id="member-detail-<%= member.id %>" class="hidden px-4 pb-4 space-y-3 border-t border-amber-500/10 pt-3">
                    <div class="grid grid-cols-2 gap-3">
                      <div class="space-y-1">
                        <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">ì—°ë½ì²˜</p>
                        <p class="text-xs font-bold text-white"><%= member.contact_info || '-' %></p>
                      </div>
                      <div class="space-y-1">
                        <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Threads ID</p>
                        <p class="text-xs font-bold text-white"><%= member.threads_nickname || '-' %></p>
                      </div>
                    </div>
                    <div class="space-y-1">
                      <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest">ê°€ì… í¬ë¶€</p>
                      <p class="text-xs font-medium text-slate-300 leading-relaxed"><%= member.goal || '-' %></p>
                    </div>
                    
                    <!-- ìŠ¹ì¸/ê±°ë¶€ ë²„íŠ¼ -->
                    <div class="flex gap-2 pt-2">
                      <%= form_with url: prototype_confirm_club_payment_path(member_id: member.id), method: :post, class: "flex-1" do %>
                        <button type="submit" onclick="return confirm('<%= member.user.nickname %>ë‹˜ì˜ ì…ê¸ˆì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="w-full py-3 rounded-2xl bg-emerald-500 text-white font-black text-xs shadow-lg shadow-emerald-500/20 hover:bg-emerald-600 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/></svg>
                          <span>ìŠ¹ì¸</span>
                        </button>
                      <% end %>
                      
                      <%= form_with url: prototype_reject_club_payment_path(member_id: member.id), method: :post, class: "flex-1" do %>
                        <button type="submit" onclick="return confirm('<%= member.user.nickname %>ë‹˜ì˜ ì…ê¸ˆì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="w-full py-3 rounded-2xl bg-rose-500/10 text-rose-500 font-black text-xs hover:bg-rose-500/20 hover:scale-[1.02] active:scale-95 transition-all flex items-center justify-center gap-2 border border-rose-500/20">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/></svg>
                          <span>ê±°ë¶€</span>
                        </button>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </section>
        <% end %>

        <!-- Active Members Sub-Tabs -->
        <section class="px-6 space-y-6">
          <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between px-1">
              <h2 class="text-xs font-black text-slate-500 uppercase tracking-[0.2em]">íšŒì› ë°ì´í„°</h2>
              <div class="px-2 py-1 rounded bg-white/5 border border-white/10">
                <span class="text-[9px] font-black text-slate-500 truncate">ì´ <%= @club_members.count %>ëª…</span>
              </div>
            </div>

            <div class="flex items-center justify-between gap-2 px-1 overflow-x-auto no-scrollbar">
              <!-- Sorting Selector (Main Filter) -->
              <div class="flex items-center gap-1.5 bg-white/10 rounded-xl px-2.5 py-1.5 border border-white/20 shrink-0">
                <svg class="w-3 h-3 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12"/></svg>
                <select onchange="updateMemberSort(this.value)" class="bg-transparent text-[10px] font-black text-white outline-none cursor-pointer focus:text-indigo-400">
                  <option value="weekly_high" class="bg-[#1B1A24]" <%= 'selected' if @member_sort == 'weekly_high' %>>Weekly ë†’ì€ìˆœ</option>
                  <option value="weekly_low" class="bg-[#1B1A24]" <%= 'selected' if @member_sort == 'weekly_low' %>>Weekly ë‚®ì€ìˆœ</option>
                  <option value="monthly_high" class="bg-[#1B1A24]" <%= 'selected' if @member_sort == 'monthly_high' %>>Monthly ë†’ì€ìˆœ</option>
                  <option value="monthly_low" class="bg-[#1B1A24]" <%= 'selected' if @member_sort == 'monthly_low' %>>Monthly ë‚®ì€ìˆœ</option>
                  <option value="join_newest" class="bg-[#1B1A24]" <%= 'selected' if @member_sort == 'join_newest' %>>ìµœì‹  ê°€ì…ìˆœ</option>
                  <option value="join_oldest" class="bg-[#1B1A24]" <%= 'selected' if @member_sort == 'join_oldest' %>>ì˜¤ë˜ëœ ê°€ì…ìˆœ</option>
                </select>
              </div>

              <div class="flex bg-white/5 rounded-lg p-1 gap-1 shrink-0">
                 <button type="button" 
                         id="sub-tab-btn-list"
                         onclick="switchSubTab('list')"
                         class="px-3 py-1 text-[9px] font-black rounded transition-all bg-white/10 text-white whitespace-nowrap">í˜„í™©</button>
                 <button type="button" 
                         id="sub-tab-btn-analysis"
                         onclick="switchSubTab('analysis')"
                         class="px-3 py-1 text-[9px] font-black rounded transition-all text-slate-500 whitespace-nowrap">ì„±ê³¼ì§€í‘œ</button>
                 <%= link_to "âš¡ ì£¼ê°„ ì ê²€", prototype_admin_weekly_check_path, class: "px-3 py-1 text-[9px] font-black rounded transition-all text-amber-500 hover:text-amber-400 border border-amber-500/20 hover:bg-amber-500/10 ml-2 whitespace-nowrap" %>
              </div>
            </div>
          </div>

          <!-- Sub-Tab: í˜„í™© -->
          <div id="sub-panel-list" class="space-y-3">
            <% if @club_members.any? %>
              <% @club_members.each do |member| %>
                <% 
                  monthly_rate = member.monthly_routine_rate 
                  
                  status_styles = case monthly_rate
                  when 95..100 then "bg-indigo-500/10 border-indigo-500/20"
                  when 90..94 then "bg-orange-500/10 border-orange-500/20"
                  when 70..89 then "bg-emerald-500/10 border-emerald-500/20"
                  when 50..69 then "bg-slate-500/5 border-white/5"
                  when 30..49 then "bg-amber-500/10 border-amber-500/20"
                  else "bg-rose-500/10 border-rose-500/20"
                  end
                %>
                <div class="app-glass-card p-4 transition-all <%= status_styles %> flex items-center justify-between gap-4">
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                      <p class="text-sm font-black text-white leading-tight truncate"><%= member.user.nickname %></p>
                      <% if monthly_rate < 30 %>
                        <span class="px-1.5 py-0.5 rounded-md bg-rose-500 text-[8px] font-black text-white whitespace-nowrap">ì¬ë¶„ë°œ</span>
                      <% end %>
                    </div>
                    <p class="text-[9px] font-bold text-slate-400 mt-1"><%= monthly_rate.to_i %>% Monthly Success Â· <%= member.identity_title || 'í´ëŸ½ ë©¤ë²„' %></p>
                  </div>
                  <div class="flex gap-2 shrink-0">
                    <button onclick="openMessageModal(<%= member.user.id %>, '<%= member.user.nickname %>')" class="w-9 h-9 rounded-xl bg-white/5 text-slate-400 flex items-center justify-center hover:bg-white/10 active:scale-95 transition-all">ğŸ’¬</button>
                    <button onclick="openPenaltyModal(<%= member.id %>, '<%= member.user.nickname %>', 'warn')" class="w-9 h-9 rounded-xl bg-white/5 text-amber-500/60 flex items-center justify-center hover:bg-amber-500/20 active:scale-95 transition-all">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    </button>
                    <button onclick="openPenaltyModal(<%= member.id %>, '<%= member.user.nickname %>', 'kick')" class="w-9 h-9 rounded-xl bg-white/5 text-rose-500/60 flex items-center justify-center hover:bg-rose-500/20 active:scale-95 transition-all">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"/></svg>
                    </button>
                  </div>
                </div>
              <% end %>
            <% else %>
              <div class="py-16 text-center bg-white/2 rounded-[32px] border border-dashed border-white/5">
                <p class="text-xs font-bold text-slate-600">ê°€ì…ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              </div>
            <% end %>
          </div>

          <!-- Sub-Tab: ì„±ê³¼ì§€í‘œ -->
          <div id="sub-panel-analysis" class="space-y-4 hidden">
            <% @member_stats.each do |stat| %>
              <div class="app-glass-card p-5 border-white/5 space-y-4">
                <div class="flex items-center justify-between">
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-black text-white leading-tight truncate"><%= stat[:member].user.nickname %></h4>
                    <p class="text-[9px] font-bold text-slate-500 mt-1">ì§€í‘œ ë¶„ì„ ê°€ë™ ì¤‘...</p>
                  </div>
                  <div class="text-right">
                     <span class="text-[10px] font-black text-emerald-400 uppercase tracking-widest"><%= stat[:weekly_rate] %>% Success</span>
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                   <div onclick="openAnalysisModal(<%= stat[:member].user.id %>, 'weekly')" class="p-3 bg-white/2 rounded-2xl border border-white/5 cursor-pointer hover:bg-white/5 hover:border-white/10 transition-all group">
                     <div class="flex items-center justify-between mb-1.5">
                       <p class="text-[8px] font-black text-slate-500 uppercase tracking-widest leading-none group-hover:text-indigo-400 transition-colors">Weekly Check</p>
                       <span class="text-[8px] font-bold text-slate-600">ì¶œì„ <%= stat[:weekly_attendance] %>%</span>
                     </div>
                     <div class="flex items-baseline gap-2">
                       <span class="text-lg font-black text-white"><%= stat[:weekly_rate] %>%</span>
                       <div class="h-1.5 flex-1 bg-white/5 rounded-full overflow-hidden self-center">
                         <div class="h-full bg-indigo-500" style="width: <%= stat[:weekly_rate] %>%"></div>
                       </div>
                     </div>
                   </div>
                   <div onclick="openAnalysisModal(<%= stat[:member].user.id %>, 'monthly')" class="p-3 bg-white/2 rounded-2xl border border-white/5 cursor-pointer hover:bg-white/5 hover:border-white/10 transition-all group">
                     <div class="flex items-center justify-between mb-1.5">
                       <p class="text-[8px] font-black text-slate-500 uppercase tracking-widest leading-none group-hover:text-purple-400 transition-colors">Monthly Check</p>
                       <span class="text-[8px] font-bold text-slate-600">ì¶œì„ <%= stat[:monthly_attendance] %>%</span>
                     </div>
                     <div class="flex items-baseline gap-2">
                       <span class="text-lg font-black text-white"><%= stat[:monthly_rate] %>%</span>
                       <div class="h-1.5 flex-1 bg-white/5 rounded-full overflow-hidden self-center">
                         <div class="h-full bg-purple-500" style="width: <%= stat[:monthly_rate] %>%"></div>
                       </div>
                     </div>
                   </div>
                </div>
                <div class="flex items-center justify-end gap-2 pt-1">
                   <%= link_to prototype_member_reports_path(user_id: stat[:member].user_id), class: "px-3 py-1.5 border border-white/10 rounded-lg text-[9px] font-black text-slate-400 hover:text-white transition-colors" do %>ë¦¬í¬íŠ¸<% end %>
                   <button onclick="openPenaltyModal(<%= stat[:member].id %>, '<%= stat[:member].user.nickname %>', 'warn')" class="px-3 py-1.5 border border-white/10 rounded-lg text-[9px] font-black text-slate-400 hover:text-amber-500 transition-colors">ê²½ê³ </button>
                   <button onclick="openPenaltyModal(<%= stat[:member].id %>, '<%= stat[:member].user.nickname %>', 'kick')" class="px-3 py-1.5 border border-white/10 rounded-lg text-[9px] font-black text-slate-400 hover:text-rose-500 transition-colors">ê°•í‡´</button>
                </div>
              </div>
            <% end %>
          </div>
        </section>

        <!-- Staff List (Moved inside Member Management) -->
        <section class="px-6 space-y-4">
          <div class="flex items-center justify-between px-1">
            <h2 class="text-xs font-black text-slate-500 uppercase tracking-[0.2em]">í´ëŸ½ ê´€ë¦¬ ìŠ¤íƒœí”„</h2>
          </div>
          <div class="space-y-3">
            <% if @club_admins.any? %>
              <% @club_admins.each do |admin| %>
                <div class="app-glass-card p-4 flex items-center justify-between border-white/5">
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-black text-white truncate"><%= admin.nickname %></p>
                    <p class="text-[9px] font-bold text-indigo-400/60 uppercase tracking-widest">Moderator</p>
                  </div>
                  <button class="text-slate-600 hover:text-rose-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                </div>
              <% end %>
            <% end %>
          </div>
        </section>
      </div>

      <!-- Lounge Management Panel -->
      <div id="panel-lounge" class="px-6 hidden">
        <div class="app-glass-card p-6 border-white/5 space-y-8" data-controller="lounge-settings">
          <div class="flex items-center justify-between border-b border-white/5 pb-4">
            <h3 class="text-lg font-black text-indigo-400 uppercase tracking-widest">ë¼ìš´ì§€ ì‹¤ì‹œê°„ ì„¤ì •</h3>
            <span class="text-[9px] font-black text-slate-500">Live & Lecture Room</span>
          </div>

          <%= form_with model: @official_club, url: prototype_update_club_lounge_path, method: :patch, local: true, class: "space-y-8" do |f| %>
            <!-- LIVE ROOM -->
            <div class="space-y-4" data-lounge-settings-target="liveContainer">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-xl bg-indigo-500/20 flex items-center justify-center text-sm">ğŸ“¹</div>
                  <span class="text-xs font-black text-white uppercase tracking-widest">LIVE ROOM</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <%= f.check_box :live_room_active, class: "sr-only peer", data: { lounge_settings_target: "liveToggle", action: "change->lounge-settings#toggleLive" } %>
                  <div class="w-9 h-5 bg-white/10 rounded-full peer peer-checked:bg-indigo-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
                </label>
              </div>
              <div class="space-y-3">
                <%= f.text_field :live_room_title, placeholder: "ë¼ì´ë¸Œ ë°© ì œëª©", class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all disabled:opacity-30", data: { lounge_settings_target: "liveInput" } %>
                <div class="grid grid-cols-2 gap-3">
                  <%= f.text_field :live_room_button_text, placeholder: "ë²„íŠ¼ëª… (ì˜ˆ: ì…ì¥í•˜ê¸°)", class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all disabled:opacity-30", data: { lounge_settings_target: "liveInput" } %>
                  <%= f.text_field :zoom_link, placeholder: "ë§í¬ URL", class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all disabled:opacity-30", data: { lounge_settings_target: "liveInput" } %>
                </div>
              </div>
            </div>

            <!-- LECTURE ROOM -->
            <div class="space-y-4" data-lounge-settings-target="lectureContainer">
              <div class="flex items-center justify-between pt-4 border-t border-white/5">
                <div class="flex items-center gap-3">
                  <div class="w-8 h-8 rounded-xl bg-purple-500/20 flex items-center justify-center text-sm">ğŸ“</div>
                  <span class="text-xs font-black text-white uppercase tracking-widest">LECTURE ROOM</span>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <%= f.check_box :lecture_room_active, class: "sr-only peer", data: { lounge_settings_target: "lectureToggle", action: "change->lounge-settings#toggleLecture" } %>
                  <div class="w-9 h-5 bg-white/10 rounded-full peer peer-checked:bg-purple-500 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:after:translate-x-full"></div>
                </label>
              </div>
              <div class="space-y-3">
                <%= f.text_field :lecture_room_title, placeholder: "ê°•ì˜ì‹¤ ì œëª©", class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-purple-500 outline-none transition-all disabled:opacity-30", data: { lounge_settings_target: "lectureInput" } %>
                <%= f.text_area :lecture_room_description, placeholder: "ê°•ì˜ ìƒì„¸ ì„¤ëª…", rows: 2, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-medium text-slate-300 focus:border-purple-500 outline-none transition-all disabled:opacity-30", data: { lounge_settings_target: "lectureInput" } %>
                <%= f.text_field :special_lecture_link, placeholder: "ê°•ì˜ì‹¤ ë§í¬", class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-purple-500 outline-none transition-all disabled:opacity-30", data: { lounge_settings_target: "lectureInput" } %>
              </div>
            </div>

            <button type="submit" class="w-full py-4 bg-indigo-600 rounded-2xl text-white font-black text-xs shadow-xl shadow-indigo-600/20 active:scale-95 transition-all">ë¼ìš´ì§€ ì„¤ì • ì—…ë°ì´íŠ¸</button>
          <% end %>
        </div>
      </div>

      <!-- Club Settings Panel -->
      <div id="panel-settings" class="px-6 hidden space-y-8">
        <div class="app-glass-card p-6 border-white/5 space-y-8">
          <div class="flex items-center justify-between border-b border-white/5 pb-4">
            <h3 class="text-lg font-black text-indigo-400 uppercase tracking-widest">í´ëŸ½ ê¸°ë³¸ ë° ìš´ì˜ ì„¤ì •</h3>
          </div>

          <%= form_with model: @official_club, url: prototype_update_club_lounge_path, method: :patch, local: true, class: "space-y-8" do |f| %>
            <!-- Basic Info -->
            <div class="space-y-4">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-xl bg-orange-500/20 flex items-center justify-center text-sm">ğŸ“</div>
                <span class="text-xs font-black text-white uppercase tracking-widest">ê¸°ë³¸ ì •ë³´ ë° ì² í•™</span>
              </div>
              <div class="space-y-3">
                <div class="space-y-1.5">
                  <%= f.label :title, "í´ëŸ½ íƒ€ì´í‹€", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.text_field :title, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
                <div class="space-y-1.5">
                  <%= f.label :description, "í´ëŸ½ ì² í•™ ë° ìƒì„¸ ì†Œê°œ (Landing)", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.text_area :description, rows: 6, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-medium text-slate-300 focus:border-indigo-500 outline-none transition-all leading-relaxed", placeholder: "ì—¬ê¸°ì— ì‘ì„±ëœ ë‚´ìš©ì´ ê°€ì… í˜ì´ì§€ ë©”ì¸ì— ë…¸ì¶œë©ë‹ˆë‹¤." %>
                </div>
              </div>
            </div>

            <div class="h-px w-full bg-white/5"></div>

            <!-- Bank Info -->
            <div class="space-y-4">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-xl bg-emerald-500/20 flex items-center justify-center text-sm">ğŸ’³</div>
                <span class="text-xs font-black text-white uppercase tracking-widest">ê²°ì œ ë° ê³„ì¢Œ ì •ë³´</span>
              </div>
              <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1.5">
                  <%= f.label :bank_name, "ì€í–‰ëª…", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.text_field :bank_name, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
                <div class="space-y-1.5">
                  <%= f.label :account_holder, "ì˜ˆê¸ˆì£¼", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.text_field :account_holder, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
                <div class="col-span-2 space-y-1.5">
                  <%= f.label :account_number, "ê³„ì¢Œë²ˆí˜¸", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.text_field :account_number, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
              </div>
            </div>

            <div class="h-px w-full bg-white/5"></div>

            <!-- Operating Rules & Thresholds -->
            <div class="space-y-4">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-xl bg-purple-500/20 flex items-center justify-center text-sm">âš–ï¸</div>
                <span class="text-xs font-black text-white uppercase tracking-widest">ìš´ì˜ ê·œì¹™ ë° ì„ê³„ì¹˜ ì„¤ì •</span>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                <div class="space-y-1.5">
                  <%= f.label :relax_pass_limit, "íœ´ì‹ê¶Œ (ì‹œì¦Œë‹¹)", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.number_field :relax_pass_limit, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
                <div class="space-y-1.5">
                  <%= f.label :save_pass_limit, "ì„¸ì´ë¸Œê¶Œ (ì‹œì¦Œë‹¹)", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.number_field :save_pass_limit, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
                <div class="space-y-1.5">
                  <%= f.label :golden_fire_bonus, "í™©ê¸ˆë¶ˆê½ƒ ë³´ë„ˆìŠ¤(P)", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.number_field :golden_fire_bonus, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
                <div class="space-y-1.5">
                  <%= f.label :auto_kick_threshold, "ì œëª… ê¸°ì¤€ (ê²½ê³  íšŸìˆ˜: ì£¼ê°„ 70% ë¯¸ë§Œ ì‹œ 1íšŒ)", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.number_field :auto_kick_threshold, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
                <div class="space-y-1.5">
                  <%= f.label :completion_attendance_rate, "ì™„ì£¼ ê¸°ì¤€ (ì¶œì„ë¥  %)", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.number_field :completion_attendance_rate, step: 0.1, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
              </div>
            </div>

            <div class="h-px w-full bg-white/5"></div>

            <!-- Reward Systems -->
            <div class="space-y-4">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-xl bg-amber-500/20 flex items-center justify-center text-sm">ğŸ</div>
                <span class="text-xs font-black text-white uppercase tracking-widest">ë¦¬ì›Œë“œ ë° ì‹œìŠ¤í…œ ì•ˆë‚´</span>
              </div>
              <div class="space-y-4">
                <div class="space-y-1.5">
                  <%= f.label :weekly_reward_info, "ì£¼ê°„ ë¦¬ì›Œë“œ (Weekly Milestone)", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.text_field :weekly_reward_info, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-bold text-white focus:border-indigo-500 outline-none transition-all" %>
                </div>
                <div class="space-y-1.5">
                  <%= f.label :monthly_reward_info, "ì›”ê°„ ë¦¬ì›Œë“œ (Monthly Milestone)", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.text_area :monthly_reward_info, rows: 2, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-medium text-slate-300 focus:border-indigo-500 outline-none transition-all" %>
                </div>
                <div class="space-y-1.5">
                  <%= f.label :season_reward_info, "ì‹œì¦Œ ë¦¬ì›Œë“œ (MVP/Legend)", class: "text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1" %>
                  <%= f.text_area :season_reward_info, rows: 2, class: "w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-xs font-medium text-slate-300 focus:border-indigo-500 outline-none transition-all" %>
                </div>
              </div>
            </div>

            <button type="submit" class="w-full py-4 bg-indigo-600 rounded-2xl text-white font-black text-xs shadow-xl shadow-indigo-600/20 active:scale-95 transition-all">ê¸°ë³¸ ì„¤ì • ì—…ë°ì´íŠ¸ ì™„ë£Œ</button>
          <% end %>
        </div>
      </div>

      <!-- Announcements Panel -->
      <div id="panel-announcements" class="px-6 hidden space-y-8">
        <!-- Create Announcement Placeholder -->
        <div class="app-glass-card p-6 border-white/5 bg-white/2 space-y-4">
           <div class="flex items-center gap-3">
             <div class="w-8 h-8 bg-indigo-500 rounded-xl flex items-center justify-center text-white text-xs">ğŸ“£</div>
             <h3 class="text-sm font-black text-white">í´ëŸ½ ê³µì§€ì‚¬í•­ ë“±ë¡</h3>
           </div>
           <%= form_with url: prototype_create_club_announcement_path, method: :post, local: true, class: "space-y-3" do |f| %>
             <%= f.text_field :title, placeholder: "ê³µì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”", class: "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs font-bold text-white outline-none focus:border-indigo-500 transition-all", required: true %>
             <%= f.text_area :content, placeholder: "ê³µì§€ ë‚´ìš©ì„ ìƒì„¸íˆ ì…ë ¥í•˜ì„¸ìš”", rows: 4, class: "w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs font-medium text-slate-300 outline-none focus:border-indigo-500 transition-all", required: true %>
             <%= f.submit "ê³µì§€ ê²Œì‹œí•˜ê¸°", class: "w-full py-3 bg-white/10 hover:bg-white/20 text-white font-black text-xs rounded-xl transition-all cursor-pointer" %>
           <% end %>
        </div>

        <div class="space-y-4">
          <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest pl-1">ê²Œì‹œëœ ìµœê·¼ ê³µì§€</h4>
          <% if @announcements.any? %>
            <% @announcements.each do |ann| %>
              <div class="app-glass-card p-5 border-white/5 flex items-start justify-between gap-4">
                 <div class="space-y-1">
                   <p class="text-xs font-black text-white"><%= ann.title %></p>
                   <p class="text-[10px] text-slate-500 font-medium line-clamp-1"><%= ann.content %></p>
                   <p class="text-[8px] font-black text-slate-600 uppercase tracking-tighter pt-1"><%= ann.created_at.strftime("%Y.%m.%d") %></p>
                 </div>
                 <button onclick="openEditAnnouncementModal(<%= ann.id %>, '<%= j ann.title %>', '<%= j ann.content %>')" class="text-slate-600 hover:text-white transition-colors">
                   <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                 </button>
              </div>
            <% end %>
          <% else %>
            <div class="py-12 text-center border-white/5 rounded-3xl border border-dashed">
              <p class="text-[10px] font-bold text-slate-600">ë“±ë¡ëœ ê³µì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
     <!-- No Club State (Keep as is) -->
     <div class="px-6">
        <div class="py-20 text-center app-glass-card border-white/10">
           <div class="w-20 h-20 mx-auto bg-indigo-500/10 rounded-3xl flex items-center justify-center p-4 border border-indigo-500/20">
             <%= image_tag "rf_official_logo.png", class: "w-full h-full object-contain" %>
           </div>
           <h2 class="text-xl font-black text-white mt-6">ê³µì‹ í´ëŸ½ ì •ë³´ ì—†ìŒ</h2>
           <button class="mt-8 px-8 py-4 bg-indigo-600 rounded-2xl text-white font-black text-sm">ë£¨íŒŒ í´ëŸ½ ê°œì„¤í•˜ê¸°</button>
        </div>
     </div>
  <% end %>
</div>

<!-- Message Modal -->
<div id="message-modal" class="hidden fixed inset-0 bg-black/50 z-[6000] flex items-center justify-center p-4">
  <div class="bg-[#1B1A24] rounded-3xl max-w-md w-full p-8 border border-white/10 shadow-2xl animate-badge-pop" onclick="event.stopPropagation()">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-black text-white leading-none">ê°œì¸ ë©”ì‹œì§€ ì „ì†¡</h3>
      <button onclick="closeMessageModal()" class="p-2 hover:bg-white/5 rounded-lg transition-colors">
        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <%= form_with url: send_message_routine_club_path(@official_club, source: 'prototype'), method: :post, class: "space-y-6" do |f| %>
      <%= hidden_field_tag :recipient_id, "", id: "recipient-id" %>
      
      <div class="bg-indigo-500/10 border border-indigo-500/20 rounded-2xl p-4">
        <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-1">Recipient</p>
        <p class="text-sm font-bold text-white" id="recipient-name"></p>
      </div>

      <div class="space-y-2">
        <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1">Message Content</label>
        <%= text_area_tag :message, "", 
            id: "message-content",
            rows: 6, 
            class: "w-full px-5 py-4 bg-white/5 border border-white/10 rounded-2xl focus:border-indigo-500 font-medium text-sm text-white resize-none outline-none transition-all",
            placeholder: "ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." %>
      </div>

      <div class="flex gap-3">
        <%= f.submit "ì „ì†¡", class: "flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-600/20 cursor-pointer" %>
        <button type="button" onclick="closeMessageModal()" class="flex-1 py-4 bg-white/5 text-slate-400 rounded-2xl font-black text-xs hover:bg-white/10 transition-all">
          ì·¨ì†Œ
        </button>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Main Tab Switcher
  function switchClubTab(tabName) {
    const tabs = ['members', 'lounge', 'announcements', 'settings'];
    const activeClass = "text-indigo-400 border-indigo-400";
    const inactiveClass = "text-slate-500 border-transparent";
    
    tabs.forEach(t => {
       const btn = document.getElementById(`tab-btn-${t}`);
       const panel = document.getElementById(`panel-${t}`);
       
       if (t === tabName) {
         btn.className = `flex-1 pb-4 text-xs font-black uppercase tracking-widest border-b-2 transition-all ${activeClass}`;
         panel.classList.remove('hidden');
       } else {
         btn.className = `flex-1 pb-4 text-xs font-black uppercase tracking-widest border-b-2 transition-all ${inactiveClass}`;
         panel.classList.add('hidden');
       }
    });
  }

  // Sub Tab Switcher (Live Data)
  function switchSubTab(tabName) {
    const listBtn = document.getElementById('sub-tab-btn-list');
    const analysisBtn = document.getElementById('sub-tab-btn-analysis');
    const listPanel = document.getElementById('sub-panel-list');
    const analysisPanel = document.getElementById('sub-panel-analysis');
    
    const activeClass = "bg-white/10 text-white";
    const inactiveClass = "text-slate-500";
    const baseClass = "px-3 py-1 text-[9px] font-black rounded transition-all whitespace-nowrap";

    if (tabName === 'list') {
      listBtn.className = `${baseClass} ${activeClass}`;
      analysisBtn.className = `${baseClass} ${inactiveClass}`;
      listPanel.classList.remove('hidden');
      analysisPanel.classList.add('hidden');
    } else {
      analysisBtn.className = `${baseClass} ${activeClass}`;
      listBtn.className = `${baseClass} ${inactiveClass}`;
      analysisPanel.classList.remove('hidden');
      listPanel.classList.add('hidden');
    }

    // Persist sub-tab state in URL
    const url = new URL(window.location.href);
    url.searchParams.set('sub_tab', tabName);
    window.history.replaceState({}, '', url);
  }

  function updateMemberSort(val) {
    const url = new URL(window.location.href);
    url.searchParams.set('member_sort', val);
    window.location.href = url.toString();
  }

  // Restore sub-tab from URL on load
  document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const subTab = urlParams.get('sub_tab');
    if (subTab === 'analysis') {
      switchSubTab('analysis');
    }
  });

  function toggleMemberDetail(memberId) {
    const detail = document.getElementById(`member-detail-${memberId}`);
    const icon = document.getElementById(`member-icon-${memberId}`);
    
    if (detail.classList.contains('hidden')) {
      detail.classList.remove('hidden');
      icon.classList.add('rotate-180');
    } else {
      detail.classList.add('hidden');
      icon.classList.remove('rotate-180');
    }
  }

  function openMessageModal(userId, userName) {
    document.getElementById('message-modal').classList.remove('hidden');
    document.getElementById('recipient-id').value = userId;
    document.getElementById('recipient-name').textContent = userName;
    document.getElementById('message-content').value = '';
    document.getElementById('message-content').focus();
  }

  function closeMessageModal() {
    document.getElementById('message-modal').classList.add('hidden');
  }

  // Close modal when clicking outside
  document.addEventListener('click', function(event) {
    const messageModal = document.getElementById('message-modal');
    const penaltyModal = document.getElementById('penalty-modal');
    const analysisModal = document.getElementById('analysis-modal');
    if (event.target === messageModal) {
      closeMessageModal();
    }
    if (event.target === penaltyModal) {
      closePenaltyModal();
    }
    if (event.target === analysisModal) {
       closeAnalysisModal();
    }
  });

  function openPenaltyModal(memberId, userName, actionType) {
    const modal = document.getElementById('penalty-modal');
    const title = document.getElementById('penalty-title');
    const form = document.getElementById('penalty-form');
    const targetName = document.getElementById('penalty-target-name');
    const submitBtn = document.getElementById('penalty-submit-btn');
    
    document.getElementById('penalty-member-id').value = memberId;
    targetName.textContent = userName;
    
    if (actionType === 'warn') {
      title.textContent = 'ìš´ì˜ ì •ì±… ê²½ê³  ë¶€ì—¬';
      form.action = `<%= @official_club ? warn_member_routine_club_path(@official_club, source: 'prototype') : "#" %>`;
      submitBtn.textContent = 'ê²½ê³  ë¶€ì—¬ í™•ì •';
      submitBtn.className = 'flex-1 py-4 bg-amber-600 text-white rounded-2xl font-black text-xs hover:bg-amber-700 transition-all shadow-xl shadow-amber-600/20 cursor-pointer';
    } else {
      title.textContent = 'ì‹œìŠ¤í…œ ì˜êµ¬ ì œëª…';
      form.action = `<%= @official_club ? kick_member_routine_club_path(@official_club, source: 'prototype') : "#" %>`;
      submitBtn.textContent = 'ì œëª… ì²˜ë¦¬ í™•ì •';
      submitBtn.className = 'flex-1 py-4 bg-rose-600 text-white rounded-2xl font-black text-xs hover:bg-rose-700 transition-all shadow-xl shadow-rose-600/20 cursor-pointer';
    }
    
    modal.classList.remove('hidden');
    document.getElementById('penalty-reason').value = '';
    document.getElementById('penalty-reason').focus();
  }

  function closePenaltyModal() {
    document.getElementById('penalty-modal').classList.add('hidden');
  }

  // Analysis Modal Logic
  function openAnalysisModal(userId, type) {
   const modal = document.getElementById('analysis-modal');
   const content = document.getElementById('analysis-modal-content');
   
   // Show spinner or loading state
   content.innerHTML = '<div class="flex items-center justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div></div>';
   modal.classList.remove('hidden');

   // Fetch data
   fetch(`/admin_center/analyze_member_performance?user_id=${userId}&type=${type}`)
     .then(response => response.text())
     .then(html => {
       content.innerHTML = html;
     })
     .catch(error => {
       content.innerHTML = '<div class="text-center py-10 text-rose-500 text-xs font-bold">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
       console.error('Error:', error);
     });
  }

   function closeAnalysisModal() {
       document.getElementById('analysis-modal').classList.add('hidden');
   }

   // Edit Announcement Modal Logic
   function openEditAnnouncementModal(announcementId, title, content) {
     const modal = document.getElementById('edit-announcement-modal');
     document.getElementById('edit-announcement-id').value = announcementId;
     document.getElementById('edit-announcement-title').value = title;
     document.getElementById('edit-announcement-content').value = content;
     modal.classList.remove('hidden');
   }

   function closeEditAnnouncementModal() {
     document.getElementById('edit-announcement-modal').classList.add('hidden');
   }
</script>

<!-- Penalty Modal -->
<div id="penalty-modal" class="hidden fixed inset-0 bg-black/50 z-[6000] flex items-center justify-center p-4">
  <div class="bg-[#1B1A24] rounded-3xl max-w-md w-full p-8 border border-white/10 shadow-2xl animate-badge-pop" onclick="event.stopPropagation()">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-black text-white leading-none" id="penalty-title">ê²½ê³ /ì œëª… ì²˜ë¦¬</h3>
      <button onclick="closePenaltyModal()" class="p-2 hover:bg-white/5 rounded-lg transition-colors">
        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <%= form_with url: "#", method: :post, id: "penalty-form", class: "space-y-6" do |f| %>
      <%= hidden_field_tag :member_id, "", id: "penalty-member-id" %>
      
      <div class="bg-white/5 border border-white/10 rounded-2xl p-4">
        <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Target Member</p>
        <p class="text-sm font-bold text-white" id="penalty-target-name"></p>
      </div>

      <div class="space-y-2">
        <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1">Penalty Reason <span class="text-rose-500">*</span></label>
        <%= text_area_tag :reason, "", 
            id: "penalty-reason",
            rows: 4, 
            required: true,
            class: "w-full px-5 py-4 bg-white/5 border border-white/10 rounded-2xl focus:border-indigo-500 font-medium text-sm text-white resize-none outline-none transition-all",
            placeholder: "ì‚¬ìœ ë¥¼ ì •ì¤‘í•˜ë©´ì„œë„ ëª…í™•í•˜ê²Œ ì…ë ¥í•˜ì„¸ìš”..." %>
      </div>

      <div class="flex gap-3">
        <%= f.submit "ì²˜ë¦¬í•˜ê¸°", id: "penalty-submit-btn", class: "flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-600/20 cursor-pointer" %>
        <button type="button" onclick="closePenaltyModal()" class="flex-1 py-4 bg-white/5 text-slate-400 rounded-2xl font-black text-xs hover:bg-white/10 transition-all">
          ì·¨ì†Œ
        </button>
      </div>
    <% end %>
  </div>
</div>

<!-- Edit Announcement Modal -->
<div id="edit-announcement-modal" class="hidden fixed inset-0 bg-black/50 z-[6000] flex items-center justify-center p-4">
  <div class="bg-[#1B1A24] rounded-3xl max-w-md w-full p-8 border border-white/10 shadow-2xl animate-badge-pop" onclick="event.stopPropagation()">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-black text-white leading-none">ê³µì§€ì‚¬í•­ ìˆ˜ì •</h3>
      <button onclick="closeEditAnnouncementModal()" class="p-2 hover:bg-white/5 rounded-lg transition-colors">
        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <%= form_with url: "#", method: :patch, id: "edit-announcement-form", class: "space-y-6", onsubmit: "this.action='/admin_center/update_club_announcement/' + document.getElementById('edit-announcement-id').value" do |f| %>
      <%= hidden_field_tag :id, "", id: "edit-announcement-id" %>
      
      <div class="space-y-2">
        <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1">ì œëª©</label>
        <%= text_field_tag :title, "", id: "edit-announcement-title", class: "w-full px-5 py-4 bg-white/5 border border-white/10 rounded-2xl focus:border-indigo-500 font-bold text-sm text-white outline-none transition-all", required: true %>
      </div>

      <div class="space-y-2">
        <label class="block text-[9px] font-black text-slate-500 uppercase tracking-widest pl-1">ë‚´ìš©</label>
        <%= text_area_tag :content, "", id: "edit-announcement-content", rows: 6, class: "w-full px-5 py-4 bg-white/5 border border-white/10 rounded-2xl focus:border-indigo-500 font-medium text-sm text-white resize-none outline-none transition-all", required: true %>
      </div>

      <div class="flex gap-3">
        <%= f.submit "ìˆ˜ì •í•˜ê¸°", class: "flex-1 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-600/20 cursor-pointer" %>
        <button type="button" onclick="closeEditAnnouncementModal()" class="flex-1 py-4 bg-white/5 text-slate-400 rounded-2xl font-black text-xs hover:bg-white/10 transition-all">
          ì·¨ì†Œ
        </button>
      </div>
    <% end %>
  </div>
</div>

<!-- Analysis Modal -->
<div id="analysis-modal" class="hidden fixed inset-0 bg-black/50 z-[6000] flex items-center justify-center p-4">
   <div class="bg-[#1B1A24] rounded-3xl max-w-md w-full p-8 border border-white/10 shadow-2xl animate-badge-pop relative" onclick="event.stopPropagation()">
       <!-- Close button set absolutely to top-right -->
       <button onclick="closeAnalysisModal()" class="absolute top-4 right-4 p-2 hover:bg-white/5 rounded-lg transition-colors z-20">
           <svg class="w-6 h-6 text-slate-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
           </svg>
       </button>

       <div id="analysis-modal-content">
           <!-- Content loaded via AJAX -->
       </div>
   </div>
</div>
