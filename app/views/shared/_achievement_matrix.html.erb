<% compact ||= false %>
<section id="achievement-matrix"
         class="bg-white rounded-[32px] md:rounded-[40px] <%= compact ? 'p-3 md:p-4' : 'p-4 md:p-6' %> border border-slate-100 shadow-sm space-y-4 md:space-y-6 relative overflow-hidden group"
         data-controller="tabs"
         data-tabs-query-param-value="matrix_tab"
         data-tabs-active-class="bg-indigo-600 text-white shadow-lg z-10"
         data-tabs-inactive-class="text-slate-400 hover:text-slate-600">
  <div class="absolute -right-4 -top-4 w-24 h-24 bg-indigo-50/50 rounded-full blur-2xl group-hover:scale-110 transition-transform"></div>
  
  <div class="relative z-10 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
    <div>
      <h3 class="<%= compact ? 'text-base' : 'text-xl' %> font-black text-slate-900 tracking-tight">성취 매트릭스</h3>
      <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mt-0.5"><%= Date.current.year %> Matrix</p>
    </div>
    
    <div class="flex bg-slate-100/50 p-1 rounded-xl self-start sm:self-auto min-w-[140px]">
      <button data-tabs-target="tab" data-action="click->tabs#change" data-id="month"
              class="flex-1 px-4 py-2 rounded-lg text-[10px] font-black transition-all bg-indigo-600 text-white shadow-lg z-10">1개월</button>
      <button data-tabs-target="tab" data-action="click->tabs#change" data-id="year"
              class="flex-1 px-4 py-2 rounded-lg text-[10px] font-black transition-all text-slate-400 hover:text-slate-600">1년</button>
    </div>
  </div>

  <%# Month View Panel (Active by Default) %>
  <div data-tabs-target="panel" data-id="month" class="relative z-10 space-y-4">
    <div class="grid grid-cols-7 gap-1 md:gap-1.5 w-full mx-auto" style="max-width: 400px;">
      <% ["S", "M", "T", "W", "T", "F", "S"].each do |day| %>
        <div class="text-[9px] font-black text-slate-300 text-center py-1 md:py-2"><%= day %></div>
      <% end %>

      <% 
        start_of_month = Date.current.beginning_of_month
        grid_start_month = start_of_month - start_of_month.wday
        end_of_month = Date.current.end_of_month
        grid_end_month = end_of_month + (6 - end_of_month.wday)
      %>
      
      <% (grid_start_month..grid_end_month).each do |date| %>
        <% 
          is_current_month = date.month == Date.current.month
          count = @activity_data[date] || 0
          color_class = case
          when !is_current_month then "bg-transparent opacity-0"
          when count == 0 then "bg-slate-50"
          when count <= 2 then "bg-indigo-100"
          when count <= 4 then "bg-indigo-300"
          else "bg-indigo-600"
          end
          
          is_today = date == Date.current
        %>
        <div class="aspect-square rounded-lg md:rounded-xl <%= color_class %> transition-all relative group/day <%= 'ring-2 ring-indigo-500 ring-offset-2 scale-90' if is_today && is_current_month %>" 
             title="<%= date %>: <%= count %> activities">
          <% if is_today && is_current_month %>
            <span class="absolute -top-1 -right-1 w-1.5 h-1.5 bg-indigo-500 rounded-full"></span>
          <% end %>
          <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover/day:opacity-100 transition-opacity pointer-events-none">
             <span class="text-[8px] font-black <%= count > 2 ? 'text-white' : 'text-indigo-600' %>"><%= date.day %></span>
          </div>
        </div>
      <% end %>
    </div>

    <div class="flex justify-between items-center pt-4 border-t border-slate-50">
      <div class="flex items-center gap-1.5">
        <div class="w-2.5 h-2.5 rounded-full bg-indigo-600"></div>
        <span class="text-[9px] font-bold text-slate-500">Target Reached</span>
      </div>
      <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest text-right">
        <%= @monthly_completions&.count || 0 %> DONE THIS MONTH
      </p>
    </div>
  </div>

  <%# Year View Panel (Initially Hidden) - Optimized with 3-column Month Grid %>
  <div data-tabs-target="panel" data-id="year" class="hidden relative z-10 space-y-2">
    <div class="grid grid-cols-3 gap-x-2 gap-y-4">
      <% 
        # Show last 12 months including current
        12.times.reverse_each do |i| 
          target_month = Date.current - i.months
          m_start = target_month.beginning_of_month
          m_end = target_month.end_of_month
          # Align to Sunday
          grid_s = m_start - m_start.wday
          grid_e = m_end + (6 - m_end.wday)
      %>
        <div class="space-y-1">
          <p class="text-[7px] font-black text-slate-300 uppercase"><%= target_month.strftime("%b") %></p>
          <div class="grid grid-cols-7 gap-[1px]">
            <% (grid_s..grid_e).each do |date| %>
              <% 
                is_this_month = date.month == target_month.month
                count = @activity_data[date] || 0
                color = if !is_this_month
                          "bg-transparent"
                        elsif count == 0
                          "bg-slate-50"
                        elsif count <= 2
                          "bg-indigo-100"
                        elsif count <= 4
                          "bg-indigo-300"
                        else
                          "bg-indigo-600"
                        end
              %>
              <div class="aspect-square rounded-[1px] <%= color %> scale-[0.85]"></div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
    
    <div class="flex justify-between items-center pt-3 border-t border-slate-50">
      <div class="flex items-center gap-1">
        <div class="w-2 h-2 rounded-[1px] bg-slate-50"></div>
        <div class="w-2 h-2 rounded-[1px] bg-indigo-100"></div>
        <div class="w-2 h-2 rounded-[1px] bg-indigo-300"></div>
        <div class="w-2 h-2 rounded-[1px] bg-indigo-600"></div>
      </div>
      <p class="text-[8px] font-black text-slate-400 uppercase tracking-tighter">
        <%= @activity_data.values.sum %> TOTAL DONE THIS YEAR
      </p>
    </div>
  </div>
</section>
