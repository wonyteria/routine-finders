<%= turbo_stream.prepend "routine-container" do %>
  <%= render "routine_card", routine: @routine %>
<% end %>

<%= turbo_stream.remove "no-routines-msg" %>
<%= turbo_stream.remove "no-total-routines-msg" %>

<%= turbo_stream.prepend "total-routine-list" do %>
  <%= render "total_routine_item", routine: @routine %>
<% end %>

<%= turbo_stream.replace "new_personal_routine" do %>
  <%= render partial: "personal_routines/form", locals: { routine: PersonalRoutine.new } %>
<% end %>

<%# Update stats in sidebar if needed %>
<%= turbo_stream.update "monthly-done-count" do %>
  <%= @monthly_completions&.count || 0 %>
<% end %>

<%= turbo_stream.update "total-active-count" do %>
  <%= current_user.personal_routines.count %> Active
<% end %>

<%= turbo_stream.replace "achievement-matrix" do %>
  <%= render "shared/achievement_matrix" %>
<% end %>


<%= turbo_stream.append "body" do %>
  <script>
    if (typeof filterRoutines === 'function') {
      const activeBtn = document.querySelector('.routine-filter-btn.bg-white');
      if (activeBtn) {
        const day = activeBtn.id.replace('btn-', '');
        filterRoutines(day);
      }
    }
  </script>
<% end %>
<%# Update Prototype Views if applicable %>
<% 
  current_day_name = Date::DAYNAMES[Date.current.wday]
  todays_routines = current_user.personal_routines.select { |r| (r.days || []).include?(current_day_name) }
  joined_participations = current_user ? current_user.participations.active.joins(:challenge) : []
  
  routine_total = todays_routines.count
  participation_total = joined_participations.count
  total_task_count = routine_total + participation_total

  routine_done = todays_routines.select(&:completed_today?).count
  participation_done = current_user ? VerificationLog.where(participant: joined_participations, created_at: Date.current.all_day).pluck(:participant_id).uniq.count : 0

  completed_count = routine_done + participation_done
  progress = total_task_count.positive? ? (completed_count.to_f / total_task_count * 100).to_i : 0
%>

<% 
  orbit_total_particles = [User.joins(:rufa_activities).where("rufa_activities.created_at >= ?", 30.minutes.ago).distinct.count, 1].max
%>
<%= turbo_stream.replace "prototype-orbit-section" do %>
  <%= render partial: "prototype/orbit", locals: { 
        progress: progress, 
        completed_count: completed_count, 
        total_task_count: total_task_count,
        orbit_total_particles: orbit_total_particles,
        orbit_users: [],
        todays_routines: todays_routines
      } %>
<% end %>

<%= turbo_stream.update "prototype-routine-list" do %>
  <% if todays_routines.any? %>
    <% todays_routines.each do |routine| %>
      <div id="routine_<%= routine.id %>_prototype">
        <%= button_to toggle_personal_routine_path(routine), 
                    method: :post, 
                    data: { action: "submit->proto-ui#checkLogin", turbo_stream: true },
                    class: "w-full app-glass-card p-5 flex items-center justify-between border-transparent hover:border-indigo-500/30 transition-all app-tap-active group #{routine.completed_today? ? 'bg-indigo-500/10' : ''}" do %>
          <div class="flex items-center gap-4">
            <span class="text-3xl group-active:scale-125 transition-transform"><%= routine.icon %></span>
            <div class="text-left">
              <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-0.5"><%= routine.category %></p>
              <p class="text-sm font-black text-white leading-none"><%= routine.title %></p>
            </div>
          </div>
          <div class="w-8 h-8 rounded-xl border-2 flex items-center justify-center transition-all #{routine.completed_today? ? 'bg-indigo-500 border-indigo-500 shadow-lg shadow-indigo-500/20' : 'border-white/10' }">
             <% if routine.completed_today? %>
               <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
             <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="app-glass-card py-16 text-center border-dashed border-white/10">
      <p class="text-sm font-bold text-slate-500">아직 루틴이 없습니다.<br/>[+] 버튼으로 추가해보세요!</p>
    </div>
  <% end %>
<% end %>
