<div class="min-h-screen bg-[#0C0B12] pb-32" data-controller="tabs" data-tabs-active-class="bg-indigo-500 text-white shadow-lg shadow-indigo-500/20" data-tabs-inactive-class="bg-white/5 text-slate-400">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-[#0C0B12]/80 backdrop-blur-md border-b border-white/5">
    <div class="px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <%= link_to prototype_admin_clubs_path, class: "w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-slate-400 hover:text-white transition-colors" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        <% end %>
        <div>
          <h1 class="text-lg font-black text-white">시스템 점검 리포트</h1>
          <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Auto monitoring system</p>
        </div>
      </div>
      <div class="px-3 py-1 rounded-lg bg-indigo-500/10 border border-indigo-500/20">
        <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest leading-none">Management</span>
      </div>
    </div>

    <!-- Tabs Container -->
    <div class="px-6 pb-2">
      <div class="flex p-1 bg-white/5 rounded-xl gap-1">
        <button data-tabs-target="tab" data-id="confirmed" data-action="click->tabs#change" class="flex-1 py-2 px-3 rounded-lg text-xs font-black transition-all duration-300">
          지난주 결과
        </button>
        <button data-tabs-target="tab" data-id="live" data-action="click->tabs#change" class="flex-1 py-2 px-3 rounded-lg text-xs font-black transition-all duration-300">
          실시간 위험군
        </button>
      </div>
    </div>
  </header>

  <main class="px-6 py-8 space-y-12">
    <!-- Tab A: 지난주 결과 -->
    <section data-tabs-target="panel" data-id="confirmed" class="space-y-6">
      <div class="px-1">
        <div class="flex items-center justify-between">
          <h2 class="text-xs font-black text-rose-500 uppercase tracking-[0.2em] flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full bg-rose-500"></span>
            지난주 점검 결과 (확정)
          </h2>
          <span class="text-xs font-black text-white"><%= @confirmed_risks.count %>명</span>
        </div>
        <p class="text-[10px] text-slate-500 mt-2 font-medium">
          기준 기간: <span class="text-slate-300"><%= @last_week_start.strftime("%m/%d") %> ~ <%= @last_week_end.strftime("%m/%d") %></span>
          <br/>
          이분들은 오늘(월요일) 새벽에 실제로 경고가 부여된 대상자들입니다.
        </p>
      </div>

      <% if @confirmed_risks.any? %>
        <div class="grid gap-3">
          <% @confirmed_risks.each do |risk| %>
            <% m = risk[:member]; stats = risk[:stats] %>
            <div class="app-glass-card p-4 border-rose-500/20 bg-rose-500/5 space-y-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-slate-800 border border-white/10 overflow-hidden">
                    <img src="<%= m.user.profile_image %>" class="w-full h-full object-cover">
                  </div>
                  <div>
                    <h3 class="text-sm font-black text-white"><%= m.user.nickname %></h3>
                    <p class="text-[10px] font-bold text-slate-500">ID: <%= m.user.id %></p>
                  </div>
                </div>
                <div class="flex items-center gap-1.5">
                  <div class="px-2 py-1 rounded bg-rose-500/20 border border-rose-500/30">
                    <span class="text-[9px] font-black text-rose-500">경고 부여됨</span>
                  </div>
                  <% if m.status_kicked? %>
                    <div class="px-1.5 py-1 rounded bg-rose-600/30 border border-rose-500/50">
                      <span class="text-[8px] font-black text-rose-300">제명됨</span>
                    </div>
                  <% elsif m.status_left? || m.user.deleted_at.present? %>
                    <div class="px-1.5 py-1 rounded bg-slate-500/20 border border-slate-500/30">
                      <span class="text-[8px] font-black text-slate-400">탈퇴/나감</span>
                    </div>
                  <% end %>
                </div>
              </div>

              <!-- Stats Grid -->
              <div class="grid grid-cols-3 gap-2">
                <div class="p-3 rounded-xl bg-white/5 border border-white/5 group">
                  <p class="text-[9px] font-black text-slate-500 uppercase tracking-tighter mb-1">최종 달성률</p>
                  <div class="flex items-end gap-1">
                    <span class="text-lg font-black text-rose-500 leading-none"><%= stats[:rate] %></span>
                    <span class="text-[10px] font-bold text-slate-600 mb-0.5">%</span>
                  </div>
                </div>
                <!-- Pass Usage (Confirmed Risk) -->
                <div class="p-3 rounded-xl bg-white/5 border border-white/5">
                  <p class="text-[9px] font-black text-slate-500 uppercase tracking-tighter mb-1">패스 사용</p>
                  <div class="flex flex-col gap-0.5">
                    <div class="flex items-center justify-between">
                      <span class="text-[8px] font-bold text-slate-500">휴식</span>
                      <span class="text-[10px] font-black text-white"><%= stats[:relax_count] || 0 %></span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-[8px] font-bold text-slate-500">세이브</span>
                      <span class="text-[10px] font-black text-white"><%= stats[:save_count] || 0 %></span>
                    </div>
                  </div>
                </div>
                <div class="p-3 rounded-xl bg-white/5 border border-white/5">
                  <p class="text-[9px] font-black text-slate-500 uppercase tracking-tighter mb-1">수행 횟수</p>
                  <div class="flex items-end gap-1">
                    <span class="text-lg font-black text-white leading-none"><%= stats[:total_completed] %></span>
                    <span class="text-[10px] font-bold text-slate-600 mb-0.5">/ <%= stats[:total_required] %></span>
                  </div>
                </div>
              </div>

              <div class="flex gap-2">
                <%= link_to "활동 상세", prototype_member_reports_path(m.user_id), class: "flex-1 py-2 rounded-xl bg-white/5 border border-white/10 text-[10px] font-black text-slate-400 text-center hover:bg-white/10 transition-all" %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="py-12 text-center border border-dashed border-white/10 rounded-3xl bg-white/2">
          <p class="text-xs font-bold text-slate-500">지난주 경고 대상자가 없습니다. 👏</p>
        </div>
      <% end %>
    </section>

    <!-- Tab B: 이번 주 실시간 현황 -->
    <section data-tabs-target="panel" data-id="live" class="space-y-6 hidden">
      <div class="px-1">
        <div class="flex items-center justify-between">
          <h2 class="text-xs font-black text-amber-500 uppercase tracking-[0.2em] flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span>
            실시간 위험군 (진행 중)
          </h2>
          <span class="text-xs font-black text-white"><%= @live_risks.count %>명</span>
        </div>
        <p class="text-[10px] text-slate-500 mt-2 font-medium leading-relaxed">
          어제(자정)까지의 누적 성과가 <span class="text-amber-400 font-bold">70% 미만</span>인 유저들입니다.
          <br/>
          (오늘 분량은 평가 달성률에서 유예됩니다.) 일요일까지 만회하지 않으면 다음 주 월요일에 경고가 부여됩니다.
        </p>
      </div>

      <% if @live_risks.any? %>
        <div class="grid gap-3">
          <% @live_risks.each do |risk| %>
            <% m = risk[:member]; stats = risk[:stats]; needed = risk[:needed] %>
            <div class="app-glass-card p-4 border-amber-500/20 bg-amber-500/5 space-y-4">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-slate-800 border border-white/10 overflow-hidden">
                    <img src="<%= m.user.profile_image %>" class="w-full h-full object-cover">
                  </div>
                  <div>
                    <h3 class="text-sm font-black text-white"><%= m.user.nickname %></h3>
                    <p class="text-[10px] font-bold text-slate-500">현재 남은 패스: <%= m.remaining_passes %>개</p>
                  </div>
                </div>
                <div class="px-2 py-1 rounded bg-amber-500/20 border border-amber-500/30">
                  <span class="text-[9px] font-black text-amber-500 tracking-tighter italic">WARNING TREND</span>
                </div>
              </div>

              <!-- Stats Grid -->
              <div class="grid grid-cols-3 gap-2">
                <div class="p-3 rounded-xl bg-white/5 border border-white/5">
                  <p class="text-[9px] font-black text-slate-500 uppercase tracking-tighter mb-1">현재 달성률</p>
                  <div class="flex items-end gap-1">
                    <span class="text-lg font-black text-amber-500 leading-none"><%= stats[:rate] %></span>
                    <span class="text-[10px] font-bold text-slate-600 mb-0.5">%</span>
                  </div>
                </div>
                <!-- Pass Usage (Live Risk) -->
                <div class="p-3 rounded-xl bg-white/5 border border-white/5">
                  <p class="text-[9px] font-black text-slate-500 uppercase tracking-tighter mb-1">이번주 패스</p>
                  <div class="flex flex-col gap-0.5">
                    <div class="flex items-center justify-between">
                      <span class="text-[8px] font-bold text-slate-500">휴식</span>
                      <span class="text-[10px] font-black text-white"><%= stats[:relax_count] || 0 %></span>
                    </div>
                    <div class="flex items-center justify-between">
                      <span class="text-[8px] font-bold text-slate-500">세이브</span>
                      <span class="text-[10px] font-black text-white"><%= stats[:save_count] || 0 %></span>
                    </div>
                  </div>
                </div>
                <div class="p-3 rounded-xl bg-indigo-500/10 border border-indigo-500/20">
                  <p class="text-[9px] font-black text-indigo-400 uppercase tracking-tighter mb-1">만회 필요분</p>
                  <div class="flex items-end gap-1">
                    <span class="text-lg font-black text-indigo-400 leading-none"><%= needed %></span>
                    <span class="text-[10px] font-bold text-indigo-400/60 mb-0.5">개</span>
                  </div>
                </div>
              </div>

              <div class="flex gap-2">
                <%= button_to prototype_send_nudge_path(member_id: m.id), method: :post, class: "flex-[2] py-2 rounded-xl bg-amber-500 text-white text-[10px] font-black hover:opacity-90 transition-all flex items-center justify-center gap-1" do %>
                  <span>⚡</span> 만회 독려 넛지 보내기
                <% end %>
                <%= link_to "기록 확인", prototype_member_reports_path(m.user_id), class: "flex-1 py-2 rounded-xl bg-white/5 border border-white/10 text-[10px] font-black text-slate-400 text-center hover:bg-white/10 transition-all" %>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="py-12 text-center border border-dashed border-white/10 rounded-3xl bg-white/2">
          <p class="text-xs font-bold text-slate-500">현재 위태로운 유저가 없습니다. 평화롭네요! 🕊️</p>
        </div>
      <% end %>
    </section>

    <!-- Common Section: 누적 경고 현황 -->
    <section class="mt-12 space-y-4">
       <div class="px-1">
        <div class="flex items-center gap-2">
          <h2 class="text-sm font-black text-indigo-400 uppercase tracking-[0.2em]">
            이번 달 누적 경고 현황
          </h2>
          <span class="text-xs font-black text-white"><%= @warned_members_this_month.count %>명</span>
        </div>
        <p class="text-[10px] text-slate-500 mt-1 font-medium"><%= Time.current.month %>월 1일 ~ 현재 누적 (매월 1일 리셋)</p>
      </div>

      <% if @warned_members_this_month.any? %>
        <div class="grid gap-3">
          <% @warned_members_this_month.each do |member| %>
            <% count = member.current_month_penalty_count %>
            <div class="app-glass-card p-4 border-white/5 flex items-center justify-between gap-4 <%= count >= 3 ? 'opacity-50 grayscale' : '' %>">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-slate-800 border border-white/10 overflow-hidden">
                  <img src="<%= member.user.profile_image %>" class="w-full h-full object-cover">
                </div>
                <div>
                  <p class="text-sm font-black text-white flex items-center gap-2">
                    <%= member.user.nickname %>
                    <% if member.status_kicked? %>
                      <span class="px-1.5 py-0.5 rounded bg-rose-500 text-[8px] text-white">제명됨</span>
                    <% end %>
                  </p>
                  <p class="text-[10px] font-bold text-slate-500 italic">
                    Status: <%= member.status.upcase %>
                  </p>
                </div>
              </div>
              
              <!-- Progress Bar -->
              <div class="flex items-center gap-3">
                <div class="flex gap-1">
                  <% 3.times do |i| %>
                    <div class="w-1.5 h-6 rounded-full <%= i < count ? (count >= 3 ? 'bg-rose-500' : 'bg-indigo-500') : 'bg-white/10' %>"></div>
                  <% end %>
                </div>
                <div class="text-right min-w-[2.5rem]">
                   <span class="text-lg font-black <%= count >= 3 ? 'text-rose-500' : 'text-indigo-400' %>"><%= count %></span><span class="text-xs font-bold text-slate-700">/3</span>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="py-12 text-center border border-dashed border-white/10 rounded-3xl bg-white/2">
          <p class="text-xs font-bold text-slate-500">이번 달 경고를 받은 회원이 없습니다.</p>
        </div>
      <% end %>
    </section>

    <!-- System Info -->
    <div class="p-6 rounded-3xl bg-indigo-500/5 border border-indigo-500/20 space-y-4">
      <div class="flex items-center gap-2">
        <div class="w-1.5 h-1.5 rounded-full bg-indigo-500"></div>
        <p class="text-[11px] font-black text-indigo-300 uppercase tracking-widest">System Rule</p>
      </div>
      <div class="space-y-3">
        <div class="flex items-start gap-3">
          <span class="text-xs text-indigo-400">01</span>
          <p class="text-[11px] text-indigo-200/60 leading-relaxed font-medium">
            주간 루틴 달성률이 <span class="text-white font-bold">70% 미만</span>일 경우 자동으로 경고 1회가 부여됩니다.
          </p>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-xs text-indigo-400">02</span>
          <p class="text-[11px] text-indigo-200/60 leading-relaxed font-medium">
            동일한 월 내에 <span class="text-white font-bold">경고 3회 누적</span> 시 시스템에서 즉시 자동 제명 처리됩니다.
          </p>
        </div>
        <div class="flex items-start gap-3">
          <span class="text-xs text-indigo-400">03</span>
          <p class="text-[11px] text-indigo-200/60 leading-relaxed font-medium">
            자동 점검은 <span class="text-white font-bold">매주 월요일 00:00</span>에 수행됩니다.
          </p>
        </div>
      </div>
    </div>
  </main>
</div>
