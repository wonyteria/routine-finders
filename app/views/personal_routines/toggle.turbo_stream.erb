<turbo-stream action="replace" target="routine_<%= @routine.id %>_home">
  <template>
    <div id="routine_<%= @routine.id %>_home" class="group/routine">
      <%= button_to toggle_personal_routine_path(@routine), 
                    method: :post, 
                    class: "w-full flex items-center justify-between p-4 lg:p-6 rounded-2xl lg:rounded-[32px] border-2 transition-all #{@routine.completed_today? ? 'bg-white border-white shadow-xl translate-y-[-4px]' : 'bg-white/5 border-white/5 text-white hover:bg-white/10 hover:border-white/10'}",
                    data: { turbo_stream: true } do %>
        <div class="flex items-center gap-4 active:scale-95 transition-transform origin-left">
          <div class="w-7 h-7 lg:w-9 lg:h-9 rounded-xl border-2 flex items-center justify-center transition-all <%= @routine.completed_today? ? 'bg-indigo-600 border-indigo-600' : 'border-white/30 group-hover/routine:border-white' %>">
            <% if @routine.completed_today? %>
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            <% end %>
          </div>
          <div class="text-left">
            <p class="text-sm lg:text-lg font-black leading-tight <%= @routine.completed_today? ? 'text-slate-900' : 'text-white' %>"><%= @routine.title %></p>
            <p class="text-[9px] lg:text-[11px] font-black uppercase tracking-[0.2em] mt-1 <%= @routine.completed_today? ? 'text-indigo-600' : 'text-white/40' %>"><%= @routine.completed_today? ? 'Completed' : 'Upcoming' %></p>
          </div>
        </div>
        <span class="text-2xl lg:text-4xl filter drop-shadow-lg group-hover/routine:scale-125 transition-transform"><%= @routine.icon %></span>
      <% end %>
    </div>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_card">
  <template>
    <%= render partial: 'personal_routines/routine_card', locals: { routine: @routine }, formats: [:html] %>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_dashboard">
  <template>
    <% is_done = @routine.completed_on?(@selected_date) %>
    <%= render partial: 'routine_clubs/dashboard_routine_item', locals: { routine: @routine, is_done: is_done, selected_date: @selected_date }, formats: [:html] %>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_club">
  <template>
    <div id="routine_<%= @routine.id %>_club" class="w-full">
      <%= button_to toggle_personal_routine_path(@routine), 
                    method: :post, 
                    class: "flex items-center justify-between p-6 rounded-3xl border-2 transition-all hover:scale-[1.02] w-full #{@routine.completed_today? ? 'bg-indigo-50 border-indigo-200 ring-4 ring-indigo-50' : 'bg-slate-50 border-transparent hover:border-indigo-100 group'}",
                    data: { turbo_stream: true } do %>
        <div class="flex items-center gap-4 flex-1 min-w-0 overflow-hidden">
          <span class="text-2xl transform group-hover:scale-125 transition-transform flex-shrink-0"><%= @routine.icon %></span>
          <div class="text-left min-w-0 flex-1">
            <p class="text-[15px] font-black text-slate-900 truncate <%= 'line-through text-slate-400' if @routine.completed_today? %>"><%= @routine.title %></p>
            <p class="text-[10px] font-bold text-slate-400 truncate"><%= @routine.category %></p>
          </div>
        </div>
        <% if @routine.completed_today? %>
          <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white flex-shrink-0 ml-4 shadow-lg shadow-indigo-100">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          </div>
        <% else %>
          <div class="w-10 h-10 bg-white rounded-2xl flex items-center justify-center text-slate-200 border border-slate-100 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-all flex-shrink-0 ml-4 shadow-sm">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          </div>
        <% end %>
      <% end %>
    </div>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_architecture">
  <template>
    <div id="routine_<%= @routine.id %>_architecture">
      <%= button_to toggle_personal_routine_path(@routine), 
                    method: :post, 
                    class: "w-10 h-10 rounded-xl flex items-center justify-center transition-all #{@routine.completed_today? ? 'bg-emerald-500 text-white shadow-lg' : 'bg-white text-slate-300 hover:bg-emerald-50 hover:text-emerald-500'}",
                    data: { turbo_stream: true } do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
      <% end %>
    </div>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_prototype">
  <template>
    <div id="routine_<%= @routine.id %>_prototype" class="relative group">
      <div class="w-full app-glass-card p-5 flex items-center justify-between border-white/5 hover:border-indigo-500/30 transition-all app-tap-active <%= @routine.completed_today? ? 'bg-indigo-500/10' : 'bg-[#1B1A24]' %>">
        <div class="flex items-center gap-4 flex-1">
          <span class="text-3xl group-active:scale-125 transition-transform shrink-0"><%= @routine.icon %></span>
          <div class="text-left flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-0.5">
              <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest truncate"><%= @routine.category %></p>
              <% if current_user.is_rufa_club_member? %>
                <div class="flex items-center gap-1">
                  <span class="w-1 h-1 rounded-full bg-indigo-500"></span>
                  <span class="text-[8px] font-black text-indigo-400 uppercase tracking-tighter">Premium</span>
                </div>
              <% end %>
            </div>
            <p class="text-sm font-black text-white leading-none truncate <%= @routine.completed_today? ? 'line-through opacity-40' : '' %>"><%= @routine.title %></p>
            <% if (completion = @routine.today_completion) %>
              <p class="text-[10px] font-bold text-indigo-400 mt-1 opacity-80 flex items-center gap-1 animate-fade-in">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0"/></svg>
                <%= completion.created_at.strftime("%H:%M") %> ÏôÑÎ£å
              </p>
            <% end %>
          </div>
        </div>
        
        <div class="flex items-center gap-3">
          <!-- Check Button -->
          <%= button_to toggle_personal_routine_path(@routine, date: Date.current, source: 'prototype'), 
                      method: :post, 
                      data: { action: "submit->proto-ui#checkLogin", turbo_stream: true },
                      class: "w-10 h-10 rounded-xl border-2 flex items-center justify-center transition-all active:scale-95 #{@routine.completed_today? ? 'bg-indigo-500 border-indigo-500 shadow-lg shadow-indigo-500/20' : 'border-white/10 bg-white/5'}" do %>
             <% if @routine.completed_today? %>
               <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
             <% else %>
               <svg class="w-5 h-5 text-white/20" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
             <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </template>
</turbo-stream>

<%= turbo_stream.update "monthly-done-count" do %>
  <%= @monthly_completions&.count || 0 %>
<% end %>

<%= turbo_stream.replace "achievement-matrix" do %>
  <%= render partial: "shared/achievement_matrix", formats: [:html] %>
<% end %>

<%= turbo_stream.replace "prototype-garden-section" do %>
  <% 
    current_wday = Date.current.wday.to_s
    todays_routines = current_user.personal_routines.where(deleted_at: nil).select { |r| (r.days || []).map(&:to_s).include?(current_wday) }
    joined_participations = current_user ? current_user.participations.active.joins(:challenge) : []
    
    routine_total = todays_routines.count
    routine_done = todays_routines.select(&:completed_today?).count
    
    # Progress Calculation (Strictly Routine Only)
    total_task_count = routine_total
    completed_count = routine_done
    progress = total_task_count.positive? ? (completed_count.to_f / total_task_count * 100).to_i : 0
    
    # Unified tasks for Aura visualization
    aura_tasks = todays_routines.map do |r|
      { id: "routine_#{r.id}", icon: r.icon, title: r.title, completed: r.completed_today? }
    end
    aura_tasks += joined_participations.map do |p|
      icon = case p.challenge.category
             when "HEALTH" then "üèãÔ∏è"
             when "STUDY" then "üìö"
             when "SNS" then "üì±"
             when "MONEY" then "üí∞"
             when "HOBBY" then "üé®"
             when "MIND" then "üßò"
             else "üèÜ"
             end
      { id: "participation_#{p.id}", icon: icon, title: p.challenge.title, completed: p.verification_logs.where(created_at: Date.current.all_day).exists? }
    end

    # For fireflies/social activity
    orbit_users = User.joins(:rufa_activities)
                      .where(rufa_activities: { created_at: Date.current.all_day })
                      .where.not(id: current_user&.id)
                      .distinct
                      .limit(10)

    global_average_progress = Rails.cache.fetch("global_avg_progress_#{Date.current}", expires_in: 30.minutes) do
      65 + rand(15)
    end
  %>
  <%= render partial: "prototype/garden", locals: { 
        progress: progress, 
        completed_count: completed_count, 
        total_task_count: total_task_count,
        orbit_users: orbit_users,
        todays_routines: todays_routines,
        aura_tasks: aura_tasks,
        global_average_progress: global_average_progress
      } %>
<% end %>

<% if current_user.is_rufa_club_member? && @routine_club && @my_membership %>
  <%# 1. Update Daily Record Area (Allowing text recording when all done) %>
  <%= turbo_stream.replace "rufa-daily-record" do %>
    <div id="rufa-daily-record" class="flex flex-col w-full">
       <%= render partial: 'routine_clubs/daily_record_area', formats: [:html] %>
    </div>
  <% end %>

  <%# 2. Update Club Dashboard Stats Grid %>
  <%= turbo_stream.replace "rufa-club-stats-grid" do %>
    <div id="rufa-club-stats-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4">
      <% daily_rate = current_user.daily_achievement_rate(@selected_date).to_i %>
      <!-- Ïò§ÎäòÏùò Îã¨ÏÑ±Î•† -->
      <div class="bg-indigo-600 rounded-2xl p-4 md:p-6 text-white shadow-lg relative overflow-hidden flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-indigo-100 uppercase tracking-wider mb-1 md:mb-2 italic">Ïò§ÎäòÏùò Îã¨ÏÑ±Î•†</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black tracking-tight tabular-nums"><%= daily_rate %></p>
          <p class="text-xs md:text-sm font-bold text-indigo-300">%</p>
        </div>
      </div>

      <!-- ÏÑ±Ïû• ÏóêÎÑàÏßÄ -->
      <div class="bg-slate-900 rounded-2xl p-4 md:p-6 text-white shadow-lg relative overflow-hidden flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-indigo-300 uppercase tracking-wider mb-1 md:mb-2">ÏÑ±Ïû• ÏóêÎÑàÏßÄ</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black tracking-tight tabular-nums"><%= @my_membership.growth_points || 0 %></p>
          <p class="text-xs md:text-sm font-bold text-indigo-400">P</p>
        </div>
      </div>

      <!-- Îã¨ÏÑ±Î•† (ÏõîÍ∞Ñ ÌèâÍ∑†) -->
      <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-purple-400 uppercase tracking-wider mb-1 md:mb-2">ÏõîÍ∞Ñ ÌèâÍ∑† ÏÑ±Ï∑®</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.achievement_rate.to_i %></p>
          <p class="text-xs md:text-sm font-bold text-slate-400">%</p>
        </div>
      </div>
      
      <!-- Ï∂úÏÑùÎ•† -->
      <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-emerald-500 uppercase tracking-wider mb-1 md:mb-2">Ï∂úÏÑùÎ•†</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.attendance_rate.to_i %></p>
          <p class="text-xs md:text-sm font-bold text-slate-400">%</p>
        </div>
      </div>
      
      <!-- Ìú¥ÏãùÍ∂å -->
      <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm cursor-help flex flex-col justify-between" 
           title="Ïò§Îäò Î∂ÑÎüâ Î©¥Ï†ú & Ï∂úÏÑùÎ•† 70% Î≥¥Ìò∏">
        <p class="text-[10px] md:text-xs font-black text-blue-400 uppercase tracking-wider mb-1 md:mb-2">Ìú¥ÏãùÍ∂å</p>
        <div class="flex items-center justify-between gap-1">
          <div class="flex items-baseline gap-1">
            <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.remaining_passes %></p>
            <p class="text-xs md:text-sm font-bold text-slate-400">Í∞ú</p>
          </div>
          <% 
            today_attendance = @my_membership.attendances.find_by(attendance_date: Date.current)
            can_use_pass = @my_membership.remaining_passes > 0 && !today_attendance&.status_excused?
          %>
          <% if can_use_pass %>
            <%= form_with url: use_pass_routine_club_path(@routine_club), method: :post, id: "rufa-stats-relax-form", data: { turbo: false } do %>
              <button type="button" 
                      onclick="requestItemUse('rufa-stats-relax-form', 'Ìú¥ÏãùÍ∂åÏùÑ ÏÇ¨Ïö©ÌïòÏãúÍ≤†ÏäµÎãàÍπå?', 'Ïò§Îäò Î∂ÑÎüâ Î©¥Ï†ú Î∞è Ï∂úÏÑù Î≥¥Ìò∏Î•º Ï†ÅÏö©Ìï©ÎãàÎã§.', 'üéüÔ∏è')"
                      class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-[10px] md:text-xs font-black border border-blue-100 hover:bg-blue-600 hover:text-white transition-all whitespace-nowrap">
                ÏÇ¨Ïö©
              </button>
            <% end %>
          <% elsif today_attendance&.status_excused? %>
            <span class="px-3 py-1.5 bg-green-50 text-green-600 rounded-lg text-[10px] md:text-xs font-black">ÏôÑÎ£å</span>
          <% end %>
        </div>
      </div>
      
      <!-- ÎàÑÏ†Å Í≤ΩÍ≥† -->
      <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm relative overflow-hidden flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-amber-500 uppercase tracking-wider mb-1 md:mb-2">ÎàÑÏ†Å Í≤ΩÍ≥†</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.penalty_count %></p>
          <p class="text-xs md:text-sm font-bold text-slate-400">Ìöå</p>
        </div>
      </div>
    </div>
  <% end %>

  <%# 3. Update Premium Personal Dashboard Stats (ÎÇòÏùò Î£®Ìã¥ ÌÉ≠) %>
  <%= turbo_stream.replace "premium-routine-stats" do %>
    <div id="premium-routine-stats" class="grid grid-cols-3 gap-3 md:gap-4">
       <!-- Achievement Rate -->
       <div class="bg-slate-900 rounded-2xl p-4 md:p-6 text-white shadow-lg relative overflow-hidden group flex flex-col justify-between">
         <div class="absolute -right-4 -top-4 w-12 h-12 bg-indigo-600/20 rounded-full blur-xl group-hover:scale-150 transition-transform duration-700"></div>
         <p class="text-[10px] md:text-xs font-black text-indigo-300 uppercase tracking-wider mb-1 md:mb-2">Îã¨ÏÑ±Î•†</p>
         <div class="flex items-baseline gap-1">
           <p class="text-2xl md:text-3xl font-black tracking-tight tabular-nums"><%= current_user.daily_achievement_rate(@selected_date).to_i %></p>
           <p class="text-xs md:text-sm font-bold text-indigo-400 font-mono">%</p>
         </div>
         <div class="mt-3 md:mt-4 h-1 w-full bg-white/10 rounded-full overflow-hidden">
            <div class="h-full bg-indigo-400 transition-all duration-1000" style="width: <%= current_user.daily_achievement_rate(@selected_date).to_i %>%"></div>
         </div>
       </div>

       <!-- Reward Points -->
       <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm group hover:border-amber-200 transition-colors flex flex-col justify-between">
         <p class="text-[10px] md:text-xs font-black text-amber-500 uppercase tracking-wider mb-1 md:mb-2 truncate">ÏóêÎÑàÏßÄ</p>
         <div class="flex items-baseline gap-1">
           <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.growth_points || 0 %></p>
           <p class="text-xs md:text-sm font-bold text-slate-300 font-mono">P</p>
         </div>
       </div>

       <!-- Member Days -->
       <% member_days = (Date.current - @my_membership.joined_at.to_date).to_i + 1 %>
       <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm group hover:border-purple-200 transition-colors flex flex-col justify-between">
         <p class="text-[10px] md:text-xs font-black text-purple-400 uppercase tracking-wider mb-1 md:mb-2 truncate">ÌôúÎèôÏùº</p>
         <div class="flex items-baseline gap-1">
           <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= member_days %></p>
           <p class="text-xs md:text-sm font-bold text-slate-300 font-mono">D</p>
         </div>
       </div>
    </div>
  <% end %>
<% end %>
