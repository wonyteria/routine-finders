<div class="space-y-5 pt-4">
  
  <!-- Header removed flash from here -->
  <header class="space-y-6 px-1">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <%= link_to hosted_challenges_path, class: "w-11 h-11 app-glass-card flex items-center justify-center text-slate-400 app-tap-active group" do %>
          <svg class="w-5 h-5 group-active:scale-90 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
        <% end %>
          <div>
            <div class="flex items-center gap-2 mb-0.5">
              <span class="w-1.5 h-1.5 rounded-full bg-indigo-500 animate-pulse"></span>
              <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest italic leading-none">ê´€ë¦¬ ë³¸ë¶€</p>
            </div>
            <h1 class="text-xl font-black text-white italic tracking-tighter truncate max-w-[200px]"><%= @challenge.title %></h1>
          </div>
      </div>
      
      <%= link_to challenge_path(@challenge), target: "_blank", class: "w-11 h-11 app-glass-card flex items-center justify-center text-white app-tap-active" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
      <% end %>
    </div>

    <% if @challenge.offline? %>
      <!-- Meeting Info Card (Compact) -->
      <div class="app-glass-card p-5 bg-emerald-500/[0.02] border-emerald-500/10 relative overflow-hidden">
        <div class="absolute -right-8 -top-8 w-24 h-24 bg-emerald-500/5 blur-3xl rounded-full"></div>
        <div class="flex items-center justify-between mb-3 relative z-10">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center text-lg">ğŸ—“ï¸</div>
            <div class="space-y-0.5">
              <p class="text-[8px] font-black text-emerald-400 uppercase tracking-widest leading-none italic">ì¼ì •</p>
              <h2 class="text-lg font-black text-white italic leading-none"><%= @challenge.start_date.strftime('%m.%d') %> <span class="text-slate-500 font-normal text-sm ml-1"><%= @challenge.meeting_info&.meeting_time.presence || "ì‹œê°„ ë¯¸ì •" %></span></h2>
            </div>
          </div>
          <div class="px-2.5 py-1 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
             <span class="text-[10px] font-black text-emerald-400 italic">D-<%= ( @challenge.start_date - Date.current).to_i %></span>
          </div>
        </div>
        <div class="flex items-center gap-3 pt-3 border-t border-white/5 relative z-10">
          <div class="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-base">ğŸ“</div>
          <div class="flex-1 min-w-0">
             <p class="text-[8px] font-black text-slate-500 uppercase leading-none mb-1">ì¥ì†Œ</p>
             <p class="text-xs font-bold text-white truncate"><%= @challenge.meeting_info&.place_name || "ì¥ì†Œ ì •ë³´ ì—†ìŒ" %></p>
          </div>
        </div>
      </div>
      
      <!-- Quick Actions (Compact) -->
      <div class="flex items-center gap-2 px-1">
        <button onclick="openNudgeModal('gathering_remind')" class="flex-1 py-3.5 app-glass-card !rounded-xl flex items-center justify-center gap-2 border-indigo-500/10 active:scale-95 transition-all">
          <span class="text-xs">ğŸ“</span>
          <span class="text-[9px] font-black text-white italic">ë¦¬ë§ˆì¸ë“œ</span>
        </button>
        <button onclick="openNudgeModal('gathering_prep')" class="flex-1 py-3.5 app-glass-card !rounded-xl flex items-center justify-center gap-2 border-amber-500/10 active:scale-95 transition-all">
          <span class="text-xs">ğŸ’</span>
          <span class="text-[9px] font-black text-white italic">ì¤€ë¹„ë¬¼</span>
        </button>
        <button type="button" onclick="openAnnouncementModal()" class="flex-1 py-3.5 app-glass-card !rounded-xl flex items-center justify-center gap-2 border-emerald-500/10 active:scale-95 transition-all">
          <span class="text-xs">ğŸ“¢</span>
          <span class="text-[9px] font-black text-white italic">ê³µì§€ë°œì†¡</span>
        </button>
      </div>
    <% else %>
      <!-- Progress Journey (For Challenges) -->
      <div class="app-glass-card p-6 bg-indigo-500/[0.03] border-indigo-500/10 relative overflow-hidden">
        <div class="flex items-end justify-between mb-4">
          <div class="space-y-1">
            <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest leading-none italic">ì±Œë¦°ì§€ ì§„í–‰ë„</p>
            <h2 class="text-2xl font-black text-white italic leading-none"><%= @current_day %>ì¼ì°¨ <span class="text-slate-800 font-normal text-lg">/ <%= @total_days %></span></h2>
          </div>
          <div class="text-right">
            <p class="text-lg font-black text-white italic"><%= @progress_percent %>%</p>
          </div>
        </div>
        <div class="h-2.5 bg-black/40 rounded-full overflow-hidden p-0.5 border border-white/5">
          <div class="h-full bg-gradient-to-r from-indigo-600 to-purple-500 rounded-full transition-all duration-1000 flex items-center justify-end px-0.5" style="width: <%= @progress_percent %>%">
            <div class="w-1 h-1 rounded-full bg-white/80"></div>
          </div>
        </div>
        <div class="flex justify-between mt-2.5">
          <span class="text-[8px] font-bold text-slate-600 uppercase"><%= @challenge.start_date.strftime('%m/%d') %></span>
          <span class="text-[8px] font-bold text-slate-600 uppercase"><%= @challenge.end_date.strftime('%m/%d') %></span>
        </div>
      </div>
      
      <!-- Quick Actions for Challenges -->
      <div class="flex items-center gap-2 px-1 mt-3">
        <button onclick="openNudgeModal('unverified_today')" class="flex-1 min-w-[100px] py-4 app-glass-card !rounded-2xl flex items-center justify-center gap-2 border-indigo-500/20 active:scale-95 transition-all">
          <span class="text-sm">ğŸ””</span>
          <span class="text-[10px] font-black text-white italic">ë¯¸ì¸ì¦ ë…ë ¤</span>
        </button>
        <button onclick="openNudgeModal('sluggish')" class="flex-1 min-w-[100px] py-4 app-glass-card !rounded-2xl flex items-center justify-center gap-2 border-amber-500/20 active:scale-95 transition-all">
          <span class="text-sm">âš ï¸</span>
          <span class="text-[10px] font-black text-white italic">ë¶€ì§„ ê²½ê³ </span>
        </button>
        <button type="button" onclick="openAnnouncementModal()" class="flex-1 min-w-[100px] py-4 app-glass-card !rounded-2xl flex items-center justify-center gap-2 border-emerald-500/20 active:scale-95 transition-all">
          <span class="text-sm">ğŸ“¢</span>
          <span class="text-[10px] font-black text-white italic">ë‹¨ì²´ ê³µì§€</span>
        </button>
      </div>
    <% end %>
  </header>

  <!-- 2. Performance HUD (Compact Grid) -->
  <section class="grid grid-cols-2 gap-2.5 px-1">
    <div class="app-glass-card py-3.5 px-2 flex flex-col items-center justify-center text-center">
      <span class="text-xl font-black italic text-white leading-none mb-1"><%= @stats[:total_participants] %></span>
      <span class="text-[7px] font-black text-slate-500 uppercase tracking-wider"><%= @challenge.offline? ? "ìµœì¢… ì°¸ì—¬ì" : "ëˆ„ì  ë£¨í¼" %></span>
    </div>
    <div class="app-glass-card py-3.5 px-2 flex flex-col items-center justify-center text-center">
      <% if @challenge.offline? %>
        <span class="text-xl font-black italic text-indigo-400 leading-none mb-1"><%= @challenge.meeting_info&.max_attendees %></span>
        <span class="text-[7px] font-black text-slate-500 uppercase tracking-wider">ëª¨ì„ ì •ì›</span>
      <% else %>
        <span class="text-xl font-black italic text-emerald-400 leading-none mb-1"><%= @stats[:active_today] %></span>
        <span class="text-[7px] font-black text-slate-500 uppercase tracking-wider">ì˜¤ëŠ˜ ì„±ê³µ</span>
      <% end %>
    </div>
    <div class="app-glass-card py-3.5 px-2 flex flex-col items-center justify-center text-center">
      <% if @challenge.offline? %>
        <span class="text-xl font-black italic text-white leading-none mb-1"><%= ( (@challenge.current_participants.to_f / (@challenge.meeting_info&.max_attendees || 1)) * 100).to_i %><span class="text-xs">%</span></span>
        <span class="text-[7px] font-black text-slate-500 uppercase tracking-wider">ì°¸ì—¬ ì ìœ ìœ¨</span>
      <% else %>
        <span class="text-xl font-black italic text-indigo-400 leading-none mb-1"><%= @stats[:avg_completion_rate] %><span class="text-xs">%</span></span>
        <span class="text-[7px] font-black text-slate-500 uppercase tracking-wider">í‰ê·  ë‹¬ì„±ë¥ </span>
      <% end %>
    </div>
    <div class="app-glass-card py-3.5 px-2 <%= (@challenge.offline? ? @stats[:pending_applications] : @stats[:pending_verifications]) > 0 ? 'bg-amber-500/5 border-amber-500/20' : '' %> flex flex-col items-center justify-center text-center">
      <span class="text-xl font-black italic <%= (@challenge.offline? ? @stats[:pending_applications] : @stats[:pending_verifications]) > 0 ? 'text-amber-500 animate-pulse' : 'text-slate-700' %> leading-none mb-1"><%= @challenge.offline? ? @stats[:pending_applications] : @stats[:pending_verifications] %></span>
      <span class="text-[7px] font-black text-slate-500 uppercase tracking-wider"><%= @challenge.offline? ? "ì‹ ì²­ ëŒ€ê¸°" : "ì¸ì¦ ê²€í† " %></span>
    </div>
  </section>

  <!-- 3. Dynamic Tabs Section -->
  <div class="space-y-4">
    <nav id="tab-nav-container" class="app-glass-card p-1.5 sticky top-4 z-[200] border-white/10 shadow-3xl mx-1 bg-[#16151D]/90 backdrop-blur-3xl">
      <div class="flex items-center gap-1 overflow-x-auto scroll-smooth" style="scrollbar-width: none; -ms-overflow-style: none;">
        <% 
          is_gathering = @challenge.gathering?
          nav_tabs = [
            ["dashboard", is_gathering ? "ëª¨ì„í˜„í™©" : "ëŒ€ì‹œë³´ë“œ", "M13 10V3L4 14h7v7l9-11h-7z"],
            ["participants", "ì°¸ê°€ì", "M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"],
            ["announcements", is_gathering ? "ê³µì§€ì‚¬í•­" : "ê³µì§€/ì¸ì¦", "M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"],
            ["settings", "ì„¤ì •", "M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z"]
          ]
          nav_tabs.insert(1, ["applications", "ìŠ¹ì¸ëŒ€ê¸°", "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"]) if @challenge.requires_approval?
          nav_tabs.push(["refunds", "ì •ì‚°/í™˜ê¸‰", "M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2M17 16v2a2 2 0 01-2 2H9a2 2 0 01-2-2v-2m3-5v3m4-3v3m-2-6V5a2 2 0 114 0v2"]) if @challenge.cost_type_deposit?
        %>
        <% nav_tabs.each do |id, label, icon| %>
          <%= link_to hosted_challenge_path(@challenge, tab: id), 
                      data: { turbo_frame: "hosted_challenge_tabs", tab_id: id, active: (@tab == id) },
                      class: "tab-item shrink-0 flex items-center gap-2 py-3 px-5 transition-all rounded-[1.25rem] #{ @tab == id ? 'bg-indigo-500/20 text-indigo-400 border border-indigo-500/20 shadow-lg' : 'text-slate-500' }" do %>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="<%= icon %>"/></svg>
            <span class="text-[10px] font-black tracking-tight whitespace-nowrap"><%= label %></span>
          <% end %>
        <% end %>
      </div>
    </nav>

    <turbo-frame id="hosted_challenge_tabs" class="block min-h-[40vh]" data-turbo-action="advance">
      <div class="animate-slide-up pb-20">
        <!-- Flash Messages (Moved Inside Frame for Turbo Updates) -->
        <% if notice %>
          <div id="flash-toast-prototype" class="fixed top-4 left-1/2 -translate-x-1/2 z-[32000] max-w-md w-[90%] animate-slide-down">
            <div class="flex items-start gap-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4 rounded-3xl shadow-2xl border border-white/20">
              <div class="w-8 h-8 bg-white/20 rounded-xl flex items-center justify-center shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg>
              </div>
              <span class="font-black text-sm flex-1"><%= notice %></span>
              <button onclick="this.parentElement.parentElement.remove()" class="hover:bg-white/20 rounded-lg p-1 transition-colors shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
          </div>
          <script>
            setTimeout(() => {
              const toast = document.getElementById('flash-toast-prototype');
              if (toast) {
                toast.classList.add('opacity-0', 'translate-y-[-20px]', 'transition-all', 'duration-500');
                setTimeout(() => toast.remove(), 500);
              }
            }, 3000);
          </script>
        <% end %>

        <% if alert %>
          <div id="error-validation-modal" class="fixed inset-0 z-[35000] flex items-center justify-center p-6">
            <div onclick="this.parentElement.remove(); document.body.classList.remove('overflow-hidden')" class="absolute inset-0 bg-black/90 backdrop-blur-3xl animate-fade-in"></div>
            
            <div class="relative w-full max-w-sm app-glass-card border-rose-500/20 p-8 text-center space-y-6 animate-badge-pop bg-[#16151D]">
              <div class="w-16 h-16 rounded-3xl bg-rose-500/20 flex items-center justify-center text-3xl mx-auto shadow-glow shadow-rose-500/20">
                âš ï¸
              </div>
              
              <div class="space-y-2">
                <p class="text-[10px] font-black text-rose-400 uppercase tracking-[0.3em]">ì…ë ¥ ì˜¤ë¥˜ í™•ì¸</p>
                <h3 class="text-2xl font-black text-white italic">ì„¤ì •ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h3>
              </div>

              <div class="p-5 rounded-2xl bg-rose-500/5 border border-rose-500/10 text-left">
                <p class="text-sm font-bold text-rose-200 leading-relaxed italic">
                  <%= alert.gsub("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ", "") %>
                </p>
              </div>

              <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest leading-relaxed">
                ì˜ëª» ì…ë ¥ëœ í•­ëª©ì„ ë‹¤ì‹œ í™•ì¸í•˜ê³ <br/>ìˆ˜ì •í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
              </p>

              <button onclick="this.closest('#error-validation-modal').remove(); document.body.classList.remove('overflow-hidden')" 
                      class="w-full py-4 bg-rose-600 text-white font-black text-sm rounded-2xl shadow-xl shadow-rose-600/20 active:scale-95 transition-all">
                ë‹¤ì‹œ í™•ì¸í•˜ê¸°
              </button>
            </div>
          </div>
          <script>document.body.classList.add('overflow-hidden');</script>
        <% end %>
        <!-- Change Confirmation Modal (Moved Inside Frame) -->
        <% if flash[:updated_changes].present? %>
          <% changes = JSON.parse(flash[:updated_changes]) %>
          <div id="success-confirmation-modal" class="fixed inset-0 z-[30000] flex items-center justify-center p-6">
            <div onclick="this.parentElement.remove(); document.body.classList.remove('overflow-hidden')" class="absolute inset-0 bg-black/90 backdrop-blur-3xl animate-fade-in"></div>
            
            <div class="relative w-full max-w-sm app-glass-card border-white/20 p-8 text-center space-y-6 animate-badge-pop bg-[#16151D]">
              <div class="w-16 h-16 rounded-3xl bg-emerald-500/20 flex items-center justify-center text-3xl mx-auto shadow-glow shadow-emerald-500/20">
                âœ…
              </div>
              
              <div class="space-y-2">
                <p class="text-[10px] font-black text-emerald-400 uppercase tracking-[0.3em]">ì €ì¥ ì™„ë£Œ</p>
                <h3 class="text-2xl font-black text-white italic">ì„¤ì •ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤</h3>
              </div>

              <div class="space-y-3 py-2">
                <% changes.each do |change| %>
                  <div class="flex items-center justify-between p-3 rounded-2xl bg-white/5 border border-white/5">
                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest"><%= change['l'] %></span>
                    <div class="text-right">
                       <p class="text-[11px] font-bold text-white"><%= change['v'] %></p>
                    </div>
                  </div>
                <% end %>
              </div>

              <button onclick="this.closest('#success-confirmation-modal').remove(); document.body.classList.remove('overflow-hidden')" 
                      class="w-full py-4 bg-indigo-600 text-white font-black text-sm rounded-2xl shadow-xl active:scale-95 transition-all">
                í™•ì¸í–ˆìŠµë‹ˆë‹¤
              </button>
            </div>
          </div>
          <script>document.body.classList.add('overflow-hidden');</script>
        <% end %>

        <% case @tab %>
        <% when "dashboard" %>
          <%= render "hosted_challenges/tabs/dashboard", challenge: @challenge, participants: @participants, pending_verifications: @pending_verifications, recent_verifications: @recent_verifications %>
        <% when "applications" %>
          <%= render "hosted_challenges/tabs/applications", challenge: @challenge, pending_applications: @pending_applications, processed_applications: @processed_applications %>
        <% when "participants" %>
          <%= render "hosted_challenges/tabs/participants", challenge: @challenge, participants: @participants %>
        <% when "announcements" %>
          <%= render "hosted_challenges/tabs/announcements", challenge: @challenge, announcements: @announcements %>
        <% when "reviews" %>
          <%= render "hosted_challenges/tabs/reviews", challenge: @challenge, reviews: @reviews %>
        <% when "settings" %>
          <%= render "hosted_challenges/tabs/settings", challenge: @challenge %>
        <% when "refunds" %>
          <%= render "hosted_challenges/tabs/refunds", challenge: @challenge, pending_refunds: @pending_refunds, completed_refunds: @completed_refunds %>
        <% end %>
      </div>
    </turbo-frame>
  </div>

  <script>
    // 1. Initial Scroll and Click Listener
    document.addEventListener('turbo:load', () => {
      scrollActiveTabToCenter();
    });

    // 2. Handle Tab Clicks (since Nav is outside Turbo Frame)
    document.addEventListener('click', (e) => {
      const tabLink = e.target.closest('[data-tab-id]');
      if (tabLink && tabLink.closest('#tab-nav-container')) {
        // Update Classes
        document.querySelectorAll('#tab-nav-container [data-tab-id]').forEach(el => {
          el.classList.remove('bg-indigo-500/20', 'text-indigo-400', 'border', 'border-indigo-500/20', 'shadow-lg');
          el.classList.add('text-slate-500');
          el.setAttribute('data-active', 'false');
        });
        
        tabLink.classList.add('bg-indigo-500/20', 'text-indigo-400', 'border', 'border-indigo-500/20', 'shadow-lg');
        tabLink.classList.remove('text-slate-500');
        tabLink.setAttribute('data-active', 'true');
        
        // Scroll to center
        setTimeout(() => scrollActiveTabToCenter(), 50);
      }
    });
    
    function scrollActiveTabToCenter() {
      const container = document.querySelector('#tab-nav-container .overflow-x-auto');
      const activeTab = container?.querySelector('[data-active="true"]');
      
      if (container && activeTab) {
        const containerWidth = container.offsetWidth;
        const tabLeft = activeTab.offsetLeft;
        const tabWidth = activeTab.offsetWidth;
        const scrollPosition = tabLeft - (containerWidth / 2) + (tabWidth / 2);
        
        container.scrollTo({
          left: scrollPosition,
          behavior: 'smooth'
        });
      }
    }
  </script>
</div>

<%# Change Confirmation Modal was moved inside turbo-frame %>

<!-- Nudge Confirmation Modal (Simplified for Prototype) -->
<div id="nudge-modal" class="hidden fixed inset-0 z-[20000]">
  <div onclick="closeNudgeModal()" class="absolute inset-0 bg-black/80 backdrop-blur-md cursor-pointer"></div>
  <div class="absolute bottom-32 left-4 right-4 max-w-md mx-auto bg-[#1B1A24] rounded-[40px] p-6 pb-8 animate-slide-up border border-white/10 shadow-[0_20px_60px_rgba(0,0,0,0.5)]">
    <div class="w-10 h-1 bg-white/10 rounded-full mx-auto mb-6"></div>
    <h3 id="nudge-title" class="text-lg font-black text-white text-center mb-1 italic">ë…ë ¤ ë©”ì‹œì§€ ë°œì†¡</h3>
    <p id="nudge-desc" class="text-[10px] font-bold text-indigo-400 text-center uppercase tracking-widest leading-none mb-6">ë£¨í¼ë“¤ì—ê²Œ í™œê¸°ì°¬ ì—ë„ˆì§€ë¥¼ ì „ë‹¬í•˜ì„¸ìš”</p>
    
    <%= form_with url: nudge_participants_hosted_challenge_path(@challenge), method: :post, class: "space-y-4" do |f| %>
      <%= hidden_field_tag :group, '', id: 'nudge-group-input' %>
      <div class="space-y-3">
        <%= text_area_tag :content, nil, id: 'nudge-content-input', required: true, class: "w-full min-h-[100px] bg-white/5 border border-white/10 rounded-3xl p-5 text-white text-sm font-bold focus:border-indigo-500 outline-none resize-none" %>
        <div class="flex gap-2">
           <button type="button" onclick="closeNudgeModal()" class="px-5 py-3 rounded-2xl bg-white/5 text-slate-500 font-bold text-xs h-12">ì·¨ì†Œ</button>
           <%= f.submit "ë°œì†¡í•˜ê¸°", class: "flex-1 rounded-2xl bg-indigo-600 text-white font-black text-xs h-12" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Announcement Modal (New) -->
<div id="announcement-modal" class="hidden fixed inset-0 z-[20000]">
  <div onclick="closeAnnouncementModal()" class="absolute inset-0 bg-black/80 backdrop-blur-md cursor-pointer"></div>
  <div class="absolute bottom-32 left-4 right-4 max-w-md mx-auto bg-[#1B1A24] rounded-[40px] p-6 pb-8 animate-slide-up border border-white/10 shadow-[0_20px_60px_rgba(0,0,0,0.5)]">
    <div class="w-10 h-1 bg-white/10 rounded-full mx-auto mb-6"></div>
    <h3 class="text-lg font-black text-white text-center mb-1 italic">ë‹¨ì²´ ê³µì§€ì‚¬í•­ ë“±ë¡</h3>
    <p class="text-[10px] font-bold text-emerald-400 text-center uppercase tracking-widest leading-none mb-6">ëª¨ë“  ì°¸ê°€ìì—ê²Œ ì¤‘ìš” ì†Œì‹ì„ ì•Œë¦½ë‹ˆë‹¤</p>
    
    <%= form_with model: [@challenge, Announcement.new], class: "space-y-4" do |f| %>
      <div class="space-y-3">
        <%= f.text_field :title, placeholder: "ê³µì§€ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”", required: true, class: "w-full bg-white/5 border border-white/10 rounded-2xl p-4 text-white text-sm font-black focus:border-emerald-500 outline-none" %>
        <%= f.text_area :content, placeholder: "ê³µì§€ ìƒì„¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...", required: true, class: "w-full min-h-[120px] bg-white/5 border border-white/10 rounded-3xl p-5 text-white text-sm font-bold focus:border-emerald-500 outline-none resize-none" %>
        <div class="flex gap-2">
           <button type="button" onclick="closeAnnouncementModal()" class="px-5 py-3 rounded-2xl bg-white/5 text-slate-500 font-bold text-xs h-12">ì·¨ì†Œ</button>
           <%= f.submit "ê³µì§€ ë°œì†¡", class: "flex-1 rounded-2xl bg-emerald-600 text-white font-black text-xs h-12" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<script>
  function openNudgeModal(group) {
    const modal = document.getElementById('nudge-modal');
    const groupInput = document.getElementById('nudge-group-input');
    const contentInput = document.getElementById('nudge-content-input');
    const titleText = document.getElementById('nudge-title');

    groupInput.value = (group === 'gathering_remind' || group === 'gathering_prep') ? 'all' : group;

    if (group === 'unverified_today') {
      titleText.innerText = "ë¯¸ì¸ì¦ ë…ë ¤í•˜ê¸°";
      contentInput.value = "'<%= j @challenge.title %>' ë¦¬ë”ê°€ ë³´ë‚¸ ì•Œë¦¼ì…ë‹ˆë‹¤. ì•„ì§ ì˜¤ëŠ˜ì˜ ì¸ì¦ì„ ì•ˆ í•˜ì…¨ë„¤ìš”! ìŠì§€ ë§ê³  ê¼­ ì™„ë£Œí•´ ì£¼ì„¸ìš”. ğŸ”¥";
    } else if (group === 'sluggish') {
      titleText.innerText = "ë¶€ì§„ ë£¨í¼ ê¹¨ìš°ê¸°";
      contentInput.value = "ëª©í‘œë¥¼ í–¥í•œ ë°œê±¸ìŒ, ë‹¤ì‹œ í˜ì„ ë‚´ë´ìš”! ìµœê·¼ í™œë™ì´ ëœ¸í•´ ë³´ì—¬ ë¦¬ë§ˆì¸ë“œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤. ğŸ’ª";
    } else if (group === 'gathering_remind') {
      titleText.innerText = "ëª¨ì„ ì¼ì • ë¦¬ë§ˆì¸ë“œ";
      contentInput.value = "ì•ˆë…•í•˜ì„¸ìš”! '<%= j @challenge.title %>' ëª¨ì„ì´ ê³§ ì§„í–‰ë©ë‹ˆë‹¤. ì¼ì •(<%= @challenge.start_date.strftime('%m/%d') %> <%= @challenge.meeting_info&.meeting_time %>)ê³¼ ì¥ì†Œ(<%= @challenge.meeting_info&.place_name %>)ë¥¼ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•´ ì£¼ì„¸ìš”! ğŸ“";
    } else if (group === 'gathering_prep') {
      titleText.innerText = "ì¤€ë¹„ë¬¼ ì²´í¬ ì•Œë¦¼";
      contentInput.value = "ëª¨ì„ ì¤€ë¹„ë¬¼(<%= @challenge.preparation_items.presence || 'ê°œì¸ ì†Œì§€í’ˆ' %>)ì„ í™•ì¸í•˜ì…¨ë‚˜ìš”? ìŠì§€ ë§ê³  ì˜ ì±™ê²¨ì„œ ì¦ê±°ìš´ ë§ˆìŒìœ¼ë¡œ ë§Œë‚˜ìš”! ğŸ’";
    }

    modal.classList.remove('hidden');
  }

  function closeNudgeModal() {
    document.getElementById('nudge-modal').classList.add('hidden');
  }

  function openAnnouncementModal() {
    document.getElementById('announcement-modal').classList.remove('hidden');
  }

  function closeAnnouncementModal() {
    document.getElementById('announcement-modal').classList.add('hidden');
  }
</script>
