<% 
  is_premium = @permission.is_premium_member?
  is_proto_style = true # Alway use prototype style
  completed = routine.completed_today?
  card_bg = is_proto_style ? (completed ? "bg-indigo-600/20 border-indigo-500/50" : "bg-[#1B1A24] border-white/5") : (completed ? "bg-indigo-600 border-indigo-600 shadow-lg text-white" : "bg-white border-slate-100 shadow-sm")
  text_color = is_proto_style ? "text-white" : (completed ? "text-white" : "text-slate-900")
%>

<div class="relative group">
  <div class="relative flex items-center justify-between p-5 md:p-6 <%= card_bg %> backdrop-blur-xl border-2 rounded-[32px] transition-all duration-300 <%= completed && is_premium ? "shadow-[0_0_30px_rgba(255,255,255,0.15)] scale-102" : "" %>">
    
    <div class="flex items-center gap-5">
      <!-- Icon Slot -->
      <div class="w-14 h-14 <%= completed ? "bg-white text-indigo-600 scale-90" : "bg-white/10 text-white" %> rounded-2xl flex items-center justify-center text-3xl transition-all duration-500 shadow-xl">
        <%= routine.icon %>
      </div>

      <!-- Title & Meta -->
      <div class="space-y-1">
        <h4 class="font-black text-lg tracking-tight <%= completed ? "line-through opacity-50" : "" %> <%= text_color %>"><%= routine.title %></h4>
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 bg-white/10 rounded-md text-[9px] font-black uppercase tracking-widest text-white/70"><%= routine.category %></span>
          <span class="text-[10px] font-bold text-white/40"><%= routine.current_streak %>일 달성 중</span>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="flex items-center gap-3">
      <% if is_premium %>
        <!-- Relax Pass Trigger (Inlay) -->
        <% unless completed %>
          <button onclick="toggleDropdown('pass-<%= routine.id %>')" class="w-10 h-10 rounded-xl bg-white/5 border border-white/10 flex items-center justify-center text-lg hover:bg-white/10 transition-colors" title="이 루틴에 휴식권 사용">
            🎟️
          </button>
        <% end %>
      <% end %>

      <!-- Check Button -->
      <%= button_to toggle_personal_routine_path(routine, date: Date.current, tab: params[:tab], source: 'prototype'), 
          method: :post,
          class: "w-14 h-14 rounded-2xl flex items-center justify-center transition-all duration-500 active:scale-90 #{completed ? 'bg-emerald-400 text-white' : 'bg-white text-indigo-600 shadow-xl hover:shadow-2xl'}",
          data: { turbo: true } do %>
        <% if completed %>
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"/></svg>
        <% else %>
          <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M12 4v16m8-8H4"/></svg>
        <% end %>
      <% end %>
    </div>

    <!-- Relax/Save Pass Dropdown (Premium Only) -->
    <% if is_premium && !completed %>
      <div id="dropdown-pass-<%= routine.id %>" class="hidden absolute top-full right-0 mt-2 z-[50] w-72 bg-slate-900 border border-white/10 rounded-3xl p-5 shadow-3xl animate-in fade-in zoom-in-95">
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <h5 class="text-sm font-black italic text-white">PREMIUM ITEM</h5>
            <div class="flex gap-2">
              <span class="text-[9px] font-bold text-indigo-400">🎟️ <%= @my_membership.remaining_relax_passes rescue 0 %></span>
              <span class="text-[9px] font-bold text-emerald-400">🛡️ <%= @my_membership.remaining_save_passes rescue 0 %></span>
            </div>
          </div>
          <p class="text-[11px] font-medium text-white/50 leading-relaxed">오늘 루틴을 넘기려면 휴식권을, 이미 놓친 기록을 복구하려면 세이브권을 사용하세요.</p>
          
          <div class="grid grid-cols-2 gap-2">
            <%= form_with url: use_pass_routine_club_path(@routine_club, date: Date.current, routine_id: routine.id, pass_type: 'relax'), 
                          id: "card-#{routine.id}-relax-form", class: "contents" do |f| %>
              <button type="button" 
                            disabled: ((@my_membership.remaining_relax_passes rescue 0) <= 0),
                            onclick="requestItemUse('card-<%= routine.id %>-relax-form', '휴식권을 사용하시겠습니까?', '오늘 루틴을 완료 처리하고 출석을 유지합니다.', '🎟️')"
                            class="w-full py-2.5 bg-indigo-600 rounded-xl text-[10px] font-black shadow-lg disabled:opacity-30 flex items-center justify-center gap-1 text-white border-none">
                <span>🎟️</span> 휴식
              </button>
            <% end %>
            <%= form_with url: use_pass_routine_club_path(@routine_club, date: Date.current, routine_id: routine.id, pass_type: 'save'), 
                          id: "card-#{routine.id}-save-form", class: "contents" do |f| %>
              <button type="button" 
                            disabled: ((@my_membership.remaining_save_passes rescue 0) <= 0),
                            onclick="requestItemUse('card-<%= routine.id %>-save-form', '세이브권을 사용하시겠습니까?', '지나간 결석을 출석으로 긴급 복구합니다.', '🛡️')"
                            class="w-full py-2.5 bg-emerald-600 rounded-xl text-[10px] font-black shadow-lg disabled:opacity-30 flex items-center justify-center gap-1 text-white border-none">
                <span>🛡️</span> 세이브
              </button>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Non-Premium locked pass indicator -->
    <% if !is_premium && !completed %>
       <div class="absolute -top-1 -right-1 opacity-100 transition-opacity">
         <div class="px-2 py-1 bg-white border border-slate-100 rounded-lg text-indigo-600 text-[8px] font-black shadow-lg flex items-center gap-1">
           <span>🎟️</span> 루파 전용
         </div>
       </div>
    <% end %>
  </div>
</div>
