  <div class="midnight-theme-bg space-y-10 pb-40 px-4">
    <%
      total_activities = @activity_data.values.sum
      current_streak = 0
      sorted_dates = @activity_data.keys.sort.reverse
      if sorted_dates.any?
        check_date = Date.current
        if @activity_data[check_date] > 0 || @activity_data[check_date - 1.day] > 0
          curr = @activity_data[check_date] > 0 ? check_date : check_date - 1.day
          while @activity_data[curr] && @activity_data[curr] > 0
            current_streak += 1
            curr -= 1.day
          end
        end
      end
    %>

    <!-- 1. App Header: User Status & Points -->
    <header class="flex items-center justify-between pt-8">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-indigo-500 overflow-hidden shadow-lg shadow-indigo-500/20 border border-white/10">
          <img src="<%= current_user.profile_image %>" class="w-full h-full object-cover">
        </div>
        <div>
          <h2 class="text-sm font-black text-white"><%= current_user.nickname %></h2>
          <div class="flex items-center gap-1.5 mt-0.5">
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
            <p class="text-[10px] font-bold text-slate-500">Active Now</p>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <div class="px-3 py-1.5 app-glass-card flex items-center gap-2 border-indigo-500/10">
          <span class="text-xs">üî•</span>
          <span class="text-xs font-black text-white tabular-nums"><%= current_streak %></span>
        </div>
      </div>
    </header>

    <!-- 2. Interactive Reflection / Quick Input (Mockup Style) -->
    <div class="relative">
      <div class="app-glass-card flex items-center px-5 py-4 gap-4 border-white/5">
        <span class="text-xl">üåô</span>
        <p class="text-[13px] font-bold text-slate-500">Ïò§ÎäòÏùò Î™∞ÏûÖ Í∏∞Î°ù ÎÇ®Í∏∞Í∏∞...</p>
        <div class="ml-auto flex items-center gap-3">
          <svg class="w-5 h-5 text-indigo-500 opacity-50" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </div>
      </div>
    </div>

    <!-- 3. Visual Focus: The Orbit (Routine Progress) -->
    <section class="relative">
      <div class="orbit-visual rounded-[48px] overflow-hidden border border-white/5 bg-[#0F0E17]">
        <!-- Orbits Background -->
        <div class="absolute inset-0 flex items-center justify-center opacity-10">
          <div class="w-[80%] h-[80%] border border-white rounded-full"></div>
          <div class="absolute w-[60%] h-[60%] border border-dashed border-white rounded-full"></div>
        </div>
        
        <!-- Center Visual -->
        <div class="text-center space-y-2 relative z-10 transition-transform duration-700 hover:scale-110">
          <p class="text-[10px] font-black tracking-[0.3em] text-indigo-400 uppercase">Today's Focus</p>
          <% 
            todays_routines = @personal_routines.select { |r| (r.days || []).include?(Date.current.wday.to_s) }
            completed_count = todays_routines.select(&:completed_today?).count
            progress = todays_routines.any? ? (completed_count.to_f / todays_routines.count * 100).to_i : 0
          %>
          <h2 class="text-6xl font-black text-white tabular-nums glow-text-primary"><%= progress %><span class="text-xl ml-1 opacity-40">%</span></h2>
          <p class="text-[12px] font-bold text-slate-500"><%= completed_count %> / <%= todays_routines.count %> Routines Done</p>
        </div>

        <!-- Floating Particles (Icons) -->
        <div class="absolute top-12 right-16 w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-sm border border-white/10 blur-[0.3px] animate-bounce" style="animation-duration: 4s;">‚ú®</div>
        <div class="absolute bottom-16 left-12 w-10 h-10 rounded-full bg-slate-800/40 flex items-center justify-center text-lg border border-white/5">üßò</div>
      </div>
    </section>

    <!-- 4. Growth Intelligence Card (Adapted) -->
    <section>
      <%= link_to achievement_report_path, class: "block app-glass-card p-6 border-indigo-500/10 app-glass-card-hover" do %>
        <div class="flex items-center justify-between mb-4">
          <span class="app-pill app-pill-active">Growth Intel</span>
          <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Detail View ‚Üí</span>
        </div>
        <h3 class="text-lg font-black text-white leading-tight">ÎÇòÏùò ÏÑ±Ï∑® Î¶¨Ìè¨Ìä∏ Î∂ÑÏÑù</h3>
        <p class="text-[11px] font-bold text-slate-500 mt-1 mb-4">Î£®Ìã¥Í≥º Ï±åÎ¶∞ÏßÄ ÏÑ±Í≥ºÎ•º AIÍ∞Ä Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§.</p>
        
        <div class="grid grid-cols-2 gap-4 border-t border-white/5 pt-4">
           <div>
             <p class="text-[9px] font-bold text-slate-600 uppercase tracking-tighter">Total Activity</p>
             <p class="text-xl font-black text-white"><%= total_activities %><span class="text-[10px] ml-0.5 text-slate-500">Ìöå</span></p>
           </div>
           <div class="text-right">
             <p class="text-[9px] font-bold text-slate-600 uppercase tracking-tighter">Success Rate</p>
             <p class="text-xl font-black text-emerald-400">86<span class="text-[10px] ml-0.5 text-slate-500">%</span></p>
           </div>
        </div>
      <% end %>
    </section>

    <!-- 5. Today's Routines (Interactive Feed) -->
    <section class="space-y-4">
      <div class="flex justify-between items-end">
        <h3 class="text-xs font-black text-slate-500 uppercase tracking-[0.2em] leading-none">Routine List</h3>
        <%= link_to personal_routines_path, class: "text-[10px] font-black text-indigo-400" do %>Manage Options ‚Üí<% end %>
      </div>

      <div class="space-y-3">
        <% if todays_routines.any? %>
          <% todays_routines.each do |routine| %>
            <div id="routine_<%= routine.id %>_home">
              <%= button_to toggle_personal_routine_path(routine), 
                            method: :post, 
                            class: "w-full app-glass-card p-5 flex items-center justify-between border-transparent #{routine.completed_today? ? 'glow-border-primary bg-indigo-500/5' : 'hover:bg-white/[0.03]'}",
                            data: { turbo_stream: true } do %>
                <div class="flex items-center gap-4">
                  <div class="w-10 h-10 rounded-2xl flex items-center justify-center text-3xl transition-transform group-hover:scale-110">
                    <%= routine.icon %>
                  </div>
                  <div class="text-left">
                    <p class="text-[11px] font-bold text-slate-500 uppercase tracking-widest"><%= routine.category %></p>
                    <p class="text-sm font-black text-white leading-none mt-1"><%= routine.title %></p>
                  </div>
                </div>
                <div class="w-8 h-8 rounded-xl border-2 flex items-center justify-center transition-all <%= routine.completed_today? ? 'bg-indigo-500 border-indigo-500 shadow-lg shadow-indigo-500/40' : 'border-white/10' %>">
                   <% if routine.completed_today? %>
                     <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                   <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <div class="app-glass-card py-12 text-center border-dashed border-white/10">
             <p class="text-xs font-bold text-slate-500">Ïò§Îäò ÏÑ§Ï†ïÎêú Î£®Ìã¥Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
          </div>
        <% end %>
      </div>
    </section>

    <!-- 6. Active Participation (Clubs & Challenges) -->
    <section class="space-y-4">
      <h3 class="text-xs font-black text-slate-500 uppercase tracking-[0.2em] leading-none">Join Activity</h3>
      
      <div class="grid grid-cols-2 gap-4">
        <% if @my_club_memberships.any? %>
          <% @my_club_memberships.take(2).each do |membership| %>
            <div class="app-glass-card p-5 space-y-4">
              <div class="flex justify-between items-start">
                <span class="text-xl">üî±</span>
                <span class="app-pill app-pill-live">LIVE</span>
              </div>
              <div>
                <h4 class="text-xs font-black text-white line-clamp-1"><%= membership.routine_club.title %></h4>
                <p class="text-[10px] font-bold text-slate-500 mt-1"><%= membership.growth_points %> Energy Points</p>
              </div>
            </div>
          <% end %>
        <% end %>

        <% if @participations.any? %>
          <% @participations.take(2).each do |participation| %>
            <div class="app-glass-card p-5 space-y-4">
              <div class="flex justify-between items-start">
                <div class="w-6 h-6 rounded-lg overflow-hidden border border-white/10">
                  <img src="<%= participation.challenge.thumbnail %>" class="w-full h-full object-cover">
                </div>
                <span class="app-pill app-pill-dim">ÏßÑÌñâ</span>
              </div>
              <div>
                <h4 class="text-xs font-black text-white line-clamp-1"><%= participation.challenge.title %></h4>
                <p class="text-[10px] font-bold text-slate-500 mt-1"><%= (participation.completion_rate * 100).to_i %>% Success</p>
              </div>
            </div>
          <% end %>
        <% end %>

        <% if @my_club_memberships.empty? && @participations.empty? %>
          <div class="col-span-2 app-glass-card p-6 text-center border-dashed border-white/10">
            <p class="text-xs font-bold text-slate-500">ÏßÑÌñâ Ï§ëÏù∏ Ï±åÎ¶∞ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
          </div>
        <% end %>
      </div>
    </section>

    <!-- 7. Ad Banners -->
    <% if @ad_banners.any? %>
      <section class="grid grid-cols-1 gap-4">
        <% @ad_banners.each do |banner| %>
          <%= link_to banner.link_url || "#", class: "group relative h-32 rounded-[32px] overflow-hidden shadow-2xl transition-all border border-white/5 active:scale-95" do %>
            <div class="absolute inset-0 bg-black/40 z-10 group-hover:bg-black/20 transition-colors"></div>
            <% if banner.image.attached? %>
              <%= image_tag banner.image, class: "absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" %>
            <% end %>
            <div class="relative z-20 h-full flex flex-col justify-center px-8 text-white">
              <span class="w-fit px-2 py-0.5 bg-white/10 backdrop-blur-md rounded-full text-[8px] font-black tracking-widest uppercase mb-1.5 border border-white/5"><%= banner.badge_text %></span>
              <h3 class="text-sm font-black"><%= banner.title %></h3>
            </div>
          <% end %>
        <% end %>
      </section>
    <% end %>

    <!-- Floating Bottom Navigation Mockup (To show mobile intent) -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-sm h-20 bg-white/5 backdrop-blur-2xl rounded-[32px] border border-white/10 flex items-center justify-around px-8 z-[100] shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
      <div class="flex flex-col items-center gap-1.5">
        <div class="w-1.5 h-1.5 rounded-full bg-indigo-500 shadow-[0_0_10px_rgba(124,77,255,0.8)]"></div>
        <span class="text-lg">üè†</span>
      </div>
      <span class="text-lg opacity-40">üîç</span>
      <div class="w-14 h-14 app-fab-gradient rounded-full flex items-center justify-center -translate-y-6 shadow-2xl border-4 border-[#0C0B12]">
        <span class="text-2xl text-white font-black">+</span>
      </div>
      <span class="text-lg opacity-40">‚ú®</span>
      <span class="text-lg opacity-40">üë§</span>
    </div>

  </div> <!-- End Midnight Theme -->

