<turbo-stream action="replace" target="routine_<%= @routine.id %>_home">
  <template>
    <div id="routine_<%= @routine.id %>_home" class="group/routine">
      <%= button_to toggle_personal_routine_path(@routine), 
                    method: :post, 
                    class: "w-full flex items-center justify-between p-4 lg:p-6 rounded-2xl lg:rounded-[32px] border-2 transition-all #{@routine.completed_today? ? 'bg-white border-white shadow-xl translate-y-[-4px]' : 'bg-white/5 border-white/5 text-white hover:bg-white/10 hover:border-white/10'}",
                    data: { turbo_stream: true } do %>
        <div class="flex items-center gap-4 active:scale-95 transition-transform origin-left">
          <div class="w-7 h-7 lg:w-9 lg:h-9 rounded-xl border-2 flex items-center justify-center transition-all <%= @routine.completed_today? ? 'bg-indigo-600 border-indigo-600' : 'border-white/30 group-hover/routine:border-white' %>">
            <% if @routine.completed_today? %>
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            <% end %>
          </div>
          <div class="text-left">
            <p class="text-sm lg:text-lg font-black leading-tight <%= @routine.completed_today? ? 'text-slate-900' : 'text-white' %>"><%= @routine.title %></p>
            <p class="text-[9px] lg:text-[11px] font-black uppercase tracking-[0.2em] mt-1 <%= @routine.completed_today? ? 'text-indigo-600' : 'text-white/40' %>"><%= @routine.completed_today? ? 'Completed' : 'Upcoming' %></p>
          </div>
        </div>
        <span class="text-2xl lg:text-4xl filter drop-shadow-lg group-hover/routine:scale-125 transition-transform"><%= @routine.icon %></span>
      <% end %>
    </div>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_card">
  <template>
    <%= render partial: 'personal_routines/routine_card', locals: { routine: @routine }, formats: [:html] %>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_dashboard">
  <template>
    <% is_done = @routine.completed_on?(@selected_date) %>
    <%= render partial: 'routine_clubs/dashboard_routine_item', locals: { routine: @routine, is_done: is_done, selected_date: @selected_date }, formats: [:html] %>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_club">
  <template>
    <div id="routine_<%= @routine.id %>_club" class="w-full">
      <%= button_to toggle_personal_routine_path(@routine), 
                    method: :post, 
                    class: "flex items-center justify-between p-6 rounded-3xl border-2 transition-all hover:scale-[1.02] w-full #{@routine.completed_today? ? 'bg-indigo-50 border-indigo-200 ring-4 ring-indigo-50' : 'bg-slate-50 border-transparent hover:border-indigo-100 group'}",
                    data: { turbo_stream: true } do %>
        <div class="flex items-center gap-4 flex-1 min-w-0 overflow-hidden">
          <span class="text-2xl transform group-hover:scale-125 transition-transform flex-shrink-0"><%= @routine.icon %></span>
          <div class="text-left min-w-0 flex-1">
            <p class="text-[15px] font-black text-slate-900 truncate <%= 'line-through text-slate-400' if @routine.completed_today? %>"><%= @routine.title %></p>
            <p class="text-[10px] font-bold text-slate-400 truncate"><%= @routine.category %></p>
          </div>
        </div>
        <% if @routine.completed_today? %>
          <div class="w-10 h-10 bg-indigo-600 rounded-2xl flex items-center justify-center text-white flex-shrink-0 ml-4 shadow-lg shadow-indigo-100">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          </div>
        <% else %>
          <div class="w-10 h-10 bg-white rounded-2xl flex items-center justify-center text-slate-200 border border-slate-100 group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-all flex-shrink-0 ml-4 shadow-sm">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          </div>
        <% end %>
      <% end %>
    </div>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_architecture">
  <template>
    <div id="routine_<%= @routine.id %>_architecture">
      <%= button_to toggle_personal_routine_path(@routine), 
                    method: :post, 
                    class: "w-10 h-10 rounded-xl flex items-center justify-center transition-all #{@routine.completed_today? ? 'bg-emerald-500 text-white shadow-lg' : 'bg-white text-slate-300 hover:bg-emerald-50 hover:text-emerald-500'}",
                    data: { turbo_stream: true } do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
      <% end %>
    </div>
  </template>
</turbo-stream>

<turbo-stream action="replace" target="routine_<%= @routine.id %>_prototype">
  <template>
    <div id="routine_<%= @routine.id %>_prototype">
      <%= button_to toggle_personal_routine_path(@routine), 
                  method: :post, 
                  class: "w-full app-glass-card p-5 flex items-center justify-between border-transparent hover:border-indigo-500/30 transition-all app-tap-active group #{@routine.completed_today? ? 'bg-indigo-500/10' : ''}",
                  data: { turbo_stream: true } do %>
        <div class="flex items-center gap-4">
          <span class="text-3xl group-active:scale-125 transition-transform"><%= @routine.icon %></span>
          <div class="text-left">
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-0.5"><%= @routine.category %></p>
            <p class="text-sm font-black text-white leading-none"><%= @routine.title %></p>
          </div>
        </div>
        <div class="w-8 h-8 rounded-xl border-2 flex items-center justify-center transition-all #{@routine.completed_today? ? 'bg-indigo-500 border-indigo-500 shadow-lg shadow-indigo-500/20' : 'border-white/10' %>">
           <% if @routine.completed_today? %>
             <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
           <% end %>
        </div>
      <% end %>
    </div>
  </template>
</turbo-stream>

<%= turbo_stream.update "monthly-done-count" do %>
  <%= @monthly_completions&.count || 0 %>
<% end %>

<%= turbo_stream.replace "achievement-matrix" do %>
  <%= render partial: "shared/achievement_matrix", formats: [:html] %>
<% end %>

<%# Update Prototype Orbit Section %>
<% 
  todays_routines = current_user.personal_routines.select { |r| (r.days || []).include?(Date.current.wday.to_s) }
  # Combined Active Participations (Challenges & Gatherings)
  joined_participations = current_user ? current_user.participations.active.joins(:challenge) : []
  
  routine_total = todays_routines.count
  participation_total = joined_participations.count
  total_task_count = routine_total + participation_total

  routine_done = todays_routines.select(&:completed_today?).count
  # Assume verification_logs for today exists for completed items
  participation_done = current_user ? VerificationLog.where(participant: joined_participations, created_at: Date.current.all_day).pluck(:participant_id).uniq.count : 0

  completed_count = routine_done + participation_done
  progress = total_task_count.positive? ? (completed_count.to_f / total_task_count * 100).to_i : 0
%>
<%= turbo_stream.replace "prototype-orbit-section" do %>
  <%= render partial: "prototype/orbit", locals: { 
        progress: progress, 
        completed_count: completed_count, 
        total_task_count: total_task_count,
        orbit_users: [],
        todays_routines: todays_routines
      } %>
<% end %>

<% if current_user.is_rufa_club_member? && @routine_club && @my_membership %>
  <%# 1. Update Daily Record Area (Allowing text recording when all done) %>
  <%= turbo_stream.replace "rufa-daily-record" do %>
    <div id="rufa-daily-record" class="flex flex-col w-full">
       <%= render partial: 'routine_clubs/daily_record_area', formats: [:html] %>
    </div>
  <% end %>

  <%# 2. Update Club Dashboard Stats Grid %>
  <%= turbo_stream.replace "rufa-club-stats-grid" do %>
    <div id="rufa-club-stats-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4">
      <% daily_rate = current_user.daily_achievement_rate(@selected_date).to_i %>
      <!-- 오늘의 달성률 -->
      <div class="bg-indigo-600 rounded-2xl p-4 md:p-6 text-white shadow-lg relative overflow-hidden flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-indigo-100 uppercase tracking-wider mb-1 md:mb-2 italic">오늘의 달성률</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black tracking-tight tabular-nums"><%= daily_rate %></p>
          <p class="text-xs md:text-sm font-bold text-indigo-300">%</p>
        </div>
      </div>

      <!-- 성장 에너지 -->
      <div class="bg-slate-900 rounded-2xl p-4 md:p-6 text-white shadow-lg relative overflow-hidden flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-indigo-300 uppercase tracking-wider mb-1 md:mb-2">성장 에너지</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black tracking-tight tabular-nums"><%= @my_membership.growth_points || 0 %></p>
          <p class="text-xs md:text-sm font-bold text-indigo-400">P</p>
        </div>
      </div>

      <!-- 달성률 (월간 평균) -->
      <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-purple-400 uppercase tracking-wider mb-1 md:mb-2">월간 평균 성취</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.achievement_rate.to_i %></p>
          <p class="text-xs md:text-sm font-bold text-slate-400">%</p>
        </div>
      </div>
      
      <!-- 출석률 -->
      <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-emerald-500 uppercase tracking-wider mb-1 md:mb-2">출석률</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.attendance_rate.to_i %></p>
          <p class="text-xs md:text-sm font-bold text-slate-400">%</p>
        </div>
      </div>
      
      <!-- 휴식권 -->
      <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm cursor-help flex flex-col justify-between" 
           title="오늘 분량 면제 & 출석률 70% 보호">
        <p class="text-[10px] md:text-xs font-black text-blue-400 uppercase tracking-wider mb-1 md:mb-2">휴식권</p>
        <div class="flex items-center justify-between gap-1">
          <div class="flex items-baseline gap-1">
            <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.remaining_passes %></p>
            <p class="text-xs md:text-sm font-bold text-slate-400">개</p>
          </div>
          <% 
            today_attendance = @my_membership.attendances.find_by(attendance_date: Date.current)
            can_use_pass = @my_membership.remaining_passes > 0 && !today_attendance&.status_excused?
          %>
          <% if can_use_pass %>
            <%= button_to use_pass_routine_club_path(@routine_club), method: :post, 
                          class: "px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-[10px] md:text-xs font-black border border-blue-100 hover:bg-blue-600 hover:text-white transition-all whitespace-nowrap", 
                          data: { turbo_confirm: "휴식권을 사용하시겠습니까?", turbo: false } do %>
              사용
            <% end %>
          <% elsif today_attendance&.status_excused? %>
            <span class="px-3 py-1.5 bg-green-50 text-green-600 rounded-lg text-[10px] md:text-xs font-black">완료</span>
          <% end %>
        </div>
      </div>
      
      <!-- 누적 경고 -->
      <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm relative overflow-hidden flex flex-col justify-between">
        <p class="text-[10px] md:text-xs font-black text-amber-500 uppercase tracking-wider mb-1 md:mb-2">누적 경고</p>
        <div class="flex items-baseline gap-1">
          <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.penalty_count %></p>
          <p class="text-xs md:text-sm font-bold text-slate-400">회</p>
        </div>
      </div>
    </div>
  <% end %>

  <%# 3. Update Premium Personal Dashboard Stats (나의 루틴 탭) %>
  <%= turbo_stream.replace "premium-routine-stats" do %>
    <div id="premium-routine-stats" class="grid grid-cols-3 gap-3 md:gap-4">
       <!-- Achievement Rate -->
       <div class="bg-slate-900 rounded-2xl p-4 md:p-6 text-white shadow-lg relative overflow-hidden group flex flex-col justify-between">
         <div class="absolute -right-4 -top-4 w-12 h-12 bg-indigo-600/20 rounded-full blur-xl group-hover:scale-150 transition-transform duration-700"></div>
         <p class="text-[10px] md:text-xs font-black text-indigo-300 uppercase tracking-wider mb-1 md:mb-2">달성률</p>
         <div class="flex items-baseline gap-1">
           <p class="text-2xl md:text-3xl font-black tracking-tight tabular-nums"><%= current_user.daily_achievement_rate(@selected_date).to_i %></p>
           <p class="text-xs md:text-sm font-bold text-indigo-400 font-mono">%</p>
         </div>
         <div class="mt-3 md:mt-4 h-1 w-full bg-white/10 rounded-full overflow-hidden">
            <div class="h-full bg-indigo-400 transition-all duration-1000" style="width: <%= current_user.daily_achievement_rate(@selected_date).to_i %>%"></div>
         </div>
       </div>

       <!-- Reward Points -->
       <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm group hover:border-amber-200 transition-colors flex flex-col justify-between">
         <p class="text-[10px] md:text-xs font-black text-amber-500 uppercase tracking-wider mb-1 md:mb-2 truncate">에너지</p>
         <div class="flex items-baseline gap-1">
           <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= @my_membership.growth_points || 0 %></p>
           <p class="text-xs md:text-sm font-bold text-slate-300 font-mono">P</p>
         </div>
       </div>

       <!-- Member Days -->
       <% member_days = (Date.current - @my_membership.joined_at.to_date).to_i + 1 %>
       <div class="bg-white rounded-2xl p-4 md:p-6 border border-slate-200 shadow-sm group hover:border-purple-200 transition-colors flex flex-col justify-between">
         <p class="text-[10px] md:text-xs font-black text-purple-400 uppercase tracking-wider mb-1 md:mb-2 truncate">활동일</p>
         <div class="flex items-baseline gap-1">
           <p class="text-2xl md:text-3xl font-black text-slate-900 tracking-tight tabular-nums"><%= member_days %></p>
           <p class="text-xs md:text-sm font-bold text-slate-300 font-mono">D</p>
         </div>
       </div>
    </div>
  <% end %>
<% end %>
