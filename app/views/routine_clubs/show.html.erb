<div class="min-h-screen bg-gradient-to-br from-orange-50 via-white to-pink-50/30">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-0 pb-12">
    
    <!-- Back Button -->
    <div class="mb-8">
      <%= link_to routine_clubs_path, class: "inline-flex items-center gap-2 text-slate-600 hover:text-slate-900 font-bold transition-colors" do %>
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        클럽 목록으로
      <% end %>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      
      <% if @is_member && params[:tab] == "dashboard" %>
        <div class="lg:col-span-12">
           <%= render "dashboard" %>
        </div>
      <% else %>
        <!-- Main Content (Landing/Info) -->
        <div class="lg:col-span-8 space-y-8">
       
        
        <!-- Hero Section -->
        <div class="bg-white rounded-[48px] overflow-hidden shadow-xl border-2 border-orange-200">
          <!-- Thumbnail -->
          <div class="aspect-[21/9] bg-gradient-to-br from-orange-400 via-pink-500 to-purple-500 relative">
            <% if @routine_club.thumbnail.attached? %>
              <%= image_tag @routine_club.thumbnail, class: "absolute inset-0 w-full h-full object-cover" %>
            <% else %>
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="text-9xl opacity-40">💎</div>
              </div>
            <% end %>
            
            <!-- Premium Badge -->
            <div class="absolute top-6 left-6">
              <span class="bg-white/90 backdrop-blur-sm px-4 py-2 rounded-full text-sm font-black text-orange-600 shadow-sm border border-orange-100">
                루파 프리미엄
              </span>
            </div>
            
            <!-- Status Badge -->
            <div class="absolute top-6 right-6">
              <% if @routine_club.is_full? %>
                <span class="bg-slate-500 px-4 py-2 rounded-full text-sm font-black text-white">
                  마감
                </span>
              <% elsif @routine_club.recruitment_open? %>
                <span class="bg-emerald-500 px-4 py-2 rounded-full text-sm font-black text-white animate-pulse">
                  모집 중
                </span>
              <% else %>
                <span class="bg-slate-900/50 backdrop-blur-md px-4 py-2 rounded-full text-sm font-black text-white/50 border border-white/10">
                  모집 종료
                </span>
              <% end %>
            </div>
          </div>
          
          <!-- Content -->
          <div class="p-8 space-y-6">
            <!-- Host Info -->
            <div class="flex items-center gap-4">
              <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-orange-200">
                <%= image_tag "/quokka_host.jpg", class: "w-full h-full object-cover" %>
              </div>
              <div>
                <p class="text-xs font-black text-slate-400 uppercase tracking-widest">Host</p>
                <p class="text-xl font-black text-slate-900">쿼카워니</p>
              </div>
            </div>
            
            <!-- Title & Description -->
            <div>
              <h1 class="text-4xl font-black text-slate-900 mb-4 break-keep">
                <%= @routine_club.title %>
              </h1>
              <p class="text-lg text-slate-600 font-medium leading-relaxed">
              <p class="text-lg text-slate-600 font-medium leading-relaxed">
                무언가가 완전히 습관으로 자리잡기 위해서는 최소 66일, 그리고 이를 증명하기 위한 여유 기간이 필요합니다. <br/><br/>
                루파 클럽은 <span class="text-orange-600 font-bold">하루 단 300원</span>으로 당신의 인생을 바꿀 90일을 설계합니다. 
                <span class="bg-amber-100 text-amber-800 px-1 font-bold">기수별 정기 모집</span>을 통해 압도적인 소속감과 강력한 환경 통제 시스템을 경험하세요.
              </p>
            </div>
            
            <!-- Stats Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-y-8 gap-x-4 pt-6 border-t border-slate-100">
              <div class="text-center md:text-left">
                <p class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest mb-1 md:mb-2 whitespace-nowrap">기간</p>
                <p class="text-xl md:text-2xl font-black text-slate-900 leading-tight">
                  <%= @routine_club.duration_in_months %>개월
                </p>
              </div>
              <div class="text-center md:text-left">
                <p class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest mb-1 md:mb-2 whitespace-nowrap">분기 요금 (시작일 기준)</p>
                <p class="text-xl md:text-2xl font-black text-orange-600 leading-tight">
                  <%= number_to_currency(@routine_club.calculate_quarterly_fee, unit: "₩", precision: 0, format: "%n%u") %>
                </p>
                <p class="text-[9px] text-slate-400 font-bold mt-1">하루 단 300원</p>
              </div>
              <div class="text-center md:text-left">
                <p class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest mb-1 md:mb-2 whitespace-nowrap">멤버</p>
                <p class="text-xl md:text-2xl font-black text-indigo-500 leading-tight">
                  <%= @routine_club.current_members %> / <%= @routine_club.max_members %>
                </p>
              </div>
              <div class="text-center md:text-left">
                <p class="text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest mb-1 md:mb-2 whitespace-nowrap">시작일</p>
                <p class="text-xl md:text-2xl font-black text-purple-500 leading-tight">
                  <%= @routine_club.start_date.strftime("%m/%d") %>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Inline Recruitment Status (Top) - Duplicated from sidebar for better visibility -->
        <% unless @is_member || @is_host || @routine_club.is_full? %>
          <% if !@routine_club.recruitment_open? && current_user&.role != "admin" %>
            <!-- Recruitment Closed Card -->
            <div class="bg-slate-900 border-2 border-slate-800 rounded-[40px] p-10 md:p-16 text-center shadow-2xl relative overflow-hidden mb-8">
              <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
              <div class="relative z-10 space-y-8 max-w-2xl mx-auto">
                <div class="w-24 h-24 bg-slate-800 rounded-[32px] flex items-center justify-center text-5xl mx-auto border border-white/5 shadow-2xl">🔒</div>
                <div class="space-y-4">
                  <h3 class="text-[20px] sm:text-3xl font-black text-white whitespace-nowrap">현재 정기 모집 기간이 아닙니다</h3>
                  <p class="text-lg text-slate-500 font-bold leading-relaxed break-keep border-b border-white/5 pb-6 mb-6">
                    루파 클럽은 최상의 몰입 환경을 유지하기 위해 <br class="hidden md:block"/>
                    정해진 분기별 기수 모집 기간에만 신규 멤버를 선발하고 있습니다.
                  </p>
                  
                  <!-- 기존 멤버 참여 버튼 -->
                  <div class="flex flex-col items-center gap-4">
                    <button onclick="document.getElementById('join-form').classList.remove('hidden'); document.getElementById('join-form').scrollIntoView({ behavior: 'smooth', block: 'start' });" class="px-8 py-4 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white rounded-2xl font-black text-lg transition-all shadow-xl hover:shadow-2xl active:scale-95 whitespace-nowrap flex items-center justify-center gap-2 mx-auto">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                      </svg>
                      기존 멤버 참여
                    </button>
                    <p class="text-sm text-indigo-400 font-bold animate-pulse">⚡ 기존 멤버는 언제든지 참여하실 수 있습니다</p>
                  </div>
                </div>
                <div class="pt-6 border-t border-white/5">
                  <p class="text-xs font-black text-indigo-400 uppercase tracking-widest mb-3">Next Recruitment Schedule</p>
                  <div class="inline-flex px-8 py-4 bg-white/5 border border-white/10 rounded-2xl text-xl text-white font-black">
                    <%= RoutineClub.recruitment_start_date.strftime("%Y년 %m월 %d일") %> 오픈 예정
                  </div>
                </div>
              </div>
            </div>
          <% end %>

          <!-- Join Form Card (Always visible for members joining via link) -->
          <div id="join-form" class="<%= 'hidden' if !@routine_club.recruitment_open? && current_user&.role != 'admin' %> bg-gradient-to-br from-indigo-500 via-purple-500 to-slate-900 rounded-[40px] p-8 md:p-12 text-white shadow-2xl relative overflow-hidden group mb-8 scroll-mt-32">
            <div class="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 group-hover:bg-white/20 transition-all"></div>
              <div class="max-w-xl">
                <% cur_gen = @routine_club.recruiting_generation_number %>
                <div class="inline-flex px-3 py-1 bg-white/20 backdrop-blur-md rounded-lg text-xs font-black uppercase tracking-widest mb-4">루파 클럽 <%= cur_gen %>기 신청</div>
                <h3 class="text-3xl font-black mb-4">멤버십 정기 모집 활성화</h3>
                <p class="text-lg font-medium text-white/80 mb-8 break-keep">
                  하루 300원 수준의 투자로 성장을 강제하세요. <br/>
                  가장 압도적인 한 단계 위로의 도약을 위해 지금 합류하세요.
                </p>
                <%= form_with url: join_routine_club_path(@routine_club), method: :post, class: "space-y-6" do |f| %>
                  <%= hidden_field_tag :beta_test, true %>
                  <!-- 1. 활동 각오 -->
                  <div>
                    <%= f.label :commitment, class: "text-[10px] font-black text-white/60 uppercase tracking-widest ml-1 mb-1 block" do %>
                      루파 클럽 활동 각오 <span class="text-indigo-300">*</span>
                    <% end %>
                    <%= text_area_tag :commitment, nil, placeholder: "루파 클럽에 임하는 나만의 각오를 진정성 있게 적어주세요.", required: true, rows: 3, class: "w-full px-6 py-4 bg-white/10 border-white/10 rounded-2xl text-white placeholder-white/50 font-bold focus:ring-2 ring-indigo-500/50 border-none transition-all resize-none" %>
                  </div>

                  <!-- 2. 이루고 싶은 목표 -->
                  <div>
                    <%= f.label :goal, class: "text-[10px] font-black text-white/60 uppercase tracking-widest ml-1 mb-1 block" do %>
                      이번 기수 목표 <span class="text-indigo-300">*</span>
                    <% end %>
                    <%= text_area_tag :goal, nil, placeholder: "구체적으로 이루고 싶은 수치나 변화를 적어주세요.", required: true, rows: 2, class: "w-full px-6 py-4 bg-white/10 border-white/10 rounded-2xl text-white placeholder-white/50 font-bold focus:ring-2 ring-indigo-500/50 border-none transition-all resize-none" %>
                  </div>

                  <!-- 3. 스레드 계정 (너비 축소) -->
                  <div class="w-full md:w-1/2">
                    <%= f.label :threads_nickname, class: "text-[10px] font-black text-white/60 uppercase tracking-widest ml-1 mb-1 block" do %>
                      스레드 계정 (선택)
                    <% end %>
                    <div class="relative">
                      <span class="absolute left-6 top-1/2 -translate-y-1/2 text-white font-bold pointer-events-none">@</span>
                      <%= text_field_tag :threads_nickname, nil, placeholder: "", class: "w-full pl-11 pr-6 py-4 bg-white/10 border-white/10 rounded-2xl text-white placeholder-white/50 font-bold focus:ring-2 ring-indigo-500/50 border-none transition-all" %>
                    </div>
                  </div>

                  <div class="h-px bg-white/10 my-6"></div>

                  <!-- 4. 입금 정보 (하단 배치) -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-slate-900">
                    <div>
                      <%= f.label :depositor_name, class: "text-[10px] font-black text-white/60 uppercase tracking-widest ml-1 mb-1 block" do %>
                        입금자 실명 <span class="text-indigo-300">*</span>
                      <% end %>
                      <%= text_field_tag :depositor_name, nil, placeholder: "입금자명", required: true, class: "w-full px-6 py-4 bg-white/10 border-white/10 rounded-2xl text-white placeholder-white/50 font-bold focus:ring-2 ring-indigo-500/50 border-none transition-all" %>
                    </div>
                    <div>
                      <%= f.label :contact_info, class: "text-[10px] font-black text-white/60 uppercase tracking-widest ml-1 mb-1 block" do %>
                        연락처 <span class="text-indigo-300">*</span>
                      <% end %>
                      <%= text_field_tag :contact_info, nil, placeholder: "010-0000-0000", required: true, 
                          class: "w-full px-6 py-4 bg-white/10 border-white/10 rounded-2xl text-white placeholder-white/50 font-bold focus:ring-2 ring-indigo-500/50 border-none transition-all",
                          data: { controller: "phone-format", action: "input->phone-format#format", phone_format_target: "input" } %>
                    </div>
                  </div>
                  <div class="flex flex-col md:flex-row items-center gap-6 pt-4">
                    <div class="flex-1 bg-white/5 rounded-2xl p-5 text-sm border border-white/10 w-full">
                      <p class="font-black text-white mb-2 text-xs">🏦 <%= @routine_club.bank_name %> <%= @routine_club.account_number %> (<%= @routine_club.account_holder %>)</p>
                      <p class="text-[10px] text-white/40">입금 완료 후 신청하기 버튼을 눌러주세요.</p>
                    </div>
                    <button type="submit" class="w-full md:w-auto px-12 py-5 bg-white text-orange-600 rounded-3xl font-black text-xl hover:bg-yellow-300 hover:text-orange-700 transition-all shadow-xl active:scale-95 whitespace-nowrap">
                      지금 바로 신청하기
                    </button>
                  </div>
                  <p class="text-[10px] text-white/50 font-bold mt-2">※ 루파 클럽은 성실한 참여를 원칙으로 하며, 제명 시 해당 클럽의 재가입이 영구적으로 제한됩니다.</p>
<% end %>
              </div>
            </div>

        <% end %>

        <!-- Rules Section -->
        <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm relative overflow-hidden">
          <div class="absolute top-0 right-0 p-8 opacity-5">
            <svg class="w-24 h-24" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z"/></svg>
          </div>
          
          <div class="flex items-center gap-3 mb-8">
            <div class="w-12 h-12 bg-orange-100 rounded-2xl flex items-center justify-center">
              <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
            <div>
              <h2 class="text-2xl font-black text-slate-900 whitespace-nowrap">루파 성장 오퍼레이팅</h2>
              <p class="text-sm text-slate-500 font-medium tracking-tight whitespace-nowrap">당신의 습관을 자동으로 완성시키는 3대 핵심 엔진</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- System 1: Relaxation Pass -->
            <div class="bg-gradient-to-br from-blue-50/50 to-indigo-50/50 rounded-[32px] p-6 border border-blue-100/50 hover:shadow-xl hover:-translate-y-1 transition-all group">
              <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-2xl mb-4 shadow-sm group-hover:scale-110 transition-transform">🎫</div>
              <h3 class="font-black text-slate-900 mb-2"><%= @routine_club.relax_pass_limit %>회의 휴식권</h3>
              <p class="text-[11px] text-slate-500 font-medium leading-relaxed">
                급한 용무가 있을 때 사용하는 치트키. <span class="text-indigo-600 font-black">스트릭을 유지</span>하며 결석 경고를 원천 차단합니다.
              </p>
            </div>

            <!-- System 2: Golden Fire -->
            <div class="bg-gradient-to-br from-orange-50/50 to-amber-50/50 rounded-[32px] p-6 border border-orange-100/50 hover:shadow-xl hover:-translate-y-1 transition-all group">
              <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-2xl mb-4 shadow-sm group-hover:scale-110 transition-transform">🔥</div>
              <h3 class="font-black text-slate-900 mb-2">황금 불꽃 리워드</h3>
              <p class="text-[11px] text-slate-500 font-medium leading-relaxed">
                주 7일 완벽한 몰입을 보여준 멤버에게 부여되는 <span class="text-orange-600 font-black">압도적인 에너지 보너스(<%= @routine_club.golden_fire_bonus %>P)</span>와 시각 효과.
              </p>
            </div>

            <!-- System 3: Strict Penalty -->
            <div class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-[32px] p-6 border border-slate-700 hover:shadow-xl hover:-translate-y-1 transition-all group">
              <div class="w-12 h-12 bg-white/10 rounded-2xl flex items-center justify-center text-2xl mb-4 shadow-sm group-hover:scale-110 transition-transform text-orange-400">🚫</div>
              <h3 class="font-black text-white mb-2">Penalty 킥</h3>
              <p class="text-[11px] text-slate-300 font-medium leading-relaxed">
                수질 관리를 위한 최후의 잣대. <span class="text-orange-400 font-black">누적 경고 <%= @routine_club.auto_kick_threshold %>회 즉시 제명</span> 및 환불 불가 원칙이 적용됩니다.
              </p>
            </div>
          </div>
        </div>

        <!-- Details Section -->
        <div class="bg-white rounded-[40px] p-8 md:p-12 border border-slate-200 shadow-sm space-y-12">
          <!-- Intro -->
          <section class="space-y-4">
            <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
              <span class="w-2 h-8 bg-orange-500 rounded-full"></span>
              루파 클럽의 철학: "의지를 넘어선 시스템의 힘"
            </h3>
            <p class="text-slate-600 font-medium leading-relaxed">
              인생을 바꾸는 것은 거창한 한 번의 결심이 아니라, 매일 반복되는 사소한 루틴의 합입니다. <br/>
              루파 클럽은 <span class="bg-orange-100 text-orange-600 px-1 font-bold">하루 단 300원</span>의 투자로 당신의 의지가 흔들릴 때, 강력한 시스템과 끈끈한 동료들이 당신을 다시 일으켜 세우는 '성장 가속기'입니다. <br/>
              <span class="text-xs text-slate-400 mt-2 block">* 본 클럽은 분기별 기수 정기 모집(1월, 4월, 7월, 10월)으로만 운영되는 상호 책임 시스템입니다.</span>
            </p>
          </section>

          <!-- Intelligent System -->
          <section class="space-y-6">
            <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
              <span class="w-2 h-8 bg-indigo-500 rounded-full"></span>
              지능형 루틴 인증 시스템
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100">
                <p class="font-black text-slate-900 mb-2">📅 개인별 맞춤 요일제</p>
                <p class="text-sm text-slate-500 leading-relaxed font-medium">본인이 설정한 요일에만 집중하세요. 루틴이 없는 날은 시스템이 자동으로 스트릭을 유지해주는 '징검다리 로직'이 작동합니다.</p>
              </div>
              <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100">
                <p class="font-black text-slate-900 mb-2">🔥 황금 불꽃 (Golden Fire)</p>
                <p class="text-sm text-slate-500 leading-relaxed font-medium">주 7일 매일 도전하는 고몰입 유저에겐 '황금 불꽃' 시각 효과와 압도적인 경험치 보상이 주어져, 노력의 밀도를 증명합니다.</p>
              </div>
              <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100">
                <p class="font-black text-slate-900 mb-2">🎫 휴식권 (Relaxation Pass)</p>
                <p class="text-sm text-slate-500 leading-relaxed font-medium">예상치 못한 사정에도 당신의 소중한 기록을 지킬 수 있습니다. 한 시즌당 3장의 휴식권으로 경고를 방어하고 스트릭을 보호하세요.</p>
              </div>
              <div class="p-6 bg-slate-50 rounded-3xl border border-slate-100">
                <p class="font-black text-slate-900 mb-2">📈 활동 점수 데이터화</p>
                <p class="text-sm text-slate-500 leading-relaxed font-medium">단순 성공/실패가 아닌, 수행한 루틴의 총량과 밀도를 데이터화하여 당신의 성장 에너지를 점수로 환산합니다.</p>
              </div>
            </div>
          </section>

          <!-- Benefits -->
          <section class="space-y-6">
            <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
              <span class="w-2 h-8 bg-emerald-500 rounded-full"></span>
              멤버십 전용 프리미엄 혜택
            </h3>
            <ul class="space-y-4">
              <li class="flex items-start gap-4">
                <div class="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center shrink-0 mt-1">✓</div>
                <div>
                  <p class="font-black text-slate-900">주간 정밀 분석 리포트</p>
                  <p class="text-sm text-slate-500 font-medium">매주 월요일, 지난주 활동 데이터를 분석하여 성장 추이와 개선점을 짚어주는 개인별 분석 리포트가 발행됩니다.</p>
                </div>
              </li>
              <li class="flex items-start gap-4">
                <div class="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center shrink-0 mt-1">✓</div>
                <div>
                  <p class="font-black text-slate-900">루파 전용 성장 타임라인</p>
                  <p class="text-sm text-slate-500 font-medium">고몰입 동료들만이 공유하는 실시간 타임라인에서 서로의 노력을 확인하고 클랩(Clap)으로 끝없는 동기부여를 받습니다.</p>
                </div>
              </li>
              <li class="flex items-start gap-4">
                <div class="w-6 h-6 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center shrink-0 mt-1">✓</div>
                <div>
                  <p class="font-black text-slate-900">명예의 전당 및 전용 배지</p>
                  <p class="text-sm text-slate-500 font-medium">루파 클러버에게만 주어지는 특별한 휘장과 함께, 서비스 전체 랭킹에서 우선 노출되는 명예를 누립니다.</p>
                </div>
              </li>
            </ul>
          </section>

          <!-- Rewards Section -->
          <section class="space-y-8">
            <h3 class="text-xl font-black text-slate-900 flex items-center gap-2">
              <span class="w-2 h-8 bg-amber-500 rounded-full"></span>
              성장의 증명: 기수 완주 및 배지 시스템
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="bg-slate-50 rounded-[32px] p-8 border border-slate-100">
                <h4 class="text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
                  <span class="text-2xl">🏅</span> 명예 완주 배지
                </h4>
                <div class="space-y-4">
                  <div class="flex items-start gap-3">
                    <div class="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-[10px] text-white shrink-0 mt-1">✓</div>
                    <p class="text-sm text-slate-600 font-medium"><span class="font-black">출석률 70% 이상</span>: 루틴이 설정된 날짜 중 70% 이상 실천 시 수여</p>
                  </div>
                  <div class="flex items-start gap-3">
                    <div class="w-5 h-5 rounded-full bg-emerald-500 flex items-center justify-center text-[10px] text-white shrink-0 mt-1">✓</div>
                    <p class="text-sm text-slate-600 font-medium"><span class="font-black">생존 필수</span>: 경고 누적으로 인한 제명 없이 시즌을 마무리할 것</p>
                  </div>
                  <p class="text-xs text-slate-400 leading-relaxed pl-8">※ 완주 배지는 기수 종료일 익일 시스템에 의해 자동 수여되며 내 프로필의 '명예의 전당'에 영구 보존됩니다.</p>
                </div>
              </div>
              
              <div class="bg-slate-900 rounded-[32px] p-8 text-white relative overflow-hidden group">
                <div class="absolute -right-4 -bottom-4 text-8xl opacity-10 group-hover:scale-110 transition-transform">🚫</div>
                <h4 class="text-lg font-black text-white mb-4 flex items-center gap-2">
                  <span class="text-2xl text-red-500">⚡️</span> 강력한 제명 규정
                </h4>
                <ul class="space-y-3">
                  <li class="text-sm text-slate-300 font-medium flex gap-2">
                    <span class="text-red-500 font-black">•</span>
                    <span>무단 결석 시 경고 1회 자동 부과</span>
                  </li>
                  <li class="text-sm text-slate-300 font-medium flex gap-2">
                    <span class="text-red-500 font-black">•</span>
                    <span><span class="text-white font-black">누적 경고 <%= @routine_club.auto_kick_threshold %>회</span> 달성 시 즉시 시스템 제명</span>
                  </li>
                  <li class="text-sm text-slate-300 font-medium flex gap-2">
                    <span class="text-red-500 font-black">•</span>
                    <span>제명 시 서비스 이용 제한 및 환불 불가</span>
                  </li>
                </ul>
              </div>
            </div>
          </section>
              <!-- Monthly: Surprise -->
              <div class="bg-slate-50 rounded-[32px] p-8 border border-slate-100 flex flex-col md:flex-row items-center gap-8 group">
                <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center text-4xl shadow-sm group-hover:scale-110 transition-transform">✨</div>
                <div class="flex-1 text-center md:text-left">
                  <div class="inline-block px-3 py-1 bg-amber-100 text-amber-600 rounded-full text-[10px] font-black uppercase tracking-widest mb-2">Monthly Milestone</div>
                  <h4 class="text-lg font-black text-slate-900 mb-1">이달의 성장 큐레이션</h4>
                  <p class="text-sm text-slate-500 font-medium leading-relaxed">한 달이라는 중요한 고비를 넘긴 당신을 위해 매월 다른 테마의 서프라이즈 리워드가 기다립니다. 성취의 기쁨을 더해줄 실질적인 혜택부터 성장을 가속화하는 특별 지원까지, 당신의 꾸준함을 응원하는 루파만의 비밀스러운 선물입니다.</p>
                </div>
              </div>

              <!-- Season: Extension -->
              <div class="relative group mt-12">
                <div class="absolute inset-0 bg-gradient-to-r from-orange-400 to-pink-500 rounded-[40px] blur-xl opacity-20 group-hover:opacity-30 transition-opacity"></div>
                <div class="relative bg-white border-2 border-orange-100 rounded-[40px] p-8 md:p-12">
                  <div class="text-center space-y-4 mb-10">
                    <div class="inline-block px-4 py-1.5 bg-orange-600 text-white rounded-full text-[10px] font-black uppercase tracking-widest">Season Final Selection</div>
                    <h4 class="text-2xl sm:text-3xl font-black text-slate-900 whitespace-nowrap">시즌 루파 레전드 (MVP)</h4>
                    <p class="text-slate-500 font-medium max-w-lg mx-auto leading-relaxed break-keep">
                      3개월의 긴 여정을 거쳐<br/>
                      최고의 변화를 이끌어낸 '루파 레전드'에게는<br/>
                      압도적인 혜택이 주어집니다.
                    </p>
                  </div>
                  
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-slate-50 rounded-3xl p-8 flex items-start gap-6 border border-slate-100">
                      <div class="w-14 h-14 bg-indigo-100 rounded-2xl flex items-center justify-center text-2xl shrink-0">🎫</div>
                      <div>
                        <p class="font-black text-slate-900 mb-1">차기 시즌 전액 지원</p>
                        <p class="text-xs text-slate-500 font-medium leading-relaxed">성장의 흐름이 끊기지 않도록, 다음 시즌 멤버십 권한을 파격적인 리워드와 함께 우선적으로 보장받습니다.</p>
                      </div>
                    </div>
                    <div class="bg-slate-50 rounded-3xl p-8 flex items-start gap-6 border border-slate-100">
                      <div class="w-14 h-14 bg-orange-100 rounded-2xl flex items-center justify-center text-2xl shrink-0">🏅</div>
                      <div>
                        <p class="font-black text-slate-900 mb-1">하이엔드 명예 시스템</p>
                        <p class="text-xs text-slate-500 font-medium leading-relaxed">영구 소장 가능한 한정판 레전드 뱃지와 전용 프로필 테마 등 루파 클럽 최고의 예우가 뒤따릅니다.</p>
                      </div>
                    </div>
                  </div>
                  
                  <p class="text-center text-[10px] text-slate-400 font-bold mt-8 italic">※ 최종 리워드는 시즌별 운영 정책에 따라 가장 가치 있는 형태로 구성되어 안내됩니다.</p>
                </div>
              </div>
            </div>
          </section>

          <!-- Rules -->
          <section class="p-8 bg-slate-900 rounded-[32px] text-white space-y-6 relative overflow-hidden">
             <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full blur-3xl translate-x-1/2 -translate-y-1/2"></div>
             <h3 class="text-xl font-black flex items-center gap-2">
              🔍 운영 및 제명 규정
            </h3>
            <div class="space-y-4 text-sm text-slate-300 font-medium leading-relaxed">
              <p>• <span class="text-white font-black">정기 모집 운영</span>: 루파 클럽은 매 분기(3개월/약 91일) 단위 기수제로 운영되며, 모집 기간 외 중도 가입은 불가능합니다.</p>
              <p>• <span class="text-white font-black">완주 및 혜택</span>: 기수 기간 내 <span class="text-indigo-400 font-black">출석률 <%= @routine_club.completion_attendance_rate.to_i %>% 이상 달성</span> 시 명예 완주 배지가 수여됩니다. (출석: 루틴이 설정된 요일에 1개 이상 실천 시)</p>
              <p>• <span class="text-white font-black">자동 제명 시스템</span>: 몰입도를 저해하는 무단 불참 누적(경고 <%= @routine_club.auto_kick_threshold %>회) 시, 시스템에 의해 자동 제명 처리됩니다.</p>
              <p>• <span class="text-white font-black">환불 및 기간</span>: 정액제 참여 특성상 시스템 승인 후 중도 퇴출이나 본인 변심에 의한 환불이 절대 불가합니다.</p>
            </div>
          </section>
        </div>

      <!-- Sidebar Area -->
      <div class="lg:col-span-4 self-start">
        <div class="lg:sticky lg:top-8 space-y-6">
        
        <!-- Join Card -->
        <% if @is_host %>
          <!-- Host Management -->
          <div class="bg-gradient-to-br from-purple-600 to-indigo-700 border-2 border-purple-200 rounded-[32px] p-8 text-center text-white shadow-xl">
            <div class="w-20 h-20 bg-white/20 rounded-[24px] flex items-center justify-center text-4xl mx-auto mb-4 border border-white/30">👑</div>
            <h3 class="text-xl font-black mb-2">프리미엄 호스트</h3>
            <p class="text-purple-200 font-medium mb-6 text-sm">
              시스템을 관리하고<br/>멤버들의 성장을 리드하세요
            </p>
            <%= link_to "관리 대시보드", manage_routine_club_path(@routine_club), class: "block w-full py-4 bg-white text-purple-600 rounded-2xl font-black hover:bg-purple-50 transition-colors mb-3 shadow-lg" %>
            <% if @pending_payments.any? %>
              <div class="bg-amber-400 text-amber-900 rounded-xl py-2 px-4 inline-flex items-center gap-2">
                <span class="w-2 h-2 bg-orange-600 rounded-full animate-ping"></span>
                <p class="text-xs font-black">확인 대기 <%= @pending_payments.count %>건</p>
              </div>
            <% end %>
          </div>
        <% elsif @is_member %>
          <!-- Already Member -->
          <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-[32px] p-8 text-center text-white shadow-xl">
            <div class="w-20 h-20 bg-white/20 rounded-[24px] flex items-center justify-center text-4xl mx-auto mb-4 border border-white/30">✅</div>
            <h3 class="text-xl font-black mb-2 whitespace-nowrap">루파 멤버십 유지 중</h3>
            <p class="text-emerald-100 font-medium mb-6 text-sm">
              환영합니다! 당신의 성장은<br/>지금 이 순간에도 진행 중입니다.
            </p>
            <%= link_to "클럽 대시보드 바로가기", personal_routines_path(tab: 'club'), class: "block w-full py-4 bg-white text-emerald-600 rounded-2xl font-black hover:bg-emerald-50 transition-colors shadow-lg" %>
          </div>
        <% elsif @routine_club.is_full? %>
          <!-- Full -->
          <div class="bg-slate-100 border-2 border-slate-200 rounded-[32px] p-8 text-center">
            <div class="text-5xl mb-4">🚫</div>
            <h3 class="text-xl font-black text-slate-400 mb-2">정원 마감</h3>
            <p class="text-slate-400 font-medium text-sm">
              인원이 가득 찼습니다<br/>다음 시즌을 기다려주세요
            </p>
          </div>
        <% elsif !@routine_club.recruitment_open? && current_user&.role != "admin" %>
          <!-- Recruitment Closed -->
          <div class="bg-slate-900 border-2 border-slate-800 rounded-[32px] p-10 text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
            <div class="relative z-10 space-y-6">
              <div class="w-20 h-20 bg-slate-800 rounded-[28px] flex items-center justify-center text-4xl mx-auto border border-white/5">🔒</div>
              <h3 class="text-xl font-black text-white">현재 정기 모집 기간이 아닙니다</h3>
              <p class="text-slate-500 font-bold text-sm leading-relaxed border-b border-white/5 pb-4">
                루파 클럽은 분기별 기수제로 운영됩니다.<br/>
                가장 완벽한 몰입을 위해 모집 기간에만<br/>
                신규 멤버를 선발하고 있습니다.
              </p>
              
              <!-- 기존 멤버 참여 버튼 -->
              <div class="flex flex-col items-center gap-3">
                <button onclick="document.getElementById('join-form').classList.remove('hidden'); document.getElementById('join-form').scrollIntoView({ behavior: 'smooth', block: 'start' });" class="w-full px-6 py-3 bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white rounded-2xl font-black text-sm transition-all shadow-xl hover:shadow-2xl active:scale-95 whitespace-nowrap flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                  </svg>
                  기존 멤버 참여
                </button>
                <p class="text-xs text-indigo-400 font-bold">⚡ 기존 멤버는 언제든지 참여 가능</p>
              </div>
              
              <div class="pt-4 border-t border-white/5">
                <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">Next Recruitment</p>
                <div class="inline-flex px-6 py-3 bg-white/5 border border-white/10 rounded-2xl text-white font-black text-sm">
                  <%= RoutineClub.recruitment_start_date.strftime("%Y년 %m월 %d일") %> 예정
                </div>
              </div>
            </div>
          </div>
        <% else %>
          <!-- Join Form -->
          <div class="bg-gradient-to-br from-indigo-500 via-purple-500 to-slate-900 rounded-[40px] p-8 text-white shadow-2xl relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 group-hover:bg-white/20 transition-all"></div>
            
            <% cur_gen = @routine_club.recruiting_generation_number %>
            <div class="inline-flex px-3 py-1 bg-white/20 backdrop-blur-md rounded-lg text-[10px] font-black uppercase tracking-widest mb-4">루파 클럽 <%= cur_gen %>기 신청</div>
            
            <h3 class="text-2xl font-black mb-2">멤버십 정기 모집</h3>
            <p class="text-xs font-bold text-white/70 mb-6 break-keep leading-relaxed">
              하루 300원 수준의 투자로 가장 압도적인 성취를 경험하세요.<br/>
              기수 완주 시 해당 기수 전용 <span class="text-indigo-300 font-black">명예 완주 배지</span>가 수여됩니다.
            </p>
            
            <!-- Price Calculation -->
            <div class="bg-black/40 backdrop-blur-xl rounded-3xl p-6 mb-6 border border-white/10">
              <p class="text-xs font-black text-white/60 mb-3 uppercase tracking-widest leading-none">Investment Plan</p>
              <% 
                quarterly_fee = @routine_club.calculate_quarterly_fee
                start_q = Date.current.beginning_of_quarter
                end_q = Date.current.end_of_quarter
              %>
              
              <div class="space-y-4">
                <div class="flex justify-between items-center">
                  <div class="text-left">
                    <span class="text-sm font-bold text-white/80 block"><%= cur_gen %>기 정액 참여비</span>
                    <span class="text-[10px] text-white/40 font-medium">시즌 전체 일수 (<%= start_q.strftime("%m/%d") %> ~ <%= end_q.strftime("%m/%d") %>)</span>
                  </div>
                  <span class="text-2xl font-black text-indigo-300"><%= number_to_currency(quarterly_fee, unit: "₩", precision: 0) %></span>
                </div>
                
                <div class="pt-4 border-t border-white/10 text-xs font-bold text-white/60 leading-relaxed">
                  * 루파클럽은 중도 가입 없이 기수 정액제로 운영됩니다.<br/>
                  * 출석률 70% 이상 달성 시 완주 보상이 제공됩니다.
                </div>
              </div>
            </div>
            
            <%= form_with url: join_routine_club_path(@routine_club), method: :post, class: "space-y-4" do |f| %>
              <div>
                <%= f.label :depositor_name, class: "text-[10px] font-black text-white/60 uppercase tracking-widest ml-1 mb-1 block" do %>
                  입금자 실명 <span class="text-indigo-300">*</span>
                <% end %>
                <%= text_field_tag :depositor_name, nil, placeholder: "실제 성함을 입력해주세요", required: true, class: "w-full px-6 py-4 bg-white/10 border-white/10 rounded-2xl text-white placeholder-white/30 font-bold focus:ring-2 ring-indigo-500/50 border-none transition-all" %>
              </div>

              <div>
                <%= f.label :contact_info, class: "text-[10px] font-black text-white/60 uppercase tracking-widest ml-1 mb-1 block" do %>
                  연락처 <span class="text-indigo-300">*</span>
                <% end %>
                <%= text_field_tag :contact_info, nil, placeholder: "010-0000-0000", required: true, 
                    class: "w-full px-6 py-4 bg-white/10 border-white/10 rounded-2xl text-white placeholder-white/30 font-bold focus:ring-2 ring-indigo-500/50 border-none transition-all",
                    data: { controller: "phone-format", action: "input->phone-format#format", phone_format_target: "input" } %>
              </div>

              <div>
                <%= f.label :threads_nickname, class: "text-[10px] font-black text-white/60 uppercase tracking-widest ml-1 mb-1 block" do %>
                  스레드 계정 <span class="text-white/30">(선택)</span>
                <% end %>
                <%= text_field_tag :threads_nickname, nil, placeholder: "@threads_id 또는 닉네임", class: "w-full px-6 py-4 bg-white/10 border-white/10 rounded-2xl text-white placeholder-white/30 font-bold focus:ring-2 ring-indigo-500/50 border-none transition-all" %>
              </div>
              
              <div class="bg-white/5 rounded-2xl p-5 text-xs space-y-2 border border-white/10">
                <p class="font-black text-white mb-2">🏦 입금 계좌 안내</p>
                <div class="flex justify-between">
                  <span class="opacity-60">은행</span>
                  <span><%= @routine_club.bank_name %></span>
                </div>
                <div class="flex justify-between">
                  <span class="opacity-60">계좌</span>
                  <span class="font-black select-all"><%= @routine_club.account_number %></span>
                </div>
                <div class="flex justify-between">
                  <span class="opacity-60">예금주</span>
                  <span><%= @routine_club.account_holder %></span>
                </div>
              </div>
              
              <button type="submit" class="w-full py-5 bg-white text-orange-600 rounded-3xl font-black text-xl hover:bg-yellow-300 hover:text-orange-700 transition-all shadow-xl active:scale-95">
                신청 완료하기
              </button>
            <% end %>
            
            <p class="text-[10px] text-white/50 text-center mt-6 font-medium leading-relaxed">
              신청 후 호스트가 입금을 확인하면<br/>즉시 루파 멤버십 권한이 부여됩니다.
            </p>
          </div>
        <% end %>

        <!-- Warning Card -->
        <div class="bg-amber-50 border border-amber-200 rounded-[32px] p-6 lg:p-8">
          <div class="flex items-start gap-4">
            <div class="w-10 h-10 bg-amber-100 rounded-xl flex items-center justify-center text-xl shrink-0">⚠️</div>
            <div>
              <p class="text-sm font-black text-amber-900 mb-3">참여 전 필독 사항</p>
              <ul class="text-xs text-amber-800 font-medium space-y-2 leading-relaxed">
                <li class="flex gap-2"><span>•</span> <span>최소 3개월(90일)의 몰입 기간이 필요합니다.</span></li>
                <li class="flex gap-2"><span>•</span> <span>규정 위반(경고 <%= @routine_club.auto_kick_threshold %>회) 시 자동 제명됩니다.</span></li>
                <li class="flex gap-2 font-black text-rose-600"><span>•</span> <span>제명 유저는 시스템에 기록되어 향후 재가입이 절대 불가합니다.</span></li>
                <li class="flex gap-2"><span>•</span> <span>멤버십 승인 후 중도 환불은 절대 불가합니다.</span></li>
                <li class="flex gap-2"><span>•</span> <span>성실한 루틴 인증으로 시스템의 혜택을 누리세요.</span></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Members Section (Moved to Sidebar) -->
        <div class="bg-white rounded-[40px] p-8 border border-slate-200 shadow-sm transition-all hover:shadow-md">
          <div class="flex items-center gap-3 mb-6">
            <div class="w-12 h-12 bg-indigo-100 rounded-2xl flex items-center justify-center">
              <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
            </div>
            <div class="flex-1">
              <h2 class="text-xl font-black text-slate-900 uppercase">함께 달리는 멤버</h2>
              <p class="text-[11px] text-slate-500 font-bold"><%= @members.count %>명의 클러버</p>
            </div>
          </div>
          
          <% if @members.any? %>
            <div class="grid grid-cols-2 lg:grid-cols-1 gap-3">
              <% @members.each do |member| %>
                <div class="bg-indigo-50/50 rounded-2xl p-4 flex items-center gap-3 border border-indigo-100/50">
                  <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white font-black text-sm shrink-0 shadow-sm">
                    <%= member.user.nickname[0].upcase %>
                  </div>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-black text-slate-900 truncate">
                      <%= member.user.nickname %>
                    </p>
                    <p class="text-[10px] text-indigo-600 font-bold">
                      LV.<%= member.user.level %> · 성공률 <%= member.attendance_rate.to_i %>%
                    </p>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="bg-slate-50 rounded-3xl p-8 text-center border border-dashed border-slate-200">
              <div class="text-3xl mb-2 opacity-30">👥</div>
              <p class="text-xs text-slate-400 font-bold">첫 번째 멤버가 되어보세요!</p>
            </div>
          <% end %>
        </div>

        </div>
      </div>
      <% end %>
    </div>

  </div>
</div>
