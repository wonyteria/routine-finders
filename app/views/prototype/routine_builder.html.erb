<div class="h-[calc(100vh-100px)] flex flex-col pt-2 bg-[#0C0B12] overflow-hidden select-none" data-controller="routine-wizard">
  <style>
    /* Ultra-clear Selection Effects */
    .premium-selection {
      border-color: #818cf8 !important;
      background: rgba(99, 102, 241, 0.25) !important;
      box-shadow: 0 0 25px rgba(99, 102, 241, 0.6), inset 0 0 10px rgba(99, 102, 241, 0.4) !important;
      transform: scale(1.1);
    }
    .check-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 22px;
      height: 22px;
      background: #818cf8;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.8);
      z-index: 20;
    }
    .unselected-opt {
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.03);
      filter: grayscale(0.5);
      opacity: 0.6;
    }
    .selected-cat {
      background: #FFFFFF !important;
      color: #0C0B12 !important;
      border: none !important;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.4) !important;
    }
    .step-section { 
      transition: all 0.45s cubic-bezier(0.23, 1, 0.32, 1); 
    }
    @keyframes check-pop {
      0% { transform: scale(0); }
      70% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .animate-check { animation: check-pop 0.3s ease-out forwards; }
  </style>

  <!-- Header -->
  <header class="flex items-center justify-between mb-2 px-6 shrink-0 z-20">
    <button id="prevBtn" class="w-10 h-10 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 active:scale-90 transition-all">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M15 19l-7-7 7-7"/></svg>
    </button>
    <div class="flex gap-2 h-1.5 px-4 flex-1 max-w-[140px] justify-center">
      <% 4.times do |i| %>
        <div class="step-indicator h-full rounded-full transition-all duration-700 ease-out" style="background: rgba(255,255,255,0.05); width: 8px;"></div>
      <% end %>
    </div>
    <div class="w-10"></div>
  </header>

  <%= form_with model: @routine, url: personal_routines_path(source: 'prototype'), data: { turbo: false }, class: "flex-1 flex flex-col min-h-0 relative max-w-lg mx-auto w-full" do |f| %>
    <%= f.hidden_field :icon, id: "routine_icon_hidden", value: "âœ¨" %>
    <%= f.hidden_field :category, id: "routine_category_hidden", value: "LIFE" %>
    <%= f.hidden_field :days, id: "routine_days_hidden", value: '["1","2","3","4","5"]' %>

    <div class="flex-1 overflow-y-auto no-scrollbar py-4 flex flex-col relative z-10 px-6">
      
      <!-- STEP 1: Title & Icon -->
      <section id="step-0" class="step-section flex-1 flex flex-col gap-4">
        <div class="space-y-1">
          <div class="flex justify-between items-end mb-2">
            <h2 class="text-xl font-black text-white tracking-tight">ì–´ë–¤ <span class="bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">ë£¨í‹´</span>ì„ ì‹œì‘í• ê¹Œìš”?</h2>
            <div class="px-3 py-1 bg-white/5 border border-white/10 rounded-full flex items-center gap-1.5">
              <span class="text-[10px] font-black <%= @active_routine_count >= 6 ? 'text-rose-500' : 'text-indigo-400' %>"><%= @active_routine_count %>/6</span>
              <span class="text-[8px] font-bold text-slate-500 uppercase tracking-tighter">Capacity</span>
            </div>
          </div>
          <% if @active_routine_count >= 6 %>
            <p class="text-[10px] font-bold text-rose-500/80 leading-relaxed italic">âš ï¸ ì„±ì‹¤í•œ ëª°ì…ì„ ìœ„í•´ ë£¨í‹´ì€ ìµœëŒ€ 6ê°œê¹Œì§€ë§Œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
          <% else %>
            <p class="text-[10px] font-bold text-slate-500 leading-relaxed">ì„±ì¥ í•µì‹¬ íŒ: í™•ì‹¤íˆ í•´ë‚¼ ìˆ˜ ìˆëŠ” 3~6ê°œê°€ ê°€ì¥ ì¢‹ìŠµë‹ˆë‹¤.</p>
          <% end %>
        </div>

        <div class="space-y-4">
          <div class="relative bg-white/5 rounded-xl p-0.5 border border-white/10 focus-within:border-indigo-500 transition-all">
            <%= f.text_field :title, id: "routine_title_input", placeholder: "ìŠµê´€ ì´ë¦„ ì…ë ¥", autocomplete: "off",
                            class: "w-full bg-transparent border-none py-3 text-base font-bold text-white placeholder:text-slate-700 focus:ring-0" %>
          </div>

          <!-- Roadmap Help Button -->
          <button type="button" id="roadmapBtn" class="w-full py-4 bg-indigo-500/10 border border-indigo-500/20 rounded-xl flex items-center justify-center gap-3 active:scale-95 transition-all group overflow-hidden relative">
            <div class="absolute inset-0 bg-gradient-to-r from-indigo-500/0 via-indigo-500/5 to-indigo-500/0 -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
            <span class="text-lg">ğŸŒ¿</span>
            <span class="text-[12px] font-black text-indigo-300">ë¬´ì—‡ì„ í• ì§€ ëª¨ë¥´ê² ì–´ìš” (ë¡œë“œë§µ ë³´ê¸°)</span>
            <svg class="w-3 h-3 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M9 5l7 7-7 7"/></svg>
          </button>

          <div class="space-y-2 shrink-0">
            <p class="text-[9px] font-black text-slate-600 uppercase tracking-[0.2em] pl-1">Choose Persona Icon</p>
            <div class="grid grid-cols-5 gap-2.5">
              <% @icons.each do |icon| %>
                <button type="button" data-icon="<%= icon %>" 
                        class="icon-opt relative aspect-square rounded-xl flex items-center justify-center text-2xl transition-all duration-300 active:scale-95 <%= icon == 'âœ¨' ? 'premium-selection' : 'unselected-opt' %>">
                  <span><%= icon %></span>
                  <% if icon == 'âœ¨' %>
                    <div class="check-badge animate-check">
                      <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M5 13l4 4L19 7"/></svg>
                    </div>
                  <% end %>
                </button>
              <% end %>
            </div>
          </div>
        </div>
      </section>

      <!-- STEP 2: Category -->
      <section id="step-1" class="step-section hidden flex-1 flex flex-col gap-6">
        <div class="space-y-1">
          <h2 class="text-2xl font-black text-white tracking-tight">ì´ ë£¨í‹´ì˜<br/><span class="text-indigo-500">ì¹´í…Œê³ ë¦¬</span>ëŠ” ë¬´ì—‡ì¸ê°€ìš”?</h2>
        </div>

        <div class="grid grid-cols-2 gap-3 pb-8">
          <% @categories.each do |cat| %>
            <button type="button" data-category="<%= cat[:key] %>" data-label="<%= cat[:label] %>"
                    class="cat-opt py-5 rounded-2xl font-black text-sm transition-all duration-300 border active:scale-[0.97] <%= cat[:key] == 'LIFE' ? 'selected-cat' : 'unselected-opt' %>">
              #<%= cat[:label] %>
            </button>
          <% end %>
        </div>
      </section>

      <!-- STEP 3: Days -->
      <section id="step-2" class="step-section hidden flex-1 flex flex-col gap-6">
        <div class="space-y-1">
          <h2 class="text-2xl font-black text-white tracking-tight">ì–¸ì œ ì´ ë£¨í‹´ì—<br/><span class="text-indigo-500">ëª°ì…</span>í• ê¹Œìš”?</h2>
        </div>

        <div class="space-y-6">
          <div class="flex justify-between gap-1">
            <% [['ì›”', '1'], ['í™”', '2'], ['ìˆ˜', '3'], ['ëª©', '4'], ['ê¸ˆ', '5'], ['í† ', '6'], ['ì¼', '0']].each do |label, val| %>
              <button type="button" data-day="<%= val %>" 
                      class="day-opt relative flex-1 aspect-[4/5.5] rounded-xl flex flex-col items-center justify-center gap-1 font-black transition-all duration-300 border <%= [1,2,3,4,5].include?(val.to_i) ? 'selected-cat' : 'unselected-opt' %>">
                <span class="text-[8px] uppercase"><%= label %></span>
                <span class="text-sm font-bold"><%= ['M','T','W','T','F','S','S'][val.to_i == 0 ? 6 : val.to_i-1] %></span>
                <% if [1,2,3,4,5].include?(val.to_i) %>
                   <div class="check-badge w-3 h-3 !-top-1 !-right-1 bg-indigo-500"></div>
                <% end %>
              </button>
            <% end %>
          </div>

          <div class="p-4 rounded-2xl bg-indigo-500/10 border border-indigo-500/30 flex gap-4">
            <span class="text-lg">ğŸ’¡</span>
            <p class="text-[10px] font-bold text-indigo-300 leading-relaxed">ë£¨íŒŒí´ëŸ½ì˜ ì„±ì‹¤í•¨ ì ìˆ˜ëŠ” <span class="text-white">í‰ì¼ ë£¨í‹´ ì²´í¬</span>ë¥¼ ê¸°ì¤€ì…ë‹ˆë‹¤.</p>
          </div>
        </div>
      </section>

      <!-- STEP 4: Summary -->
      <section id="step-3" class="step-section hidden flex-1 flex flex-col gap-4">
        <h2 class="text-2xl font-black text-white text-center">ì¤€ë¹„ <span class="text-indigo-500">ì™„ë£Œ!</span></h2>
        
        <div class="flex-1 flex flex-col items-center justify-center">
          <div class="w-full max-w-[280px] bg-[#1A1924] rounded-[40px] border border-indigo-500/30 shadow-2xl overflow-hidden p-8 text-center space-y-6">
            <div id="sum-icon" class="w-24 h-24 rounded-[32px] bg-indigo-500/20 border border-indigo-500/50 flex items-center justify-center text-5xl mx-auto shadow-2xl shadow-indigo-500/20">âœ¨</div>
            <div class="space-y-1">
              <p id="sum-cat" class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.3em]">#LIFE</p>
              <h3 id="sum-title" class="text-2xl font-black text-white break-words"></h3>
            </div>
            <div class="space-y-1 pt-4 border-t border-white/5">
              <p class="text-[9px] font-black text-slate-600 uppercase tracking-widest">Schedule</p>
              <p id="sum-days" class="text-xs font-black text-indigo-100 italic">ì›”, í™”, ìˆ˜, ëª©, ê¸ˆ</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Extra spacing for scroll -->
      <div class="h-32 shrink-0"></div>
    </div>

    <!-- Global Footer Button: Sticky at bottom, lifted to clear Navigation [+] button -->
    <div class="sticky bottom-0 inset-x-0 bg-gradient-to-t from-[#0C0B12] via-[#0C0B12] to-transparent pt-8 pb-32 px-6 shrink-0 z-20 pointer-events-none">
      <div class="pointer-events-auto">
        <button id="nextBtn" type="button" class="group relative w-full py-5 rounded-2xl bg-indigo-500 text-white font-black text-base shadow-xl active:scale-95 transition-all opacity-30 cursor-not-allowed" disabled>
          <span>ë‹¤ìŒ ë‹¨ê³„ë¡œ</span>
        </button>

        <button id="submitBtn" type="submit" class="hidden w-full py-5 rounded-2xl bg-indigo-500 text-white font-black text-lg shadow-2xl shadow-indigo-500/40 active:scale-95 transition-all">
          ì´ ë£¨í‹´ì„ ìƒì„±í•˜ê¸°
        </button>
      </div>
    </div>
  <% end %>
  <!-- ROUTINE ROADMAP OVERLAY (Premium App Style) -->
  <div id="roadmapOverlay" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm transform translate-y-full transition-transform duration-500 ease-[cubic-bezier(0.23,1,0.32,1)] overflow-hidden flex justify-center">
    <div class="w-full max-w-[500px] bg-[#0C0B12] h-full flex flex-col relative shadow-2xl border-x border-white/5">
      <!-- Header -->
      <header class="pt-6 pb-2 px-6 flex items-center justify-between shrink-0">
        <h2 class="text-xl font-black text-white italic tracking-tight">ë£¨í‹´ ë¡œë“œë§µ ğŸŒ¿</h2>
        <button id="closeRoadmap" class="w-10 h-10 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center text-slate-400 active:scale-90 transition-all">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </header>

      <!-- Category Tabs (Horizontal Scroll) -->
      <nav class="px-6 py-4 flex gap-3 overflow-x-auto no-scrollbar shrink-0">
        <% RoutineRoadmapHelper::ROADMAP_DATA.each_with_index do |(key, data), idx| %>
          <button type="button" data-roadmap-tab="<%= key %>" 
                  class="roadmap-tab px-5 py-2.5 rounded-full border text-xs font-black whitespace-nowrap transition-all duration-300
                         <%= idx == 0 ? 'bg-white text-[#0C0B12] border-white shadow-lg shadow-white/10' : 'bg-white/5 text-slate-500 border-white/10' %>">
            <%= data[:label] %>
          </button>
        <% end %>
      </nav>

    <!-- Content (Growth Path) -->
    <div class="flex-1 overflow-y-auto no-scrollbar relative">
      <div class="px-6 py-4 pb-32">
        <div class="mb-10 text-center">
          <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Growth Journey</p>
          <h3 class="text-xl font-black text-white">ê´€ì‹¬ì‚¬ë¥¼ ì„ íƒí•˜ê³ <br/>ì‘ì€ ì”¨ì•—ë¶€í„° ì‹œì‘í•´ë³´ì„¸ìš”.</h3>
        </div>

        <% RoutineRoadmapHelper::ROADMAP_DATA.each_with_index do |(key, data), idx| %>
          <div id="roadmap-path-<%= key %>" class="roadmap-path space-y-12 relative <%= idx == 0 ? '' : 'hidden' %>">
            
            <!-- Vertical Guide Line -->
            <div class="absolute left-1/2 -translate-x-1/2 top-10 bottom-10 w-px bg-gradient-to-b from-emerald-500/20 via-indigo-500/20 to-purple-500/20"></div>

            <% data[:steps].each_with_index do |step, s_idx| %>
              <div class="relative flex flex-col items-center roadmap-item group" 
                   data-title="<%= step[:title] %>" data-icon="<%= step[:icon] %>" data-category="<%= key %>">
                
                <!-- Connection Visuals -->
                <% if s_idx < data[:steps].size - 1 %>
                   <div class="absolute top-[80px] left-1/2 -translate-x-1/2 w-4 h-[60px] flex items-center justify-center">
                      <svg class="w-full h-full text-white/5" viewBox="0 0 24 60" fill="none" stroke="currentColor">
                         <path d="M12 0V60" stroke-width="2" stroke-dasharray="4 4" />
                      </svg>
                   </div>
                <% end %>

                <!-- Icon Node -->
                <div class="relative w-24 h-24 rounded-[32px] bg-gradient-to-br <%= step[:level] == 'SEED' ? 'from-emerald-500/10 to-emerald-500/5 border-emerald-500/20' : (step[:level] == 'SPROUT' ? 'from-indigo-500/10 to-indigo-500/5 border-indigo-500/20' : 'from-purple-500/10 to-purple-500/5 border-purple-500/20') %> 
                            border flex items-center justify-center text-4xl shadow-2xl transition-all duration-500 group-active:scale-95 z-10">
                  <span><%= step[:icon] %></span>
                  
                  <!-- Level Badge -->
                  <div class="absolute -bottom-2 px-3 py-1 rounded-full border text-[8px] font-black tracking-tighter uppercase
                             <%= step[:level] == 'SEED' ? 'bg-emerald-500 text-white border-emerald-400 shadow-lg shadow-emerald-500/30' : 
                                (step[:level] == 'SPROUT' ? 'bg-indigo-500 text-white border-indigo-400 shadow-lg shadow-indigo-500/30' : 'bg-purple-500 text-white border-purple-400 shadow-lg shadow-purple-500/30') %>">
                    <%= step[:level] %>
                  </div>
                </div>

                <!-- Text Info -->
                <div class="mt-6 text-center max-w-[180px]">
                  <h4 class="text-base font-black text-white mb-1"><%= step[:title] %></h4>
                  <p class="text-[10px] font-bold text-slate-500 leading-tight"><%= step[:description] %></p>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Bottom Action Tip -->
    <div class="absolute bottom-0 inset-x-0 p-6 bg-gradient-to-t from-[#0C0B12] via-[#0C0B12]/90 to-transparent pointer-events-none">
      <div class="py-4 px-6 rounded-2xl bg-indigo-500/10 border border-indigo-500/20 flex items-center justify-center gap-3 pointer-events-auto">
        <span class="text-base animate-pulse">âœ¨</span>
        <p class="text-[10px] font-bold text-indigo-300">ì›í•˜ëŠ” ë£¨í‹´ ë‹¨ê³„ë¥¼ íƒ­í•˜ì—¬ ë°”ë¡œ ì‹œì‘í•˜ì„¸ìš”.</p>
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const sections = document.querySelectorAll('.step-section');
    const indicators = document.querySelectorAll('.step-indicator');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const prevBtn = document.getElementById('prevBtn');
    
    let currentStep = 0;

    const titleInput = document.getElementById('routine_title_input');
    const iconHidden = document.getElementById('routine_icon_hidden');
    const catHidden = document.getElementById('routine_category_hidden');
    const daysHidden = document.getElementById('routine_days_hidden');

    const activeRoutineCount = <%= @active_routine_count %>;
    
    function validate() {
      if (currentStep === 0) {
        const isValid = titleInput.value.trim().length > 0 && activeRoutineCount < 6;
        nextBtn.disabled = !isValid;
        nextBtn.classList.toggle('opacity-30', !isValid);
        nextBtn.classList.toggle('cursor-not-allowed', !isValid);
      } else {
        nextBtn.disabled = activeRoutineCount >= 6;
        nextBtn.classList.toggle('opacity-30', activeRoutineCount >= 6);
      }
    }

    function update() {
      sections.forEach((s, i) => s.classList.toggle('hidden', i !== currentStep));
      indicators.forEach((ind, i) => {
        ind.style.background = i <= currentStep ? '#818cf8' : 'rgba(255,255,255,0.05)';
        ind.style.width = i === currentStep ? '32px' : '8px';
      });

      if (currentStep === sections.length - 1) {
        nextBtn.classList.add('hidden');
        submitBtn.classList.remove('hidden');
      } else {
        nextBtn.classList.remove('hidden');
        submitBtn.classList.add('hidden');
      }

      if (titleInput.value) document.getElementById('sum-title').textContent = titleInput.value;
      if (iconHidden.value) document.getElementById('sum-icon').textContent = iconHidden.value;
      
      const activeCat = document.querySelector('.cat-opt.selected-cat');
      if (activeCat) {
        document.getElementById('sum-cat').textContent = '#' + activeCat.dataset.label;
      }
      
      validate();
    }

    titleInput.addEventListener('input', validate);

    document.querySelectorAll('.icon-opt').forEach(btn => {
      btn.addEventListener('click', () => {
        iconHidden.value = btn.dataset.icon;
        document.querySelectorAll('.icon-opt').forEach(b => {
          b.className = "icon-opt relative aspect-square rounded-xl flex items-center justify-center text-2xl transition-all duration-300 active:scale-95 unselected-opt";
          const badge = b.querySelector('.check-badge');
          if (badge) badge.remove();
        });
        btn.classList.replace('unselected-opt', 'premium-selection');
        btn.innerHTML += '<div class="check-badge animate-check"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M5 13l4 4L19 7"/></svg></div>';
        update();
      });
    });

    document.querySelectorAll('.cat-opt').forEach(btn => {
      btn.addEventListener('click', () => {
        catHidden.value = btn.dataset.category;
        document.querySelectorAll('.cat-opt').forEach(b => {
          b.className = "cat-opt py-5 rounded-2xl font-black text-sm transition-all duration-300 border active:scale-[0.97] unselected-opt";
        });
        btn.className = "cat-opt py-5 rounded-2xl font-black text-sm transition-all duration-300 border active:scale-[0.97] selected-cat";
        update();
      });
    });

    document.querySelectorAll('.day-opt').forEach(btn => {
      btn.addEventListener('click', () => {
        const isSelected = btn.classList.contains('selected-cat');
        if (isSelected) {
          btn.className = "day-opt relative flex-1 aspect-[4/5.5] rounded-xl flex flex-col items-center justify-center gap-1 font-black transition-all duration-300 border unselected-opt";
          const badge = btn.querySelector('.check-badge');
          if (badge) badge.remove();
        } else {
          btn.className = "day-opt relative flex-1 aspect-[4/5.5] rounded-xl flex flex-col items-center justify-center gap-1 font-black transition-all duration-300 border selected-cat";
          btn.innerHTML += '<div class="check-badge w-3 h-3 !-top-1 !-right-1 bg-indigo-500"></div>';
        }
        
        const selected = Array.from(document.querySelectorAll('.day-opt.selected-cat')).map(b => b.dataset.day);
        daysHidden.value = JSON.stringify(selected);
        
        const labels = {"1":"ì›”","2":"í™”","3":"ìˆ˜","4":"ëª©","5":"ê¸ˆ","6":"í† ","0":"ì¼"};
        const sorted = selected.sort((a,b) => (a == "0" ? 7 : a) - (b == "0" ? 7 : b));
        document.getElementById('sum-days').textContent = selected.length === 7 ? "ë§¤ì¼" : sorted.map(d => labels[d]).join(", ");
      });
    });

    nextBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (currentStep < sections.length - 1) {
        currentStep++;
        update();
      }
    });

    prevBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (currentStep > 0) {
        currentStep--;
        update();
      } else {
        window.history.back();
      }
    });

    update();
    
    // ROADMAP LOGIC (Premium App Style)
    const roadmapBtn = document.getElementById('roadmapBtn');
    const roadmapOverlay = document.getElementById('roadmapOverlay');
    const closeRoadmap = document.getElementById('closeRoadmap');

    roadmapBtn.addEventListener('click', () => {
      roadmapOverlay.classList.replace('translate-y-full', 'translate-y-0');
    });

    closeRoadmap.addEventListener('click', () => {
      roadmapOverlay.classList.replace('translate-y-0', 'translate-y-full');
    });

    // Roadmap Tab Switching
    document.querySelectorAll('[data-roadmap-tab]').forEach(tab => {
      tab.addEventListener('click', () => {
        const target = tab.dataset.roadmapTab;
        
        // Update Tabs UI
        document.querySelectorAll('[data-roadmap-tab]').forEach(t => {
          t.className = "roadmap-tab px-5 py-2.5 rounded-full border text-[11px] font-black whitespace-nowrap transition-all duration-300 bg-white/5 text-slate-500 border-white/10";
        });
        tab.className = "roadmap-tab px-5 py-2.5 rounded-full border text-[11px] font-black whitespace-nowrap transition-all duration-300 bg-white text-[#0C0B12] border-white shadow-lg shadow-white/10";

        // Update Paths Visibility
        document.querySelectorAll('.roadmap-path').forEach(p => p.classList.add('hidden'));
        document.getElementById(`roadmap-path-${target}`).classList.remove('hidden');
      });
    });

    document.querySelectorAll('.roadmap-item').forEach(item => {
      item.addEventListener('click', () => {
        // Pre-fill fields
        titleInput.value = item.dataset.title;
        iconHidden.value = item.dataset.icon;
        catHidden.value = item.dataset.category;
        
        // Update Icon selection UI
        document.querySelectorAll('.icon-opt').forEach(b => {
          b.className = "icon-opt relative aspect-square rounded-xl flex items-center justify-center text-2xl transition-all duration-300 active:scale-95 unselected-opt";
          const badge = b.querySelector('.check-badge');
          if (badge) badge.remove();
        });
        
        const targetIconBtn = document.querySelector(`.icon-opt[data-icon="${item.dataset.icon}"]`);
        if (targetIconBtn) {
          targetIconBtn.classList.replace('unselected-opt', 'premium-selection');
          targetIconBtn.innerHTML += '<div class="check-badge animate-check"><svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="4"><path d="M5 13l4 4L19 7"/></svg></div>';
        }

        // Update Category selection UI
        document.querySelectorAll('.cat-opt').forEach(b => {
          b.className = "cat-opt py-5 rounded-2xl font-black text-sm transition-all duration-300 border active:scale-[0.97] unselected-opt";
        });
        const targetCatBtn = document.querySelector(`.cat-opt[data-category="${item.dataset.category}"]`);
        if (targetCatBtn) {
          targetCatBtn.className = "cat-opt py-5 rounded-2xl font-black text-sm transition-all duration-300 border active:scale-[0.97] selected-cat";
        }

        // Close Overlay
        roadmapOverlay.classList.replace('translate-y-0', 'translate-y-full');
        
        // Update components and Go to next step
        update();
        if (currentStep === 0) {
          currentStep = 1; 
          update();
        }
      });
    });

    // Prevent accidental exit
    setTimeout(() => {
      let isFormDirty = false;
      const form = document.querySelector('form');
      if (form) {
        form.addEventListener('change', () => { isFormDirty = true; });
        form.addEventListener('input', () => { isFormDirty = true; });
        form.addEventListener('submit', () => { isFormDirty = false; });
        
        window.addEventListener('beforeunload', (e) => {
          if (isFormDirty) {
            e.preventDefault();
            e.returnValue = '';
          }
        });
        
        document.addEventListener('turbo:before-visit', (e) => {
          if (isFormDirty && document.body.contains(form)) {
             if (!confirm('ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì´ ì €ì¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
               e.preventDefault();
             } else {
               isFormDirty = false;
             }
          }
        });
      }
    }, 500);
  })();
</script>
